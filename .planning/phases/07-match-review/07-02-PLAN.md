---
phase: 07-match-review
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/(dashboard)/rfps/components/confidence-bar.tsx
  - src/app/(dashboard)/rfps/components/match-suggestion-row.tsx
  - src/app/(dashboard)/rfps/components/rfp-item-card.tsx
  - src/app/(dashboard)/rfps/[id]/matches/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees RFP items in a scrollable list with nested match suggestions"
    - "User sees teal confidence bar for each match suggestion"
    - "User can click Accept on a match and it becomes highlighted/accepted"
    - "User can click Reject on a match and it fades/becomes rejected"
    - "Reviewed items collapse to show only outcome with 70% opacity"
    - "Accepting one match auto-rejects all other matches for that item"
  artifacts:
    - path: "src/app/(dashboard)/rfps/components/confidence-bar.tsx"
      provides: "Teal progress bar showing match similarity score"
      exports: ["ConfidenceBar"]
      min_lines: 15
    - path: "src/app/(dashboard)/rfps/components/match-suggestion-row.tsx"
      provides: "Single match row with Accept/Reject buttons and loading state"
      exports: ["MatchSuggestionRow"]
      min_lines: 50
    - path: "src/app/(dashboard)/rfps/components/rfp-item-card.tsx"
      provides: "RFP item card with nested matches and collapse behavior"
      exports: ["RFPItemCard"]
      min_lines: 60
  key_links:
    - from: "src/app/(dashboard)/rfps/components/match-suggestion-row.tsx"
      to: "src/app/(dashboard)/rfps/[id]/matches/actions.ts"
      via: "Server Action calls"
      pattern: "acceptMatch|rejectMatch"
    - from: "src/app/(dashboard)/rfps/[id]/matches/page.tsx"
      to: "src/app/(dashboard)/rfps/components/rfp-item-card.tsx"
      via: "component import"
      pattern: "RFPItemCard"
---

<objective>
Create the interactive match review components: ConfidenceBar, MatchSuggestionRow, and RFPItemCard. Wire them into the page.

Purpose: Deliver the complete match review UI where users can see confidence scores, accept/reject individual matches, and see reviewed items collapse with visual distinction.

Output:
- ConfidenceBar component (teal progress bar with percentage)
- MatchSuggestionRow component (match data + actions + loading states)
- RFPItemCard component (item info + nested matches + collapse behavior)
- Updated page.tsx using the new components
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase context (locked decisions)
@.planning/phases/07-match-review/07-CONTEXT.md
@.planning/phases/07-match-review/07-RESEARCH.md

# Plan 01 outputs (if SUMMARY exists)
@.planning/phases/07-match-review/07-01-SUMMARY.md

# Existing code from Plan 01
@src/types/rfp.ts
@src/app/(dashboard)/rfps/[id]/matches/actions.ts
@src/app/(dashboard)/rfps/[id]/matches/page.tsx

# Existing patterns and components
@src/app/(dashboard)/rfps/components/rfp-jobs-list.tsx
@src/components/ui/card.tsx
@src/components/ui/button.tsx
@src/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConfidenceBar component</name>
  <files>src/app/(dashboard)/rfps/components/confidence-bar.tsx</files>
  <action>
Create a Client Component ('use client') for displaying match confidence as a teal progress bar.

**Props:**
- score: number (0.0000 to 1.0000 from database)
- className?: string (optional for customization)

**Implementation per CONTEXT.md:**
- Convert score to percentage: `Math.round(score * 100)`
- Use a horizontal bar container with bg-muted (the track)
- Inner div with bg-primary (teal) and width set by percentage
- Add percentage text to the right of the bar (e.g., "85%")
- Use CSS transition on width for smooth updates

**Visual structure:**
```
[====teal bar====          ] 85%
```

- Bar container: h-2, flex-1, rounded-full, bg-muted, overflow-hidden
- Inner bar: h-full, bg-primary, transition-all
- Text: text-xs, text-muted-foreground, w-8, text-right

Use cn() for merging classes. Keep it simple - no gradient, no color variations based on score.
  </action>
  <verify>
Component renders without errors. Import in page.tsx temporarily to test with a hardcoded score.
  </verify>
  <done>
ConfidenceBar renders a teal progress bar with percentage label.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MatchSuggestionRow component</name>
  <files>src/app/(dashboard)/rfps/components/match-suggestion-row.tsx</files>
  <action>
Create a Client Component for a single match suggestion row with Accept/Reject buttons.

**Props:**
- jobId: string
- rfpItemId: string
- match: MatchSuggestion type from '@/types/rfp'

**Implementation:**

1. **State management:**
   - Use `useTransition()` from React for isPending state during Server Action calls

2. **Action handlers:**
   - handleAccept: startTransition -> await acceptMatch(jobId, rfpItemId, match.id)
   - handleReject: startTransition -> await rejectMatch(jobId, rfpItemId, match.id)
   - Import actions from '../[id]/matches/actions'

3. **Layout structure (flex row):**
   - Match data columns (grid grid-cols-3):
     - codigo_spms (font-mono, text-sm) - show '-' if null
     - artigo (text-sm) - show '-' if null
     - descricao (text-sm, truncate) - show '-' if null
   - ConfidenceBar (w-24)
   - Action buttons container

4. **Visual states per CONTEXT.md:**
   - Default: border rounded-md p-3
   - isAccepted (match.status === 'accepted'): bg-primary/5, border-primary/30
   - isRejected (match.status === 'rejected'): opacity-50
   - isPending (useTransition): opacity-70, pointer-events-none

5. **Buttons:**
   - Accept button: size="sm", variant changes based on isAccepted
     - Default: variant="outline"
     - When accepted: variant="default" (filled)
     - Disabled when already accepted
     - Icon: Check from lucide-react
     - aria-label="Accept this match"
   - Reject button: size="sm"
     - Default: variant="outline"
     - When rejected: variant="destructive"
     - Disabled when already rejected
     - Icon: X from lucide-react
     - aria-label="Reject this match"
   - When isPending: show Loader2 with animate-spin instead of buttons

Use cn() for conditional classes. Import ConfidenceBar from './confidence-bar'.
  </action>
  <verify>
Component renders without errors. Test by temporarily using in page.tsx with a mock match object.
  </verify>
  <done>
MatchSuggestionRow shows match data, confidence bar, and Accept/Reject buttons with loading states.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create RFPItemCard component with collapse behavior</name>
  <files>src/app/(dashboard)/rfps/components/rfp-item-card.tsx</files>
  <action>
Create a Client Component for displaying an RFP item with its nested match suggestions.

**Props:**
- jobId: string
- item: RFPItemWithMatches type from '@/types/rfp'

**Implementation per CONTEXT.md:**

1. **State:**
   - isExpanded: boolean, default to `item.review_status === 'pending'` (expanded if pending, collapsed if reviewed)

2. **Derived values:**
   - isReviewed: item.review_status !== 'pending'
   - acceptedMatch: item.rfp_match_suggestions.find(m => m.status === 'accepted')

3. **Card styling:**
   - Use Card component from '@/components/ui/card'
   - Apply `opacity-70` class when isReviewed (faded appearance per CONTEXT.md)
   - transition-opacity for smooth fading

4. **CardHeader:**
   - Make clickable when isReviewed (toggle collapse) with cursor-pointer
   - Left side (flex items-center gap-3):
     - Badge showing "Lote {lote_pedido}.{posicao_pedido}" if lote_pedido exists
     - CardTitle with item.descricao_pedido (text-base font-medium)
   - Right side (flex items-center gap-2):
     - Status badge when reviewed:
       - accepted: bg-primary/10 text-primary border-primary/30, Check icon, "Matched"
       - rejected: variant="secondary", X icon, "No Match"
     - ChevronDown icon when isReviewed (rotates 180deg when isExpanded)

5. **Collapsed summary (show when isReviewed AND NOT isExpanded AND acceptedMatch exists):**
   - Below the header: "Matched to: {acceptedMatch.artigo} - {acceptedMatch.descricao}"
   - text-sm text-muted-foreground mt-2

6. **CardContent (show when isExpanded):**
   - space-y-2 for vertical spacing between match rows
   - Map over item.rfp_match_suggestions and render MatchSuggestionRow for each
   - Empty state if no suggestions: "No match suggestions available" (centered, muted text)

Import components: Card/CardContent/CardHeader/CardTitle from '@/components/ui/card', Badge, Check/X/ChevronDown from lucide-react, cn from '@/lib/utils', MatchSuggestionRow from './match-suggestion-row'.
  </action>
  <verify>
Component renders without errors. Verify collapse behavior works by clicking header of a reviewed item.
  </verify>
  <done>
RFPItemCard displays item info with nested matches, collapses when reviewed, shows status badges.
  </done>
</task>

<task type="auto">
  <name>Task 4: Wire components into page.tsx</name>
  <files>src/app/(dashboard)/rfps/[id]/matches/page.tsx</files>
  <action>
Update the match review page to use the new components instead of placeholder Cards.

**Changes:**

1. **Add import:**
   ```typescript
   import { RFPItemCard } from '@/app/(dashboard)/rfps/components/rfp-item-card'
   ```

2. **Replace the placeholder mapping:**
   Remove the temporary Card placeholders and replace with:
   ```tsx
   {itemsWithSortedMatches.map(item => (
     <RFPItemCard
       key={item.id}
       jobId={jobId}
       item={item}
     />
   ))}
   ```

3. **Ensure type casting:**
   The nested select returns `rfp_match_suggestions` array - cast items to RFPItemWithMatches[] if needed after sorting.

4. **Verify imports:**
   - RFPItemWithMatches from '@/types/rfp'
   - No longer need Card import if only used in placeholder

5. **Keep the empty state:**
   Still show "No items found for this RFP." when itemsWithSortedMatches.length === 0

The page should now render the full interactive match review UI.
  </action>
  <verify>
1. `npm run dev` - start dev server
2. Navigate to /rfps/{jobId}/matches for a completed job with items
3. Verify:
   - Items display with nested match suggestions
   - Confidence bars show (teal, with percentage)
   - Accept button works (item becomes accepted, siblings rejected)
   - Reject button works (match fades, all rejected = item rejected)
   - Reviewed items collapse and fade to 70% opacity
   - Click collapsed item header to expand/collapse
4. `npm run lint` passes
5. `npx tsc --noEmit` passes
  </verify>
  <done>
Page renders full match review UI with interactive accept/reject functionality.
  </done>
</task>

</tasks>

<verification>
Full integration test:
1. Upload an RFP (Phase 5) and wait for processing to complete
2. Click toast action or navigate to /rfps/{jobId}/matches
3. Verify all items display with match suggestions
4. Accept a match on one item - verify it highlights, siblings reject, item collapses
5. Reject all matches on another item - verify item shows "No Match" status
6. Click collapsed item to expand - verify it re-expands
7. Refresh page - verify state persists from database
</verification>

<success_criteria>
- [ ] ConfidenceBar shows teal progress bar with percentage
- [ ] MatchSuggestionRow shows match data in columns + confidence + Accept/Reject buttons
- [ ] MatchSuggestionRow shows loading state during Server Action
- [ ] MatchSuggestionRow highlights accepted matches, fades rejected matches
- [ ] RFPItemCard displays item description with lote/posicao badge
- [ ] RFPItemCard shows status badge (Matched/No Match) for reviewed items
- [ ] RFPItemCard collapses reviewed items, shows expanded for pending
- [ ] RFPItemCard at 70% opacity when reviewed
- [ ] Clicking Accept triggers Server Action, updates UI after revalidation
- [ ] Clicking Reject triggers Server Action, auto-rejects item if all matches rejected
- [ ] Page integrates all components correctly
</success_criteria>

<output>
After completion, create `.planning/phases/07-match-review/07-02-SUMMARY.md`
</output>
