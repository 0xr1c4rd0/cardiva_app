---
phase: 02-authentication
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/login/actions.ts
  - src/middleware.ts
  - src/app/(dashboard)/layout.tsx
  - src/components/layout/user-menu.tsx
autonomous: true

must_haves:
  truths:
    - "User can access login form at /login"
    - "User can submit login with email and password"
    - "Banned users see 'pending approval' message instead of generic error"
    - "Approved users are redirected to dashboard after login"
    - "User session persists across browser refresh"
    - "User can log out from dashboard header"
    - "Unauthenticated users are redirected from dashboard to login"
    - "Authenticated users are redirected from login/register to dashboard"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login form UI"
      min_lines: 60
    - path: "src/app/(auth)/login/actions.ts"
      provides: "Login and logout server actions"
      exports: ["login", "logout"]
    - path: "src/middleware.ts"
      provides: "Updated middleware with route protection"
      contains: "redirect.*login"
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with auth check and logout"
      contains: "getUser"
    - path: "src/components/layout/user-menu.tsx"
      provides: "User dropdown menu with logout"
      exports: ["UserMenu"]
  key_links:
    - from: "src/app/(auth)/login/page.tsx"
      to: "src/app/(auth)/login/actions.ts"
      via: "form action={login}"
      pattern: "action=\\{.*login"
    - from: "src/middleware.ts"
      to: "/login"
      via: "redirect for unauthenticated"
      pattern: "redirect.*login"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/lib/supabase/server.ts"
      via: "getUser() validation"
      pattern: "getUser\\(\\)"
    - from: "src/components/layout/user-menu.tsx"
      to: "src/app/(auth)/login/actions.ts"
      via: "logout form action"
      pattern: "action=\\{logout\\}"
---

<objective>
Implement login functionality with session persistence, route protection, and logout capability.

Purpose: Enables approved users to log in, maintains their session across navigation and refresh, and provides logout functionality. This satisfies AUTH-04 (user can log in), AUTH-05 (session persists), and AUTH-06 (user can log out from any page).

Output:
- Login form with server action
- Updated middleware with protected route logic
- Dashboard layout with auth validation and user menu
- User menu component with logout button
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-RESEARCH.md

# Created in 02-01
@src/lib/supabase/admin.ts
@src/lib/auth/validation.ts
@src/app/(auth)/layout.tsx
@src/app/(auth)/register/actions.ts

# Existing files to update
@src/middleware.ts
@src/app/(dashboard)/layout.tsx
@src/components/layout/app-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create login page and actions</name>
  <files>
    - src/app/(auth)/login/page.tsx
    - src/app/(auth)/login/actions.ts
  </files>
  <action>
Create login page at `src/app/(auth)/login/page.tsx`:
- Client component ('use client') to use useActionState
- Import useActionState from 'react'
- Import useSearchParams from 'next/navigation' to read message param
- Use shadcn Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter
- Form fields: email (Input type="email" name="email"), password (Input type="password" name="password")
- Submit button with pending state
- Display error from state.error in red alert
- Display success message from searchParams.get('message') in green alert (for registration success, password reset)
- Links: "Forgot password?" to /reset-password, "Don't have an account? Sign up" to /register

Create login server action at `src/app/(auth)/login/actions.ts`:
- 'use server' directive
- Import createClient from @/lib/supabase/server
- Import loginSchema from @/lib/auth/validation
- Import redirect from next/navigation
- Import revalidatePath from next/cache

login function (prevState, formData):
1. Create Supabase client
2. Validate with loginSchema.safeParse({ email: formData.get('email'), password: formData.get('password') })
3. If invalid, return { error: 'Invalid email or password format' }
4. Call supabase.auth.signInWithPassword({ email, password })
5. If error:
   - Check if error.message includes 'banned' -> return { error: 'Your account is pending admin approval. Please contact an administrator.' }
   - Otherwise return { error: error.message }
6. revalidatePath('/', 'layout')
7. redirect('/')

logout function:
1. Create Supabase client
2. Call supabase.auth.signOut()
3. revalidatePath('/', 'layout')
4. redirect('/login')
  </action>
  <verify>
- Navigate to http://localhost:3000/login - form renders
- TypeScript compiles: `npx tsc --noEmit`
- Login page shows message from URL params (test with /login?message=test)
  </verify>
  <done>
Login form captures credentials, server action authenticates against Supabase and handles banned user case with clear message, logout action signs out and redirects
  </done>
</task>

<task type="auto">
  <name>Task 2: Update middleware for route protection</name>
  <files>
    - src/middleware.ts
  </files>
  <action>
Update middleware at `src/middleware.ts` to add route protection:

Keep existing token refresh logic, add route protection after getUser() call:

```typescript
// After: const { data: { user } } = await supabase.auth.getUser()

// Define protected and public routes
const protectedRoutes = ['/', '/rfps', '/inventory', '/history', '/settings', '/admin']
const authRoutes = ['/login', '/register', '/reset-password', '/update-password']

const pathname = request.nextUrl.pathname

// Check if current path is protected
const isProtectedRoute = protectedRoutes.some(route =>
  pathname === route || pathname.startsWith(route + '/')
)

// Check if current path is an auth route
const isAuthRoute = authRoutes.some(route =>
  pathname === route || pathname.startsWith(route + '/')
)

// Redirect unauthenticated users from protected routes to login
if (isProtectedRoute && !user) {
  const loginUrl = new URL('/login', request.url)
  return NextResponse.redirect(loginUrl)
}

// Redirect authenticated users from auth routes to dashboard
if (isAuthRoute && user) {
  const dashboardUrl = new URL('/', request.url)
  return NextResponse.redirect(dashboardUrl)
}
```

IMPORTANT:
- The check uses `user` (result of getUser()), not session - this validates the JWT server-side
- Protected routes include root '/' since dashboard is at root
- Auth routes redirect logged-in users to prevent accessing login when already authenticated
  </action>
  <verify>
- Dev server runs without errors
- Unauthenticated: visiting / redirects to /login
- Unauthenticated: visiting /login shows login page (no redirect loop)
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Middleware protects dashboard routes and redirects appropriately based on auth state
  </done>
</task>

<task type="auto">
  <name>Task 3: Update dashboard layout and create user menu</name>
  <files>
    - src/app/(dashboard)/layout.tsx
    - src/components/layout/user-menu.tsx
  </files>
  <action>
First, add dropdown-menu component: `npx shadcn@latest add dropdown-menu avatar`

Create user menu component at `src/components/layout/user-menu.tsx`:
- Server component (can access cookies)
- Import createClient from @/lib/supabase/server
- Import logout from @/app/(auth)/login/actions
- Import DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel, DropdownMenuSeparator, DropdownMenuTrigger from @/components/ui/dropdown-menu
- Import Avatar, AvatarFallback from @/components/ui/avatar (for user icon)
- Import Button from @/components/ui/button
- Import LogOut, User icons from lucide-react

Component:
1. Get user with supabase.auth.getUser()
2. If no user, return null (shouldn't happen in dashboard)
3. Extract email and initials for avatar
4. Render dropdown with:
   - Trigger: Avatar with user initials or fallback icon
   - Content:
     - Label showing user email
     - Separator
     - Logout item as form with action={logout}

Update dashboard layout at `src/app/(dashboard)/layout.tsx`:
- Import createClient from @/lib/supabase/server
- Import redirect from next/navigation
- Import UserMenu from @/components/layout/user-menu

Add auth check at start of component:
```typescript
const supabase = await createClient()
const { data: { user }, error } = await supabase.auth.getUser()

if (error || !user) {
  redirect('/login')
}
```

Replace the comment `{/* User menu will be added in Auth phase */}` with `<UserMenu />` in the header.

IMPORTANT: Use getUser() not getSession() for server-side auth validation (security requirement from research).
  </action>
  <verify>
- Dropdown menu component exists: src/components/ui/dropdown-menu.tsx
- Avatar component exists: src/components/ui/avatar.tsx
- User menu component renders user email and logout button
- Dashboard layout redirects to /login if not authenticated
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Dashboard layout validates authentication server-side and renders user menu with logout functionality in header
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Components installed:**
   - src/components/ui/dropdown-menu.tsx exists
   - src/components/ui/avatar.tsx exists

2. **TypeScript compiles:**
   - `npx tsc --noEmit` exits with 0

3. **Route protection works:**
   - Unauthenticated: / redirects to /login
   - Unauthenticated: /login renders login form
   - Authenticated: /login redirects to /
   - Authenticated: / renders dashboard with user menu

4. **Login flow works (requires SQL migration from 02-01):**
   - Valid credentials for approved user -> redirects to dashboard
   - Valid credentials for banned user -> shows "pending approval" error
   - Invalid credentials -> shows error message

5. **Logout flow works:**
   - Click user avatar -> dropdown appears
   - Click logout -> redirects to /login
   - Session is cleared (/ now redirects to /login)

6. **Session persistence:**
   - Login and refresh page -> still authenticated
   - Login, close browser, reopen -> still authenticated (within session timeout)
</verification>

<success_criteria>
- User can log in with email/password (after SQL migration and admin approval)
- Banned users see clear "pending approval" message
- Session persists across page refresh and navigation
- User can log out from dropdown menu in header
- Protected routes redirect to /login when unauthenticated
- Auth routes redirect to / when authenticated
- AUTH-04, AUTH-05, AUTH-06 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-02-SUMMARY.md`
</output>
