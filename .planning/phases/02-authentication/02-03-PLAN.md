---
phase: 02-authentication
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/app/(auth)/reset-password/page.tsx
  - src/app/(auth)/reset-password/actions.ts
  - src/app/(auth)/update-password/page.tsx
  - src/app/(auth)/update-password/actions.ts
  - src/app/auth/confirm/route.ts
  - src/lib/auth/utils.ts
  - src/app/(dashboard)/admin/users/page.tsx
  - src/app/(dashboard)/admin/users/actions.ts
  - src/app/(dashboard)/admin/layout.tsx
  - src/components/layout/app-sidebar.tsx
autonomous: true
user_setup:
  - service: supabase
    why: "Email template configuration for password reset"
    dashboard_config:
      - task: "Update password reset email template"
        location: "Supabase Dashboard -> Authentication -> Email Templates -> Reset Password"
        details: "Replace {{ .ConfirmationURL }} with {{ .SiteURL }}/auth/confirm?token_hash={{ .TokenHash }}&type=recovery&next=/update-password"
    env_vars:
      - name: NEXT_PUBLIC_SITE_URL
        source: "Your app URL (e.g., http://localhost:3000 for dev, https://yourapp.com for prod)"

must_haves:
  truths:
    - "User can request password reset at /reset-password"
    - "User receives email with reset link"
    - "User can set new password at /update-password after clicking email link"
    - "Admin users can view list of pending users at /admin/users"
    - "Admin can approve a pending user (removes ban)"
    - "Admin can reject a pending user (deletes account)"
    - "Non-admin users cannot access /admin routes"
    - "Admin link appears in sidebar only for admin users"
  artifacts:
    - path: "src/app/(auth)/reset-password/page.tsx"
      provides: "Password reset request form"
      min_lines: 40
    - path: "src/app/(auth)/reset-password/actions.ts"
      provides: "Password reset request action"
      exports: ["requestPasswordReset"]
    - path: "src/app/(auth)/update-password/page.tsx"
      provides: "New password form for reset flow"
      min_lines: 50
    - path: "src/app/(auth)/update-password/actions.ts"
      provides: "Password update action"
      exports: ["updatePassword"]
    - path: "src/app/auth/confirm/route.ts"
      provides: "Email confirmation callback handler"
      exports: ["GET"]
    - path: "src/lib/auth/utils.ts"
      provides: "Auth helper functions"
      exports: ["getUserRole", "requireAdmin"]
    - path: "src/app/(dashboard)/admin/users/page.tsx"
      provides: "Admin user management page"
      min_lines: 80
    - path: "src/app/(dashboard)/admin/users/actions.ts"
      provides: "Admin user actions"
      exports: ["approveUser", "rejectUser"]
    - path: "src/app/(dashboard)/admin/layout.tsx"
      provides: "Admin route protection"
      contains: "requireAdmin"
  key_links:
    - from: "src/app/(auth)/reset-password/actions.ts"
      to: "supabase.auth.resetPasswordForEmail"
      via: "Supabase password reset API"
      pattern: "resetPasswordForEmail"
    - from: "src/app/auth/confirm/route.ts"
      to: "supabase.auth.verifyOtp"
      via: "Token verification"
      pattern: "verifyOtp"
    - from: "src/app/(dashboard)/admin/layout.tsx"
      to: "src/lib/auth/utils.ts"
      via: "requireAdmin() check"
      pattern: "requireAdmin\\(\\)"
    - from: "src/app/(dashboard)/admin/users/actions.ts"
      to: "src/lib/supabase/admin.ts"
      via: "Admin client for user management"
      pattern: "createAdminClient\\(\\)"
---

<objective>
Implement password reset flow, RBAC utilities, and admin interface for user approval.

Purpose: Enables users to reset forgotten passwords and provides admin users with the ability to approve/reject pending registrations. This satisfies AUTH-03 (admin can approve/reject), AUTH-07 (password reset via email), AUTH-08 (user and admin roles), and AUTH-09 (permissions at profile level).

Output:
- Password reset request and update forms
- Email confirmation callback route
- Auth utility functions for role checking
- Admin user management page with approve/reject actions
- Admin route layout with protection
- Updated sidebar with admin link for admin users
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-RESEARCH.md

# Created in 02-01 and 02-02
@src/lib/supabase/admin.ts
@src/lib/supabase/server.ts
@src/lib/auth/validation.ts
@src/app/(auth)/layout.tsx
@src/app/(auth)/login/actions.ts
@src/middleware.ts

# Existing files to update
@src/components/layout/app-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth utilities and email confirmation route</name>
  <files>
    - src/lib/auth/utils.ts
    - src/app/auth/confirm/route.ts
  </files>
  <action>
Create auth utilities at `src/lib/auth/utils.ts`:

```typescript
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'

export type UserRole = 'user' | 'admin'

/**
 * Get the current user's role from JWT claims
 * Returns null if not authenticated
 */
export async function getUserRole(): Promise<UserRole | null> {
  const supabase = await createClient()
  const { data: { session } } = await supabase.auth.getSession()

  if (!session?.access_token) {
    return null
  }

  try {
    // Decode JWT payload (middle part, base64)
    const payload = JSON.parse(
      Buffer.from(session.access_token.split('.')[1], 'base64').toString()
    )
    return payload.user_role || 'user'
  } catch {
    return null
  }
}

/**
 * Require admin role, redirect to unauthorized if not admin
 * Use in server components/actions that need admin access
 */
export async function requireAdmin(): Promise<void> {
  const role = await getUserRole()
  if (role !== 'admin') {
    redirect('/unauthorized')
  }
}

/**
 * Check if current user is admin (non-redirecting version)
 */
export async function isAdmin(): Promise<boolean> {
  const role = await getUserRole()
  return role === 'admin'
}
```

Create email confirmation route at `src/app/auth/confirm/route.ts`:

```typescript
import { type NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url)
  const token_hash = searchParams.get('token_hash')
  const type = searchParams.get('type')
  const next = searchParams.get('next') ?? '/'

  if (token_hash && type) {
    const supabase = await createClient()

    const { error } = await supabase.auth.verifyOtp({
      type: type as any,
      token_hash,
    })

    if (!error) {
      // Redirect to the next URL after successful verification
      return NextResponse.redirect(new URL(next, request.url))
    }
  }

  // Redirect to error page or login with error message
  return NextResponse.redirect(
    new URL('/login?message=Invalid or expired link', request.url)
  )
}
```

Also create unauthorized page at `src/app/unauthorized/page.tsx`:
- Simple page with "Access Denied" message
- Link back to dashboard
- No special layout needed (uses root layout)
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- src/lib/auth/utils.ts exports getUserRole, requireAdmin, isAdmin
- src/app/auth/confirm/route.ts exports GET handler
  </verify>
  <done>
Auth utilities provide role checking functions, email confirmation route handles token verification and redirects appropriately
  </done>
</task>

<task type="auto">
  <name>Task 2: Create password reset flow</name>
  <files>
    - src/app/(auth)/reset-password/page.tsx
    - src/app/(auth)/reset-password/actions.ts
    - src/app/(auth)/update-password/page.tsx
    - src/app/(auth)/update-password/actions.ts
  </files>
  <action>
Create password reset request page at `src/app/(auth)/reset-password/page.tsx`:
- Client component with useActionState
- Form with single email field
- Use Card layout consistent with login/register
- Show success message when email is sent
- Link back to login

Create reset request action at `src/app/(auth)/reset-password/actions.ts`:

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { resetPasswordSchema } from '@/lib/auth/validation'

export async function requestPasswordReset(
  prevState: any,
  formData: FormData
) {
  const supabase = await createClient()

  const validated = resetPasswordSchema.safeParse({
    email: formData.get('email'),
  })

  if (!validated.success) {
    return { error: 'Invalid email address' }
  }

  const { email } = validated.data

  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: `${process.env.NEXT_PUBLIC_SITE_URL}/auth/confirm?type=recovery&next=/update-password`,
  })

  if (error) {
    return { error: error.message }
  }

  return { success: 'Password reset email sent. Check your inbox.' }
}
```

Create update password page at `src/app/(auth)/update-password/page.tsx`:
- Client component with useActionState
- Form with password and confirmPassword fields
- Must be accessed via email link (session established by auth/confirm route)
- Show error if passwords don't match (client-side validation too)
- Redirect to login on success

Create update password action at `src/app/(auth)/update-password/actions.ts`:

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { updatePasswordSchema } from '@/lib/auth/validation'
import { redirect } from 'next/navigation'

export async function updatePassword(
  prevState: any,
  formData: FormData
) {
  const supabase = await createClient()

  const validated = updatePasswordSchema.safeParse({
    password: formData.get('password'),
    confirmPassword: formData.get('confirmPassword'),
  })

  if (!validated.success) {
    const errors = validated.error.errors.map(e => e.message).join(', ')
    return { error: errors }
  }

  const { password } = validated.data

  const { error } = await supabase.auth.updateUser({
    password,
  })

  if (error) {
    return { error: error.message }
  }

  redirect('/login?message=Password updated successfully. Please log in.')
}
```

IMPORTANT: The password reset flow works as follows:
1. User submits email at /reset-password
2. Supabase sends email with link to /auth/confirm?token_hash=X&type=recovery&next=/update-password
3. /auth/confirm verifies token and establishes session, redirects to /update-password
4. User enters new password at /update-password
5. updateUser() updates password, redirects to login
  </action>
  <verify>
- Navigate to http://localhost:3000/reset-password - form renders
- Navigate to http://localhost:3000/update-password - form renders
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Password reset request form sends email via Supabase, update password form allows setting new password after email verification
  </done>
</task>

<task type="auto">
  <name>Task 3: Create admin user management page</name>
  <files>
    - src/app/(dashboard)/admin/layout.tsx
    - src/app/(dashboard)/admin/users/page.tsx
    - src/app/(dashboard)/admin/users/actions.ts
    - src/components/layout/app-sidebar.tsx
  </files>
  <action>
First, add badge component: `npx shadcn@latest add badge`

Create admin layout at `src/app/(dashboard)/admin/layout.tsx`:

```typescript
import { requireAdmin } from '@/lib/auth/utils'

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode
}) {
  // This will redirect to /unauthorized if not admin
  await requireAdmin()

  return <>{children}</>
}
```

Create admin users page at `src/app/(dashboard)/admin/users/page.tsx`:
- Server component
- Import createAdminClient from @/lib/supabase/admin
- Fetch all users with admin.auth.admin.listUsers()
- Separate into pendingUsers (user.banned_until is truthy) and approvedUsers
- Use Table component from shadcn (add: `npx shadcn@latest add table`)
- Show pending users section at top:
  - Email, created date, Approve/Reject buttons
  - Use Badge component to show "Pending" status
- Show approved users section below:
  - Email, role (from profiles table), approved date
- Page title: "User Management"
- Use revalidatePath in actions to refresh data

Create admin actions at `src/app/(dashboard)/admin/users/actions.ts`:

```typescript
'use server'

import { createAdminClient } from '@/lib/supabase/admin'
import { createClient } from '@/lib/supabase/server'
import { requireAdmin } from '@/lib/auth/utils'
import { revalidatePath } from 'next/cache'

export async function approveUser(userId: string) {
  await requireAdmin() // Double-check admin status

  const admin = createAdminClient()

  // Remove ban
  const { error: banError } = await admin.auth.admin.updateUserById(userId, {
    ban_duration: 'none',
  })

  if (banError) {
    return { error: banError.message }
  }

  // Update profile approved_at timestamp
  const supabase = await createClient()
  await supabase
    .from('profiles')
    .update({ approved_at: new Date().toISOString() })
    .eq('id', userId)

  revalidatePath('/admin/users')
  return { success: true }
}

export async function rejectUser(userId: string) {
  await requireAdmin()

  const admin = createAdminClient()

  // Delete the user account
  const { error } = await admin.auth.admin.deleteUser(userId)

  if (error) {
    return { error: error.message }
  }

  revalidatePath('/admin/users')
  return { success: true }
}
```

Update sidebar at `src/components/layout/app-sidebar.tsx`:
- Convert to async server component
- Import isAdmin from @/lib/auth/utils
- Check if user is admin
- Add Admin section with Users link if isAdmin is true
- Use Shield icon for admin section

```typescript
// Add to navItems conditionally
const adminItems = [
  { title: 'Users', url: '/admin/users', icon: Users },
]

// In component, check role and render admin section
const userIsAdmin = await isAdmin()

// Then in JSX, add admin nav group if userIsAdmin
{userIsAdmin && (
  <SidebarGroup>
    <SidebarGroupLabel>Admin</SidebarGroupLabel>
    <SidebarGroupContent>
      <SidebarMenu>
        {adminItems.map((item) => (
          // ... same pattern as main nav
        ))}
      </SidebarMenu>
    </SidebarGroupContent>
  </SidebarGroup>
)}
```
  </action>
  <verify>
- Badge component exists: src/components/ui/badge.tsx
- Table component exists: src/components/ui/table.tsx
- Navigate to http://localhost:3000/admin/users as admin - page renders
- Navigate to /admin/users as non-admin - redirects to /unauthorized
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Admin can view pending and approved users, approve (unban) or reject (delete) pending users, sidebar shows admin section only to admin users
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Components installed:**
   - src/components/ui/badge.tsx exists
   - src/components/ui/table.tsx exists

2. **TypeScript compiles:**
   - `npx tsc --noEmit` exits with 0

3. **Password reset flow (requires email template config):**
   - /reset-password shows email form
   - Submitting email shows success message
   - Email contains link to /auth/confirm
   - Clicking link redirects to /update-password with session
   - Submitting new password updates it and redirects to login

4. **Admin protection:**
   - Non-admin visiting /admin/users redirects to /unauthorized
   - /unauthorized page renders with access denied message

5. **Admin user management (requires SQL migration, admin user in profiles):**
   - Admin can view pending users (banned)
   - Admin can view approved users
   - Clicking Approve removes ban, updates approved_at
   - Clicking Reject deletes user

6. **Sidebar role-based:**
   - Admin users see Admin section with Users link
   - Regular users don't see Admin section
</verification>

<success_criteria>
- User can request password reset and receive email
- User can set new password via email link
- Admin users can access /admin/users
- Admin can approve pending users (removes ban)
- Admin can reject pending users (deletes account)
- Non-admin users cannot access admin routes
- Sidebar shows admin section only to admin users
- AUTH-03, AUTH-07, AUTH-08, AUTH-09 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-03-SUMMARY.md`
</output>
