---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase/admin.ts
  - src/lib/auth/validation.ts
  - src/app/(auth)/register/page.tsx
  - src/app/(auth)/register/actions.ts
  - src/app/(auth)/layout.tsx
autonomous: true
user_setup:
  - service: supabase
    why: "Database schema setup and Auth Hooks configuration"
    dashboard_config:
      - task: "Run SQL migrations for profiles table and Custom Access Token Hook"
        location: "Supabase Dashboard -> SQL Editor"
      - task: "Enable Custom Access Token Hook"
        location: "Supabase Dashboard -> Authentication -> Hooks -> customAccessTokenHook"
      - task: "Disable email confirmation for simpler approval flow"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email -> Confirm email OFF"
    env_vars:
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role (secret)"

must_haves:
  truths:
    - "User can access registration form at /register"
    - "User can submit registration with email and password"
    - "New account is created in Supabase auth.users table"
    - "New account is auto-banned (pending admin approval)"
    - "Profile row is created in profiles table with 'user' role"
    - "User sees success message indicating account is pending approval"
  artifacts:
    - path: "src/lib/supabase/admin.ts"
      provides: "Admin Supabase client with service_role key"
      exports: ["createAdminClient"]
    - path: "src/lib/auth/validation.ts"
      provides: "Zod schemas for auth form validation"
      exports: ["loginSchema", "signupSchema"]
    - path: "src/app/(auth)/register/page.tsx"
      provides: "Registration form UI"
      min_lines: 50
    - path: "src/app/(auth)/register/actions.ts"
      provides: "Registration server action with auto-ban"
      exports: ["signup"]
    - path: "src/app/(auth)/layout.tsx"
      provides: "Auth route group layout (public, centered)"
      min_lines: 15
  key_links:
    - from: "src/app/(auth)/register/page.tsx"
      to: "src/app/(auth)/register/actions.ts"
      via: "form action={signup}"
      pattern: "action=\\{.*signup"
    - from: "src/app/(auth)/register/actions.ts"
      to: "src/lib/supabase/admin.ts"
      via: "createAdminClient() for ban"
      pattern: "createAdminClient\\(\\)"
    - from: "src/app/(auth)/register/actions.ts"
      to: "src/lib/auth/validation.ts"
      via: "signupSchema.safeParse"
      pattern: "signupSchema\\.safeParse"
---

<objective>
Set up Supabase Auth infrastructure and implement user registration with automatic account disabling for manual approval workflow.

Purpose: Establishes the authentication foundation. New users can register but cannot log in until an admin approves their account. This satisfies AUTH-01 (user can register with email/password) and AUTH-02 (account created in disabled state).

Output:
- Admin Supabase client for service_role operations
- Zod validation schemas for auth forms
- Registration form with server action
- Auth route group layout
- SQL migration file for profiles table and Custom Access Token Hook
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-RESEARCH.md

# Existing files from Phase 1
@src/lib/supabase/server.ts
@src/lib/supabase/client.ts
@src/middleware.ts
@src/components/ui/button.tsx
@src/components/ui/input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create admin client</name>
  <files>
    - package.json
    - src/lib/supabase/admin.ts
    - src/lib/auth/validation.ts
  </files>
  <action>
Install zod for form validation (react-hook-form and @hookform/resolvers are optional - use native form with useActionState for simpler implementation):

```bash
npm install zod
```

Create admin client at `src/lib/supabase/admin.ts`:
- Import createClient from @supabase/supabase-js (not @supabase/ssr - admin client doesn't need cookie handling)
- Use NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY (no NEXT_PUBLIC_ prefix for service role - server only)
- Set auth options: autoRefreshToken: false, persistSession: false
- Export createAdminClient function

Create validation schemas at `src/lib/auth/validation.ts`:
- loginSchema: email (string().email()), password (string().min(6))
- signupSchema: email (string().email()), password (string().min(8) with uppercase, lowercase, number requirements), confirmPassword (refine to match password)
- resetPasswordSchema: email only
- updatePasswordSchema: password with requirements, confirmPassword with refine
  </action>
  <verify>
- `npm ls zod` shows zod installed
- TypeScript compiles: `npx tsc --noEmit`
- Admin client exports createAdminClient function
- Validation schemas export loginSchema, signupSchema, resetPasswordSchema, updatePasswordSchema
  </verify>
  <done>
Dependencies installed, admin client ready for service_role operations, validation schemas ready for form validation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth route group layout and registration page</name>
  <files>
    - src/app/(auth)/layout.tsx
    - src/app/(auth)/register/page.tsx
    - src/app/(auth)/register/actions.ts
  </files>
  <action>
Create auth route group layout at `src/app/(auth)/layout.tsx`:
- Simple centered layout without sidebar
- Full height (min-h-screen), flex container, items-center justify-center
- Light background (bg-background)
- This layout applies to /login, /register, /reset-password, /update-password

Create registration page at `src/app/(auth)/register/page.tsx`:
- Client component ('use client') to use useActionState
- Import useActionState from 'react', useSearchParams from 'next/navigation'
- Use shadcn Card, CardHeader, CardTitle, CardDescription, CardContent components (add card component first: `npx shadcn@latest add card`)
- Form fields: email (Input type="email"), password (Input type="password"), confirmPassword (Input type="password")
- Submit button with pending state (disabled when pending, shows "Creating account...")
- Display error messages from state.error
- Link to /login at bottom
- Display success message from searchParams.get('message') if present

Create registration server action at `src/app/(auth)/register/actions.ts`:
- 'use server' directive
- Import createClient from @/lib/supabase/server
- Import createAdminClient from @/lib/supabase/admin
- Import signupSchema from @/lib/auth/validation
- Import redirect from next/navigation

signup function (prevState, formData):
1. Validate with signupSchema.safeParse
2. If invalid, return { error: formatted error message }
3. Create user with supabase.auth.signUp({ email, password })
4. If error or no user, return { error: error.message }
5. Immediately ban user using admin client: admin.auth.admin.updateUserById(user.id, { ban_duration: '876000h' })
6. redirect('/login?message=Account created. Pending admin approval.')

IMPORTANT: The function signature must be (prevState: any, formData: FormData) for useActionState compatibility.
  </action>
  <verify>
- Card component installed: check src/components/ui/card.tsx exists
- Navigate to http://localhost:3000/register - form renders
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Auth layout provides centered public pages, registration form captures email/password, server action creates user and auto-bans pending approval
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SQL migration file for profiles table and Auth Hook</name>
  <files>
    - supabase/migrations/20260121_profiles_and_auth_hook.sql
  </files>
  <action>
Create directory `supabase/migrations/` if it doesn't exist.

Create SQL migration file at `supabase/migrations/20260121_profiles_and_auth_hook.sql`:

```sql
-- Phase 2: Authentication - Profiles table and Custom Access Token Hook
-- Run this in Supabase SQL Editor (Dashboard -> SQL Editor -> New query)

-- Step 1: Create user_role enum type
CREATE TYPE user_role AS ENUM ('user', 'admin');

-- Step 2: Create profiles table
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  role user_role NOT NULL DEFAULT 'user',
  approved_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Step 3: Enable Row Level Security
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Step 4: Create RLS policies
-- Users can read their own profile
CREATE POLICY "Users can read own profile"
  ON public.profiles
  FOR SELECT
  TO authenticated
  USING (auth.uid() = id);

-- Admins can read all profiles
CREATE POLICY "Admins can read all profiles"
  ON public.profiles
  FOR SELECT
  TO authenticated
  USING (
    (SELECT role FROM public.profiles WHERE id = auth.uid()) = 'admin'
  );

-- Admins can update any profile
CREATE POLICY "Admins can update any profile"
  ON public.profiles
  FOR UPDATE
  TO authenticated
  USING (
    (SELECT role FROM public.profiles WHERE id = auth.uid()) = 'admin'
  );

-- Step 5: Create trigger to auto-create profile on user signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, role)
  VALUES (NEW.id, NEW.email, 'user');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();

-- Step 6: Create Custom Access Token Hook function
-- This injects the user role into JWT claims
CREATE OR REPLACE FUNCTION public.custom_access_token_hook(event JSONB)
RETURNS JSONB
LANGUAGE plpgsql
STABLE
AS $$
DECLARE
  claims JSONB;
  user_role_value user_role;
BEGIN
  -- Fetch user role from profiles table
  SELECT role INTO user_role_value
  FROM public.profiles
  WHERE id = (event->>'user_id')::UUID;

  -- Get existing claims
  claims := event->'claims';

  -- Add user_role to claims
  IF user_role_value IS NOT NULL THEN
    claims := jsonb_set(claims, '{user_role}', to_jsonb(user_role_value));
  ELSE
    claims := jsonb_set(claims, '{user_role}', 'null');
  END IF;

  -- Update the claims in the event
  event := jsonb_set(event, '{claims}', claims);

  RETURN event;
END;
$$;

-- Step 7: Grant execute permission to supabase_auth_admin
GRANT EXECUTE ON FUNCTION public.custom_access_token_hook TO supabase_auth_admin;

-- Revoke from public and authenticated (security)
REVOKE EXECUTE ON FUNCTION public.custom_access_token_hook FROM PUBLIC;
REVOKE EXECUTE ON FUNCTION public.custom_access_token_hook FROM authenticated;

-- Step 8: Create updated_at trigger for profiles
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_profiles_updated_at
  BEFORE UPDATE ON public.profiles
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at_column();
```

Add instructions comment at the top of the file explaining:
1. Copy this SQL and run in Supabase Dashboard -> SQL Editor
2. After running, enable the hook: Dashboard -> Authentication -> Hooks -> Select custom_access_token_hook
3. Disable email confirmation: Dashboard -> Authentication -> Providers -> Email -> Toggle off "Confirm email"

Note: This SQL file is for reference and manual execution. Supabase migrations via CLI would require `supabase init` and `supabase db push` which adds complexity. For v1, manual SQL execution is simpler.
  </action>
  <verify>
- File exists at supabase/migrations/20260121_profiles_and_auth_hook.sql
- SQL syntax is valid (no obvious errors)
- Instructions are clear for manual execution
  </verify>
  <done>
SQL migration ready for manual execution in Supabase Dashboard, creates profiles table, RLS policies, user creation trigger, and Custom Access Token Hook for RBAC
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Dependencies installed:**
   - `npm ls zod` shows zod in dependency tree

2. **TypeScript compiles:**
   - `npx tsc --noEmit` exits with 0

3. **Files created:**
   - src/lib/supabase/admin.ts exports createAdminClient
   - src/lib/auth/validation.ts exports schemas
   - src/app/(auth)/layout.tsx provides centered layout
   - src/app/(auth)/register/page.tsx renders form
   - src/app/(auth)/register/actions.ts exports signup
   - supabase/migrations/20260121_profiles_and_auth_hook.sql contains valid SQL

4. **Dev server runs:**
   - `npm run dev` starts without errors
   - http://localhost:3000/register shows registration form
</verification>

<success_criteria>
- User can navigate to /register and see registration form
- Form validates email format and password requirements
- Form submission creates user in Supabase (requires env vars and SQL migration)
- Created user is auto-banned (requires service role key)
- SQL migration file ready for dashboard execution
- AUTH-01 and AUTH-02 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
