---
phase: 06-processing-status
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/progress.tsx
  - src/app/(dashboard)/rfps/components/rfp-processing-card.tsx
  - src/app/(dashboard)/rfps/components/rfp-jobs-list.tsx
  - src/app/(dashboard)/rfps/page.tsx
  - src/hooks/use-rfp-upload-status.ts
  - src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "User sees prominent status card when RFP is being processed"
    - "Progress indicator shows estimated time during 3-5 minute wait"
    - "Toast notification appears when processing completes or fails"
    - "Status updates arrive in real-time without page refresh"
    - "User can navigate away and return to see current status"
    - "Jobs list updates automatically when status changes"
  artifacts:
    - path: "src/components/ui/progress.tsx"
      provides: "shadcn/ui Progress component"
      contains: "ProgressPrimitive.Root"
    - path: "src/app/(dashboard)/rfps/components/rfp-processing-card.tsx"
      provides: "Prominent processing status display"
      exports: ["RFPProcessingCard"]
    - path: "src/app/(dashboard)/rfps/components/rfp-jobs-list.tsx"
      provides: "Real-time updating jobs list"
      contains: "useRFPUploadStatus"
  key_links:
    - from: "src/app/(dashboard)/rfps/page.tsx"
      to: "RFPProcessingCard"
      via: "component import and render"
      pattern: "RFPProcessingCard"
    - from: "src/app/(dashboard)/rfps/components/rfp-jobs-list.tsx"
      to: "useRFPUploadStatus"
      via: "hook integration"
      pattern: "useRFPUploadStatus"
    - from: "src/hooks/use-rfp-upload-status.ts"
      to: "toast"
      via: "completion notifications"
      pattern: "toast.success.*action"
---

<objective>
Implement real-time processing status UI with progress indicators and enhanced toast notifications

Purpose: Users need clear visual feedback during the 3-5 minute RFP processing wait. This phase builds on existing Realtime infrastructure from Phase 5 to add prominent status display, progress indication, and actionable notifications.

Output: Enhanced /rfps page with processing status card, progress bar, real-time job list updates, and improved toast notifications with action buttons.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase research
@.planning/phases/06-processing-status/06-RESEARCH.md

# Existing infrastructure to leverage
@src/hooks/use-rfp-upload-status.ts
@src/app/(dashboard)/rfps/page.tsx
@src/app/(dashboard)/rfps/components/rfp-jobs-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Progress Component and Processing Status Card</name>
  <files>
    src/components/ui/progress.tsx
    src/app/(dashboard)/rfps/components/rfp-processing-card.tsx
    src/app/globals.css
  </files>
  <action>
1. Install shadcn/ui Progress component:
   ```bash
   npx shadcn@latest add progress
   ```

2. Add indeterminate animation keyframes to globals.css (after existing styles):
   ```css
   @keyframes indeterminate {
     0% { transform: translateX(-100%); }
     100% { transform: translateX(400%); }
   }
   ```

3. Create RFPProcessingCard component at `src/app/(dashboard)/rfps/components/rfp-processing-card.tsx`:
   - Import Card, CardContent, CardDescription, CardHeader, CardTitle from @/components/ui/card
   - Import Progress from @/components/ui/progress
   - Import useRFPUploadStatus, RFPUploadJob from @/hooks/use-rfp-upload-status
   - Import Loader2, Clock, FileText from lucide-react
   - Import formatDistanceToNow from date-fns

   Component logic:
   - Get `activeJob` and `isProcessing` from useRFPUploadStatus()
   - Use useState for elapsedTime (number)
   - Use useEffect with setInterval (1000ms) to update elapsedTime when isProcessing
   - ESTIMATED_TIME_MS = 4 * 60 * 1000 (4 minutes midpoint)
   - Calculate progressPercent = Math.min(95, (elapsedTime / ESTIMATED_TIME_MS) * 100)
   - For pending status, show indeterminate progress (value={undefined})
   - For processing status, show time-based progress with 95% cap

   Card styling:
   - Border: border-blue-200 bg-blue-50/50 (light blue accent)
   - Header: Loader2 spinning icon + "Processing RFP" title
   - Description changes based on status (pending vs processing)
   - Content shows: file_name, Progress bar, time started, "~3-5 minutes total" text
   - Footer text: "You can navigate away from this page. You'll receive a notification when processing completes."

   Return null if !isProcessing or !activeJob
  </action>
  <verify>
    - Run `npm run build` - no TypeScript errors
    - Run `npm run lint` - no lint errors
    - Verify progress.tsx exists in src/components/ui/
    - Verify rfp-processing-card.tsx exports RFPProcessingCard
  </verify>
  <done>
    - Progress component installed and available
    - RFPProcessingCard component created with time-based progress
    - Indeterminate animation keyframes added to globals.css
    - Component shows pending vs processing states correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Processing Card and Make Jobs List Real-time</name>
  <files>
    src/app/(dashboard)/rfps/page.tsx
    src/app/(dashboard)/rfps/components/rfp-jobs-list.tsx
  </files>
  <action>
1. Update RFPJobsList to be real-time updating:
   - Add useEffect that subscribes to activeJob changes from useRFPUploadStatus
   - Maintain local jobs state initialized from props
   - When activeJob changes, update the matching job in local state or prepend if new
   - Keep existing UI structure (Card with job items)

   Implementation:
   ```typescript
   interface RFPJobsListProps {
     initialJobs: RFPJob[]  // Rename from jobs to initialJobs
   }

   export function RFPJobsList({ initialJobs }: RFPJobsListProps) {
     const [jobs, setJobs] = useState(initialJobs)
     const { activeJob } = useRFPUploadStatus()

     useEffect(() => {
       if (activeJob) {
         setJobs(prev => {
           const index = prev.findIndex(j => j.id === activeJob.id)
           if (index >= 0) {
             // Update existing job
             const updated = [...prev]
             updated[index] = activeJob
             return updated
           }
           // New job - prepend
           return [activeJob, ...prev]
         })
       }
     }, [activeJob])

     // Rest of component unchanged...
   }
   ```

2. Update page.tsx to add RFPProcessingCard:
   - Import RFPProcessingCard from ./components/rfp-processing-card
   - Add <RFPProcessingCard /> between header section and RFPJobsList
   - Update RFPJobsList prop from `jobs` to `initialJobs`

   Page structure:
   ```tsx
   <div className="flex flex-1 flex-col gap-6 p-4">
     {/* Header with title and upload button */}
     <div className="flex items-center justify-between">...</div>

     {/* NEW: Processing status card (shows only when active) */}
     <RFPProcessingCard />

     {/* Jobs list (prop renamed) */}
     <RFPJobsList initialJobs={jobs ?? []} />
   </div>
   ```
  </action>
  <verify>
    - Run `npm run build` - no TypeScript errors
    - Run `npm run lint` - no lint errors
    - Start dev server: `npm run dev`
    - Navigate to /rfps page - renders without error
    - Processing card shows only when there's an active job
  </verify>
  <done>
    - RFPJobsList updates in real-time when job status changes
    - RFPProcessingCard appears prominently when job is processing
    - Jobs list reflects status changes without page refresh
    - Page layout properly structures processing card above jobs list
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance Toast Notifications with Actions</name>
  <files>
    src/hooks/use-rfp-upload-status.ts
  </files>
  <action>
1. Enhance the existing useRFPUploadStatus hook toast notifications:

   For 'processing' status change:
   - Use toast.loading instead of toast.info
   - Add duration: Infinity to persist until status changes
   - Description: "Analyzing {file_name}... This may take 3-5 minutes."

   For 'completed' status change:
   - Use toast.success with longer duration (10000ms)
   - Add action button: { label: 'View Results', onClick: () => router.push(`/rfps/${job.id}/matches`) }
   - Description: "{file_name} processed successfully. X items matched."
   - Note: Since router not available in hook, use window.location.href as fallback

   For 'failed' status change:
   - Keep toast.error but extend duration to 15000ms
   - Description should include error_message if available
   - Add "Try Again" text suggestion in description

   Updated handleJobUpdate callback:
   ```typescript
   const handleJobUpdate = useCallback((payload: { new: RFPUploadJob; old: RFPUploadJob }) => {
     const newJob = payload.new
     const oldJob = payload.old

     // Update local state
     if (newJob.status === 'pending' || newJob.status === 'processing') {
       setActiveJob(newJob)
     } else {
       setActiveJob(null)
     }

     // Enhanced toast notifications for status changes
     if (oldJob.status !== newJob.status) {
       switch (newJob.status) {
         case 'processing':
           toast.loading('Processing RFP', {
             id: `rfp-job-${newJob.id}`,
             description: `Analyzing ${newJob.file_name}... This may take 3-5 minutes.`,
             duration: Infinity,
           })
           break
         case 'completed':
           toast.success('RFP processed successfully', {
             id: `rfp-job-${newJob.id}`,
             description: `${newJob.file_name} is ready for review.`,
             duration: 10000,
             action: {
               label: 'View Results',
               onClick: () => {
                 window.location.href = `/rfps/${newJob.id}/matches`
               },
             },
           })
           break
         case 'failed':
           toast.error('RFP processing failed', {
             id: `rfp-job-${newJob.id}`,
             description: newJob.error_message
               ? `${newJob.error_message}. Please try uploading again.`
               : `Failed to process ${newJob.file_name}. Please try uploading again.`,
             duration: 15000,
           })
           break
       }
     }
   }, [])
   ```

2. Also update handleJobInsert to show initial toast for new jobs:
   ```typescript
   const handleJobInsert = useCallback((payload: { new: RFPUploadJob }) => {
     const newJob = payload.new
     if (newJob.status === 'pending' || newJob.status === 'processing') {
       setActiveJob(newJob)
       // Show initial upload confirmation toast
       toast.loading('Upload received', {
         id: `rfp-job-${newJob.id}`,
         description: `${newJob.file_name} queued for processing...`,
         duration: 5000, // Will be replaced by processing toast
       })
     }
   }, [])
   ```
  </action>
  <verify>
    - Run `npm run build` - no TypeScript errors
    - Run `npm run lint` - no lint errors
    - Toast types verified: toast.loading, toast.success, toast.error all from sonner
    - Action button onClick handler properly typed
  </verify>
  <done>
    - Processing toast persists with duration: Infinity until completion
    - Completion toast shows for 10 seconds with "View Results" action button
    - Error toast shows for 15 seconds with helpful retry message
    - Initial upload confirmation toast displays when job is created
    - Toast IDs prevent duplicate notifications per job
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify Phase 6 requirements:

1. **RFP-03: Processing status displays in UI**
   - Navigate to /rfps with an active processing job
   - RFPProcessingCard should be visible with current status

2. **RFP-04: Progress indicator during wait**
   - Card shows Progress component
   - Pending state shows indeterminate animation
   - Processing state shows time-based progress capped at 95%

3. **RFP-05: Toast notification on completion**
   - When job completes, toast.success appears with action button
   - When job fails, toast.error appears with error details

4. **UI-04: Status updates via Realtime**
   - Jobs list updates without page refresh
   - Processing card appears/disappears based on active job
   - All changes happen in real-time

5. **UI-05: Navigation persistence**
   - Navigate away from /rfps during processing
   - Return to /rfps - processing card still shows current state
   - Toast notification appears even if on different page

Run verification:
```bash
npm run build
npm run lint
npm run dev
```

Test manually:
1. Upload an RFP PDF
2. Observe processing card appears immediately
3. Progress bar animates
4. Navigate to /inventory and back to /rfps
5. Processing card still shows correct state
6. Wait for completion (or simulate via Supabase Dashboard update)
7. Toast appears with "View Results" button
</verification>

<success_criteria>
- [ ] Progress component installed from shadcn/ui
- [ ] RFPProcessingCard displays during pending/processing states
- [ ] Progress bar shows time-based progress capped at 95%
- [ ] Jobs list updates in real-time via useRFPUploadStatus hook
- [ ] Processing toast uses duration: Infinity
- [ ] Completion toast shows for 10 seconds with action button
- [ ] Error toast shows for 15 seconds with retry guidance
- [ ] No TypeScript or lint errors
- [ ] User can navigate away and return without losing status
</success_criteria>

<output>
After completion, create `.planning/phases/06-processing-status/06-01-SUMMARY.md`
</output>
