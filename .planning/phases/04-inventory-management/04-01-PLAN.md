---
phase: 04-inventory-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/csv/parser.ts
  - src/lib/csv/validation.ts
  - src/app/(dashboard)/inventory/components/csv-dropzone.tsx
  - src/app/(dashboard)/inventory/components/csv-preview.tsx
  - src/app/(dashboard)/inventory/components/csv-upload-dialog.tsx
  - src/app/(dashboard)/inventory/components/csv-upload-button.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag-and-drop a CSV file into the upload area"
    - "User can click to select a CSV file via file picker"
    - "CSV is parsed client-side and validation errors are shown before upload"
    - "User sees row count and validation status before confirming upload"
    - "Invalid CSV files show specific error messages per row/field"
  artifacts:
    - path: "src/lib/csv/parser.ts"
      provides: "Papa Parse wrapper with type-safe CSV parsing"
      exports: ["parseCSVFile", "ParseResult"]
    - path: "src/lib/csv/validation.ts"
      provides: "Zod schemas and validation functions for CSV data"
      exports: ["inventoryRowSchema", "validateCSVData", "ValidationResult"]
    - path: "src/app/(dashboard)/inventory/components/csv-dropzone.tsx"
      provides: "Drag-and-drop file input with react-dropzone"
      exports: ["CSVDropzone"]
    - path: "src/app/(dashboard)/inventory/components/csv-upload-dialog.tsx"
      provides: "Modal dialog orchestrating upload flow"
      exports: ["CSVUploadDialog"]
  key_links:
    - from: "csv-upload-dialog.tsx"
      to: "src/lib/csv/parser.ts"
      via: "parseCSVFile import"
      pattern: "import.*parseCSVFile.*from.*lib/csv/parser"
    - from: "csv-upload-dialog.tsx"
      to: "src/lib/csv/validation.ts"
      via: "validateCSVData import"
      pattern: "import.*validateCSVData.*from.*lib/csv/validation"
---

<objective>
Create CSV upload component with client-side parsing and validation

Purpose: Enable users to upload inventory data via CSV with immediate validation feedback before triggering the backend workflow.

Output: Reusable CSV dropzone component, validation utilities, and upload dialog that can be integrated into the inventory page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-inventory-management/04-RESEARCH.md
@src/app/(dashboard)/inventory/page.tsx
@src/app/(dashboard)/inventory/components/inventory-table.tsx
@src/lib/supabase/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install CSV dependencies</name>
  <files>package.json</files>
  <action>
Install react-dropzone and papaparse for CSV upload and parsing:

```bash
npm install react-dropzone papaparse
npm install -D @types/papaparse
```

Note: If React 19 peer dependency warning appears, use `--legacy-peer-deps` flag. react-dropzone works fine with React 19, just hasn't updated peer deps yet.

Verify packages are added to package.json dependencies.
  </action>
  <verify>
Run `npm ls react-dropzone papaparse` to confirm packages installed.
Check package.json contains react-dropzone and papaparse in dependencies.
  </verify>
  <done>
react-dropzone and papaparse are in package.json dependencies.
@types/papaparse is in devDependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CSV parser and validation utilities</name>
  <files>
    src/lib/csv/parser.ts
    src/lib/csv/validation.ts
  </files>
  <action>
Create `src/lib/csv/` directory with two utility files.

**parser.ts** - Papa Parse wrapper with type safety:
```typescript
import Papa from 'papaparse'

export interface ParseResult {
  data: Record<string, unknown>[]
  errors: Papa.ParseError[]
  meta: Papa.ParseMeta
}

export function parseCSVFile(file: File): Promise<ParseResult> {
  return new Promise((resolve) => {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: 'greedy',
      dynamicTyping: true,
      transformHeader: (header) => header.trim().toLowerCase(),
      encoding: 'UTF-8',
      complete: (results) => {
        // Check for encoding issues (replacement characters)
        const hasEncodingIssues = JSON.stringify(results.data).includes('\uFFFD')
        if (hasEncodingIssues) {
          // Retry with different encoding for Portuguese characters
          Papa.parse(file, {
            header: true,
            skipEmptyLines: 'greedy',
            dynamicTyping: true,
            transformHeader: (header) => header.trim().toLowerCase(),
            encoding: 'ISO-8859-1',
            complete: (retryResults) => {
              resolve({
                data: retryResults.data as Record<string, unknown>[],
                errors: retryResults.errors,
                meta: retryResults.meta,
              })
            },
          })
          return
        }
        resolve({
          data: results.data as Record<string, unknown>[],
          errors: results.errors,
          meta: results.meta,
        })
      },
      error: (error) => {
        resolve({
          data: [],
          errors: [error],
          meta: {} as Papa.ParseMeta,
        })
      },
    })
  })
}
```

**validation.ts** - Zod schemas for inventory CSV validation:
```typescript
import { z } from 'zod'

// Inventory row schema - adapt field names to match artigos table
// Using flexible schema since column structure is dynamic
export const inventoryRowSchema = z.object({
  codigo: z.string().min(1, 'Code is required').optional(),
  nome: z.string().min(1, 'Name is required').optional(),
  // Accept both number and string for price/stock (CSV parsing may vary)
  preco: z.union([
    z.number().positive('Price must be positive'),
    z.string().transform((val) => {
      const num = parseFloat(val.replace(',', '.'))
      if (isNaN(num) || num < 0) return null
      return num
    }),
    z.null(),
  ]).optional(),
  stock: z.union([
    z.number().int().min(0, 'Stock cannot be negative'),
    z.string().transform((val) => {
      const num = parseInt(val, 10)
      if (isNaN(num) || num < 0) return null
      return num
    }),
    z.null(),
  ]).optional(),
}).passthrough() // Allow additional fields

export type InventoryRow = z.infer<typeof inventoryRowSchema>

export interface ValidationError {
  row: number
  field: string
  message: string
}

export interface ValidationWarning {
  row: number
  field: string
  message: string
}

export interface ValidationResult {
  valid: boolean
  errors: ValidationError[]
  warnings: ValidationWarning[]
  validRowCount: number
  totalRowCount: number
}

export function validateCSVData(
  data: Record<string, unknown>[]
): ValidationResult {
  const errors: ValidationError[] = []
  const warnings: ValidationWarning[] = []
  let validRowCount = 0

  // Check for empty file
  if (data.length === 0) {
    errors.push({ row: 0, field: 'file', message: 'CSV file is empty' })
    return { valid: false, errors, warnings, validRowCount: 0, totalRowCount: 0 }
  }

  // Check for headers
  const headers = Object.keys(data[0] || {})
  if (headers.length === 0) {
    errors.push({ row: 0, field: 'headers', message: 'No columns found in CSV' })
    return { valid: false, errors, warnings, validRowCount: 0, totalRowCount: 0 }
  }

  // Validate each row (basic validation - n8n does full processing)
  data.forEach((row, index) => {
    const rowNumber = index + 2 // +2: index 0 = row 2 (after header)

    // Check if row has any data
    const hasData = Object.values(row).some(
      (v) => v !== null && v !== undefined && v !== ''
    )

    if (!hasData) {
      warnings.push({
        row: rowNumber,
        field: 'row',
        message: 'Empty row detected',
      })
    } else {
      validRowCount++
    }
  })

  // Check for duplicate codes if 'codigo' column exists
  if (headers.includes('codigo')) {
    const codes = data.map((r) => r.codigo).filter(Boolean) as string[]
    const duplicates = findDuplicates(codes)
    duplicates.forEach((code) => {
      warnings.push({
        row: 0,
        field: 'codigo',
        message: `Duplicate code found: ${code}`,
      })
    })
  }

  return {
    valid: errors.length === 0,
    errors,
    warnings,
    validRowCount,
    totalRowCount: data.length,
  }
}

function findDuplicates(arr: string[]): string[] {
  const seen = new Set<string>()
  const duplicates = new Set<string>()

  arr.forEach((item) => {
    if (item && seen.has(item)) {
      duplicates.add(item)
    }
    seen.add(item)
  })

  return Array.from(duplicates)
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles without errors.
Check files exist at src/lib/csv/parser.ts and src/lib/csv/validation.ts.
  </verify>
  <done>
parser.ts exports parseCSVFile function with encoding fallback for Portuguese characters.
validation.ts exports validateCSVData with error/warning separation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CSV upload components</name>
  <files>
    src/app/(dashboard)/inventory/components/csv-dropzone.tsx
    src/app/(dashboard)/inventory/components/csv-preview.tsx
    src/app/(dashboard)/inventory/components/csv-upload-dialog.tsx
    src/app/(dashboard)/inventory/components/csv-upload-button.tsx
  </files>
  <action>
Create four components for the CSV upload flow.

**csv-dropzone.tsx** - Drag-and-drop file input:
```typescript
'use client'

import { useCallback } from 'react'
import { useDropzone, FileRejection } from 'react-dropzone'
import { Upload, FileSpreadsheet } from 'lucide-react'
import { cn } from '@/lib/utils'

interface CSVDropzoneProps {
  onFileSelect: (file: File) => void
  file: File | null
  disabled?: boolean
}

export function CSVDropzone({ onFileSelect, file, disabled }: CSVDropzoneProps) {
  const onDrop = useCallback(
    (acceptedFiles: File[], rejectedFiles: FileRejection[]) => {
      if (rejectedFiles.length > 0) {
        const rejection = rejectedFiles[0]
        const error = rejection.errors[0]
        // Could emit error via callback if needed
        console.error('File rejected:', error.code, error.message)
        return
      }

      if (acceptedFiles.length > 0) {
        onFileSelect(acceptedFiles[0])
      }
    },
    [onFileSelect]
  )

  const { getRootProps, getInputProps, isDragActive, isDragReject } = useDropzone({
    onDrop,
    accept: {
      'text/csv': ['.csv'],
      'application/vnd.ms-excel': ['.csv'],
    },
    maxFiles: 1,
    maxSize: 10 * 1024 * 1024, // 10MB
    disabled,
  })

  return (
    <div
      {...getRootProps()}
      className={cn(
        'border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors',
        isDragActive && !isDragReject && 'border-primary bg-primary/5',
        isDragReject && 'border-destructive bg-destructive/5',
        file && 'border-green-500 bg-green-50 dark:bg-green-950/20',
        disabled && 'opacity-50 cursor-not-allowed',
        !isDragActive && !file && 'border-muted-foreground/25 hover:border-muted-foreground/50'
      )}
    >
      <input {...getInputProps()} />
      {file ? (
        <div className="flex items-center justify-center gap-2">
          <FileSpreadsheet className="h-8 w-8 text-green-600 dark:text-green-400" />
          <div className="text-left">
            <p className="font-medium">{file.name}</p>
            <p className="text-sm text-muted-foreground">
              {(file.size / 1024).toFixed(1)} KB
            </p>
          </div>
        </div>
      ) : isDragActive ? (
        <div className="space-y-2">
          <Upload className="h-8 w-8 mx-auto text-primary" />
          <p className="text-primary font-medium">Drop the CSV file here...</p>
        </div>
      ) : (
        <div className="space-y-2">
          <Upload className="h-8 w-8 mx-auto text-muted-foreground" />
          <p>Drag and drop a CSV file, or click to select</p>
          <p className="text-sm text-muted-foreground">Max file size: 10MB</p>
        </div>
      )}
    </div>
  )
}
```

**csv-preview.tsx** - Validation results display:
```typescript
'use client'

import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { CheckCircle2, AlertCircle, AlertTriangle } from 'lucide-react'
import { ValidationResult } from '@/lib/csv/validation'

interface CSVPreviewProps {
  validation: ValidationResult
  isValidating: boolean
}

export function CSVPreview({ validation, isValidating }: CSVPreviewProps) {
  if (isValidating) {
    return (
      <div className="flex items-center gap-2 text-muted-foreground">
        <div className="h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent" />
        <span>Validating CSV...</span>
      </div>
    )
  }

  return (
    <div className="space-y-4">
      {/* Summary */}
      {validation.valid ? (
        <Alert className="border-green-500 bg-green-50 dark:bg-green-950/20">
          <CheckCircle2 className="h-4 w-4 text-green-600" />
          <AlertTitle>Validation Passed</AlertTitle>
          <AlertDescription>
            {validation.validRowCount} of {validation.totalRowCount} rows ready for upload
          </AlertDescription>
        </Alert>
      ) : (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Validation Failed</AlertTitle>
          <AlertDescription>
            {validation.errors.length} error(s) found. Please fix and try again.
          </AlertDescription>
        </Alert>
      )}

      {/* Warnings */}
      {validation.warnings.length > 0 && (
        <Alert className="border-yellow-500 bg-yellow-50 dark:bg-yellow-950/20">
          <AlertTriangle className="h-4 w-4 text-yellow-600" />
          <AlertTitle>Warnings ({validation.warnings.length})</AlertTitle>
          <AlertDescription>
            <ul className="mt-2 text-sm space-y-1 max-h-24 overflow-y-auto">
              {validation.warnings.slice(0, 5).map((warning, i) => (
                <li key={i}>
                  {warning.row > 0 ? `Row ${warning.row}: ` : ''}
                  {warning.message}
                </li>
              ))}
              {validation.warnings.length > 5 && (
                <li className="text-muted-foreground">
                  ...and {validation.warnings.length - 5} more warnings
                </li>
              )}
            </ul>
          </AlertDescription>
        </Alert>
      )}

      {/* Errors */}
      {validation.errors.length > 0 && (
        <div className="max-h-48 overflow-y-auto rounded-md border border-destructive/50 p-3">
          <ul className="text-sm space-y-1">
            {validation.errors.slice(0, 10).map((error, i) => (
              <li key={i} className="text-destructive">
                {error.row > 0 ? `Row ${error.row}: ` : ''}
                {error.field !== 'file' && error.field !== 'headers' && `${error.field} - `}
                {error.message}
              </li>
            ))}
            {validation.errors.length > 10 && (
              <li className="text-muted-foreground">
                ...and {validation.errors.length - 10} more errors
              </li>
            )}
          </ul>
        </div>
      )}
    </div>
  )
}
```

**csv-upload-dialog.tsx** - Main upload dialog:
```typescript
'use client'

import { useState, useCallback } from 'react'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { CSVDropzone } from './csv-dropzone'
import { CSVPreview } from './csv-preview'
import { parseCSVFile } from '@/lib/csv/parser'
import { validateCSVData, ValidationResult } from '@/lib/csv/validation'

interface CSVUploadDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  onUpload: (file: File, rowCount: number) => Promise<{ success: boolean; error?: string }>
}

export function CSVUploadDialog({ open, onOpenChange, onUpload }: CSVUploadDialogProps) {
  const [file, setFile] = useState<File | null>(null)
  const [validation, setValidation] = useState<ValidationResult | null>(null)
  const [isValidating, setIsValidating] = useState(false)
  const [isUploading, setIsUploading] = useState(false)
  const [uploadError, setUploadError] = useState<string | null>(null)

  const handleFileSelect = useCallback(async (selectedFile: File) => {
    setFile(selectedFile)
    setValidation(null)
    setUploadError(null)
    setIsValidating(true)

    try {
      const parseResult = await parseCSVFile(selectedFile)

      if (parseResult.errors.length > 0) {
        setValidation({
          valid: false,
          errors: parseResult.errors.map((e, i) => ({
            row: e.row ?? 0,
            field: 'parse',
            message: e.message,
          })),
          warnings: [],
          validRowCount: 0,
          totalRowCount: 0,
        })
      } else {
        const result = validateCSVData(parseResult.data)
        setValidation(result)
      }
    } catch (error) {
      setValidation({
        valid: false,
        errors: [{ row: 0, field: 'file', message: 'Failed to parse CSV file' }],
        warnings: [],
        validRowCount: 0,
        totalRowCount: 0,
      })
    } finally {
      setIsValidating(false)
    }
  }, [])

  const handleUpload = async () => {
    if (!file || !validation?.valid) return

    setIsUploading(true)
    setUploadError(null)

    try {
      const result = await onUpload(file, validation.validRowCount)

      if (result.success) {
        // Reset state and close dialog
        setFile(null)
        setValidation(null)
        onOpenChange(false)
      } else {
        setUploadError(result.error ?? 'Upload failed')
      }
    } catch (error) {
      setUploadError('An unexpected error occurred')
    } finally {
      setIsUploading(false)
    }
  }

  const handleClose = (newOpen: boolean) => {
    if (!isUploading) {
      if (!newOpen) {
        // Reset state when closing
        setFile(null)
        setValidation(null)
        setUploadError(null)
      }
      onOpenChange(newOpen)
    }
  }

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>Upload Inventory CSV</DialogTitle>
          <DialogDescription>
            Upload a CSV file to update your inventory. The file will be validated before processing.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-6">
          <CSVDropzone
            onFileSelect={handleFileSelect}
            file={file}
            disabled={isUploading}
          />

          {(validation || isValidating) && (
            <CSVPreview validation={validation!} isValidating={isValidating} />
          )}

          {uploadError && (
            <p className="text-sm text-destructive">{uploadError}</p>
          )}

          <div className="flex justify-end gap-2">
            <Button
              variant="outline"
              onClick={() => handleClose(false)}
              disabled={isUploading}
            >
              Cancel
            </Button>
            <Button
              onClick={handleUpload}
              disabled={!validation?.valid || isUploading || isValidating}
            >
              {isUploading ? 'Uploading...' : 'Upload'}
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  )
}
```

**csv-upload-button.tsx** - Button trigger with dialog state:
```typescript
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Upload } from 'lucide-react'
import { CSVUploadDialog } from './csv-upload-dialog'
import { toast } from 'sonner'

interface CSVUploadButtonProps {
  onUpload: (file: File, rowCount: number) => Promise<{ success: boolean; error?: string; jobId?: string }>
}

export function CSVUploadButton({ onUpload }: CSVUploadButtonProps) {
  const [open, setOpen] = useState(false)

  const handleUpload = async (file: File, rowCount: number) => {
    const result = await onUpload(file, rowCount)

    if (result.success) {
      toast.success('Upload started', {
        description: `Processing ${rowCount} rows in background. You'll be notified when complete.`,
      })
    } else {
      toast.error('Upload failed', {
        description: result.error,
      })
    }

    return result
  }

  return (
    <>
      <Button onClick={() => setOpen(true)}>
        <Upload className="mr-2 h-4 w-4" />
        Upload CSV
      </Button>
      <CSVUploadDialog
        open={open}
        onOpenChange={setOpen}
        onUpload={handleUpload}
      />
    </>
  )
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Run `npm run build` to confirm no build errors.
  </verify>
  <done>
Four components created:
- CSVDropzone with react-dropzone integration
- CSVPreview showing validation results
- CSVUploadDialog orchestrating the flow
- CSVUploadButton providing the trigger with toast notifications
  </done>
</task>

</tasks>

<verification>
1. Run `npm ls react-dropzone papaparse` - both packages installed
2. Run `npx tsc --noEmit` - no TypeScript errors
3. Run `npm run build` - build succeeds
4. Files exist:
   - src/lib/csv/parser.ts
   - src/lib/csv/validation.ts
   - src/app/(dashboard)/inventory/components/csv-dropzone.tsx
   - src/app/(dashboard)/inventory/components/csv-preview.tsx
   - src/app/(dashboard)/inventory/components/csv-upload-dialog.tsx
   - src/app/(dashboard)/inventory/components/csv-upload-button.tsx
</verification>

<success_criteria>
- react-dropzone and papaparse installed as dependencies
- CSV parser utility with encoding fallback for Portuguese characters
- Zod-based validation schema with error/warning separation
- Dropzone component with drag-and-drop and click-to-select
- Preview component showing validation results before upload
- Upload dialog orchestrating the complete flow
- Upload button component ready for integration
- Requirements INV-06 (CSV upload interface) and INV-07 (validation preview) foundations complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-inventory-management/04-01-SUMMARY.md`
</output>
