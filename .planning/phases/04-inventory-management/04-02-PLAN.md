---
phase: 04-inventory-management
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - package.json
  - supabase/migrations/20260121_inventory_upload_jobs.sql
  - src/lib/n8n/webhook.ts
  - src/lib/csv/export.ts
  - src/app/(dashboard)/inventory/actions.ts
  - src/app/(dashboard)/inventory/components/export-button.tsx
autonomous: true

must_haves:
  truths:
    - "CSV upload creates a job record in inventory_upload_jobs table"
    - "CSV upload triggers n8n webhook without blocking UI"
    - "User can export visible inventory data to Excel (.xlsx)"
    - "User can export visible inventory data to CSV"
    - "Upload returns immediately with job_id for tracking"
  artifacts:
    - path: "supabase/migrations/20260121_inventory_upload_jobs.sql"
      provides: "Database table for tracking upload jobs"
      contains: "CREATE TABLE inventory_upload_jobs"
    - path: "src/lib/n8n/webhook.ts"
      provides: "n8n webhook client with fire-and-forget pattern"
      exports: ["triggerN8nWebhook", "WebhookPayload"]
    - path: "src/lib/csv/export.ts"
      provides: "Excel and CSV export utilities"
      exports: ["exportToExcel", "exportToCSV"]
    - path: "src/app/(dashboard)/inventory/actions.ts"
      provides: "Server action for upload job creation"
      exports: ["triggerInventoryUpload"]
    - path: "src/app/(dashboard)/inventory/components/export-button.tsx"
      provides: "Export dropdown with Excel/CSV options"
      exports: ["ExportButton"]
  key_links:
    - from: "src/app/(dashboard)/inventory/actions.ts"
      to: "src/lib/n8n/webhook.ts"
      via: "triggerN8nWebhook call"
      pattern: "triggerN8nWebhook\\("
    - from: "src/app/(dashboard)/inventory/actions.ts"
      to: "inventory_upload_jobs table"
      via: "Supabase insert"
      pattern: "from\\(['\"]inventory_upload_jobs['\"]\\)"
    - from: "export-button.tsx"
      to: "src/lib/csv/export.ts"
      via: "exportToExcel/exportToCSV imports"
      pattern: "import.*export.*from.*lib/csv/export"
---

<objective>
Create n8n webhook integration for CSV upload and Excel/CSV export functionality

Purpose: Complete the upload flow with backend processing trigger and add export capabilities for inventory data.

Output: Server action that creates upload jobs and triggers n8n, plus client-side export utilities with Excel and CSV support.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-inventory-management/04-RESEARCH.md
@.planning/phases/04-inventory-management/04-01-SUMMARY.md
@src/lib/auth/utils.ts
@src/lib/supabase/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create inventory_upload_jobs table migration</name>
  <files>supabase/migrations/20260121_inventory_upload_jobs.sql</files>
  <action>
Create SQL migration file for the upload jobs tracking table.

**supabase/migrations/20260121_inventory_upload_jobs.sql:**
```sql
-- Migration: Create inventory_upload_jobs table for tracking CSV uploads
-- Run this in Supabase Dashboard SQL Editor

-- Create the inventory_upload_jobs table
CREATE TABLE IF NOT EXISTS inventory_upload_jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  file_name TEXT NOT NULL,
  row_count INTEGER NOT NULL DEFAULT 0,
  status TEXT NOT NULL DEFAULT 'pending',
  error_message TEXT,
  processed_rows INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,

  -- Constraint for valid status values
  CONSTRAINT valid_status CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'partial'))
);

-- Create index for querying by user
CREATE INDEX IF NOT EXISTS idx_inventory_upload_jobs_user_id ON inventory_upload_jobs(user_id);

-- Create index for querying by status
CREATE INDEX IF NOT EXISTS idx_inventory_upload_jobs_status ON inventory_upload_jobs(status);

-- Create index for recent jobs
CREATE INDEX IF NOT EXISTS idx_inventory_upload_jobs_created_at ON inventory_upload_jobs(created_at DESC);

-- Enable RLS
ALTER TABLE inventory_upload_jobs ENABLE ROW LEVEL SECURITY;

-- Policy: Users can view their own jobs
CREATE POLICY "Users can view own upload jobs"
  ON inventory_upload_jobs
  FOR SELECT
  USING (auth.uid() = user_id);

-- Policy: Users can create jobs
CREATE POLICY "Users can create upload jobs"
  ON inventory_upload_jobs
  FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- Policy: Service role can update jobs (for n8n)
-- Note: n8n will use service_role key to update job status
CREATE POLICY "Service role can update jobs"
  ON inventory_upload_jobs
  FOR UPDATE
  USING (true)
  WITH CHECK (true);

-- Trigger to update updated_at
CREATE OR REPLACE FUNCTION update_inventory_job_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER inventory_job_updated_at
  BEFORE UPDATE ON inventory_upload_jobs
  FOR EACH ROW
  EXECUTE FUNCTION update_inventory_job_updated_at();

-- Grant permissions
GRANT SELECT, INSERT ON inventory_upload_jobs TO authenticated;
GRANT ALL ON inventory_upload_jobs TO service_role;
```

Add a comment at the top of the file noting this must be run manually in Supabase Dashboard.
  </action>
  <verify>
File exists at supabase/migrations/20260121_inventory_upload_jobs.sql
SQL syntax is valid (no syntax errors in CREATE statements)
  </verify>
  <done>
Migration file created with:
- inventory_upload_jobs table with status tracking
- RLS policies for user access and service role updates
- Indexes for efficient queries
- Updated_at trigger
  </done>
</task>

<task type="auto">
  <name>Task 2: Create n8n webhook client and server action</name>
  <files>
    src/lib/n8n/webhook.ts
    src/app/(dashboard)/inventory/actions.ts
  </files>
  <action>
Create the n8n webhook utility and server action for upload.

**src/lib/n8n/webhook.ts:**
```typescript
export interface WebhookPayload {
  jobId: string
  csvContent: string
  fileName: string
  userId: string
  rowCount: number
}

/**
 * Trigger n8n webhook with fire-and-forget pattern
 * Does NOT await response - n8n will update job status when complete
 */
export async function triggerN8nWebhook(payload: WebhookPayload): Promise<void> {
  const webhookUrl = process.env.N8N_INVENTORY_WEBHOOK_URL

  if (!webhookUrl) {
    console.error('N8N_INVENTORY_WEBHOOK_URL not configured')
    throw new Error('N8N_INVENTORY_WEBHOOK_URL not configured')
  }

  // Fire-and-forget: don't await the response
  // n8n webhook is configured to respond "immediately"
  fetch(webhookUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      // Add authentication header if n8n webhook requires it
      ...(process.env.N8N_WEBHOOK_SECRET && {
        'X-Webhook-Secret': process.env.N8N_WEBHOOK_SECRET,
      }),
    },
    body: JSON.stringify({
      jobId: payload.jobId,
      csvContent: payload.csvContent,
      fileName: payload.fileName,
      userId: payload.userId,
      rowCount: payload.rowCount,
      timestamp: new Date().toISOString(),
    }),
  }).catch((error) => {
    // Log but don't throw - fire-and-forget
    console.error('n8n webhook request failed:', error)
  })
}
```

**src/app/(dashboard)/inventory/actions.ts:**
```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { getUserRole } from '@/lib/auth/utils'
import { triggerN8nWebhook } from '@/lib/n8n/webhook'

export interface UploadResult {
  success: boolean
  error?: string
  jobId?: string
}

/**
 * Create an inventory upload job and trigger n8n webhook
 * Fire-and-forget pattern: returns immediately, n8n processes async
 */
export async function triggerInventoryUpload(
  formData: FormData
): Promise<UploadResult> {
  const supabase = await createClient()

  // Check permission - only admin can upload
  const role = await getUserRole()
  if (role !== 'admin') {
    return { success: false, error: 'Unauthorized: Admin access required' }
  }

  // Verify user is authenticated
  const {
    data: { user },
  } = await supabase.auth.getUser()
  if (!user) {
    return { success: false, error: 'Not authenticated' }
  }

  // Extract file from form data
  const file = formData.get('file') as File | null
  const rowCount = parseInt(formData.get('rowCount') as string, 10) || 0

  if (!file) {
    return { success: false, error: 'No file provided' }
  }

  // Read file content
  let fileContent: string
  try {
    fileContent = await file.text()
  } catch (error) {
    return { success: false, error: 'Failed to read file content' }
  }

  // Create upload job record
  const { data: job, error: jobError } = await supabase
    .from('inventory_upload_jobs')
    .insert({
      user_id: user.id,
      file_name: file.name,
      row_count: rowCount,
      status: 'pending',
    })
    .select()
    .single()

  if (jobError) {
    console.error('Failed to create upload job:', jobError)
    return {
      success: false,
      error: `Failed to create upload job: ${jobError.message}`,
    }
  }

  // Fire-and-forget: trigger n8n webhook without awaiting completion
  // The webhook will update job status when processing completes
  try {
    await triggerN8nWebhook({
      jobId: job.id,
      csvContent: fileContent,
      fileName: file.name,
      userId: user.id,
      rowCount: rowCount,
    })
  } catch (error) {
    // Log error but don't fail - job is created, n8n will retry or admin can check
    console.error('Failed to trigger n8n webhook:', error)
    // Optionally update job status to indicate webhook issue
    await supabase
      .from('inventory_upload_jobs')
      .update({
        status: 'pending',
        error_message: 'Webhook trigger failed - will retry',
      })
      .eq('id', job.id)
  }

  // Revalidate inventory page
  revalidatePath('/inventory')

  return {
    success: true,
    jobId: job.id,
  }
}

/**
 * Get upload job status
 * Can be used for polling or initial load
 */
export async function getUploadJobStatus(jobId: string) {
  const supabase = await createClient()

  const { data, error } = await supabase
    .from('inventory_upload_jobs')
    .select('*')
    .eq('id', jobId)
    .single()

  if (error) {
    return { success: false, error: error.message }
  }

  return { success: true, job: data }
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles.
Files exist at src/lib/n8n/webhook.ts and src/app/(dashboard)/inventory/actions.ts.
  </verify>
  <done>
n8n webhook client with fire-and-forget pattern created.
Server action creates job record, triggers webhook, returns immediately.
Admin permission check enforced in server action.
  </done>
</task>

<task type="auto">
  <name>Task 3: Install export dependencies and create export utilities</name>
  <files>
    package.json
    src/lib/csv/export.ts
    src/app/(dashboard)/inventory/components/export-button.tsx
  </files>
  <action>
Install SheetJS and file-saver, then create export utilities.

**Install dependencies:**
```bash
npm install xlsx file-saver
npm install -D @types/file-saver
```

Note: xlsx (SheetJS) uses untyped exports, types are included. file-saver needs @types/file-saver.

**src/lib/csv/export.ts:**
```typescript
import * as XLSX from 'xlsx'
import { saveAs } from 'file-saver'

export interface ExportColumn<T> {
  key: keyof T
  header: string
}

export interface ExportOptions {
  filename?: string
  sheetName?: string
}

/**
 * Export data to Excel (.xlsx) format
 * Generates file in browser and triggers download
 */
export function exportToExcel<T extends Record<string, unknown>>(
  data: T[],
  columns: ExportColumn<T>[],
  options: ExportOptions = {}
): void {
  const { filename = 'export', sheetName = 'Data' } = options

  // Transform data to include only specified columns with custom headers
  const exportData = data.map((row) => {
    const exportRow: Record<string, unknown> = {}
    columns.forEach((col) => {
      exportRow[col.header] = row[col.key]
    })
    return exportRow
  })

  // Create workbook and worksheet
  const worksheet = XLSX.utils.json_to_sheet(exportData)
  const workbook = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(workbook, worksheet, sheetName)

  // Auto-size columns based on content
  const maxWidths = columns.map((col) => {
    const headerWidth = col.header.length
    const dataWidths = exportData.map((row) =>
      String(row[col.header] ?? '').length
    )
    return Math.min(Math.max(headerWidth, ...dataWidths) + 2, 50)
  })
  worksheet['!cols'] = maxWidths.map((w) => ({ wch: w }))

  // Generate buffer and download
  const excelBuffer = XLSX.write(workbook, {
    bookType: 'xlsx',
    type: 'array',
  })

  const blob = new Blob([excelBuffer], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
  })

  const dateStr = new Date().toISOString().split('T')[0]
  saveAs(blob, `${filename}-${dateStr}.xlsx`)
}

/**
 * Export data to CSV format
 * Generates file in browser and triggers download
 */
export function exportToCSV<T extends Record<string, unknown>>(
  data: T[],
  columns: ExportColumn<T>[],
  filename = 'export'
): void {
  // Transform data to include only specified columns with custom headers
  const exportData = data.map((row) => {
    const exportRow: Record<string, unknown> = {}
    columns.forEach((col) => {
      exportRow[col.header] = row[col.key]
    })
    return exportRow
  })

  const worksheet = XLSX.utils.json_to_sheet(exportData)
  const csv = XLSX.utils.sheet_to_csv(worksheet)

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' })
  const dateStr = new Date().toISOString().split('T')[0]
  saveAs(blob, `${filename}-${dateStr}.csv`)
}
```

**src/app/(dashboard)/inventory/components/export-button.tsx:**
```typescript
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Download, FileSpreadsheet, FileText, ChevronDown } from 'lucide-react'
import { exportToExcel, exportToCSV, ExportColumn } from '@/lib/csv/export'
import { Artigo, InventoryColumnConfig } from '@/lib/supabase/types'
import { toast } from 'sonner'

interface ExportButtonProps {
  data: Artigo[]
  columnConfig: InventoryColumnConfig[]
  disabled?: boolean
}

export function ExportButton({ data, columnConfig, disabled }: ExportButtonProps) {
  const [isExporting, setIsExporting] = useState(false)

  // Map column config to export columns
  const columns: ExportColumn<Artigo>[] = columnConfig.map((col) => ({
    key: col.column_name as keyof Artigo,
    header: col.display_name,
  }))

  const handleExportExcel = () => {
    if (data.length === 0) {
      toast.error('No data to export')
      return
    }

    setIsExporting(true)
    // Use setTimeout to let React update UI before CPU-intensive export
    setTimeout(() => {
      try {
        exportToExcel(data, columns, {
          filename: 'inventory',
          sheetName: 'Inventory',
        })
        toast.success('Excel file downloaded')
      } catch (error) {
        console.error('Export failed:', error)
        toast.error('Export failed')
      } finally {
        setIsExporting(false)
      }
    }, 0)
  }

  const handleExportCSV = () => {
    if (data.length === 0) {
      toast.error('No data to export')
      return
    }

    setIsExporting(true)
    setTimeout(() => {
      try {
        exportToCSV(data, columns, 'inventory')
        toast.success('CSV file downloaded')
      } catch (error) {
        console.error('Export failed:', error)
        toast.error('Export failed')
      } finally {
        setIsExporting(false)
      }
    }, 0)
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="outline" disabled={disabled || isExporting || data.length === 0}>
          <Download className="mr-2 h-4 w-4" />
          {isExporting ? 'Exporting...' : 'Export'}
          <ChevronDown className="ml-2 h-4 w-4" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuItem onClick={handleExportExcel} disabled={isExporting}>
          <FileSpreadsheet className="mr-2 h-4 w-4" />
          Export as Excel (.xlsx)
        </DropdownMenuItem>
        <DropdownMenuItem onClick={handleExportCSV} disabled={isExporting}>
          <FileText className="mr-2 h-4 w-4" />
          Export as CSV (.csv)
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```
  </action>
  <verify>
Run `npm ls xlsx file-saver` to confirm packages installed.
Run `npx tsc --noEmit` to verify TypeScript compiles.
Run `npm run build` to confirm build succeeds.
  </verify>
  <done>
xlsx and file-saver installed as dependencies.
Export utilities created with Excel and CSV support.
ExportButton component with dropdown menu ready for integration.
Exports include date in filename for versioning.
  </done>
</task>

</tasks>

<verification>
1. Run `npm ls xlsx file-saver` - packages installed
2. Run `npx tsc --noEmit` - no TypeScript errors
3. Run `npm run build` - build succeeds
4. Files exist:
   - supabase/migrations/20260121_inventory_upload_jobs.sql
   - src/lib/n8n/webhook.ts
   - src/lib/csv/export.ts
   - src/app/(dashboard)/inventory/actions.ts
   - src/app/(dashboard)/inventory/components/export-button.tsx
5. Migration file contains CREATE TABLE inventory_upload_jobs
</verification>

<success_criteria>
- inventory_upload_jobs migration ready to run in Supabase Dashboard
- n8n webhook client with fire-and-forget pattern
- Server action creates job record and triggers webhook
- Admin permission check in server action
- Excel export generates .xlsx with auto-sized columns
- CSV export generates .csv with proper encoding
- ExportButton with dropdown for format selection
- Toast notifications for export success/failure
- Requirements INV-08 (n8n webhook) and INV-09 (export) complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-inventory-management/04-02-SUMMARY.md`

User setup required after this plan:
1. Run migration in Supabase Dashboard SQL Editor
2. Set N8N_INVENTORY_WEBHOOK_URL in .env.local
3. (Optional) Set N8N_WEBHOOK_SECRET if webhook requires authentication
</output>
