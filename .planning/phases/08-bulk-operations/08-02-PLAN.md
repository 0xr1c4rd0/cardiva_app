---
phase: 08-bulk-operations
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/app/(dashboard)/rfps/components/manual-match-dialog.tsx
  - src/app/(dashboard)/rfps/components/confirmation-summary.tsx
  - src/app/(dashboard)/rfps/components/match-review-table.tsx
  - src/app/(dashboard)/rfps/[id]/matches/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can open manual match dialog from any item row"
    - "User can search inventory and select a different match"
    - "Confirmation summary shows review status counts (accepted, manual, rejected, pending)"
    - "Export button is disabled until all items have a decision (no pending)"
  artifacts:
    - path: "src/app/(dashboard)/rfps/components/manual-match-dialog.tsx"
      provides: "Dialog for inventory search and manual match selection"
      exports: ["ManualMatchDialog"]
      min_lines: 80
    - path: "src/app/(dashboard)/rfps/components/confirmation-summary.tsx"
      provides: "Summary panel with review counts and export gating"
      exports: ["ConfirmationSummary"]
      min_lines: 50
    - path: "src/app/(dashboard)/rfps/components/match-review-table.tsx"
      provides: "Extended with Corrigir button and ManualMatchDialog integration"
      contains: "ManualMatchDialog"
    - path: "src/app/(dashboard)/rfps/[id]/matches/page.tsx"
      provides: "Updated layout with ConfirmationSummary sidebar"
      contains: "ConfirmationSummary"
  key_links:
    - from: "ManualMatchDialog"
      to: "searchInventory action"
      via: "useDebouncedCallback import"
      pattern: "searchInventory"
    - from: "ManualMatchDialog"
      to: "setManualMatch action"
      via: "startTransition call"
      pattern: "setManualMatch"
    - from: "ConfirmationSummary"
      to: "items prop"
      via: "review_status filter"
      pattern: "review_status.*pending"
---

<objective>
Create ManualMatchDialog and ConfirmationSummary components, integrate into match review page.

Purpose: Enable manual match correction via inventory search dialog and gate export until all items have decisions.
Output: Two new components and updated page layout with confirmation sidebar.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-bulk-operations/08-RESEARCH.md
@.planning/phases/08-bulk-operations/08-01-SUMMARY.md

# Existing components to extend
@src/app/(dashboard)/rfps/components/match-review-table.tsx
@src/app/(dashboard)/rfps/[id]/matches/page.tsx

# Actions from Plan 01
@src/app/(dashboard)/rfps/[id]/matches/actions.ts

# UI components available
@src/components/ui/dialog.tsx
@src/components/ui/input.tsx
@src/components/ui/button.tsx
@src/components/ui/card.tsx

# Types
@src/types/rfp.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ManualMatchDialog component</name>
  <files>src/app/(dashboard)/rfps/components/manual-match-dialog.tsx</files>
  <action>
Create a new client component for manual match selection:

1. File header:
```typescript
'use client'

import { useState, useTransition } from 'react'
import { useDebouncedCallback } from 'use-debounce'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from '@/components/ui/dialog'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Search, Loader2, Check } from 'lucide-react'
import { searchInventory, setManualMatch } from '../[id]/matches/actions'
import type { InventorySearchResult } from '../[id]/matches/actions'
```

2. Props interface:
```typescript
interface ManualMatchDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  jobId: string
  rfpItemId: string
  rfpItemDescription: string
}
```

3. Component structure:
- State: query (string), results (InventorySearchResult[]), isSearching (boolean)
- useTransition for setManualMatch pending state
- useDebouncedCallback(300ms) for search - calls searchInventory
- handleSelect function that calls setManualMatch and closes dialog on success

4. Dialog content:
- DialogHeader with title "Selecionar correspondencia manualmente"
- DialogDescription showing the RFP item description (truncated with line-clamp-2)
- Search input with Search icon (left-3), placeholder "Pesquisar por codigo, nome ou descricao..."
- Results container (max-h-[400px] overflow-y-auto border rounded-md):
  - Loading state: Loader2 with animate-spin
  - Results: map to InventoryResultItem subcomponent
  - Empty state when query >= 2 chars: "Nenhum resultado encontrado"
  - Prompt state when query < 2 chars: "Digite pelo menos 2 caracteres para pesquisar"

5. InventoryResultItem subcomponent (inline in same file):
- Props: item, onSelect, isPending
- Display: codigo_spms or artigo, descricao truncated
- Clickable div with hover:bg-muted/40
- Check button that triggers onSelect

Portuguese text for all user-facing strings.
  </action>
  <verify>
File exists: `ls src/app/(dashboard)/rfps/components/manual-match-dialog.tsx`
TypeScript compiles: `npx tsc --noEmit`
Imports searchInventory: `grep "searchInventory" src/app/(dashboard)/rfps/components/manual-match-dialog.tsx`
  </verify>
  <done>ManualMatchDialog component renders inventory search with debounced input and selection</done>
</task>

<task type="auto">
  <name>Task 2: Create ConfirmationSummary component</name>
  <files>src/app/(dashboard)/rfps/components/confirmation-summary.tsx</files>
  <action>
Create a client component for review summary and export gating:

1. File header:
```typescript
'use client'

import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Check, X, AlertCircle, Edit, Download } from 'lucide-react'
import type { RFPItemWithMatches } from '@/types/rfp'
```

2. Props interface:
```typescript
interface ConfirmationSummaryProps {
  items: RFPItemWithMatches[]
  onProceedToExport: () => void
}
```

3. Calculate stats from items:
```typescript
const stats = {
  total: items.length,
  accepted: items.filter(i => i.review_status === 'accepted').length,
  rejected: items.filter(i => i.review_status === 'rejected').length,
  manual: items.filter(i => i.review_status === 'manual').length,
  pending: items.filter(i => i.review_status === 'pending').length,
}
const allDecided = stats.pending === 0
const hasMatches = stats.accepted + stats.manual > 0
```

4. Card layout:
- CardHeader: "Resumo da Revisao" (base text)
- CardContent with space-y-4:
  a. Status counts grid (2 columns, gap-2, text-sm):
     - Check icon (emerald-600) + "Selecionados: {accepted}"
     - Edit icon (blue-600) + "Manuais: {manual}"
     - X icon (gray-500) + "Sem match: {rejected}"
     - AlertCircle icon (amber-500) + "Pendentes: {pending}"
  b. Warning message if pending > 0:
     - amber background (bg-amber-50), text-amber-600
     - "Reveja os {pending} itens pendentes antes de continuar."
  c. Export button (full width):
     - Disabled when !allDecided OR !hasMatches
     - Download icon + text
     - When allDecided: "Confirmar e Exportar"
     - When not: "{pending} itens por rever"

Portuguese text for all user-facing strings.
  </action>
  <verify>
File exists: `ls src/app/(dashboard)/rfps/components/confirmation-summary.tsx`
TypeScript compiles: `npx tsc --noEmit`
Has pending check: `grep "pending" src/app/(dashboard)/rfps/components/confirmation-summary.tsx`
  </verify>
  <done>ConfirmationSummary shows review status counts and disables export until all items decided</done>
</task>

<task type="auto">
  <name>Task 3: Integrate ManualMatchDialog into MatchReviewTable</name>
  <files>src/app/(dashboard)/rfps/components/match-review-table.tsx</files>
  <action>
Modify the existing MatchReviewTable to add manual correction option:

1. Add import at top:
```typescript
import { Edit } from 'lucide-react'
import { ManualMatchDialog } from './manual-match-dialog'
```

2. In ItemRow component, add state:
```typescript
const [showManualDialog, setShowManualDialog] = useState(false)
```

3. Add "Corrigir" button in the Status TableCell:
- Place BEFORE the existing Popover (as a separate option)
- Only show when: hasNoSuggestions is TRUE, OR when user wants to override
- Actually, show for ALL rows as a secondary action
- Button styling: variant="ghost", size="sm", className="text-blue-600 hover:text-blue-700 hover:bg-blue-50"
- Content: Edit icon (h-3.5 w-3.5 mr-1) + "Corrigir"
- onClick: () => setShowManualDialog(true)

4. Render ManualMatchDialog at end of ItemRow return:
```tsx
<ManualMatchDialog
  open={showManualDialog}
  onOpenChange={setShowManualDialog}
  jobId={jobId}
  rfpItemId={item.id}
  rfpItemDescription={item.descricao_pedido}
/>
```

5. Update the Status cell layout:
- Wrap the existing Popover/button in a flex container with gap-2
- Add "Corrigir" button as first element
- Keep existing status button as second element

This allows users to either:
a. Use the suggestion popover to accept/reject AI matches
b. Click "Corrigir" to search inventory and select manually
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Imports ManualMatchDialog: `grep "ManualMatchDialog" src/app/(dashboard)/rfps/components/match-review-table.tsx`
Has Corrigir button: `grep "Corrigir" src/app/(dashboard)/rfps/components/match-review-table.tsx`
  </verify>
  <done>MatchReviewTable has Corrigir button that opens ManualMatchDialog for any row</done>
</task>

<task type="auto">
  <name>Task 4: Add ConfirmationSummary to matches page</name>
  <files>src/app/(dashboard)/rfps/[id]/matches/page.tsx</files>
  <action>
Update the matches page to include ConfirmationSummary sidebar:

1. Add import:
```typescript
import { ConfirmationSummary } from '@/app/(dashboard)/rfps/components/confirmation-summary'
```

2. Replace the comment "Phase 8 will add Continue/Confirm button here" with actual ConfirmationSummary

3. Update the main layout structure:
- Current: single div with MatchReviewTable
- New: flex row with table (flex-1) and summary sidebar (w-72 shrink-0)

4. Updated JSX structure:
```tsx
return (
  <div className="flex flex-1 flex-col gap-6">
    {/* Header - unchanged */}
    <div className="flex items-center justify-between">
      {/* ... existing header content ... */}
    </div>

    {/* Main content with summary sidebar */}
    <div className="flex gap-6">
      {/* Items table - takes most space */}
      <div className="flex-1 min-w-0">
        <MatchReviewTable jobId={jobId} items={itemsWithSortedMatches} />
      </div>

      {/* Confirmation summary - fixed sidebar */}
      <div className="w-72 shrink-0">
        <ConfirmationSummary
          items={itemsWithSortedMatches}
          onProceedToExport={() => {
            // Phase 9 will implement export - for now, just log
            console.log('Proceed to export')
          }}
        />
      </div>
    </div>
  </div>
)
```

5. The ConfirmationSummary is a client component but receives server-rendered data.
   The onProceedToExport will be implemented in Phase 9 (Export & Email).
   For now, it gates the button until all items are decided.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Imports ConfirmationSummary: `grep "ConfirmationSummary" src/app/(dashboard)/rfps/[id]/matches/page.tsx`
Has sidebar layout: `grep "w-72" src/app/(dashboard)/rfps/[id]/matches/page.tsx`
  </verify>
  <done>Matches page has ConfirmationSummary sidebar showing review progress and gating export</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Dev server runs: `npm run dev`
3. Navigate to /rfps/[job-id]/matches page
4. Verify "Corrigir" button appears on item rows
5. Click "Corrigir" opens ManualMatchDialog with search input
6. Search returns inventory results (requires data in artigos table)
7. ConfirmationSummary sidebar shows review counts
8. Export button disabled when pending items exist
</verification>

<success_criteria>
- ManualMatchDialog allows searching inventory and selecting a match
- ConfirmationSummary displays accurate review status counts
- Export button only enabled when all items have decisions (no pending)
- Corrigir button available on every item row
- All text in Portuguese
</success_criteria>

<output>
After completion, create `.planning/phases/08-bulk-operations/08-02-SUMMARY.md`
</output>
