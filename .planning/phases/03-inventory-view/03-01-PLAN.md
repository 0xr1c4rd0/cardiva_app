---
phase: 03-inventory-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/app/(dashboard)/inventory/page.tsx
  - src/app/(dashboard)/inventory/schema.ts
  - src/app/(dashboard)/inventory/components/inventory-table.tsx
  - src/app/(dashboard)/inventory/components/inventory-columns.tsx
  - src/app/(dashboard)/inventory/components/data-table-pagination.tsx
  - src/lib/supabase/types.ts
autonomous: true

must_haves:
  truths:
    - "User can navigate to /inventory and see product listing"
    - "Product listing displays data from artigos table"
    - "Pagination controls allow navigation between pages"
    - "Page size selector allows 25, 50, or 100 rows per page"
    - "URL reflects current pagination state (page, pageSize)"
    - "Loading skeleton displays during initial data fetch"
    - "Empty state displays when no products exist"
  artifacts:
    - path: "src/app/(dashboard)/inventory/page.tsx"
      provides: "Server Component that fetches paginated artigos data"
      min_lines: 40
    - path: "src/app/(dashboard)/inventory/schema.ts"
      provides: "Zod schema for URL param validation"
      exports: ["searchParamsSchema", "SearchParams"]
    - path: "src/app/(dashboard)/inventory/components/inventory-table.tsx"
      provides: "Client Component with TanStack Table and nuqs URL state"
      exports: ["InventoryTable"]
    - path: "src/app/(dashboard)/inventory/components/inventory-columns.tsx"
      provides: "Column definitions for TanStack Table"
      exports: ["columns"]
    - path: "src/app/(dashboard)/inventory/components/data-table-pagination.tsx"
      provides: "Pagination controls component"
      exports: ["DataTablePagination"]
    - path: "src/lib/supabase/types.ts"
      provides: "TypeScript types for artigos table"
      exports: ["Artigo"]
  key_links:
    - from: "src/app/(dashboard)/inventory/page.tsx"
      to: "src/lib/supabase/server.ts"
      via: "createClient() for data fetch"
      pattern: "createClient\\(\\)"
    - from: "src/app/(dashboard)/inventory/page.tsx"
      to: "src/app/(dashboard)/inventory/components/inventory-table.tsx"
      via: "passes data and totalCount to InventoryTable"
      pattern: "<InventoryTable"
    - from: "src/app/(dashboard)/inventory/components/inventory-table.tsx"
      to: "nuqs"
      via: "useQueryStates for URL state management"
      pattern: "useQueryStates"
---

<objective>
Create the inventory page with TanStack Table displaying products from the artigos table with server-side pagination.

Purpose: Establishes the core inventory viewing capability. Users can browse the 20k+ product catalog with efficient pagination. This satisfies INV-01 (view product listing) and INV-02 (paginated listing), plus UI-04 (loading states) and UI-06 (empty states).

Output:
- Inventory page at /inventory route
- TanStack Table with server-side pagination
- URL-based state management with nuqs
- Zod schema for search param validation
- TypeScript types for artigos table
- Loading skeletons and empty state handling
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-inventory-view/03-RESEARCH.md

# Existing files from Phase 1-2
@src/lib/supabase/server.ts
@src/lib/supabase/client.ts
@src/app/(dashboard)/layout.tsx
@src/components/ui/table.tsx
@src/components/ui/skeleton.tsx
@src/components/ui/button.tsx
@src/components/layout/app-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create type definitions</name>
  <files>
    - package.json
    - src/lib/supabase/types.ts
    - src/app/(dashboard)/inventory/schema.ts
  </files>
  <action>
Install TanStack Table, nuqs for URL state, and use-debounce:

```bash
npm install @tanstack/react-table nuqs use-debounce
```

Create Supabase types at `src/lib/supabase/types.ts`:
- Define Artigo type matching the artigos table schema
- Include fields: id (number), codigo (string), nome (string), descricao (string | null), preco (number | null), stock (number | null), categoria (string | null), created_at (string), updated_at (string)
- Export the type

Create search params schema at `src/app/(dashboard)/inventory/schema.ts`:
- Import z from 'zod'
- Define searchParamsSchema with:
  - page: z.coerce.number().int().positive().default(1)
  - pageSize: z.coerce.number().int().positive().max(100).default(50)
- Export searchParamsSchema and inferred SearchParams type
  </action>
  <verify>
- `npm ls @tanstack/react-table nuqs use-debounce` shows all packages installed
- TypeScript compiles: `npx tsc --noEmit`
- Types file exports Artigo type
- Schema file exports searchParamsSchema and SearchParams
  </verify>
  <done>
Dependencies installed, Artigo type defined for database queries, URL param validation schema ready
  </done>
</task>

<task type="auto">
  <name>Task 2: Create inventory page and table components</name>
  <files>
    - src/app/(dashboard)/inventory/page.tsx
    - src/app/(dashboard)/inventory/components/inventory-table.tsx
    - src/app/(dashboard)/inventory/components/inventory-columns.tsx
    - src/app/(dashboard)/inventory/components/data-table-pagination.tsx
  </files>
  <action>
First, add the select component for page size selector:
```bash
npx shadcn@latest add select
```

Create inventory page at `src/app/(dashboard)/inventory/page.tsx`:
- Server Component (no 'use client')
- Import createClient from @/lib/supabase/server
- Import searchParamsSchema from ./schema
- Import InventoryTable from ./components/inventory-table
- Import Skeleton from @/components/ui/skeleton
- Accept searchParams prop (Promise<Record<string, string | string[] | undefined>>)
- Await and parse searchParams with schema (use .safeParse, fallback to defaults)
- Fetch from artigos table with:
  - .select('*', { count: 'exact' })
  - .order('nome', { ascending: true })
  - .range((page - 1) * pageSize, page * pageSize - 1)
- Handle error with throw
- Pass data, totalCount, and initialState to InventoryTable

Create column definitions at `src/app/(dashboard)/inventory/components/inventory-columns.tsx`:
- 'use client' directive (columns use client-side rendering functions)
- Import ColumnDef from @tanstack/react-table
- Import Artigo type from @/lib/supabase/types
- Define columns array with ColumnDef<Artigo>[]:
  - codigo: header 'Code', enableSorting: true
  - nome: header 'Name', enableSorting: true
  - categoria: header 'Category', enableSorting: true
  - preco: header 'Price', enableSorting: true, cell formats as EUR currency (use Intl.NumberFormat)
  - stock: header 'Stock', enableSorting: true
- Export columns

Create pagination component at `src/app/(dashboard)/inventory/components/data-table-pagination.tsx`:
- 'use client' directive
- Import Table type from @tanstack/react-table
- Import Button from @/components/ui/button
- Import Select components from @/components/ui/select
- Props: table (Table<TData>), isPending (boolean)
- Display: "Showing X of Y items" using table.getRowModel().rows.length and table.getRowCount()
- Page size selector: 25, 50, 100 options
- Page info: "Page X of Y" using pagination state and getPageCount()
- Navigation buttons: Previous, Next with disabled states and isPending
- Export DataTablePagination

Create inventory table at `src/app/(dashboard)/inventory/components/inventory-table.tsx`:
- 'use client' directive
- Import useQueryStates, parseAsInteger from 'nuqs'
- Import useReactTable, getCoreRowModel, flexRender from @tanstack/react-table
- Import useTransition from 'react'
- Import Table components from @/components/ui/table
- Import Skeleton from @/components/ui/skeleton
- Import columns from ./inventory-columns
- Import DataTablePagination from ./data-table-pagination
- Import Artigo from @/lib/supabase/types
- Import PackageOpen from 'lucide-react' for empty state icon

Props interface:
- data: Artigo[]
- totalCount: number
- initialState: { page: number, pageSize: number }

Implementation:
- useTransition for isPending state
- useQueryStates with nuqs for page and pageSize (parseAsInteger.withDefault)
- Configure useReactTable with:
  - data, columns
  - manualPagination: true (CRITICAL)
  - rowCount: totalCount
  - pageCount: Math.ceil(totalCount / pageSize)
  - state.pagination: { pageIndex: page - 1, pageSize }
  - onPaginationChange: wrap in startTransition, update URL params via setParams
  - getCoreRowModel: getCoreRowModel()

Render:
- Table with TableHeader mapping headerGroups
- TableBody with:
  - Skeleton rows when isPending (5 rows with skeleton cells matching column count)
  - Data rows when not pending and rows exist
  - Empty state when not pending and no rows (centered PackageOpen icon, "No products found" message)
- DataTablePagination at bottom

IMPORTANT: Use { shallow: false } in useQueryStates options to trigger server re-render on URL change.
  </action>
  <verify>
- Select component installed: check src/components/ui/select.tsx exists
- Navigate to http://localhost:3000/inventory - page renders
- TypeScript compiles: `npx tsc --noEmit`
- Changing page via pagination updates URL (?page=2)
- Changing page size updates URL (?pageSize=25)
  </verify>
  <done>
Inventory page displays products from artigos table, pagination works via URL state, loading and empty states implemented
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Dependencies installed:**
   - `npm ls @tanstack/react-table nuqs use-debounce` shows all packages

2. **TypeScript compiles:**
   - `npx tsc --noEmit` exits with 0

3. **Files created:**
   - src/lib/supabase/types.ts exports Artigo type
   - src/app/(dashboard)/inventory/schema.ts exports searchParamsSchema
   - src/app/(dashboard)/inventory/page.tsx fetches paginated data
   - src/app/(dashboard)/inventory/components/inventory-table.tsx renders TanStack Table
   - src/app/(dashboard)/inventory/components/inventory-columns.tsx defines columns
   - src/app/(dashboard)/inventory/components/data-table-pagination.tsx renders pagination

4. **Functional verification:**
   - http://localhost:3000/inventory shows product listing
   - Pagination controls navigate between pages
   - URL updates when changing page/pageSize
   - Loading skeleton shows during page transitions
   - Empty state shows if no products (test with empty table or invalid filter)
</verification>

<success_criteria>
- User can navigate to /inventory and see products from artigos table
- Pagination works with 25/50/100 rows per page options
- URL reflects pagination state (?page=2&pageSize=50)
- Loading skeletons display during data fetches
- Empty state displays when no products match
- INV-01 and INV-02 requirements satisfied
- UI-04 and UI-06 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-inventory-view/03-01-SUMMARY.md`
</output>
