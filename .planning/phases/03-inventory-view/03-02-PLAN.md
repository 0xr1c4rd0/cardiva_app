---
phase: 03-inventory-view
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/(dashboard)/inventory/page.tsx
  - src/app/(dashboard)/inventory/schema.ts
  - src/app/(dashboard)/inventory/components/inventory-table.tsx
  - src/app/(dashboard)/inventory/components/inventory-columns.tsx
  - src/app/(dashboard)/inventory/components/table-toolbar.tsx
autonomous: true

must_haves:
  truths:
    - "User can type in search box and results filter after 300ms debounce"
    - "Search filters products by name, code, or description"
    - "User can click column headers to sort ascending/descending"
    - "Sort indicator (arrow) shows current sort direction"
    - "User can filter products by category using dropdown"
    - "Changing search/sort/filter resets pagination to page 1"
    - "URL reflects search, sort, and filter state"
    - "Loading indicator shows during search/filter operations"
  artifacts:
    - path: "src/app/(dashboard)/inventory/schema.ts"
      provides: "Extended Zod schema with search, sortBy, sortOrder, category params"
      exports: ["searchParamsSchema", "SearchParams"]
    - path: "src/app/(dashboard)/inventory/components/table-toolbar.tsx"
      provides: "Search input with debounce and category filter dropdown"
      exports: ["TableToolbar"]
    - path: "src/app/(dashboard)/inventory/components/inventory-columns.tsx"
      provides: "Column definitions with sorting enabled"
      exports: ["columns"]
    - path: "src/app/(dashboard)/inventory/components/inventory-table.tsx"
      provides: "Table with sorting state and toolbar integration"
      exports: ["InventoryTable"]
    - path: "src/app/(dashboard)/inventory/page.tsx"
      provides: "Server Component with search, sort, filter query logic"
      min_lines: 60
  key_links:
    - from: "src/app/(dashboard)/inventory/components/table-toolbar.tsx"
      to: "use-debounce"
      via: "useDebouncedCallback for search input"
      pattern: "useDebouncedCallback"
    - from: "src/app/(dashboard)/inventory/components/inventory-table.tsx"
      to: "src/app/(dashboard)/inventory/components/table-toolbar.tsx"
      via: "passes search/filter state and callbacks"
      pattern: "<TableToolbar"
    - from: "src/app/(dashboard)/inventory/page.tsx"
      to: "supabase"
      via: ".ilike() for search, .order() for sort, .eq() for filter"
      pattern: "\\.ilike\\(|\\.order\\(|\\.eq\\("
---

<objective>
Add search, sort, and filter functionality to the inventory table with URL-based state management.

Purpose: Enables efficient product discovery in the 20k+ item catalog. Users can search by text, sort by clicking columns, and filter by category. This satisfies INV-03 (sortable columns), INV-04 (search by name/code/attributes), and INV-05 (filter by category).

Output:
- Search input with 300ms debounce
- Clickable column headers for sorting
- Category filter dropdown
- Updated URL state management for all filters
- Server-side query updates for search/sort/filter
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-inventory-view/03-RESEARCH.md
@.planning/phases/03-inventory-view/03-01-SUMMARY.md

# Files from Plan 01
@src/app/(dashboard)/inventory/page.tsx
@src/app/(dashboard)/inventory/schema.ts
@src/app/(dashboard)/inventory/components/inventory-table.tsx
@src/app/(dashboard)/inventory/components/inventory-columns.tsx
@src/app/(dashboard)/inventory/components/data-table-pagination.tsx
@src/lib/supabase/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema and create toolbar component</name>
  <files>
    - src/app/(dashboard)/inventory/schema.ts
    - src/app/(dashboard)/inventory/components/table-toolbar.tsx
  </files>
  <action>
Update schema at `src/app/(dashboard)/inventory/schema.ts`:
- Add search: z.string().max(200).default('')
- Add sortBy: z.enum(['nome', 'codigo', 'preco', 'stock', 'categoria']).default('nome')
- Add sortOrder: z.enum(['asc', 'desc']).default('asc')
- Add category: z.string().optional()
- Keep existing page and pageSize fields

Create toolbar component at `src/app/(dashboard)/inventory/components/table-toolbar.tsx`:
- 'use client' directive
- Import useDebouncedCallback from 'use-debounce'
- Import Input from @/components/ui/input
- Import Select components from @/components/ui/select
- Import Search, X, Loader2 icons from 'lucide-react'
- Import Button from @/components/ui/button

Props interface:
- search: string
- onSearchChange: (value: string) => void
- category: string | null
- onCategoryChange: (value: string | null) => void
- categories: string[]
- isPending: boolean

Implementation:
- useDebouncedCallback wrapping onSearchChange with 300ms delay
- Search input with:
  - Search icon on left (inside input)
  - defaultValue={search}
  - onChange calls debounced callback
  - disabled when isPending
  - Placeholder "Search by name, code, or description..."
  - Clear button (X icon) when search has value, calls onSearchChange('')
- Category select:
  - "All Categories" option with value 'all'
  - Map categories to SelectItem options
  - onValueChange: if 'all' selected, call onCategoryChange(null), else call onCategoryChange(value)
  - disabled when isPending
- Show Loader2 spinner (animate-spin) when isPending

Export TableToolbar
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Schema exports extended searchParamsSchema with new fields
- TableToolbar component renders with search and category filter
  </verify>
  <done>
Schema extended with search/sort/filter params, toolbar component created with debounced search and category filter
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sorting to columns and update table component</name>
  <files>
    - src/app/(dashboard)/inventory/components/inventory-columns.tsx
    - src/app/(dashboard)/inventory/components/inventory-table.tsx
  </files>
  <action>
Update columns at `src/app/(dashboard)/inventory/components/inventory-columns.tsx`:
- Import ArrowUpDown, ArrowUp, ArrowDown from 'lucide-react'
- Import Button from @/components/ui/button
- Update header function for sortable columns to return clickable button:
  ```tsx
  header: ({ column }) => {
    return (
      <Button
        variant="ghost"
        onClick={() => column.toggleSorting(column.getIsSorted() === "asc")}
        className="-ml-4"
      >
        Name
        {column.getIsSorted() === "asc" ? (
          <ArrowUp className="ml-2 h-4 w-4" />
        ) : column.getIsSorted() === "desc" ? (
          <ArrowDown className="ml-2 h-4 w-4" />
        ) : (
          <ArrowUpDown className="ml-2 h-4 w-4 text-muted-foreground" />
        )}
      </Button>
    )
  }
  ```
- Apply this pattern to: nome, codigo, preco, stock, categoria columns

Update table at `src/app/(dashboard)/inventory/components/inventory-table.tsx`:
- Update useQueryStates to include: search (parseAsString), sortBy (parseAsString), sortOrder (parseAsString), category (parseAsString)
- Update props interface to include initialState with search, sortBy, sortOrder, category
- Add categories prop (string[]) for toolbar
- Import TableToolbar from ./table-toolbar

Update useReactTable configuration:
- Add manualSorting: true (CRITICAL - server handles sorting)
- Add state.sorting: [{ id: sortBy, desc: sortOrder === 'desc' }]
- Add onSortingChange handler:
  ```tsx
  onSortingChange: (updater) => {
    startTransition(() => {
      const current = [{ id: sortBy, desc: sortOrder === 'desc' }]
      const newState = typeof updater === 'function' ? updater(current) : updater
      if (newState[0]) {
        setParams({
          sortBy: newState[0].id,
          sortOrder: newState[0].desc ? 'desc' : 'asc',
          page: 1  // Reset to page 1 on sort change
        })
      }
    })
  }
  ```

Add toolbar to render:
- Place TableToolbar above the table
- Pass search, onSearchChange (wraps setParams with page: 1), category, onCategoryChange (wraps setParams with page: 1), categories, isPending
- onSearchChange resets page to 1
- onCategoryChange resets page to 1
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Click column header changes sort (URL shows ?sortBy=codigo&sortOrder=asc)
- Click same column again toggles sort direction
- Sort indicator arrow shows on sorted column
  </verify>
  <done>
Columns have clickable sort headers with indicators, table manages sort state via URL
  </done>
</task>

<task type="auto">
  <name>Task 3: Update server page with search, sort, filter queries</name>
  <files>
    - src/app/(dashboard)/inventory/page.tsx
  </files>
  <action>
Update inventory page at `src/app/(dashboard)/inventory/page.tsx`:

Parse additional params from schema:
- Extract search, sortBy, sortOrder, category from parsed params

Update Supabase query to apply search, sort, and filter:
```tsx
let query = supabase
  .from('artigos')
  .select('*', { count: 'exact' })

// Apply search filter (search across multiple fields)
if (search) {
  // Use OR filter to search across name, code, and description
  query = query.or(`nome.ilike.%${search}%,codigo.ilike.%${search}%,descricao.ilike.%${search}%`)
}

// Apply category filter
if (category) {
  query = query.eq('categoria', category)
}

// Apply sorting
query = query.order(sortBy, { ascending: sortOrder === 'asc' })

// Apply pagination
query = query.range((page - 1) * pageSize, page * pageSize - 1)

const { data, error, count } = await query
```

Fetch distinct categories for filter dropdown:
```tsx
const { data: categoryData } = await supabase
  .from('artigos')
  .select('categoria')
  .not('categoria', 'is', null)
  .order('categoria')

// Extract unique categories
const categories = [...new Set(categoryData?.map(item => item.categoria).filter(Boolean))] as string[]
```

Update InventoryTable props:
- Add categories prop
- Update initialState to include search, sortBy, sortOrder, category

IMPORTANT: Both queries can run in parallel since they're independent. Use Promise.all if performance is critical, but sequential is fine for v1.

Handle edge cases:
- If search is empty string, don't apply search filter
- If category is undefined/null, don't apply category filter
- Ensure sortBy value is valid column name (schema validates this)
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Navigate to /inventory - page loads normally
- Type in search box - after 300ms, results filter (URL shows ?search=term)
- Select category - results filter (URL shows ?category=CategoryName)
- Click column header - results sort (URL shows ?sortBy=preco&sortOrder=desc)
- Changing any filter resets to page 1
  </verify>
  <done>
Server queries apply search, sort, and filter from URL params; categories fetched for dropdown
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **TypeScript compiles:**
   - `npx tsc --noEmit` exits with 0

2. **Search functionality:**
   - Type in search box - results update after 300ms debounce
   - Search matches products by name, code, or description
   - URL shows ?search=searchterm
   - Clearing search shows all products

3. **Sort functionality:**
   - Click column header - results sort by that column
   - Click again - sort direction toggles
   - Arrow indicator shows current sort column and direction
   - URL shows ?sortBy=column&sortOrder=asc|desc

4. **Filter functionality:**
   - Select category from dropdown - results filter
   - Select "All Categories" - filter cleared
   - URL shows ?category=CategoryName

5. **State management:**
   - All state changes update URL
   - Changing search/sort/filter resets to page 1
   - Loading indicator shows during transitions
   - Browser back/forward works correctly
</verification>

<success_criteria>
- User can search products by name, code, or description
- User can sort by clicking column headers
- User can filter by category
- All state persists in URL for bookmarking/sharing
- Loading states display during operations
- INV-03, INV-04, INV-05 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-inventory-view/03-02-SUMMARY.md`
</output>
