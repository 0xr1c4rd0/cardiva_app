---
phase: 09-export-email-admin
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260125_app_settings.sql
  - supabase/migrations/20260125_export_column_config.sql
autonomous: true
user_setup:
  - service: supabase
    why: "Database migrations require manual execution"
    dashboard_config:
      - task: "Run migration scripts in SQL Editor"
        location: "Supabase Dashboard -> SQL Editor"

must_haves:
  truths:
    - "app_settings table exists with single-row pattern (id=1 check constraint)"
    - "app_settings has email_default_recipients, email_user_can_edit, email_defaults_replaceable columns"
    - "export_column_config table exists with source_table, column_name, display_name, visible, display_order, column_type"
    - "sync_export_columns() function auto-discovers columns from rfp_items and rfp_match_suggestions"
    - "Authenticated users can SELECT from both tables; only admins can UPDATE/INSERT/DELETE"
  artifacts:
    - path: "supabase/migrations/20260125_app_settings.sql"
      provides: "app_settings table with email configuration"
      contains: "CREATE TABLE.*app_settings"
    - path: "supabase/migrations/20260125_export_column_config.sql"
      provides: "export_column_config table with sync function"
      contains: "CREATE TABLE.*export_column_config"
  key_links:
    - from: "export_column_config"
      to: "rfp_items and rfp_match_suggestions"
      via: "sync_export_columns function"
      pattern: "ARRAY\\['rfp_items', 'rfp_match_suggestions'\\]"
    - from: "RLS policies"
      to: "auth.jwt()"
      via: "user_role extraction"
      pattern: "auth\\.jwt\\(\\) ->> 'user_role'"
---

<objective>
Create database migrations for app_settings and export_column_config tables.

Purpose: Provide foundation for admin-configurable email recipients and export field selection.
Output: Two SQL migration files ready for execution in Supabase Dashboard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/plans/2026-01-25-phase9-export-email-admin-design.md

# Reference existing migration pattern
@supabase/migrations/20260121_inventory_column_config.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create app_settings migration</name>
  <files>supabase/migrations/20260125_app_settings.sql</files>
  <action>
Create migration file with the following SQL:

1. Create app_settings table with single-row pattern:
```sql
CREATE TABLE public.app_settings (
  id INT PRIMARY KEY DEFAULT 1 CHECK (id = 1),

  -- Email configuration
  email_default_recipients TEXT[] DEFAULT '{}',
  email_user_can_edit BOOLEAN DEFAULT true,
  email_defaults_replaceable BOOLEAN DEFAULT true,

  -- Timestamps
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  updated_by UUID REFERENCES auth.users(id)
);
```

2. Enable RLS:
```sql
ALTER TABLE public.app_settings ENABLE ROW LEVEL SECURITY;
```

3. Create RLS policies:
- SELECT: All authenticated users can read
- UPDATE: Only admins (use `(auth.jwt() ->> 'user_role') = 'admin'`)
- No INSERT policy needed (single row inserted below)
- No DELETE policy (prevent deletion)

4. Insert default row:
```sql
INSERT INTO public.app_settings (id) VALUES (1);
```

5. Create updated_at trigger using existing `update_updated_at_column()` function

Include header comments with instructions for running the migration.
  </action>
  <verify>
File exists and contains: `grep -l "app_settings" supabase/migrations/20260125_app_settings.sql`
Single-row pattern: `grep "CHECK (id = 1)" supabase/migrations/20260125_app_settings.sql`
Email columns present: `grep "email_default_recipients" supabase/migrations/20260125_app_settings.sql`
  </verify>
  <done>app_settings migration file exists with single-row table, email columns, and RLS policies</done>
</task>

<task type="auto">
  <name>Task 2: Create export_column_config migration</name>
  <files>supabase/migrations/20260125_export_column_config.sql</files>
  <action>
Create migration file with the following SQL:

1. Create export_column_config table:
```sql
CREATE TABLE public.export_column_config (
  id SERIAL PRIMARY KEY,
  source_table TEXT NOT NULL,              -- 'rfp_items' or 'rfp_match_suggestions'
  column_name TEXT NOT NULL,               -- actual DB column
  display_name TEXT NOT NULL,              -- Excel header
  visible BOOLEAN DEFAULT true,
  display_order INT DEFAULT 0,
  column_type TEXT DEFAULT 'text',         -- text, number, currency, date
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(source_table, column_name)
);
```

2. Enable RLS and create policies (same pattern as inventory_column_config):
- SELECT: authenticated users
- ALL: admins only

3. Create updated_at trigger

4. Create sync_export_columns() function:
```sql
CREATE OR REPLACE FUNCTION public.sync_export_columns()
RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE
  col RECORD;
  col_order INT := 0;
  tbl TEXT;
BEGIN
  FOREACH tbl IN ARRAY ARRAY['rfp_items', 'rfp_match_suggestions']
  LOOP
    FOR col IN
      SELECT column_name, data_type
      FROM information_schema.columns
      WHERE table_schema = 'public' AND table_name = tbl
      ORDER BY ordinal_position
    LOOP
      INSERT INTO public.export_column_config (
        source_table, column_name, display_name, visible, display_order, column_type
      ) VALUES (
        tbl,
        col.column_name,
        INITCAP(REPLACE(col.column_name, '_', ' ')),
        CASE WHEN col.column_name IN ('id', 'created_at', 'updated_at', 'embedding')
             THEN false ELSE true END,
        col_order,
        CASE
          WHEN col.data_type IN ('numeric', 'decimal', 'money') THEN 'currency'
          WHEN col.data_type IN ('integer', 'bigint', 'smallint', 'real', 'double precision') THEN 'number'
          WHEN col.data_type IN ('timestamp', 'timestamptz', 'date', 'time') THEN 'date'
          ELSE 'text'
        END
      ) ON CONFLICT (source_table, column_name) DO NOTHING;
      col_order := col_order + 1;
    END LOOP;
  END LOOP;
END;
$$;
```

5. Run initial sync:
```sql
SELECT public.sync_export_columns();
```

Include header comments with instructions.
  </action>
  <verify>
File exists: `ls supabase/migrations/20260125_export_column_config.sql`
Table creation: `grep "CREATE TABLE.*export_column_config" supabase/migrations/20260125_export_column_config.sql`
Sync function: `grep "sync_export_columns" supabase/migrations/20260125_export_column_config.sql`
Both tables referenced: `grep "rfp_items.*rfp_match_suggestions" supabase/migrations/20260125_export_column_config.sql`
  </verify>
  <done>export_column_config migration exists with table, RLS, sync function, and initial data population</done>
</task>

</tasks>

<verification>
1. Both migration files exist in supabase/migrations/
2. app_settings uses single-row pattern with CHECK constraint
3. export_column_config has UNIQUE constraint on (source_table, column_name)
4. Both tables have RLS enabled with proper admin-only write policies
5. sync_export_columns() function iterates both rfp_items and rfp_match_suggestions
6. SQL syntax is valid (proper escaping, semicolons, comments)
</verification>

<success_criteria>
- Two SQL migration files created with proper structure
- Single-row pattern enforced for app_settings
- Auto-discovery function for export columns
- RLS policies protect admin-only writes
- Ready for manual execution in Supabase Dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/09-export-email-admin/09-01-SUMMARY.md`
</output>
