---
phase: 09-export-email-admin
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/admin/users/page.tsx
  - src/app/(dashboard)/admin/users/user-actions.tsx
  - src/app/(dashboard)/admin/users/actions.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Approved users table shows role dropdown (Utilizador/Admin) for each user"
    - "Role changes persist to profiles table immediately"
    - "Approved users table shows delete button for each user (except current user)"
    - "Delete button shows confirmation dialog before deleting"
    - "Deleting user removes from auth.users and cascades to profiles"
  artifacts:
    - path: "src/app/(dashboard)/admin/users/page.tsx"
      provides: "Enhanced approved users table with role and delete columns"
      contains: "RoleDropdown"
    - path: "src/app/(dashboard)/admin/users/user-actions.tsx"
      provides: "RoleDropdown and DeleteUserButton components"
      exports: ["RoleDropdown", "DeleteUserButton"]
    - path: "src/app/(dashboard)/admin/users/actions.ts"
      provides: "updateUserRole and deleteUser server actions"
      exports: ["updateUserRole", "deleteUser"]
  key_links:
    - from: "RoleDropdown"
      to: "updateUserRole"
      via: "onValueChange handler"
      pattern: "updateUserRole"
    - from: "DeleteUserButton"
      to: "deleteUser"
      via: "AlertDialog action"
      pattern: "deleteUser"
---

<objective>
Enhance admin users page with role management and user deletion.

Purpose: Allow admins to change user roles and remove users from the system.
Output: Role dropdown and delete button in approved users table with server actions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/plans/2026-01-25-phase9-export-email-admin-design.md

# Current implementation
@src/app/(dashboard)/admin/users/page.tsx
@src/app/(dashboard)/admin/users/user-actions.tsx
@src/app/(dashboard)/admin/users/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add updateUserRole and deleteUser server actions</name>
  <files>src/app/(dashboard)/admin/users/actions.ts</files>
  <action>
Add two new server actions to the existing actions.ts file:

1. Add updateUserRole action:
```typescript
export async function updateUserRole(userId: string, role: 'user' | 'admin') {
  await requireAdmin()

  const supabase = await createClient()

  // Prevent changing own role (safety)
  const { data: { user } } = await supabase.auth.getUser()
  if (user?.id === userId) {
    return { error: 'Nao pode alterar a sua propria funcao' }
  }

  const { error } = await supabase
    .from('profiles')
    .update({ role })
    .eq('id', userId)

  if (error) {
    console.error('updateUserRole error:', error)
    return { error: error.message }
  }

  revalidatePath('/admin/users')
  return { success: true }
}
```

2. Add deleteUser action:
```typescript
export async function deleteUser(userId: string) {
  await requireAdmin()

  const supabase = await createClient()

  // Prevent deleting self
  const { data: { user } } = await supabase.auth.getUser()
  if (user?.id === userId) {
    return { error: 'Nao pode eliminar a sua propria conta' }
  }

  // Delete via admin API (cascades to profiles via FK)
  const admin = createAdminClient()
  const { error } = await admin.auth.admin.deleteUser(userId)

  if (error) {
    console.error('deleteUser error:', error)
    return { error: error.message }
  }

  revalidatePath('/admin/users')
  return { success: true }
}
```

Note: The admin client import should already exist from the existing actions.
  </action>
  <verify>
updateUserRole exists: `grep "export async function updateUserRole" src/app/(dashboard)/admin/users/actions.ts`
deleteUser exists: `grep "export async function deleteUser" src/app/(dashboard)/admin/users/actions.ts`
Self-protection: `grep "Nao pode" src/app/(dashboard)/admin/users/actions.ts`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>updateUserRole and deleteUser server actions added with self-protection</done>
</task>

<task type="auto">
  <name>Task 2: Create RoleDropdown and DeleteUserButton components</name>
  <files>src/app/(dashboard)/admin/users/user-actions.tsx</files>
  <action>
Add new components to the existing user-actions.tsx file:

1. Add imports at top:
```typescript
import { useState } from 'react'
import { updateUserRole, deleteUser } from './actions'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog'
import { Trash2, Loader2 } from 'lucide-react'
import { toast } from 'sonner'
```

2. Add RoleDropdown component:
```typescript
interface RoleDropdownProps {
  userId: string
  currentRole: string
  isCurrentUser: boolean
}

export function RoleDropdown({ userId, currentRole, isCurrentUser }: RoleDropdownProps) {
  const [isUpdating, setIsUpdating] = useState(false)

  const handleRoleChange = async (newRole: string) => {
    if (newRole === currentRole) return

    setIsUpdating(true)
    try {
      const result = await updateUserRole(userId, newRole as 'user' | 'admin')
      if (result.success) {
        toast.success('Funcao atualizada')
      } else {
        toast.error(result.error || 'Erro ao atualizar funcao')
      }
    } catch (error) {
      toast.error('Erro ao atualizar funcao')
    } finally {
      setIsUpdating(false)
    }
  }

  return (
    <Select
      value={currentRole}
      onValueChange={handleRoleChange}
      disabled={isUpdating || isCurrentUser}
    >
      <SelectTrigger className="w-32">
        {isUpdating ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <SelectValue />
        )}
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="user">Utilizador</SelectItem>
        <SelectItem value="admin">Admin</SelectItem>
      </SelectContent>
    </Select>
  )
}
```

3. Add DeleteUserButton component:
```typescript
interface DeleteUserButtonProps {
  userId: string
  userEmail: string
  isCurrentUser: boolean
}

export function DeleteUserButton({ userId, userEmail, isCurrentUser }: DeleteUserButtonProps) {
  const [isDeleting, setIsDeleting] = useState(false)

  const handleDelete = async () => {
    setIsDeleting(true)
    try {
      const result = await deleteUser(userId)
      if (result.success) {
        toast.success('Utilizador eliminado')
      } else {
        toast.error(result.error || 'Erro ao eliminar utilizador')
      }
    } catch (error) {
      toast.error('Erro ao eliminar utilizador')
    } finally {
      setIsDeleting(false)
    }
  }

  if (isCurrentUser) {
    return null // Don't show delete for current user
  }

  return (
    <AlertDialog>
      <AlertDialogTrigger asChild>
        <Button variant="ghost" size="icon" disabled={isDeleting}>
          {isDeleting ? (
            <Loader2 className="h-4 w-4 animate-spin" />
          ) : (
            <Trash2 className="h-4 w-4 text-destructive" />
          )}
        </Button>
      </AlertDialogTrigger>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Eliminar utilizador?</AlertDialogTitle>
          <AlertDialogDescription>
            Tem a certeza que pretende eliminar <strong>{userEmail}</strong>?
            Esta acao nao pode ser revertida.
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>Cancelar</AlertDialogCancel>
          <AlertDialogAction onClick={handleDelete} className="bg-destructive hover:bg-destructive/90">
            Eliminar
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  )
}
```
  </action>
  <verify>
RoleDropdown exists: `grep "export function RoleDropdown" src/app/(dashboard)/admin/users/user-actions.tsx`
DeleteUserButton exists: `grep "export function DeleteUserButton" src/app/(dashboard)/admin/users/user-actions.tsx`
Select import: `grep "Select," src/app/(dashboard)/admin/users/user-actions.tsx`
AlertDialog import: `grep "AlertDialog" src/app/(dashboard)/admin/users/user-actions.tsx`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>RoleDropdown and DeleteUserButton components added with proper UI</done>
</task>

<task type="auto">
  <name>Task 3: Update admin users page to use new components</name>
  <files>src/app/(dashboard)/admin/users/page.tsx</files>
  <action>
Update the page to include new columns and components:

1. Add imports:
```typescript
import { RoleDropdown, DeleteUserButton } from './user-actions'
```

2. Get current user ID for comparison (add after profiles fetch):
```typescript
const { data: { user: currentUser } } = await supabase.auth.getUser()
const currentUserId = currentUser?.id
```

3. Update the approved users table to add new columns.

Update TableHeader:
```tsx
<TableHeader>
  <TableRow>
    <TableHead>Email</TableHead>
    <TableHead className="w-[140px]">Funcao</TableHead>
    <TableHead className="w-[1%]">Aprovado</TableHead>
    <TableHead className="w-[1%]">Registado</TableHead>
    <TableHead className="w-[1%] text-right">Acoes</TableHead>
  </TableRow>
</TableHeader>
```

Update TableBody row for each approved user:
```tsx
{approvedUsers.map((user) => {
  const profile = profilesMap.get(user.id)
  const isCurrentUser = user.id === currentUserId
  return (
    <TableRow key={user.id}>
      <TableCell className="font-medium">
        {user.email}
        {isCurrentUser && (
          <span className="ml-2 text-xs text-muted-foreground">(voce)</span>
        )}
      </TableCell>
      <TableCell>
        <RoleDropdown
          userId={user.id}
          currentRole={profile?.role || 'user'}
          isCurrentUser={isCurrentUser}
        />
      </TableCell>
      <TableCell>
        {profile?.approved_at
          ? new Date(profile.approved_at).toLocaleDateString('pt-PT')
          : '-'}
      </TableCell>
      <TableCell>
        {new Date(user.created_at).toLocaleDateString('pt-PT')}
      </TableCell>
      <TableCell className="text-right">
        <DeleteUserButton
          userId={user.id}
          userEmail={user.email || ''}
          isCurrentUser={isCurrentUser}
        />
      </TableCell>
    </TableRow>
  )
})}
```

Remove the Badge for role since we now have the dropdown.
  </action>
  <verify>
RoleDropdown import: `grep "RoleDropdown" src/app/(dashboard)/admin/users/page.tsx`
DeleteUserButton import: `grep "DeleteUserButton" src/app/(dashboard)/admin/users/page.tsx`
Current user check: `grep "currentUserId\|isCurrentUser" src/app/(dashboard)/admin/users/page.tsx`
Acoes column: `grep "Acoes" src/app/(dashboard)/admin/users/page.tsx`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Admin users page shows role dropdown and delete button for approved users</done>
</task>

</tasks>

<verification>
1. updateUserRole server action changes role in profiles table
2. deleteUser server action removes user via admin API
3. Both actions prevent self-modification
4. RoleDropdown shows current role and allows changing
5. RoleDropdown is disabled for current user
6. DeleteUserButton shows confirmation dialog
7. DeleteUserButton is hidden for current user
8. Current user marked with "(voce)" label
9. TypeScript compiles without errors
10. Page revalidates after changes
</verification>

<success_criteria>
- Admins can change user roles via dropdown
- Admins can delete users via confirmation dialog
- Current user cannot change own role or delete self
- Changes persist immediately to database
- UI provides feedback via toast notifications
</success_criteria>

<output>
After completion, create `.planning/phases/09-export-email-admin/09-06-SUMMARY.md`
</output>
