---
phase: 09-export-email-admin
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/rfps/components/confirmation-summary.tsx
  - src/app/(dashboard)/rfps/components/export-download-dialog.tsx
  - src/app/(dashboard)/rfps/components/export-dialog.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Exportar button in ConfirmationSummary opens a dropdown menu with two options"
    - "Transferir Excel option opens ExportDownloadDialog"
    - "Enviar por Email option opens ExportEmailDialog (handled in 09-03)"
    - "ExportDownloadDialog allows selecting export mode (matched/all) and downloading"
    - "Old combined ExportDialog is deleted and replaced with new split dialogs"
  artifacts:
    - path: "src/app/(dashboard)/rfps/components/confirmation-summary.tsx"
      provides: "Dropdown menu with export options"
      contains: "DropdownMenu"
    - path: "src/app/(dashboard)/rfps/components/export-download-dialog.tsx"
      provides: "Dialog for Excel download"
      exports: ["ExportDownloadDialog"]
  key_links:
    - from: "ConfirmationSummary"
      to: "ExportDownloadDialog"
      via: "downloadDialogOpen state"
      pattern: "setDownloadDialogOpen\\(true\\)"
    - from: "ExportDownloadDialog"
      to: "rfp-export.ts"
      via: "exportRFPToExcel function"
      pattern: "exportRFPToExcel"
---

<objective>
Split ExportDialog into dropdown with ExportDownloadDialog for direct download.

Purpose: Separate download and email flows for cleaner UX and easier admin configuration.
Output: ConfirmationSummary with dropdown, new ExportDownloadDialog component, old ExportDialog deleted.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/plans/2026-01-25-phase9-export-email-admin-design.md

# Current implementation to replace
@src/app/(dashboard)/rfps/components/confirmation-summary.tsx
@src/app/(dashboard)/rfps/components/export-dialog.tsx

# Export logic (stays unchanged)
@src/lib/export/rfp-export.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExportDownloadDialog component</name>
  <files>src/app/(dashboard)/rfps/components/export-download-dialog.tsx</files>
  <action>
Create new dialog component for Excel download:

```typescript
'use client'

import { useState, useMemo } from 'react'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Label } from '@/components/ui/label'
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group'
import { Download, Loader2, Check, AlertCircle } from 'lucide-react'
import { toast } from 'sonner'
import type { RFPItemWithMatches } from '@/types/rfp'
import {
  transformToExportRows,
  calculateExportSummary,
  exportRFPToExcel,
} from '@/lib/export/rfp-export'

interface ExportDownloadDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  items: RFPItemWithMatches[]
}

export function ExportDownloadDialog({ open, onOpenChange, items }: ExportDownloadDialogProps) {
  const [exportMode, setExportMode] = useState<'matched' | 'all'>('matched')
  const [isExporting, setIsExporting] = useState(false)

  // Calculate summary and row counts
  const { matchedCount, noMatchCount, totalRows } = useMemo(() => {
    const summary = calculateExportSummary(items)
    const matched = summary.confirmedCount + summary.manualCount
    const noMatch = summary.rejectedCount + summary.noMatchCount
    const confirmedOnly = exportMode === 'matched'
    const rows = transformToExportRows(items, confirmedOnly)

    return {
      matchedCount: matched,
      noMatchCount: noMatch,
      totalRows: rows.length,
    }
  }, [items, exportMode])

  const handleExport = async () => {
    if (totalRows === 0) {
      toast.error('Sem dados para exportar')
      return
    }

    setIsExporting(true)
    setTimeout(() => {
      try {
        const confirmedOnly = exportMode === 'matched'
        exportRFPToExcel(items, confirmedOnly, 'RFP_Resultados')
        toast.success('Ficheiro Excel transferido')
        onOpenChange(false)
      } catch (error) {
        console.error('Export failed:', error)
        toast.error('Erro ao exportar ficheiro')
      } finally {
        setIsExporting(false)
      }
    }, 0)
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[420px]">
        <DialogHeader>
          <DialogTitle>Transferir Excel</DialogTitle>
          <DialogDescription>
            Exporte os resultados da revisao para Excel.
          </DialogDescription>
        </DialogHeader>

        {/* Summary stats - compact inline */}
        <div className="flex items-center justify-center gap-6 py-3">
          <div className="flex items-center gap-2">
            <div className="flex items-center justify-center h-6 w-6 rounded-full bg-emerald-100">
              <Check className="h-3.5 w-3.5 text-emerald-600" />
            </div>
            <span className="text-lg font-semibold text-emerald-700">{matchedCount}</span>
            <span className="text-xs text-muted-foreground">Correspondencias</span>
          </div>
          <div className="h-5 w-px bg-border" />
          <div className="flex items-center gap-2">
            <div className="flex items-center justify-center h-6 w-6 rounded-full bg-gray-100">
              <AlertCircle className="h-3.5 w-3.5 text-gray-500" />
            </div>
            <span className="text-lg font-semibold text-gray-700">{noMatchCount}</span>
            <span className="text-xs text-muted-foreground">Sem correspondencia</span>
          </div>
        </div>

        {/* Export mode selection */}
        <div className="space-y-3 py-3 border-t">
          <Label className="text-sm font-medium">Incluir na exportacao</Label>
          <RadioGroup
            value={exportMode}
            onValueChange={(value) => setExportMode(value as 'matched' | 'all')}
            className="space-y-2"
          >
            <div className="flex items-center space-x-3">
              <RadioGroupItem value="matched" id="matched" />
              <Label htmlFor="matched" className="cursor-pointer font-normal">
                Apenas correspondencias ({matchedCount} {matchedCount === 1 ? 'produto' : 'produtos'})
              </Label>
            </div>
            <div className="flex items-center space-x-3">
              <RadioGroupItem value="all" id="all" />
              <Label htmlFor="all" className="cursor-pointer font-normal">
                Todos os produtos ({items.length} {items.length === 1 ? 'produto' : 'produtos'})
              </Label>
            </div>
          </RadioGroup>
        </div>

        <DialogFooter className="gap-3 pt-2">
          <Button variant="outline" onClick={() => onOpenChange(false)} disabled={isExporting}>
            Cancelar
          </Button>
          <Button onClick={handleExport} disabled={isExporting || totalRows === 0}>
            {isExporting ? (
              <>
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                A exportar...
              </>
            ) : (
              <>
                <Download className="mr-2 h-4 w-4" />
                Transferir Excel
              </>
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

Note: Keep Portuguese accents in text content (revisao, Correspondencias, exportacao). Dialog closes after successful download.
  </action>
  <verify>
File exists: `ls src/app/(dashboard)/rfps/components/export-download-dialog.tsx`
Export present: `grep "export function ExportDownloadDialog" src/app/(dashboard)/rfps/components/export-download-dialog.tsx`
Uses export function: `grep "exportRFPToExcel" src/app/(dashboard)/rfps/components/export-download-dialog.tsx`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>ExportDownloadDialog component exists with export mode selection and download functionality</done>
</task>

<task type="auto">
  <name>Task 2: Update ConfirmationSummary with dropdown menu</name>
  <files>src/app/(dashboard)/rfps/components/confirmation-summary.tsx</files>
  <action>
Update ConfirmationSummary to use dropdown menu instead of single button:

1. Update imports:
   - Remove `ExportDialog` import
   - Add `ExportDownloadDialog` import
   - Add DropdownMenu imports from shadcn/ui:
     ```typescript
     import {
       DropdownMenu,
       DropdownMenuContent,
       DropdownMenuItem,
       DropdownMenuTrigger,
     } from '@/components/ui/dropdown-menu'
     ```
   - Add `ChevronDown, Mail` icons from lucide-react

2. Replace state:
   - Change `exportDialogOpen` to `downloadDialogOpen`
   - Add `emailDialogOpen` state (will be used by 09-03)

3. Replace the Button with DropdownMenu:
```tsx
<DropdownMenu>
  <DropdownMenuTrigger asChild>
    <Button className="w-full" disabled={!allDecided || !hasMatches}>
      {allDecided
        ? <>Exportar <ChevronDown className="ml-2 h-4 w-4" /></>
        : `${stats.pending} ${stats.pending === 1 ? 'produto' : 'produtos'} por rever`}
    </Button>
  </DropdownMenuTrigger>
  <DropdownMenuContent align="end" className="w-48">
    <DropdownMenuItem onClick={() => setDownloadDialogOpen(true)}>
      <Download className="mr-2 h-4 w-4" />
      Transferir Excel
    </DropdownMenuItem>
    <DropdownMenuItem onClick={() => setEmailDialogOpen(true)}>
      <Mail className="mr-2 h-4 w-4" />
      Enviar por Email
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

4. Replace ExportDialog with ExportDownloadDialog:
```tsx
<ExportDownloadDialog
  open={downloadDialogOpen}
  onOpenChange={setDownloadDialogOpen}
  items={items}
/>
```

5. Add placeholder for ExportEmailDialog (will be implemented in 09-03):
```tsx
{/* ExportEmailDialog - implemented in plan 09-03 */}
{emailDialogOpen && (
  <div>Email dialog placeholder</div>
)}
```

Keep all existing stat calculations and warning messages unchanged.
  </action>
  <verify>
DropdownMenu imported: `grep "DropdownMenu" src/app/(dashboard)/rfps/components/confirmation-summary.tsx`
Both dialogs have state: `grep "downloadDialogOpen\|emailDialogOpen" src/app/(dashboard)/rfps/components/confirmation-summary.tsx`
ExportDownloadDialog used: `grep "ExportDownloadDialog" src/app/(dashboard)/rfps/components/confirmation-summary.tsx`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>ConfirmationSummary uses dropdown with Transferir Excel and Enviar por Email options</done>
</task>

<task type="auto">
  <name>Task 3: Delete old ExportDialog</name>
  <files>src/app/(dashboard)/rfps/components/export-dialog.tsx</files>
  <action>
Delete the old combined export-dialog.tsx file.

The functionality has been split:
- Download: ExportDownloadDialog (created in Task 1)
- Email: ExportEmailDialog (created in plan 09-03)

Use rm or delete the file:
```bash
rm src/app/(dashboard)/rfps/components/export-dialog.tsx
```

Verify no other files import from export-dialog.tsx (should only have been confirmation-summary.tsx which was updated).
  </action>
  <verify>
File deleted: `! ls src/app/(dashboard)/rfps/components/export-dialog.tsx 2>/dev/null && echo "Deleted"`
No imports remain: `! grep -r "from.*export-dialog" src/app --include="*.tsx" --include="*.ts" 2>/dev/null | grep -v "export-download-dialog\|export-email-dialog" && echo "No old imports"`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Old export-dialog.tsx is deleted; all exports now use new split dialogs</done>
</task>

</tasks>

<verification>
1. ExportDownloadDialog component exists and exports properly
2. ConfirmationSummary shows dropdown with two options
3. "Transferir Excel" opens ExportDownloadDialog
4. "Enviar por Email" sets emailDialogOpen (placeholder until 09-03)
5. Old export-dialog.tsx is deleted
6. TypeScript compiles without errors
7. Export functionality works as before (same export logic)
</verification>

<success_criteria>
- Dropdown menu replaces single export button
- Download dialog works identically to old combined dialog
- Email dialog state is ready for 09-03 implementation
- No regression in export functionality
- Clean component separation
</success_criteria>

<output>
After completion, create `.planning/phases/09-export-email-admin/09-02-SUMMARY.md`
</output>
