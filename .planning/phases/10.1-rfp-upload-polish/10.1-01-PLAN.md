---
phase: 10.1-rfp-upload-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/rfps/components/match-review-table.tsx
autonomous: true

must_haves:
  truths:
    - "User clicks sort header and table data refreshes with new sort order"
    - "URL updates reflect the current sort state"
    - "Loading state shows during sort transition"
  artifacts:
    - path: "src/app/(dashboard)/rfps/components/match-review-table.tsx"
      provides: "Match review table with working sorting"
      contains: "startTransition"
  key_links:
    - from: "match-review-table.tsx"
      to: "nuqs useQueryStates"
      via: "startTransition option"
      pattern: "startTransition.*shallow.*false"
---

<objective>
Fix the critical bug where match review table sorting updates the URL but doesn't refresh the data.

Purpose: The sorting is broken because nuqs v2+ requires `startTransition` to be passed alongside `shallow: false` to trigger a proper server component re-render. Currently the URL updates but the server data doesn't reload.

Output: Working table sorting where clicking column headers refreshes the data correctly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.1-rfp-upload-polish/10.1-CONTEXT.md
@.planning/phases/10.1-rfp-upload-polish/10.1-RESEARCH.md
@src/app/(dashboard)/rfps/components/match-review-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add startTransition to nuqs configuration</name>
  <files>src/app/(dashboard)/rfps/components/match-review-table.tsx</files>
  <action>
Modify match-review-table.tsx to fix the sorting bug:

1. Import `useTransition` from React (already imported but not used for nuqs)
2. Create the transition state at component level:
   ```typescript
   const [isPending, startTransition] = useTransition()
   ```

3. Pass `startTransition` to the nuqs useQueryStates options:
   ```typescript
   const [{ page, pageSize, search, status, sortBy, sortDir }, setParams] = useQueryStates(
     {
       page: parseAsInteger.withDefault(1),
       pageSize: parseAsInteger.withDefault(25),
       search: parseAsString.withDefault(''),
       status: parseAsString.withDefault('all'),
       sortBy: parseAsString.withDefault('lote'),
       sortDir: parseAsString.withDefault('asc'),
     },
     {
       shallow: false,
       startTransition, // CRITICAL: Required for server re-render
     }
   )
   ```

4. Remove the manual navigation state management:
   - Remove `const [isNavigating, setIsNavigating] = useState(false)`
   - Remove `const navigationTimeoutRef = useRef<NodeJS.Timeout | null>(null)`
   - Remove the useEffect that clears navigation state
   - Remove the cleanup useEffect for the timeout
   - Remove the `navigate` helper function

5. Update all handlers to call `setParams` directly (no need to wrap in navigate):
   - `handleSearchChange`: Just call `setParams({ search: value || null, page: 1 })`
   - `handleStatusChange`: Just call `setParams({ status: ..., page: 1 })`
   - `handleSortChange`: Just call `setParams({ sortBy, sortDir, page: 1 })`
   - `handlePageChange`: Just call `setParams({ page: ... })`
   - `handlePageSizeChange`: Just call `setParams({ pageSize, page: 1 })`
   - `handleClearFilters`: Just call `setParams({ search: null, status: null, page: 1 })`

6. The `isPending` from useTransition will now correctly track loading state - no changes needed to where isPending is used.

Why this fixes the bug: nuqs v2+ requires startTransition to properly notify React that a server component re-render is needed. Without it, shallow: false updates the URL but the router doesn't trigger a new server request.
  </action>
  <verify>
1. Run `npm run build` to verify no TypeScript errors
2. Start dev server with `npm run dev`
3. Navigate to `/rfps/{id}/matches` for any completed RFP
4. Click "Lote" column header - URL should update AND data should re-sort
5. Click "Posicao" column header - URL should update AND data should re-sort
6. Click "Estado" column header - URL should update AND data should re-sort
7. Verify loading state appears briefly during sort transition
  </verify>
  <done>
- Clicking any sortable column header updates URL AND refreshes data
- Loading indicator shows during sort transition
- No manual isNavigating state or timeouts needed
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Sorting works end-to-end: click header -> URL changes -> data refreshes -> new order displayed
3. Loading state visible during transitions
4. No console errors related to nuqs or navigation
</verification>

<success_criteria>
- Match review table sorting fully functional
- URL and data stay in sync
- isPending from useTransition provides loading feedback
</success_criteria>

<output>
After completion, create `.planning/phases/10.1-rfp-upload-polish/10.1-01-SUMMARY.md`
</output>
