# Phase 10.1: RFP Upload Polish - Research

**Researched:** 2026-01-23
**Domain:** Next.js App Router, nuqs URL state, Supabase RLS, Multi-file upload
**Confidence:** HIGH

## Summary

This research covers five planned tasks for Phase 10.1: fixing the match review table sorting bug, implementing 3-state KPI calculations with confirmation workflow, adding multi-RFP upload support, enabling multi-user visibility with real-time sync, and displaying uploader/editor information with table design alignment.

The codebase uses nuqs v2.8.6 with Next.js 16 for URL state management, Supabase Realtime for live updates, and a fire-and-forget webhook pattern for n8n processing. The sorting bug is a nuqs configuration issue requiring `startTransition` to be passed alongside `shallow: false`. Multi-upload requires queue management in context state. Multi-user requires RLS policy updates to remove user_id filtering.

**Primary recommendation:** Fix sorting by adding `startTransition` option to nuqs configuration; implement upload queue as separate state in existing context; update RLS policies to allow all authenticated users access.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| nuqs | 2.8.6 | URL state management | Already in use, type-safe search params |
| @supabase/supabase-js | 2.91.0 | Database & Realtime | Already in use, established pattern |
| sonner | 2.0.7 | Toast notifications | Already in use for upload feedback |
| date-fns | 4.1.0 | Date formatting | Already in use with pt locale |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| react-dropzone | 14.3.8 | File upload dropzone | Already in use for PDF upload |
| framer-motion | 12.29.0 | Animations | For progress bar animations |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Custom queue state | zustand | zustand adds complexity; React context sufficient for this scope |
| Manual polling | Supabase Realtime | Realtime already set up, more efficient |

**Installation:**
```bash
# No new packages needed - all dependencies already installed
```

## Architecture Patterns

### Current Project Structure
```
src/
├── app/(dashboard)/rfps/
│   ├── page.tsx                      # RFP list page (server component)
│   ├── actions.ts                    # Server actions (triggerRFPUpload, deleteRFPJob)
│   ├── components/
│   │   ├── rfp-upload-button.tsx     # Upload trigger (uses context)
│   │   ├── rfp-upload-dialog.tsx     # Single file upload dialog
│   │   ├── pdf-dropzone.tsx          # Dropzone component
│   │   ├── rfp-processing-card.tsx   # Processing progress (uses context)
│   │   ├── rfp-jobs-list.tsx         # Jobs history list
│   │   ├── rfp-stats.tsx             # KPI cards (server component)
│   │   ├── match-review-table.tsx    # Match review with sorting (NEEDS FIX)
│   │   └── review-stats-chips.tsx    # Per-RFP stats chips
│   └── [id]/matches/
│       ├── page.tsx                  # Match review page (server component)
│       └── actions.ts                # Match accept/reject actions
├── contexts/
│   └── rfp-upload-status-context.tsx # Single job tracking (NEEDS MULTI-UPLOAD)
├── hooks/
│   └── use-rfp-upload-status.ts      # Re-export (deprecated)
├── lib/n8n/
│   └── rfp-webhook.ts                # Webhook trigger (fire-and-forget)
└── types/
    └── rfp.ts                        # RFP types
```

### Pattern 1: nuqs with startTransition for Server Re-render
**What:** Pass `startTransition` to nuqs options alongside `shallow: false` to trigger proper server component re-render
**When to use:** Any nuqs useQueryStates that needs server-side sorting/filtering
**Example:**
```typescript
// Source: https://nuqs.dev/docs/options
'use client'
import { useTransition } from 'react'
import { useQueryStates, parseAsInteger, parseAsString } from 'nuqs'

export function MatchReviewTable({ items, initialState }) {
  const [isPending, startTransition] = useTransition()

  const [{ page, sortBy, sortDir }, setParams] = useQueryStates(
    {
      page: parseAsInteger.withDefault(1),
      sortBy: parseAsString.withDefault('lote'),
      sortDir: parseAsString.withDefault('asc'),
    },
    {
      shallow: false,
      startTransition, // CRITICAL: Required for server re-render
    }
  )

  const handleSortChange = (column: string) => {
    const newDir = sortBy === column && sortDir === 'asc' ? 'desc' : 'asc'
    // setParams will now trigger server re-render
    setParams({ sortBy: column, sortDir: newDir, page: 1 })
  }
}
```

### Pattern 2: Multi-Upload Queue in Context
**What:** Extend existing RFPUploadStatusContext to track multiple concurrent uploads
**When to use:** When transitioning from single to multi-file upload
**Example:**
```typescript
// Extend existing context
interface RFPUploadJob {
  id: string
  file_name: string
  status: 'pending' | 'processing' | 'completed' | 'failed'
  created_at: string
  // ... existing fields
}

interface RFPUploadStatusContextValue {
  // Existing (keep for backward compat)
  activeJob: RFPUploadJob | null
  isProcessing: boolean

  // New for multi-upload
  uploadQueue: RFPUploadJob[]      // All jobs being tracked
  processingCount: number          // Count of pending/processing
  queueFile: (file: File) => void  // Add to queue
  maxConcurrent: number            // 10 as per spec
}
```

### Pattern 3: RLS Policy for Multi-User Access
**What:** Update RLS policies to allow all authenticated users to access all RFPs
**When to use:** When removing user_id filtering for collaborative access
**Example:**
```sql
-- Drop existing user-specific policies
DROP POLICY IF EXISTS "Users can view own rfp jobs" ON rfp_upload_jobs;
DROP POLICY IF EXISTS "Users can view own rfp items" ON rfp_items;

-- Create new policies for all authenticated users
CREATE POLICY "Authenticated users can view all rfp jobs"
  ON rfp_upload_jobs
  FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY "Authenticated users can update all rfp jobs"
  ON rfp_upload_jobs
  FOR UPDATE
  TO authenticated
  USING (true);
```

### Anti-Patterns to Avoid
- **Don't use router.refresh():** Causes full page reload, loses client state. Use nuqs with startTransition instead.
- **Don't disable upload button during processing:** Per spec, button should NEVER be disabled. Queue jobs instead.
- **Don't filter by user_id in client code:** Remove filtering at RLS level, not just client queries.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| URL state sync | Custom router.push | nuqs useQueryStates | Type-safe, handles serialization, server re-render support |
| Real-time updates | Polling intervals | Supabase Realtime | Already configured, more efficient |
| Progress tracking | Custom state + timers | Extend existing context | Context already has Realtime subscription |
| File queue management | Custom queue class | Array state in context | React state sufficient for 10 items max |

**Key insight:** The codebase already has all necessary infrastructure. The work is configuration fixes and extensions, not new architecture.

## Common Pitfalls

### Pitfall 1: nuqs shallow:false Without startTransition
**What goes wrong:** URL updates but server component doesn't re-render with new data
**Why it happens:** nuqs v2+ requires explicit startTransition for server re-render notification
**How to avoid:** Always pass `startTransition` when using `shallow: false`
**Warning signs:** URL shows new params but table/list data unchanged

### Pitfall 2: Removing user_id Filter Only in Client Code
**What goes wrong:** RLS still blocks other users' data
**Why it happens:** Supabase RLS evaluates at database level, not client
**How to avoid:** Update RLS policies in migration, not just client queries
**Warning signs:** Empty results for non-owner users despite query changes

### Pitfall 3: Using Single activeJob for Multi-Upload
**What goes wrong:** New upload overwrites previous upload state
**Why it happens:** Current context designed for single job tracking
**How to avoid:** Change to array-based queue, keep activeJob for backward compat
**Warning signs:** Progress shows wrong file, completed toasts for wrong job

### Pitfall 4: Realtime Subscription Filter After Multi-User
**What goes wrong:** Users don't see other users' changes in real-time
**Why it happens:** Current Realtime subscription filters by user_id
**How to avoid:** Remove user_id filter from Realtime subscription
**Warning signs:** Changes appear on refresh but not in real-time

### Pitfall 5: Confirmation Status Without Database Column
**What goes wrong:** Confirmation state lost on page refresh
**Why it happens:** Using client-side state instead of persisting to database
**How to avoid:** Add `confirmed_at` column to rfp_upload_jobs table
**Warning signs:** User clicks Confirm, refreshes, RFP shows as unconfirmed

## Code Examples

### Fix 1: Match Review Table Sorting (Plan 10.1-01)
```typescript
// Source: Codebase analysis + nuqs docs
// File: src/app/(dashboard)/rfps/components/match-review-table.tsx

export function MatchReviewTable({ jobId, items, totalCount, initialState }) {
  // Use startTransition for server re-render
  const [isPending, startTransition] = useTransition()

  const [{ page, pageSize, search, status, sortBy, sortDir }, setParams] = useQueryStates(
    {
      page: parseAsInteger.withDefault(1),
      pageSize: parseAsInteger.withDefault(25),
      search: parseAsString.withDefault(''),
      status: parseAsString.withDefault('all'),
      sortBy: parseAsString.withDefault('lote'),
      sortDir: parseAsString.withDefault('asc'),
    },
    {
      shallow: false,
      startTransition, // ADD THIS - triggers server re-render
    }
  )

  // Remove manual isNavigating state - use isPending from useTransition
  // Remove navigationTimeoutRef - no longer needed

  const handleSortChange = (column: SortColumn) => {
    const newDir = sortBy === column && sortDir === 'asc' ? 'desc' : 'asc'
    setParams({ sortBy: column, sortDir: newDir, page: 1 })
  }

  // isPending from useTransition handles loading state automatically
}
```

### Fix 2: KPI 3-State Model (Plan 10.1-02)
```typescript
// Source: Codebase analysis
// File: src/app/(dashboard)/rfps/components/rfp-stats.tsx

// Current KPIs: Total, Completed, "Por Rever" (pending items), Failed
// New KPIs: "Por Rever", "Revistos", "Confirmados"

export async function RFPStats() {
  const supabase = await createClient()

  // Remove user_id filter for multi-user
  const { data: jobStats } = await supabase
    .from('rfp_upload_jobs')
    .select('id, status, confirmed_at') // Add confirmed_at
    .eq('status', 'completed')

  // Por Rever: Jobs with at least 1 item that has pending suggestions not decided
  // Query rfp_items where review_status = 'pending' AND has suggestions

  // Revistos: Jobs where all items addressed, but confirmed_at IS NULL
  // All items have review_status != 'pending' (or no suggestions), AND confirmed_at IS NULL

  // Confirmados: Jobs where confirmed_at IS NOT NULL

  // Return 3 KPI chips
}
```

### Fix 3: Multi-Upload Queue (Plan 10.1-03)
```typescript
// Source: Codebase analysis
// File: src/contexts/rfp-upload-status-context.tsx (extend)

interface QueuedUpload {
  file: File
  status: 'queued' | 'uploading' | 'processing' | 'completed' | 'failed'
  jobId?: string
  startedAt?: Date
}

const MAX_CONCURRENT = 10
const WEBHOOK_DELAY_MS = 2500 // 2.5s between n8n triggers

// In provider state:
const [uploadQueue, setUploadQueue] = useState<QueuedUpload[]>([])

// Process queue with delay between webhooks
const processQueue = useCallback(async () => {
  for (const item of uploadQueue.filter(q => q.status === 'queued')) {
    // 1. Create job in DB
    // 2. Wait WEBHOOK_DELAY_MS
    // 3. Trigger webhook
    // 4. Update status to 'processing'
  }
}, [uploadQueue])
```

### Fix 4: RLS Multi-User Migration (Plan 10.1-04)
```sql
-- Source: Codebase analysis
-- File: supabase/migrations/20260124_multi_user_rfp_access.sql

-- 1. Drop user-specific SELECT policies
DROP POLICY IF EXISTS "Users can view own rfp jobs" ON rfp_upload_jobs;
DROP POLICY IF EXISTS "Users can view own rfp items" ON rfp_items;
DROP POLICY IF EXISTS "Users can view own match suggestions" ON rfp_match_suggestions;

-- 2. Create new policies for all authenticated users
CREATE POLICY "Authenticated users can view all rfp jobs"
  ON rfp_upload_jobs FOR SELECT TO authenticated USING (true);

CREATE POLICY "Authenticated users can update all rfp jobs"
  ON rfp_upload_jobs FOR UPDATE TO authenticated USING (true);

CREATE POLICY "Authenticated users can delete all rfp jobs"
  ON rfp_upload_jobs FOR DELETE TO authenticated USING (true);

-- Same for rfp_items and rfp_match_suggestions
-- Keep service_role policies unchanged for n8n

-- 3. Add last_edited_by column
ALTER TABLE rfp_upload_jobs ADD COLUMN IF NOT EXISTS last_edited_by UUID REFERENCES auth.users(id);
ALTER TABLE rfp_upload_jobs ADD COLUMN IF NOT EXISTS confirmed_at TIMESTAMPTZ;

-- 4. Update Realtime subscription (remove user_id filter in client code)
```

### Fix 5: Uploader/Editor Display (Plan 10.1-05)
```typescript
// Source: Codebase analysis
// File: src/app/(dashboard)/rfps/components/rfp-jobs-list.tsx

// Fetch jobs with profile joins
const { data: jobs } = await supabase
  .from('rfp_upload_jobs')
  .select(`
    *,
    uploader:profiles!user_id(email, full_name),
    last_editor:profiles!last_edited_by(email, full_name)
  `)

// Display format: "ha 2 horas . Joao Silva . Editado por Maria"
const formatUserDisplay = (profile: { email: string, full_name?: string }) => {
  return profile.full_name || profile.email
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| nuqs shallow:false only | shallow:false + startTransition | nuqs v2.0 | Server re-render requires both |
| Single upload state | Queue-based multi-upload | This phase | Concurrent processing support |
| User-specific RLS | All authenticated users | This phase | Multi-user collaboration |
| 2 KPI states | 3 KPI states + confirmation | This phase | Better workflow visibility |

**Deprecated/outdated:**
- `useRFPUploadStatus` in hooks/: Deprecated, use context directly
- Manual `isNavigating` state in match-review-table: Replace with useTransition isPending

## Open Questions

Things that couldn't be fully resolved:

1. **Webhook Delay Timing**
   - What we know: Need 2-3s delay between n8n webhook triggers per spec
   - What's unclear: Exact optimal timing depends on n8n workflow capacity
   - Recommendation: Start with 2500ms, make configurable

2. **Queue Overflow UI**
   - What we know: Spec says collapsible section for overflow
   - What's unclear: Exact animation/transition behavior
   - Recommendation: Claude's discretion per CONTEXT.md

3. **Profiles Table Structure**
   - What we know: Profiles table exists with id, email, role
   - What's unclear: Whether full_name column exists
   - Recommendation: Check schema, add if missing, use email as fallback

## Sources

### Primary (HIGH confidence)
- Codebase files: match-review-table.tsx, rfp-upload-status-context.tsx, rfp-stats.tsx
- Codebase files: migrations/20260122_rfp_upload_jobs.sql, 20260122_rfp_match_results.sql
- [nuqs Options Documentation](https://nuqs.dev/docs/options) - startTransition requirement

### Secondary (MEDIUM confidence)
- [nuqs GitHub](https://github.com/47ng/nuqs) - shallow:false behavior
- [LogRocket nuqs Article](https://blog.logrocket.com/managing-search-parameters-next-js-nuqs/) - patterns

### Tertiary (LOW confidence)
- WebSearch results for nuqs/Next.js 16 compatibility - no specific issues found

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries already in use, versions verified
- Architecture: HIGH - Patterns derived from existing codebase
- Pitfalls: HIGH - Based on actual bug report and code analysis

**Research date:** 2026-01-23
**Valid until:** 2026-02-23 (30 days - stable stack)

---

## Plan-Specific Files

### Plan 10.1-01: Fix Match Review Table Sorting
**Files to modify:**
- `src/app/(dashboard)/rfps/components/match-review-table.tsx` - Add startTransition to nuqs config

**Key changes:**
1. Add `const [isPending, startTransition] = useTransition()`
2. Pass `startTransition` to useQueryStates options
3. Remove manual `isNavigating` state and `navigationTimeoutRef`
4. Use `isPending` from useTransition for loading state

### Plan 10.1-02: KPI Calculations and Confirmation Workflow
**Files to modify:**
- `src/app/(dashboard)/rfps/components/rfp-stats.tsx` - Update KPI calculation logic
- `src/app/(dashboard)/rfps/[id]/matches/page.tsx` - Add Confirm button
- `src/app/(dashboard)/rfps/[id]/matches/actions.ts` - Add confirmRFP action
- `supabase/migrations/YYYYMMDD_add_confirmed_at.sql` - Add confirmed_at column

**Key changes:**
1. Add `confirmed_at` column to rfp_upload_jobs
2. Calculate 3 KPI states: Por Rever, Revistos, Confirmados
3. Add Confirm button to match review page header
4. Block export/email until confirmed (export in Phase 9)

### Plan 10.1-03: Multi-Upload Support with Progress UI
**Files to modify:**
- `src/contexts/rfp-upload-status-context.tsx` - Extend for queue management
- `src/app/(dashboard)/rfps/components/rfp-upload-dialog.tsx` - Multi-file selection
- `src/app/(dashboard)/rfps/components/rfp-processing-card.tsx` - Multi-progress display
- `src/app/(dashboard)/rfps/components/pdf-dropzone.tsx` - Accept multiple files

**Key changes:**
1. Change PDFDropzone to accept multiple files (max 10)
2. Add queue state to context (array of QueuedUpload)
3. Process queue with 2.5s delay between webhook triggers
4. Display up to 3 progress bars stacked, collapsible for overflow

### Plan 10.1-04: Multi-User Permissions and Real-Time Sync
**Files to modify:**
- `supabase/migrations/YYYYMMDD_multi_user_rfp_access.sql` - Update RLS policies
- `src/contexts/rfp-upload-status-context.tsx` - Remove user_id filter from Realtime
- `src/app/(dashboard)/rfps/page.tsx` - Remove user_id filter from query
- `src/app/(dashboard)/rfps/[id]/matches/page.tsx` - Remove user_id filter
- `src/app/(dashboard)/rfps/components/rfp-stats.tsx` - Remove user_id filter

**Key changes:**
1. Update RLS policies to allow all authenticated users
2. Remove user_id filters in all Supabase queries
3. Remove user_id filter from Realtime subscription
4. Add last_edited_by tracking to rfp_upload_jobs

### Plan 10.1-05: Uploader/Editor Display and Table Alignment
**Files to modify:**
- `supabase/migrations/YYYYMMDD_add_last_edited_by.sql` - Add column (may combine with 10.1-04)
- `src/app/(dashboard)/rfps/components/rfp-jobs-list.tsx` - Display uploader/editor
- `src/app/(dashboard)/rfps/[id]/matches/actions.ts` - Update last_edited_by on actions
- `src/app/(dashboard)/inventory/components/inventory-table.tsx` - Align styling with match-review-table

**Key changes:**
1. Add last_edited_by column if not done in 10.1-04
2. Join profiles table in job queries
3. Display format: "ha 2 horas . Joao Silva . Editado por Maria"
4. Copy styling from match-review-table to inventory-table
