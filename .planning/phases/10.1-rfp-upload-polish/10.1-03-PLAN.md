---
phase: 10.1-rfp-upload-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/contexts/rfp-upload-status-context.tsx
  - src/app/(dashboard)/rfps/components/pdf-dropzone.tsx
  - src/app/(dashboard)/rfps/components/rfp-upload-dialog.tsx
  - src/app/(dashboard)/rfps/components/rfp-processing-card.tsx
autonomous: true

must_haves:
  truths:
    - "User can select up to 10 PDF files at once"
    - "Each file shows individual progress (filename, percentage, time)"
    - "Upload button is NEVER disabled during processing"
    - "Up to 3 progress bars stack vertically"
    - "Overflow files show in collapsible section"
    - "n8n webhooks trigger with 2-3 second delay between each"
  artifacts:
    - path: "src/contexts/rfp-upload-status-context.tsx"
      provides: "Multi-upload queue management"
      contains: "uploadQueue"
    - path: "src/app/(dashboard)/rfps/components/pdf-dropzone.tsx"
      provides: "Multi-file dropzone"
      contains: "multiple"
    - path: "src/app/(dashboard)/rfps/components/rfp-processing-card.tsx"
      provides: "Multi-progress display"
      contains: "uploadQueue"
  key_links:
    - from: "rfp-upload-dialog.tsx"
      to: "rfp-upload-status-context.tsx"
      via: "queueFiles function"
      pattern: "queueFiles"
    - from: "rfp-processing-card.tsx"
      to: "rfp-upload-status-context.tsx"
      via: "uploadQueue state"
      pattern: "uploadQueue"
---

<objective>
Enable users to upload up to 10 RFP PDFs concurrently with individual progress tracking for each file.

Purpose: Users need to process multiple RFPs efficiently. The current single-file upload requires waiting for each to complete before uploading the next. Multi-upload allows batch processing while maintaining visibility into each file's status.

Output: Multi-file upload UI with queue management, stacked progress bars, and webhook triggering with delays.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.1-rfp-upload-polish/10.1-CONTEXT.md
@.planning/phases/10.1-rfp-upload-polish/10.1-RESEARCH.md
@src/contexts/rfp-upload-status-context.tsx
@src/app/(dashboard)/rfps/components/pdf-dropzone.tsx
@src/app/(dashboard)/rfps/components/rfp-upload-dialog.tsx
@src/app/(dashboard)/rfps/components/rfp-processing-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend context for multi-upload queue</name>
  <files>src/contexts/rfp-upload-status-context.tsx</files>
  <action>
Extend the RFPUploadStatusContext to support multiple concurrent uploads:

1. Add new types for queue management:
   ```typescript
   interface QueuedUpload {
     id: string              // Temporary ID until job created
     file: File
     status: 'queued' | 'uploading' | 'processing' | 'completed' | 'failed'
     jobId?: string          // Set after job created in DB
     startedAt?: Date
     error?: string
   }

   interface RFPUploadStatusContextValue {
     // Existing (keep for backward compat with single-job display)
     activeJob: RFPUploadJob | null
     lastCompletedJob: RFPUploadJob | null
     isProcessing: boolean
     refetch: () => Promise<void>

     // New for multi-upload
     uploadQueue: QueuedUpload[]
     queueFiles: (files: File[]) => void
     processingCount: number
     queuedCount: number
   }
   ```

2. Add state and constants:
   ```typescript
   const MAX_CONCURRENT = 10
   const WEBHOOK_DELAY_MS = 2500 // 2.5s between n8n triggers

   const [uploadQueue, setUploadQueue] = useState<QueuedUpload[]>([])
   ```

3. Implement queueFiles function:
   ```typescript
   const queueFiles = useCallback((files: File[]) => {
     // Limit to MAX_CONCURRENT total (queued + processing)
     const currentCount = uploadQueue.filter(
       q => q.status === 'queued' || q.status === 'uploading' || q.status === 'processing'
     ).length
     const available = MAX_CONCURRENT - currentCount
     const filesToQueue = files.slice(0, available)

     const newItems: QueuedUpload[] = filesToQueue.map(file => ({
       id: crypto.randomUUID(),
       file,
       status: 'queued'
     }))

     setUploadQueue(prev => [...prev, ...newItems])
   }, [uploadQueue])
   ```

4. Implement queue processor with delays:
   ```typescript
   // Process queue - triggered when new items added or status changes
   useEffect(() => {
     const processNext = async () => {
       const nextQueued = uploadQueue.find(q => q.status === 'queued')
       if (!nextQueued) return

       // Mark as uploading
       setUploadQueue(prev => prev.map(q =>
         q.id === nextQueued.id ? { ...q, status: 'uploading', startedAt: new Date() } : q
       ))

       try {
         // 1. Upload file and create job (existing triggerRFPUpload action)
         const formData = new FormData()
         formData.append('file', nextQueued.file)
         const result = await triggerRFPUploadFromContext(formData)

         if (result.success && result.jobId) {
           // 2. Update queue with job ID
           setUploadQueue(prev => prev.map(q =>
             q.id === nextQueued.id ? { ...q, jobId: result.jobId, status: 'processing' } : q
           ))

           // 3. Wait before processing next (webhook delay)
           await new Promise(resolve => setTimeout(resolve, WEBHOOK_DELAY_MS))
         } else {
           setUploadQueue(prev => prev.map(q =>
             q.id === nextQueued.id ? { ...q, status: 'failed', error: result.error } : q
           ))
         }
       } catch (error) {
         setUploadQueue(prev => prev.map(q =>
           q.id === nextQueued.id ? { ...q, status: 'failed', error: 'Upload failed' } : q
         ))
       }
     }

     // Check if we should process next item
     const hasQueued = uploadQueue.some(q => q.status === 'queued')
     const isUploading = uploadQueue.some(q => q.status === 'uploading')

     if (hasQueued && !isUploading) {
       processNext()
     }
   }, [uploadQueue])
   ```

5. Update Realtime subscription to update queue items when jobs complete:
   - When a job UPDATE is received, find matching queue item by jobId
   - Update queue item status to 'completed' or 'failed'
   - Remove completed/failed items after delay (for smooth animation)

6. Compute derived values:
   ```typescript
   const processingCount = uploadQueue.filter(
     q => q.status === 'uploading' || q.status === 'processing'
   ).length

   const queuedCount = uploadQueue.filter(q => q.status === 'queued').length
   ```

Note: Keep existing activeJob/lastCompletedJob logic for backward compatibility - it tracks the most recent job for toast notifications.
  </action>
  <verify>
1. Run `npm run build` to verify no TypeScript errors
2. Context provider compiles and exports new properties
  </verify>
  <done>
- uploadQueue state tracks multiple files
- queueFiles function adds files to queue (max 10)
- Queue processor handles files sequentially with 2.5s delay
- Realtime updates reflected in queue
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable multi-file selection in dropzone and dialog</name>
  <files>
    src/app/(dashboard)/rfps/components/pdf-dropzone.tsx
    src/app/(dashboard)/rfps/components/rfp-upload-dialog.tsx
  </files>
  <action>
1. Update PDFDropzone to accept multiple files:
   - Change react-dropzone config to `multiple: true, maxFiles: 10`
   - Update onDrop callback to receive File[] instead of single File
   - Update props interface:
     ```typescript
     interface PDFDropzoneProps {
       onFilesSelected: (files: File[]) => void  // Changed from onFileSelected
       disabled?: boolean
     }
     ```
   - Display selected count if multiple: "10 ficheiros selecionados"

2. Update RFPUploadDialog to handle multiple files:
   - Change state from `selectedFile: File | null` to `selectedFiles: File[]`
   - Update handlers to work with array
   - Change confirmation text: "Carregar X concurso(s)"
   - On confirm, call context's `queueFiles(selectedFiles)`
   - Close dialog immediately after queueing (don't wait for completion)
   - Show info text: "Pode carregar ate 10 ficheiros de cada vez"

3. Remove any "disabled during processing" logic:
   - Per spec, upload button should NEVER be disabled
   - Users can always queue more files (up to limit)
  </action>
  <verify>
1. Run `npm run build` to verify no TypeScript errors
2. Open upload dialog
3. Select multiple files in file picker or drag multiple files
4. Verify file count displays correctly
5. Click upload - files should be added to queue
6. Dialog should close immediately
  </verify>
  <done>
- Dropzone accepts multiple files (max 10)
- Dialog shows count of selected files
- Upload queues files and closes dialog immediately
- Upload button never disabled
  </done>
</task>

<task type="auto">
  <name>Task 3: Display multi-progress UI</name>
  <files>src/app/(dashboard)/rfps/components/rfp-processing-card.tsx</files>
  <action>
Update rfp-processing-card.tsx to display multiple progress bars:

1. Get uploadQueue from context instead of just activeJob:
   ```typescript
   const { uploadQueue, processingCount, queuedCount } = useRFPUploadStatus()
   ```

2. Filter to show only active items (uploading or processing):
   ```typescript
   const activeUploads = uploadQueue.filter(
     q => q.status === 'uploading' || q.status === 'processing'
   )
   const queuedUploads = uploadQueue.filter(q => q.status === 'queued')
   ```

3. Show up to 3 progress bars stacked vertically:
   ```tsx
   const visibleUploads = activeUploads.slice(0, 3)
   const overflowCount = activeUploads.length - 3 + queuedUploads.length

   {visibleUploads.map((upload) => (
     <ProgressBar
       key={upload.id}
       fileName={upload.file.name}
       startedAt={upload.startedAt}
       status={upload.status}
     />
   ))}
   ```

4. Each progress bar shows (same info as current single-file progress):
   - Filename (truncated if too long)
   - Progress percentage (time-based, same 4-minute estimate)
   - Time since started ("ha X minutos")
   - Status indicator (uploading spinner vs processing animation)

5. If overflow (more than 3 active + queued):
   - Show collapsible section below progress bars
   - Header: "Mais X em fila" with expand/collapse toggle
   - When expanded, show list of queued filenames

6. Show badge on upload button in RFPUploadButton if queue has items:
   - Import queuedCount from context
   - Display badge: `<Badge>{queuedCount}</Badge>` next to button icon

7. If no active uploads, return null (card not visible)
  </action>
  <verify>
1. Run `npm run build` to verify no TypeScript errors
2. Upload multiple files (3+)
3. Verify up to 3 progress bars display stacked
4. Verify each shows filename, progress, and time
5. If more than 3, verify overflow section appears
6. Verify badge appears on upload button when queue has items
  </verify>
  <done>
- Up to 3 progress bars stack vertically
- Each shows filename, percentage, and time
- Overflow shows in collapsible section
- Badge indicates queue count on upload button
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Can select multiple PDFs in dialog (max 10)
3. Files process sequentially with visible progress for each
4. Progress bars stack correctly (max 3 visible)
5. Overflow queue shows in collapsible section
6. Upload button never disabled during processing
7. n8n webhooks trigger with ~2.5s delay between each
</verification>

<success_criteria>
- Multi-file upload works end-to-end
- Individual progress tracking per file
- Queue management respects 10-file limit
- UI clearly shows processing state for all files
- Upload always available (button never disabled)
</success_criteria>

<output>
After completion, create `.planning/phases/10.1-rfp-upload-polish/10.1-03-SUMMARY.md`
</output>
