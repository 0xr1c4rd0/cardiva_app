---
phase: 10.1-rfp-upload-polish
plan: 02
type: execute
wave: 2
depends_on: ["10.1-04"]
files_modified:
  - supabase/migrations/20260124_add_confirmed_at.sql
  - src/app/(dashboard)/rfps/components/rfp-stats.tsx
  - src/app/(dashboard)/rfps/[id]/matches/page.tsx
  - src/app/(dashboard)/rfps/[id]/matches/actions.ts
  - src/app/(dashboard)/rfps/components/confirm-rfp-button.tsx
autonomous: true

must_haves:
  truths:
    - "RFPs page shows 3 KPI chips: Por Rever, Revistos, Confirmados"
    - "Por Rever counts RFPs with pending items needing decision"
    - "Revistos counts RFPs where all items addressed but not confirmed"
    - "Confirmados counts RFPs where user clicked Confirm button"
    - "Match review page has a Confirm button in header"
    - "Clicking Confirm sets confirmed_at timestamp in database"
  artifacts:
    - path: "supabase/migrations/20260124_add_confirmed_at.sql"
      provides: "confirmed_at column on rfp_upload_jobs"
      contains: "confirmed_at"
    - path: "src/app/(dashboard)/rfps/components/rfp-stats.tsx"
      provides: "3-state KPI calculation"
      contains: "Por Rever"
    - path: "src/app/(dashboard)/rfps/[id]/matches/actions.ts"
      provides: "confirmRFP server action"
      contains: "confirmRFP"
    - path: "src/app/(dashboard)/rfps/components/confirm-rfp-button.tsx"
      provides: "Confirm button component"
      exports: ["ConfirmRFPButton"]
  key_links:
    - from: "rfp-stats.tsx"
      to: "rfp_upload_jobs.confirmed_at"
      via: "Supabase query"
      pattern: "confirmed_at"
    - from: "confirm-rfp-button.tsx"
      to: "actions.ts confirmRFP"
      via: "Server Action call"
      pattern: "confirmRFP"
---

<objective>
Implement the 3-state KPI model (Por Rever, Revistos, Confirmados) and add a Confirm button to the match review page.

Purpose: Users need clearer visibility into RFP workflow status. The current 2-state model (completed/pending) doesn't distinguish between "reviewed but not confirmed" and "confirmed and ready for export". The new 3-state model provides this clarity and introduces a confirmation step before export.

Output: Updated KPI chips on RFPs page showing 3 states, and a Confirm button on match review page that persists confirmation to database.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.1-rfp-upload-polish/10.1-CONTEXT.md
@.planning/phases/10.1-rfp-upload-polish/10.1-RESEARCH.md
@.planning/phases/10.1-rfp-upload-polish/10.1-04-SUMMARY.md
@src/app/(dashboard)/rfps/components/rfp-stats.tsx
@src/app/(dashboard)/rfps/[id]/matches/page.tsx
@src/app/(dashboard)/rfps/[id]/matches/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add confirmed_at column to database</name>
  <files>supabase/migrations/20260124_add_confirmed_at.sql</files>
  <action>
Create a new migration file that adds the `confirmed_at` column to `rfp_upload_jobs` table:

```sql
-- Add confirmed_at column for 3-state KPI model
-- Por Rever: has pending items to decide
-- Revistos: all items addressed, confirmed_at IS NULL
-- Confirmados: confirmed_at IS NOT NULL

ALTER TABLE rfp_upload_jobs
ADD COLUMN IF NOT EXISTS confirmed_at TIMESTAMPTZ;

-- Index for efficient filtering by confirmation status
CREATE INDEX IF NOT EXISTS idx_rfp_upload_jobs_confirmed_at
ON rfp_upload_jobs(confirmed_at)
WHERE confirmed_at IS NOT NULL;
```

Note: The last_edited_by column is added in Plan 10.1-04, which this plan depends on.
  </action>
  <verify>
Log the migration file path and contents for user to run in Supabase Dashboard SQL Editor.
  </verify>
  <done>
- Migration file exists at supabase/migrations/20260124_add_confirmed_at.sql
- User instructed to run migration in Supabase Dashboard
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement 3-state KPI calculations</name>
  <files>src/app/(dashboard)/rfps/components/rfp-stats.tsx</files>
  <action>
Rewrite rfp-stats.tsx to calculate and display 3 KPI states:

1. Remove user_id filter (multi-user access from Plan 10.1-04)

2. Fetch completed jobs with their items and confirmation status:
   ```typescript
   // Fetch all completed jobs
   const { data: completedJobs } = await supabase
     .from('rfp_upload_jobs')
     .select('id, confirmed_at')
     .eq('status', 'completed')
   ```

3. For each completed job, determine its KPI state:
   - **Confirmados**: `confirmed_at IS NOT NULL` - count directly from query
   - **Por Rever**: Has at least 1 rfp_item where:
     - review_status = 'pending' AND
     - has rfp_match_suggestions with status = 'pending' AND
     - NO suggestion has similarity_score >= 0.9999 (100% auto-accepted)
   - **Revistos**: Everything else (completed, not confirmed, no pending decisions)

4. Calculate counts:
   ```typescript
   const confirmedCount = completedJobs?.filter(j => j.confirmed_at !== null).length ?? 0

   // For each unconfirmed job, check if it has pending items needing decision
   const unconfirmedJobs = completedJobs?.filter(j => j.confirmed_at === null) ?? []
   const jobIds = unconfirmedJobs.map(j => j.id)

   // Query items with pending suggestions (not auto-accepted 100% matches)
   // A job is "Por Rever" if ANY item has pending suggestions requiring decision
   // An item requires decision if:
   //   - review_status = 'pending'
   //   - has at least 1 suggestion with status = 'pending'
   //   - does NOT have a 100% match (auto-accepted)
   ```

5. Display 3 KPI chips (replace current 4-chip layout):
   - "Por Rever" (amber) - jobs needing human decision
   - "Revistos" (blue) - jobs reviewed but not confirmed
   - "Confirmados" (emerald) - jobs confirmed and ready for export

6. Use appropriate icons:
   - Por Rever: Clock or Loader2 (with pulse animation if count > 0)
   - Revistos: CheckCircle2
   - Confirmados: CheckCircle2 with different styling
  </action>
  <verify>
1. Run `npm run build` to verify no TypeScript errors
2. Navigate to `/rfps` page
3. Verify 3 KPI chips display with correct labels
4. Verify counts by running this Supabase query and comparing:
   ```sql
   -- Count Confirmados (has confirmed_at)
   SELECT COUNT(*) as confirmados FROM rfp_upload_jobs
   WHERE status = 'completed' AND confirmed_at IS NOT NULL;

   -- Count Por Rever (has pending items needing decision)
   SELECT COUNT(DISTINCT j.id) as por_rever FROM rfp_upload_jobs j
   WHERE j.status = 'completed' AND j.confirmed_at IS NULL
   AND EXISTS (
     SELECT 1 FROM rfp_items i
     JOIN rfp_match_suggestions s ON s.rfp_item_id = i.id
     WHERE i.job_id = j.id
     AND i.review_status = 'pending'
     AND s.status = 'pending'
     AND s.similarity_score < 0.9999
   );

   -- Count Revistos (completed, not confirmed, no pending decisions)
   -- This is: total_completed - confirmados - por_rever
   ```
5. UI counts should match SQL query results
  </verify>
  <done>
- RFPs page shows exactly 3 KPI chips: Por Rever, Revistos, Confirmados
- Counts accurately reflect the 3-state model (verified against SQL queries)
- No user_id filtering (all users see all RFPs)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add confirmRFP server action and Confirm button</name>
  <files>
    src/app/(dashboard)/rfps/[id]/matches/actions.ts
    src/app/(dashboard)/rfps/components/confirm-rfp-button.tsx
    src/app/(dashboard)/rfps/[id]/matches/page.tsx
  </files>
  <action>
**IMPORTANT**: This task updates last_edited_by, which requires the Plan 10.1-04 migration to be run first. Ensure that migration has been applied before testing this task.

1. Add confirmRFP server action to actions.ts:
   ```typescript
   export async function confirmRFP(jobId: string) {
     const supabase = await createClient()
     const { data: { user } } = await supabase.auth.getUser()

     if (!user) {
       return { success: false, error: 'Not authenticated' }
     }

     const { error } = await supabase
       .from('rfp_upload_jobs')
       .update({
         confirmed_at: new Date().toISOString(),
         last_edited_by: user.id  // Requires 10.1-04 migration
       })
       .eq('id', jobId)

     if (error) {
       return { success: false, error: error.message }
     }

     revalidatePath('/rfps')
     revalidatePath(`/rfps/${jobId}/matches`)

     return { success: true }
   }
   ```

2. Create ConfirmRFPButton client component:
   ```typescript
   'use client'

   import { useState, useTransition } from 'react'
   import { Button } from '@/components/ui/button'
   import { CheckCircle2, Loader2 } from 'lucide-react'
   import { toast } from 'sonner'
   import { confirmRFP } from '../[id]/matches/actions'

   interface ConfirmRFPButtonProps {
     jobId: string
     isConfirmed: boolean
   }

   export function ConfirmRFPButton({ jobId, isConfirmed }: ConfirmRFPButtonProps) {
     const [isPending, startTransition] = useTransition()

     if (isConfirmed) {
       return (
         <Button variant="outline" disabled className="text-emerald-600 border-emerald-200">
           <CheckCircle2 className="mr-2 h-4 w-4" />
           Confirmado
         </Button>
       )
     }

     const handleConfirm = () => {
       startTransition(async () => {
         const result = await confirmRFP(jobId)
         if (result.success) {
           toast.success('Concurso confirmado', {
             description: 'O concurso está pronto para exportação.'
           })
         } else {
           toast.error('Erro ao confirmar', {
             description: result.error
           })
         }
       })
     }

     return (
       <Button onClick={handleConfirm} disabled={isPending}>
         {isPending ? (
           <Loader2 className="mr-2 h-4 w-4 animate-spin" />
         ) : (
           <CheckCircle2 className="mr-2 h-4 w-4" />
         )}
         Confirmar
       </Button>
     )
   }
   ```

3. Update matches/page.tsx to include Confirm button:
   - Fetch job.confirmed_at in the initial query
   - Add ConfirmRFPButton to header next to export button:
     ```tsx
     <div className="flex items-center gap-4 shrink-0">
       <ReviewStatsChips items={allItemsWithSortedMatches} />
       <ConfirmRFPButton jobId={jobId} isConfirmed={!!job.confirmed_at} />
       <HeaderExportButton items={allItemsWithSortedMatches} jobId={jobId} />
     </div>
     ```
  </action>
  <verify>
1. Run `npm run build` to verify no TypeScript errors
2. Navigate to `/rfps/{id}/matches` for a completed RFP
3. Verify "Confirmar" button appears in header
4. Click "Confirmar" - should show success toast
5. Button should change to "Confirmado" (disabled)
6. Navigate to /rfps - Confirmados KPI should increment
  </verify>
  <done>
- confirmRFP server action exists and updates confirmed_at and last_edited_by
- ConfirmRFPButton component shows Confirmar/Confirmado state
- Button appears in match review page header
- Clicking confirm updates database and shows success feedback
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Migration file ready for user to execute
3. KPIs page shows 3 states with correct calculations
4. Confirm button works end-to-end
5. State persists across page refreshes
</verification>

<success_criteria>
- 3 KPI chips visible on /rfps page: Por Rever, Revistos, Confirmados
- Counts accurately reflect job states
- Confirm button on match review page updates confirmed_at
- Confirmed state persists and displays correctly
</success_criteria>

<output>
After completion, create `.planning/phases/10.1-rfp-upload-polish/10.1-02-SUMMARY.md`
</output>
