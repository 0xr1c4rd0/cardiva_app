---
phase: 10.1-rfp-upload-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260124_multi_user_rfp_access.sql
  - src/contexts/rfp-upload-status-context.tsx
  - src/app/(dashboard)/rfps/page.tsx
  - src/app/(dashboard)/rfps/[id]/matches/page.tsx
  - src/app/(dashboard)/rfps/[id]/matches/actions.ts
autonomous: true
user_setup:
  - service: supabase
    why: "Update RLS policies for multi-user access"
    dashboard_config:
      - task: "Run migration SQL in Supabase Dashboard SQL Editor"
        location: "Supabase Dashboard -> SQL Editor"

must_haves:
  truths:
    - "All authenticated users can see all RFPs (not just their own)"
    - "Any user can accept/reject matches on any RFP"
    - "Any user can delete any RFP"
    - "Changes by one user appear in real-time for other users"
    - "last_edited_by tracks who made the most recent change"
  artifacts:
    - path: "supabase/migrations/20260124_multi_user_rfp_access.sql"
      provides: "RLS policies for multi-user access + last_edited_by column"
      contains: "Authenticated users can"
    - path: "src/contexts/rfp-upload-status-context.tsx"
      provides: "Real-time subscription without user_id filter"
      contains: "rfp_upload_jobs"
    - path: "src/app/(dashboard)/rfps/page.tsx"
      provides: "Query without user_id filter"
  key_links:
    - from: "rfp-upload-status-context.tsx"
      to: "Supabase Realtime"
      via: "postgres_changes subscription"
      pattern: "rfp_upload_jobs"
    - from: "page.tsx queries"
      to: "RLS policies"
      via: "Supabase RLS evaluation"
---

<objective>
Enable multi-user collaboration where all authenticated users can view, edit, and delete any RFP with real-time synchronization.

Purpose: The current user_id-based filtering prevents team collaboration. In a multi-user environment, any team member should be able to work on any RFP, with changes syncing in real-time across all users' screens.

Output: Updated RLS policies, removed user_id filters from queries and Realtime subscriptions, added last_edited_by tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.1-rfp-upload-polish/10.1-CONTEXT.md
@.planning/phases/10.1-rfp-upload-polish/10.1-RESEARCH.md
@src/contexts/rfp-upload-status-context.tsx
@src/app/(dashboard)/rfps/page.tsx
@src/app/(dashboard)/rfps/[id]/matches/page.tsx
@src/app/(dashboard)/rfps/[id]/matches/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RLS migration for multi-user access</name>
  <files>supabase/migrations/20260124_multi_user_rfp_access.sql</files>
  <action>
Create a comprehensive migration that:

1. Adds last_edited_by column:
   ```sql
   -- Add last_edited_by column to track who made most recent change
   ALTER TABLE rfp_upload_jobs
   ADD COLUMN IF NOT EXISTS last_edited_by UUID REFERENCES auth.users(id);
   ```

2. Updates RLS policies for rfp_upload_jobs:
   ```sql
   -- Drop existing user-specific policies
   DROP POLICY IF EXISTS "Users can insert own rfp jobs" ON rfp_upload_jobs;
   DROP POLICY IF EXISTS "Users can view own rfp jobs" ON rfp_upload_jobs;
   DROP POLICY IF EXISTS "Users can update own rfp jobs" ON rfp_upload_jobs;
   DROP POLICY IF EXISTS "Users can delete own rfp jobs" ON rfp_upload_jobs;

   -- Create new policies for all authenticated users
   CREATE POLICY "Authenticated users can insert rfp jobs"
     ON rfp_upload_jobs FOR INSERT
     TO authenticated
     WITH CHECK (auth.uid() = user_id);  -- Must be the uploader

   CREATE POLICY "Authenticated users can view all rfp jobs"
     ON rfp_upload_jobs FOR SELECT
     TO authenticated
     USING (true);

   CREATE POLICY "Authenticated users can update all rfp jobs"
     ON rfp_upload_jobs FOR UPDATE
     TO authenticated
     USING (true);

   CREATE POLICY "Authenticated users can delete all rfp jobs"
     ON rfp_upload_jobs FOR DELETE
     TO authenticated
     USING (true);
   ```

3. Updates RLS policies for rfp_items:
   ```sql
   -- Drop existing user-specific policies
   DROP POLICY IF EXISTS "Users can view own rfp items" ON rfp_items;
   DROP POLICY IF EXISTS "Users can update own rfp items" ON rfp_items;

   -- Create new policies for all authenticated users
   CREATE POLICY "Authenticated users can view all rfp items"
     ON rfp_items FOR SELECT
     TO authenticated
     USING (true);

   CREATE POLICY "Authenticated users can update all rfp items"
     ON rfp_items FOR UPDATE
     TO authenticated
     USING (true);
   ```

4. Updates RLS policies for rfp_match_suggestions:
   ```sql
   -- Drop existing user-specific policies (if any)
   DROP POLICY IF EXISTS "Users can view own match suggestions" ON rfp_match_suggestions;
   DROP POLICY IF EXISTS "Users can update own match suggestions" ON rfp_match_suggestions;

   -- Create new policies for all authenticated users
   CREATE POLICY "Authenticated users can view all match suggestions"
     ON rfp_match_suggestions FOR SELECT
     TO authenticated
     USING (true);

   CREATE POLICY "Authenticated users can update all match suggestions"
     ON rfp_match_suggestions FOR UPDATE
     TO authenticated
     USING (true);
   ```

5. Keep service_role policies unchanged for n8n access.

Note: This migration adds last_edited_by; confirmed_at is added in Plan 10.1-02.
  </action>
  <verify>
Log the migration file path and contents for user to run in Supabase Dashboard SQL Editor.
  </verify>
  <done>
- Migration file exists at supabase/migrations/20260124_multi_user_rfp_access.sql
- User instructed to run migration in Supabase Dashboard
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove user_id filters from queries and Realtime</name>
  <files>
    src/contexts/rfp-upload-status-context.tsx
    src/app/(dashboard)/rfps/page.tsx
    src/app/(dashboard)/rfps/[id]/matches/page.tsx
  </files>
  <action>
1. Update rfp-upload-status-context.tsx:
   - Remove user_id filter from fetchActiveJob query
   - Remove user_id filter from Realtime subscription
   - Change channel name to not include user_id: `rfp_jobs_all` instead of `rfp_jobs_${user.id}`
   - Remove `filter: user_id=eq.${user.id}` from postgres_changes subscriptions
   - Keep userIdRef for tracking current user (for toast logic) but don't filter by it
   - In handleJobUpdate, show toasts for all jobs (not just user's own) - or optionally only show for user's own uploads

2. Update rfps/page.tsx:
   - In the Supabase query that fetches jobs for the list, remove `.eq('user_id', user.id)`
   - The query should now be:
     ```typescript
     const { data: jobs, count } = await supabase
       .from('rfp_upload_jobs')
       .select('*', { count: 'exact' })
       // ... sorting, pagination, search filters
       // NO user_id filter
     ```

3. Update rfps/[id]/matches/page.tsx:
   - Remove ownership check: delete `.eq('user_id', user.id)` from job fetch
   - Keep authentication check (redirect to login if not authenticated)
   - The query becomes:
     ```typescript
     const { data: job, error: jobError } = await supabase
       .from('rfp_upload_jobs')
       .select('*')
       .eq('id', jobId)
       // NO user_id filter
       .single()
     ```
  </action>
  <verify>
1. Run `npm run build` to verify no TypeScript errors
2. Log in as User A
3. Upload an RFP as User A
4. Log in as User B in different browser
5. User B should see User A's RFP in the list
6. User B should be able to click and view User A's RFP matches
7. User B should be able to accept/reject matches on User A's RFP
  </verify>
  <done>
- All users see all RFPs in the list
- Users can access any RFP's match review page
- Realtime updates work across all users (no user_id filter)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update actions to track last_edited_by</name>
  <files>src/app/(dashboard)/rfps/[id]/matches/actions.ts</files>
  <action>
Update all Server Actions that modify RFP data to set last_edited_by:

1. In acceptMatch action:
   ```typescript
   // After updating match suggestion status
   await supabase
     .from('rfp_upload_jobs')
     .update({ last_edited_by: user.id })
     .eq('id', jobId)
   ```

2. In rejectMatch action:
   ```typescript
   // After updating match suggestion status
   await supabase
     .from('rfp_upload_jobs')
     .update({ last_edited_by: user.id })
     .eq('id', jobId)
   ```

3. In unselectMatch action:
   ```typescript
   // After updating match suggestion status
   await supabase
     .from('rfp_upload_jobs')
     .update({ last_edited_by: user.id })
     .eq('id', jobId)
   ```

4. In setManualMatch action (if exists):
   ```typescript
   // After setting manual match
   await supabase
     .from('rfp_upload_jobs')
     .update({ last_edited_by: user.id })
     .eq('id', jobId)
   ```

5. Optionally, create a helper function to reduce duplication:
   ```typescript
   async function updateLastEditedBy(supabase: SupabaseClient, jobId: string, userId: string) {
     await supabase
       .from('rfp_upload_jobs')
       .update({ last_edited_by: userId })
       .eq('id', jobId)
   }
   ```
  </action>
  <verify>
1. Run `npm run build` to verify no TypeScript errors
2. As User A, accept a match on any RFP
3. Query database to verify last_edited_by is set to User A's ID
4. As User B, reject a match on same RFP
5. Query database to verify last_edited_by is now User B's ID
  </verify>
  <done>
- All match actions update last_edited_by
- Column correctly tracks the most recent editor
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Migration file ready for user to execute
3. All users can see all RFPs (test with two different users)
4. Any user can accept/reject on any RFP
5. Real-time updates work across users
6. last_edited_by correctly tracks who made changes
</verification>

<success_criteria>
- Multi-user access works end-to-end
- No user_id filtering in queries or Realtime
- last_edited_by column tracks changes
- Changes sync in real-time across all users
</success_criteria>

<output>
After completion, create `.planning/phases/10.1-rfp-upload-polish/10.1-04-SUMMARY.md`
</output>
