---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/middleware.ts
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/page.tsx
  - src/components/layout/app-sidebar.tsx
  - src/app/api/health/route.ts
autonomous: true
user_setup:
  - service: supabase
    why: "Database and authentication backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
    dashboard_config:
      - task: "Ensure project exists (can use existing Cardiva project)"
        location: "Supabase Dashboard -> Projects"

must_haves:
  truths:
    - "Supabase client can connect to database without errors"
    - "Left sidebar navigation renders with Dashboard, RFPs, Inventory, History links"
    - "Sidebar is collapsible and persists state in cookie"
    - "Dashboard layout is responsive on desktop (1024px+)"
    - "Health check endpoint returns connection status"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser-side Supabase client"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server-side Supabase client"
      exports: ["createClient"]
    - path: "src/middleware.ts"
      provides: "Auth token refresh middleware"
      exports: ["middleware", "config"]
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with sidebar"
      exports: ["default"]
    - path: "src/components/layout/app-sidebar.tsx"
      provides: "Application sidebar navigation"
      exports: ["AppSidebar"]
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/supabase/server.ts"
      via: "Supabase client creation"
      pattern: "createServerClient"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/components/layout/app-sidebar.tsx"
      via: "Sidebar component import"
      pattern: "import.*AppSidebar"
    - from: "src/components/layout/app-sidebar.tsx"
      to: "src/components/ui/sidebar.tsx"
      via: "shadcn Sidebar primitives"
      pattern: "import.*from.*sidebar"
---

<objective>
Set up Supabase client configuration and create the dashboard layout shell with sidebar navigation.

Purpose: Establish the connection to existing Supabase database and create the main application structure with navigation ready for feature development.

Output: Working Supabase connection (browser + server clients, middleware for token refresh) and responsive dashboard layout with collapsible sidebar navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/UI_DESIGN.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase client utilities</name>
  <files>
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/middleware.ts
  </files>
  <action>
    1. Create `src/lib/supabase/client.ts` (browser client):
       ```typescript
       import { createBrowserClient } from '@supabase/ssr'

       export function createClient() {
         return createBrowserClient(
           process.env.NEXT_PUBLIC_SUPABASE_URL!,
           process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
         )
       }
       ```

    2. Create `src/lib/supabase/server.ts` (server client):
       ```typescript
       import { createServerClient } from '@supabase/ssr'
       import { cookies } from 'next/headers'

       export async function createClient() {
         const cookieStore = await cookies()

         return createServerClient(
           process.env.NEXT_PUBLIC_SUPABASE_URL!,
           process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
           {
             cookies: {
               getAll() {
                 return cookieStore.getAll()
               },
               setAll(cookiesToSet) {
                 try {
                   cookiesToSet.forEach(({ name, value, options }) =>
                     cookieStore.set(name, value, options)
                   )
                 } catch {
                   // Called from Server Component - cookies are read-only
                   // This is expected and safe to ignore
                 }
               },
             },
           }
         )
       }
       ```

    3. Create `src/middleware.ts` (auth token refresh):
       ```typescript
       import { type NextRequest, NextResponse } from 'next/server'
       import { createServerClient } from '@supabase/ssr'

       export async function middleware(request: NextRequest) {
         let supabaseResponse = NextResponse.next({
           request,
         })

         const supabase = createServerClient(
           process.env.NEXT_PUBLIC_SUPABASE_URL!,
           process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
           {
             cookies: {
               getAll() {
                 return request.cookies.getAll()
               },
               setAll(cookiesToSet) {
                 cookiesToSet.forEach(({ name, value }) =>
                   request.cookies.set(name, value)
                 )
                 supabaseResponse = NextResponse.next({
                   request,
                 })
                 cookiesToSet.forEach(({ name, value, options }) =>
                   supabaseResponse.cookies.set(name, value, options)
                 )
               },
             },
           }
         )

         // IMPORTANT: Do not remove this line
         // It refreshes the auth token and must be called for every request
         await supabase.auth.getUser()

         return supabaseResponse
       }

       export const config = {
         matcher: [
           /*
            * Match all request paths except:
            * - _next/static (static files)
            * - _next/image (image optimization files)
            * - favicon.ico (favicon file)
            * - public files (images, etc.)
            */
           '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
         ],
       }
       ```

    Key points:
    - Browser client is a singleton (createBrowserClient handles this)
    - Server client must be created per request (async function)
    - Middleware refreshes auth tokens on every request
    - Use getUser() not getSession() on server (validates token)
  </action>
  <verify>
    - Files exist at correct paths
    - TypeScript compiles without errors
    - No runtime errors when importing clients
  </verify>
  <done>
    Supabase client utilities created following @supabase/ssr patterns. Browser client, server client, and middleware configured for auth token refresh.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard layout with sidebar</name>
  <files>
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/page.tsx
    src/components/layout/app-sidebar.tsx
  </files>
  <action>
    1. Create `src/components/layout/app-sidebar.tsx`:
       ```typescript
       import { Home, FileText, Package, History, Settings } from 'lucide-react'
       import Link from 'next/link'
       import {
         Sidebar,
         SidebarContent,
         SidebarGroup,
         SidebarGroupContent,
         SidebarGroupLabel,
         SidebarMenu,
         SidebarMenuButton,
         SidebarMenuItem,
         SidebarHeader,
         SidebarFooter,
       } from '@/components/ui/sidebar'

       const navItems = [
         { title: 'Dashboard', url: '/', icon: Home },
         { title: 'RFPs', url: '/rfps', icon: FileText },
         { title: 'Inventory', url: '/inventory', icon: Package },
         { title: 'History', url: '/history', icon: History },
       ]

       export function AppSidebar() {
         return (
           <Sidebar>
             <SidebarHeader className="border-b border-sidebar-border px-6 py-4">
               <Link href="/" className="flex items-center gap-2">
                 <span className="text-xl font-semibold text-sidebar-foreground">
                   Cardiva
                 </span>
               </Link>
             </SidebarHeader>
             <SidebarContent>
               <SidebarGroup>
                 <SidebarGroupLabel>Navigation</SidebarGroupLabel>
                 <SidebarGroupContent>
                   <SidebarMenu>
                     {navItems.map((item) => (
                       <SidebarMenuItem key={item.title}>
                         <SidebarMenuButton asChild>
                           <Link href={item.url}>
                             <item.icon className="h-4 w-4" />
                             <span>{item.title}</span>
                           </Link>
                         </SidebarMenuButton>
                       </SidebarMenuItem>
                     ))}
                   </SidebarMenu>
                 </SidebarGroupContent>
               </SidebarGroup>
             </SidebarContent>
             <SidebarFooter className="border-t border-sidebar-border p-4">
               <SidebarMenu>
                 <SidebarMenuItem>
                   <SidebarMenuButton asChild>
                     <Link href="/settings">
                       <Settings className="h-4 w-4" />
                       <span>Settings</span>
                     </Link>
                   </SidebarMenuButton>
                 </SidebarMenuItem>
               </SidebarMenu>
             </SidebarFooter>
           </Sidebar>
         )
       }
       ```

    2. Create `src/app/(dashboard)/layout.tsx`:
       ```typescript
       import { cookies } from 'next/headers'
       import { SidebarProvider, SidebarInset, SidebarTrigger } from '@/components/ui/sidebar'
       import { AppSidebar } from '@/components/layout/app-sidebar'

       export default async function DashboardLayout({
         children,
       }: {
         children: React.ReactNode
       }) {
         const cookieStore = await cookies()
         const defaultOpen = cookieStore.get('sidebar_state')?.value !== 'false'

         return (
           <SidebarProvider defaultOpen={defaultOpen}>
             <AppSidebar />
             <SidebarInset>
               <header className="flex h-16 shrink-0 items-center gap-2 border-b px-4">
                 <SidebarTrigger className="-ml-1" />
                 <div className="flex-1" />
                 {/* User menu will be added in Auth phase */}
               </header>
               <main className="flex-1 overflow-auto">
                 <div className="mx-auto max-w-[1200px] p-6 lg:p-10">
                   {children}
                 </div>
               </main>
             </SidebarInset>
           </SidebarProvider>
         )
       }
       ```

    3. Create `src/app/(dashboard)/page.tsx`:
       ```typescript
       import { Button } from '@/components/ui/button'
       import { FileText, Package, History } from 'lucide-react'
       import Link from 'next/link'

       export default function DashboardPage() {
         return (
           <div className="space-y-8">
             <div>
               <h1 className="text-3xl font-semibold text-gray-900">Dashboard</h1>
               <p className="mt-2 text-gray-600">
                 Welcome to Cardiva RFP Matching
               </p>
             </div>

             <div className="grid gap-6 md:grid-cols-3">
               <Link
                 href="/rfps"
                 className="flex flex-col gap-4 rounded-lg border p-6 transition-colors hover:bg-accent"
               >
                 <FileText className="h-8 w-8 text-primary" />
                 <div>
                   <h2 className="font-semibold text-gray-900">Upload RFP</h2>
                   <p className="text-sm text-gray-600">
                     Upload a PDF to start matching
                   </p>
                 </div>
               </Link>

               <Link
                 href="/inventory"
                 className="flex flex-col gap-4 rounded-lg border p-6 transition-colors hover:bg-accent"
               >
                 <Package className="h-8 w-8 text-primary" />
                 <div>
                   <h2 className="font-semibold text-gray-900">Inventory</h2>
                   <p className="text-sm text-gray-600">
                     Browse and manage products
                   </p>
                 </div>
               </Link>

               <Link
                 href="/history"
                 className="flex flex-col gap-4 rounded-lg border p-6 transition-colors hover:bg-accent"
               >
                 <History className="h-8 w-8 text-primary" />
                 <div>
                   <h2 className="font-semibold text-gray-900">History</h2>
                   <p className="text-sm text-gray-600">
                     View past RFP matches
                   </p>
                 </div>
               </Link>
             </div>
           </div>
         )
       }
       ```

    4. Update `src/app/page.tsx` to redirect to dashboard:
       ```typescript
       import { redirect } from 'next/navigation'

       export default function Home() {
         // Redirect to dashboard (auth protection added in Phase 2)
         redirect('/')
       }
       ```

       Note: Since both are at '/', the (dashboard) route group handles it. The root page.tsx can be removed or kept as a redirect placeholder.
  </action>
  <verify>
    - `npm run dev` shows dashboard with sidebar
    - Sidebar displays all navigation items with icons
    - Sidebar collapse button works (toggle open/closed)
    - Sidebar state persists after page refresh (check cookie)
    - Content area has max-width 1200px and proper padding
  </verify>
  <done>
    Dashboard layout created with collapsible sidebar navigation. Sidebar uses dark theme and persists state in cookie. Layout is responsive with proper content constraints.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create health check endpoint and verify Supabase connection</name>
  <files>
    src/app/api/health/route.ts
    .env.local
  </files>
  <action>
    1. Create `src/app/api/health/route.ts`:
       ```typescript
       import { createClient } from '@/lib/supabase/server'
       import { NextResponse } from 'next/server'

       export async function GET() {
         try {
           const supabase = await createClient()

           // Test connection by making a simple query
           // This query will fail gracefully if table doesn't exist
           const { error } = await supabase
             .from('artigos')
             .select('count')
             .limit(0)
             .single()

           // If we get a "relation does not exist" error, connection works
           // but table doesn't exist - that's fine for this check
           if (error && !error.message.includes('does not exist')) {
             // Real connection error
             return NextResponse.json(
               {
                 status: 'error',
                 message: error.message,
                 supabase_url: process.env.NEXT_PUBLIC_SUPABASE_URL ? 'configured' : 'missing'
               },
               { status: 500 }
             )
           }

           return NextResponse.json({
             status: 'healthy',
             supabase: 'connected',
             timestamp: new Date().toISOString(),
           })
         } catch (error) {
           return NextResponse.json(
             {
               status: 'error',
               message: error instanceof Error ? error.message : 'Unknown error',
               supabase_url: process.env.NEXT_PUBLIC_SUPABASE_URL ? 'configured' : 'missing'
             },
             { status: 500 }
           )
         }
       }
       ```

    2. Create `.env.local` (user must fill in actual values):
       ```
       # Supabase Configuration
       # Get these from: Supabase Dashboard -> Project Settings -> API
       NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
       NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
       ```

       Note: User needs to replace placeholder values with actual Supabase credentials before testing health endpoint.

    3. Test the endpoint:
       - After user configures .env.local with real Supabase credentials
       - Visit http://localhost:3000/api/health
       - Should return `{"status":"healthy","supabase":"connected",...}`
  </action>
  <verify>
    - API route exists and returns JSON
    - With invalid/missing credentials: returns error with helpful message
    - With valid credentials: returns healthy status
    - `npm run build` succeeds (no TypeScript errors)
  </verify>
  <done>
    Health check endpoint created. Supabase connection verified working when credentials are configured. API returns clear status for debugging.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run dev` and navigate to http://localhost:3000
2. Verify sidebar renders with all navigation items
3. Test sidebar collapse/expand functionality
4. Refresh page and verify sidebar state persists
5. Test responsive behavior at different viewport widths
6. Visit http://localhost:3000/api/health and verify Supabase connection
</verification>

<success_criteria>
- Supabase client can connect to database (health check returns "healthy")
- Left sidebar navigation renders with Dashboard, RFPs, Inventory, History links
- Sidebar is collapsible and state persists via cookie
- Dashboard layout is responsive on desktop (1024px+)
- Content area has max-width 1200px with proper padding
- No console errors in browser or terminal
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
