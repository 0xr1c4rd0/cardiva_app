{
  "name": "Cardiva - Extract and compare",
  "nodes": [
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3216,
        64
      ],
      "id": "65508d6b-f2c1-4b7b-8dda-ce959c17c065",
      "name": "Merge"
    },
    {
      "parameters": {
        "operation": "share",
        "fileId": {
          "__rl": true,
          "value": "={{ $('Copia template').item.json.id }}",
          "mode": "id"
        },
        "permissionsUi": {
          "permissionsValues": {
            "role": "writer",
            "type": "anyone"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        3664,
        64
      ],
      "id": "d118770f-d588-4c9d-9832-ddfef2de236f",
      "name": "Share file",
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "gpzJF9flSNZkxxKk",
          "name": "Cardiva.automation GDrive"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        2624,
        464
      ],
      "id": "d3f31632-cbd7-4718-abcd-aa466cc308ea",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "HHrw5Jlu6sN509de",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash-lite",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        2016,
        288
      ],
      "id": "fdbb8c07-fb9b-41ab-b561-3242ec58832a",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "mlwfCzPRF097AsCS",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Pesquisa por correspondencia + pesquisa semântica vectorial",
        "height": 816,
        "width": 3696,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        544,
        -224
      ],
      "id": "d46ba57f-efc0-474a-ab6d-09481c2c7ee3",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "operation": "pdf",
        "binaryPropertyName": "attachment_0",
        "options": {
          "keepSource": "binary"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        688,
        48
      ],
      "id": "91c890be-3310-4630-82e3-8d808bdb2693",
      "name": "Extrai conteúdo"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ff5760ab-2722-4db4-bd4d-8c405adebf11",
              "leftValue": "={{ $json.metadata['pdf:producer'] }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        896,
        48
      ],
      "id": "d09ec4b6-74ac-4975-a949-e245220d6016",
      "name": "É imagem em PDF?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.mistral.ai/v1/ocr",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"mistral-ocr-latest\",\n  \"document\": {\n    \"type\": \"document_url\",\n    \"document_url\": \"{{ $('Obter Signed URL').item.json.url }}\"\n  },\n  \"include_image_base64\": false\n}",
        "options": {
          "batching": {
            "batch": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1616,
        -112
      ],
      "id": "0763b314-abd7-47d1-91cd-49512a6761f6",
      "name": "Aplicar OCR e devolve conteúdo",
      "credentials": {
        "httpHeaderAuth": {
          "id": "EZgptxODF6C28J53",
          "name": "Mistral OCR"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://api.mistral.ai/v1/files/{{ $json.id }}/url",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "expiry",
              "value": "24"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1360,
        -96
      ],
      "id": "99a9d614-1895-4868-8f44-03090318fa15",
      "name": "Obter Signed URL",
      "retryOnFail": false,
      "credentials": {
        "httpHeaderAuth": {
          "id": "EZgptxODF6C28J53",
          "name": "Mistral OCR"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.mistral.ai/v1/files",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "purpose",
              "value": "ocr"
            },
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "=data"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1136,
        -96
      ],
      "id": "d3b37f1b-d705-401b-be51-b357dea761c4",
      "name": "Upload pdf \"imagem\" p/ cloud mistral",
      "credentials": {
        "httpHeaderAuth": {
          "id": "EZgptxODF6C28J53",
          "name": "Mistral OCR"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const pages = $('Aplicar OCR e devolve conteúdo').first().json.pages;\n\nconst combinedMarkdown = pages\n  .map(page => page.markdown)\n  .join('\\n\\n---\\n\\n');\n\nreturn {\n  json: {\n    markdown: combinedMarkdown\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1824,
        -112
      ],
      "id": "ff12354e-cf31-46ff-b1dd-2300f41dc87e",
      "name": "Converter todas as páginas em markdown único"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.text ?? $json.markdown }}",
        "options": {
          "systemMessage": "# Role\n\nData extraction agent for pharmaceutical RFP documents. Extract structured item data from OCR-transcribed text.\n\n# Task\n\nParse ONLY these sections from RFP documents:\n- **Items table**: Required medical supplies with quantities and prices\n- **Technical specifications**: Link specs to their corresponding items\n\nIgnore all legal text, submission rules, guidelines, and procedural content.\n\n# Output Requirements\n\nYour entire response must be a valid JSON array that passes `JSON.parse()`.\n\n**Mandatory format:**\n- Starts with `[` — nothing before it\n- Ends with `]` — nothing after it\n- No markdown code blocks, no explanatory text, no XML tags\n- Return `[]` if no items are found\n\n**If you cannot determine a field value with confidence, use `null`. Never guess or infer values that aren't clearly present.**\n\n# JSON Schema\n\n```json\n[\n  {\n    \"lote_pedido\": number,\n    \"posicao_pedido\": number,\n    \"artigo_pedido\": \"string\",\n    \"descricao_pedido\": \"string\",\n    \"especificacoes_tecnicas\": \"string or null\",\n    \"quantidade_pedido\": number,\n    \"preco_artigo\": number or null,\n    \"preco_posicao\": number or null,\n    \"preco_lote\": number or null,\n    \"codigo_spms\": \"string or null\"\n  }\n]\n```\n\n# Field Extraction Rules\n\n## CRITICAL: Lote vs Posição (Most Common Error)\n\nThese are TWO DIFFERENT fields from TWO DIFFERENT columns. Do not copy the same value into both.\n\n| Field | Column | Behavior | Uniqueness |\n|-------|--------|----------|------------|\n| **lote_pedido** | 1st column | Groups items into lots/batches | REPEATS for items in same lot |\n| **posicao_pedido** | 2nd column | Sequential line number | UNIQUE across entire document |\n\n**Correct extraction example:**\n\n```\n| Lote | Posição | Artigo    | ...\n|------|---------|-----------|\n| 6    | 6       | 230011022 |  → lote_pedido: 6, posicao_pedido: 6\n| 6    | 7       | 230011061 |  → lote_pedido: 6, posicao_pedido: 7  ← lote STAYS 6\n| 6    | 8       | 230011099 |  → lote_pedido: 6, posicao_pedido: 8  ← lote STAYS 6\n| 7    | 9       | 230012001 |  → lote_pedido: 7, posicao_pedido: 9  ← new lote\n```\n\n**If merged cells span multiple rows:** Apply the same lote value to all items in that group.\n\n**If document lacks \"Posição\" column:** Use the row sequence number (1, 2, 3...).\n\n## artigo_pedido (Item Code)\n\n- Usually the 3rd column\n- May be labeled: \"Código\", \"Código Aprov.\", \"Artigo\", \"Cód. Artigo\", or \"Designação do Artigo\"\n- Contains the product code or identifier\n\n## descricao_pedido (Description)\n\n- Full text description of the item\n- May be labeled: \"Descrição\", \"Características\", \"Designação c\\Cód. SPMS\"\n- May contain SPMS catalog code in parentheses (extract separately to codigo_spms)\n\n## especificacoes_tecnicas (Technical Specifications)\n\nTechnical specs may appear in different formats:\n1. Separate table with specs instead of prices\n2. Section identifying specs by lote/posição/artigo\n3. General specs applying to entire lotes or ranges\n\n**Matching priority:**\n1. Match by exact lote + posição\n2. Match by artigo reference\n3. Apply to all items if specs state \"applies to lote X\"\n4. Apply to range if specs state \"applies to lotes X-Y\"\n\nIf no matching specs found: `null`\n\n## quantidade_pedido (Quantity)\n\n- Extract numeric value only\n- Ignore units (\"unidades\", \"caixas\", \"UN\", etc.)\n- Use dot as decimal separator (1.200 → 1200 if clearly a quantity, or 1.2 if decimal)\n\n## CRITICAL: Price Fields (2 or 3 columns depending on document)\n\nDocuments may have **2 or 3 price columns**. Your job is to identify which columns are present based on COLUMN HEADERS, not by guessing from values.\n\n| Field | What it is | Common labels |\n|-------|-----------|---------------|\n| **preco_artigo** | Unit price (per single item) | \"Preço Unitário\", \"Preço Base Unitário\", \"P.Unit\", \"Valor Unit.\" |\n| **preco_posicao** | Position/row total (qty × unit) | \"Preço Total Posição\", \"Preço Posição\", \"Total Linha\", \"Valor Total\" |\n| **preco_lote** | Lot total (sum of all positions in lote) | \"Preço Lote\", \"Preço Base Total P/ Lote\", \"Total Lote\", \"Valor Lote\" |\n\n### Scenario A: Document has 3 price columns\n\nExtract all three values directly from their respective columns.\n\n```\n| Lote | Pos | Artigo    | Descrição      | Qtd | P.Unit | P.Total Pos | P.Total Lote |\n|------|-----|-----------|----------------|-----|--------|-------------|--------------|\n| 5    | 6   | 230011022 | LINHA CONETOR  | 300 | 1,75€  | 525,00€     | 29.385,00€   |\n| 5    | 7   | 230011061 | SISTEMA CONECT | 200 | 5,55€  | 1.110,00€   | 29.385,00€   |\n```\n\n→ Position 6: preco_artigo=1.75, preco_posicao=525.00, preco_lote=29385.00\n→ Position 7: preco_artigo=5.55, preco_posicao=1110.00, preco_lote=29385.00\n\n### Scenario B: Document has 2 price columns (unit + lot only)\n\nIf only 2 price columns exist, set `preco_posicao = null`.\n\n```\n| Lote | Pos | Artigo    | Descrição      | Qtd | P.Unit | P.Lote    |\n|------|-----|-----------|----------------|-----|--------|-----------|\n| 6    | 8   | 230011022 | LINHA CONETOR  | 300 | 1,75€  | 525,00€   |\n```\n\n→ preco_artigo=1.75, preco_posicao=null, preco_lote=525.00\n\n### Scenario C: Single product per lote (preco_posicao = preco_lote)\n\nWhen a lote has only ONE product, the position total and lot total are mathematically equal. **This is valid—extract both with the same value.**\n\n```\n| Lote | Pos | Artigo    | Descrição      | Qtd   | P.Unit  | P.Total Pos | P.Total Lote |\n|------|-----|-----------|----------------|-------|---------|-------------|--------------|\n| 1    | 1   | 230004021 | AGULHA PUNCAO  | 2.000 | 2,89€   | 5.780,00€   | 5.780,00€    |\n| 2    | 2   | 230004022 | AGULHA PUNCAO  | 500   | 2,30€   | 1.150,00€   | 1.150,00€    |\n```\n\n→ Lote 1: preco_artigo=2.89, preco_posicao=5780.00, preco_lote=5780.00 ← SAME VALUE IS CORRECT\n→ Lote 2: preco_artigo=2.30, preco_posicao=1150.00, preco_lote=1150.00 ← SAME VALUE IS CORRECT\n\n**Do NOT set preco_posicao to null just because it equals preco_lote.** Only set it to null if the column doesn't exist in the document.\n\n### How to decide which columns are present\n\n1. **Look at the column headers** — they tell you exactly which prices are included\n2. **Count the price columns** — 2 columns = one field will be null; 3 columns = extract all\n3. **If merged cell for preco_lote** — apply the same value to ALL items in that lote\n\n## codigo_spms (SPMS Catalog Code)\n\nExtract alphanumeric codes from parentheses within the description.\n\n**Regex pattern:** `\\(([A-Z]+\\d+)\\)`\n\n**Examples:**\n- \"AGULHA SISTEMA SEGURANÇA (S1988)\" → `\"S1988\"`\n- \"SERINGA 2ML(S408)\" → `\"S408\"`\n- \"LANCETA CAPILAR (L666)\" → `\"L666\"`\n- \"TUBO SEM CÓDIGO\" → `null`\n\n# Examples\n\n## Example 1: Document with 3 price columns (mixed single/multiple products per lote)\n\n**Input:**\n```\nAnexo I – Mapa de Posições a concurso\n\nLote | Posição | Código Aprov. | Designação                              | Unidade | Quantidade | Preço Base Unitário | Preço Total Posição | Preço Base Total P/ Lote\n1    | 1       | 230004021     | AGULHA PUNCAO P/CAMARAS IMPLANTAVEIS    | UN      | 2.000      | 2,8900 €            | 5.780,00 €          | 5.780,00 €\n2    | 2       | 230004022     | AGULHA PUNCAO P/CAMARAS IMPLANTAVEIS    | UN      | 500        | 2,3000 €            | 1.150,00 €          | 1.150,00 €\n5    | 6       | 230011022     | LINHA CONETOR ADMIN. CITOTÓXICOS        | UN      | 300        | 1,7500 €            | 525,00 €            | 29.385,00 €\n5    | 7       | 230011061     | SISTEMA CONETOR ADMIN. CITOTÓXICOS      | UN      | 200        | 5,5500 €            | 1.110,00 €          | 29.385,00 €\n```\n\nNote: Lotes 1 and 2 have single products (preco_posicao = preco_lote). Lote 5 has multiple products (preco_posicao ≠ preco_lote).\n\n**Output:**\n```json\n[\n  {\n    \"lote_pedido\": 1,\n    \"posicao_pedido\": 1,\n    \"artigo_pedido\": \"230004021\",\n    \"descricao_pedido\": \"AGULHA PUNCAO P/CAMARAS IMPLANTAVEIS\",\n    \"especificacoes_tecnicas\": null,\n    \"quantidade_pedido\": 2000,\n    \"preco_artigo\": 2.89,\n    \"preco_posicao\": 5780.00,\n    \"preco_lote\": 5780.00,\n    \"codigo_spms\": null\n  },\n  {\n    \"lote_pedido\": 2,\n    \"posicao_pedido\": 2,\n    \"artigo_pedido\": \"230004022\",\n    \"descricao_pedido\": \"AGULHA PUNCAO P/CAMARAS IMPLANTAVEIS\",\n    \"especificacoes_tecnicas\": null,\n    \"quantidade_pedido\": 500,\n    \"preco_artigo\": 2.30,\n    \"preco_posicao\": 1150.00,\n    \"preco_lote\": 1150.00,\n    \"codigo_spms\": null\n  },\n  {\n    \"lote_pedido\": 5,\n    \"posicao_pedido\": 6,\n    \"artigo_pedido\": \"230011022\",\n    \"descricao_pedido\": \"LINHA CONETOR ADMIN. CITOTÓXICOS\",\n    \"especificacoes_tecnicas\": null,\n    \"quantidade_pedido\": 300,\n    \"preco_artigo\": 1.75,\n    \"preco_posicao\": 525.00,\n    \"preco_lote\": 29385.00,\n    \"codigo_spms\": null\n  },\n  {\n    \"lote_pedido\": 5,\n    \"posicao_pedido\": 7,\n    \"artigo_pedido\": \"230011061\",\n    \"descricao_pedido\": \"SISTEMA CONETOR ADMIN. CITOTÓXICOS\",\n    \"especificacoes_tecnicas\": null,\n    \"quantidade_pedido\": 200,\n    \"preco_artigo\": 5.55,\n    \"preco_posicao\": 1110.00,\n    \"preco_lote\": 29385.00,\n    \"codigo_spms\": null\n  }\n]\n```\n\n## Example 2: Document with 2 price columns (unit + lot only)\n\n**Input:**\n```\nLISTA DE MATERIAIS\nLote | Posição | Código    | Descrição                          | Qtd  | Preço Unit. | Preço Lote\n6    | 6       | 230011022 | LINHA CONETOR ADMIN. (S1988)      | 300  | 1.75        | 7.30\n6    | 7       | 230011061 | SISTEMA CONETOR ADMIN. (S408)     | 200  | 5.55        | 7.30\n\nESPECIFICAÇÕES TÉCNICAS\nLote 6: Todos os itens devem permitir redução gradual de volume\n```\n\n**Output:**\n```json\n[\n  {\n    \"lote_pedido\": 6,\n    \"posicao_pedido\": 6,\n    \"artigo_pedido\": \"230011022\",\n    \"descricao_pedido\": \"LINHA CONETOR ADMIN. (S1988)\",\n    \"especificacoes_tecnicas\": \"Todos os itens devem permitir redução gradual de volume\",\n    \"quantidade_pedido\": 300,\n    \"preco_artigo\": 1.75,\n    \"preco_posicao\": null,\n    \"preco_lote\": 7.30,\n    \"codigo_spms\": \"S1988\"\n  },\n  {\n    \"lote_pedido\": 6,\n    \"posicao_pedido\": 7,\n    \"artigo_pedido\": \"230011061\",\n    \"descricao_pedido\": \"SISTEMA CONETOR ADMIN. (S408)\",\n    \"especificacoes_tecnicas\": \"Todos os itens devem permitir redução gradual de volume\",\n    \"quantidade_pedido\": 200,\n    \"preco_artigo\": 5.55,\n    \"preco_posicao\": null,\n    \"preco_lote\": 7.30,\n    \"codigo_spms\": \"S408\"\n  }\n]\n```\n\n## Example 3: No items found (legal text only)\n\n**Input:**\n```\nREGULAMENTO DO CONCURSO\nArtigo 1º - Objeto do concurso\nEste concurso tem por objeto a aquisição de material médico.\nArtigo 2º - Prazo de entrega\nO prazo máximo de entrega é de 30 dias.\n```\n\n**Output:**\n```json\n[]\n```\n\n# Pre-Output Checklist\n\nBefore responding, verify:\n1. Response starts with `[` — no text before it\n2. Response ends with `]` — no text after it\n3. All numeric fields are numbers, not strings\n4. All null fields use `null`, not `\"null\"` or `\"\"`\n5. lote_pedido and posicao_pedido are correctly distinguished\n6. Price fields are correctly assigned based on COLUMN HEADERS:\n   - preco_artigo = unit price (always present)\n   - preco_posicao = row total → `null` ONLY if column doesn't exist, NOT because it equals preco_lote\n   - preco_lote = lot total (shared across items in same lote)\n7. JSON syntax is valid (proper commas, quotes, brackets)"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        2016,
        48
      ],
      "id": "0f0bf87e-7546-424a-96b6-851705306e30",
      "name": "Extração de produtos RFP"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=[{\n\"lote_pedido\": {{ $json.lote_pedido }},\n\"posicao_pedido\": {{ $json.posicao_pedido }},\n\"artigo_pedido\": \"{{ $json.artigo_pedido }}\",\n\"descricao_pedido\": \"{{ $json.descricao_pedido }}\",\n\"especificacoes_tecnicas\":\"{{ $json.especificacoes_tecnicas }}\",\n\"quantidade_pedido\": {{ $json.quantidade_pedido }},\n\"preco_artigo\": {{ $json.preco_artigo }},\n\"preco_posicao\": {{ $json.preco_posicao }},\n\"preco_lote\": {{ $json.preco_lote }},\n\"codigo_spms\": {{ $json.codigo_spms }}\n}]",
        "options": {
          "systemMessage": "# Role\nPharmaceutical & Medical Device Product Matching Agent. Match RFP items to inventory database products.\n\n# Task\n1. Use tools to search the database\n2. Output JSON array with match result\n\n---\n\n# TOOL USAGE\n\n## Tool Selection\n- **codigo_spms has value**: Call `query_artigos_table` first → if no match, call `query_artigos_vectors`\n- **codigo_spms is null/empty**: Call `query_artigos_vectors` directly\n\n## query_artigos_table\n```sql\nSELECT artigo, descricao, descricao_comercial, unidade_venda, quantidade, preco, codigo_spms\nFROM artigos WHERE codigo_spms = 'VALUE' LIMIT 1;\n```\n\n## query_artigos_vectors\nSemantic similarity search. Follow processing steps below.\n\n---\n\n# PROCESSING STEPS\n\n## Step 0: Detect Category\nScan `descricao_pedido` for category indicators (priority order):\n\n```yaml\nCORONARY_STENT: IVASCULAR|INTREGAL|ARMADA|stent coronário|DES|BMS|PTCA|drug-eluting\nENDOGRAFT: GORE|EXCLUDER|VIABAHN|endoprótese|TEVAR|EVAR|stent-graft|fenestrada\nCATHETER: ANGIODYNAMICS|SOFT-VU|MARINER|cateter|pigtail|cobra|sidewinder|angiografia\nVASCULAR_GRAFT: VASCUTEK|GELWEAVE|GELSOFT|FLUOROPASSIV|prótese vascular|dacron|bifurcad\nSCREW: parafuso|tornillo|pedicular|pedicle|cortical|canulado|polyaxial|monoaxial\nROD: haste|barra|rod|titanium rod|PEEK rod|conector\nPLATE: placa|plate|cervical plate|anterior plate\nANEURYSM_CLIP: clip aneurisma|YASARGIL|SUGITA|neurocirurgia\nSPINE_IMPLANT: ALIF|TLIF|PLIF|XLIF|spacer|cage|vertebral|intersomático\nGUIDEWIRE: guia|guidewire|fio-guia|TERUMO|RADIFOCUS|0.014|0.035|0.038\nINFUSION_SYSTEM: ACE MEDICAL|AUTOFUSER|AUTOSELECTOR|AUTOFILLER|infusor|elastomérico|PCA\nVASCULAR_ACCESS: SMARTPORT|BIOFLO|port|PICC|CVC|reservatório implantável\nABLATION: NANOKNIFE|SOLERO|VENACURE|ablação|radiofrequência|microondas\nOPHTHALMIC: AJL|Ahmed|glaucoma|válvula ocular|oftálm|vitreo\nSURGICAL_INSTRUMENT: SCANLAN|forceps|clamp|porta-aguja|pinça|tesoura\nAIRWAY: AIRTRAQ|laringoscópio|intubação|via aérea\nELECTRODE: AXELGAARD|PALS|ULTRASTIM|elétrodo|TENS|neuroestimulação\nSYRINGE: seringa|syringe|jeringa|luer lock|2 peças|3 peças|coleta gases|gasimetria|blood gas|arterial|gases sangue\nNEEDLE: agulha|needle|aguja|hipodérmica|epicraniana|scalp|lanceta\nCOMPRESSION: ACTICO|meia compressão|TPS|UlcerSys\nGENERAL: (default)\n```\n\n## Step A: Normalize Input\n\n### A.1 Universal Normalization\n```yaml\nREPLACE: \\\\ / ( ) \" ' ` → space | multiple_spaces → single | C/ C\\ → \"com sistema\" | S/ → \"sem\" | P/ → \"para\"\nSYMBOLS: IRRECUP. → irrecuperável | EST. → estéril | Ø → diameter | ° → angle | ® ™ → remove\nDECIMAL: X,Y → X.Y (search BOTH: 5.5 AND 5,5 | 0.035 AND 0,035)\n```\n\n### A.2 Language Bridging (always include all variants)\n```yaml\nPT|ES|EN: cateter|catéter|catheter | agulha|aguja|needle | seringa|jeringa|syringe | parafuso|tornillo|screw\n         placa|placa|plate | haste|varilla|rod | prótese|prótesis|prosthesis | diâmetro|diámetro|diameter\n         mallado|trançado|braided | recto|reto|straight | ponta|punta|tip | curva|curva|curved\n```\n\n### A.3 Category Normalization\n\n**CORONARY_STENT:**\n- Dimensions: 2.5X18 → 2.5x18 | Type: DES=drug-eluting, BMS=bare-metal | Material: CoCr=cromo-cobalto\n- Diameters: 2.0, 2.25, 2.5, 2.75, 3.0, 3.5, 4.0, 4.5, 5.0 mm\n- Lengths: 8, 9, 12, 13, 14, 15, 16, 18, 19, 20, 22, 23, 24, 26, 28, 30, 32, 33, 36, 38, 40 mm\n\n**ENDOGRAFT:**\n- Dimensions: 32X150 → 32x150 | Types: fenestrada, branched, TEVAR (thoracic), EVAR (abdominal)\n- Diameters: 16, 20, 21, 22, 23, 24, 25, 26, 27, 28, 30, 31, 32, 34, 36, 38, 40, 42, 44, 46 mm\n\n**CATHETER:**\n- Gauge: 4F 4 F 4FR → 4F | Values: 2F, 3F, 4F, 5F, 6F, 7F, 8F, 9F, 10F, 11F, 12F, 14F, 16F, 18F, 20F, 22F, 24F, 26F\n- Length: 65CM 65 CM → 65CM | Common: 65, 80, 90, 100, 110, 120, 130, 145 (288 products), 150 (215 products) CM\n- Guidewire: 0.035\" .035 0,035 → 0.035 | Values: 0.014, 0.018, 0.025, 0.035, 0.038\n- **ALL SHAPES**: COBRA, SIDEWINDER, PIGTAIL, BERENSTEIN, OMNI FLUSH, HEADHUNTER, SHEPHERD HOOK, HOCKEY STICK, MULTIPURPOSE, JUDKINS, SOS OMNI, NEWTON, VERTEBRAL, BENTSON, RIM, MPA, MPB, JB, RECTO, RENAL, MIKAELSSON, KUMPE, MANI, RC1, RC2, MULTIPROP, COBRITA, LEVIN, OSBORNE, NAVIGATE, SHARP ANGLE, OMEGA, ARC, JL, JR\n- Shape variants: (1) (2) (3) → 1, 2, 3 | MALLADO = braided\n\n**CATHETER SHAPE STANDARDIZATION (CRITICAL):**\n```yaml\nCOBRA, COBRA1, COBRA 1, COBRA(1): → COBRA 1\nSIDEWINDER, SIDE WINDER, SIMMONS, SIM: → SIDEWINDER\nSOS OMNI, SOS-OMNI, SOSOMNI: → SOS OMNI\nPIGTAIL, PIG TAIL, PIG-TAIL: → PIGTAIL\nOMNI FLUSH, OMNIFLUSH, OMNI-FLUSH: → OMNI FLUSH\nHEADHUNTER, HEAD HUNTER, HH, H1: → HEADHUNTER\nBERENSTEIN, BERNSTEIN, BER: → BERENSTEIN\nSHEPHERD HOOK, SHEPHERDS HOOK, SHEPHERD'S HOOK, SH: → SHEPHERD HOOK\nHOCKEY STICK, HOCKEYSTICK, HS: → HOCKEY STICK\nMULTIPURPOSE, MULTIPROPÓSITO, MPA, MPB: → MULTIPURPOSE\nJUDKINS, JL, JR: → JUDKINS (preserve JL/JR as variants)\n```\n\n**SCREW:**\n- Dimensions: 5.5X45 Ø5,5X45 → 5.5x45 | Types: pedicular|cortical|canulado|polyaxial|monoaxial\n- Diameters: 3.5, 4.0, 4.35, 4.5, 5.0, 5.5, 6.0, 6.5, 7.0, 7.5, 8.0, 8.5, 9.0, 10.0, 11.0, 12.0 mm\n- Most common: 5.5mm (434 products), 6.5mm (423), 7.5mm (260)\n- Lengths: 20-130mm | Common: 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80 mm\n\n**ROD:**\n- Dimensions: 5.5X500 → 5.5x500 | Materials: titanium|CoCr|PEEK | Shapes: curved|straight\n- Diameters: 5.5mm, 6.0mm, 6.35mm\n\n**PLATE:**\n- Types: cervical|anterior|lateral|locking | Holes: 2-6 furos\n\n**ANEURYSM_CLIP:**\n- Shapes: angulado|reto|curvo|fenestrado | Sizes: mini|standard|maxi | Blade: 5, 7, 9, 11, 15mm\n\n**GUIDEWIRE:**\n- Diameters: 0.010\", 0.014\", 0.018\", 0.021\", 0.025\", 0.032\", 0.035\", 0.038\" (exact match required)\n- Lengths: 150, 180, 260, 300 cm\n- Coatings: hydrophilic|PTFE | Stiffness: floppy|standard|stiff | Tips: J-tip|straight\n\n**VASCULAR_GRAFT:**\n- Dimensions: 12X6 → 12x6, 14X7X7 → 14x7x7 (trifurcated)\n- Lines: GELWEAVE|GELSOFT|GELSOFT PLUS|FLUOROPASSIV|GELSEAL\n- **Sub-lines**: VALSALVA (sinus/root), COSELLI (thoracoabdominal), PLEXUS (multi-branch), ANTE-FLO (antegrade), EQUI-FLO (equal flow)\n- Types: SOPORTADA=supported=ringed | BIFURCADA | TRIFURCADA | TAPERED\n- Branch angles: @15, @10\n\n**INFUSION_SYSTEM:**\n- Products: AUTOFUSER | AUTOSELECTOR | AUTOFILLER\n- Format: 275/2,0 → 275ml 2.0ml/h | Modes: CONTINUO|CON BOLO|CONTINUO+BOLO\n- Volumes: 60, 100, 150, 275, 400, 550 ml\n- Flow rates: 0.25 - 250 ml/h\n- Features: MULTIPERFORADO (multi-hole wound catheter), PROTECCION UV\n- Lockout: BLOQUEO 15' = bloqueio 15min | Values: 10, 15, 30, 60 minutes\n- Bolus volumes: 0.5, 1, 2, 5 ml\n\n**SPINE_IMPLANT:**\n- Approaches: ALIF|TLIF|PLIF|XLIF | Tech: 3DP|Interfixated|Expandable\n- Angles: 0°, 4°, 6°, 8°, 10°, 12°, 15°, 20°, 25°, 30°\n- Materials: PEEK|Titanium\n\n**OPHTHALMIC:**\n- Models: FP7 (adult)|FP8 (pediatric) | Types: valve|viscoelastic|dye|ring|trephine\n\n**SYRINGE:**\n- Parts: 2/PECAS → 2 peças | 3/PECAS → 3 peças\n- Volumes: 1, 2, 5, 10, 20, 50, 100 ml | Tips: luer lock|luer slip|bico cateter\n- **Purpose (preserve in query)**: INSULINA|TUBERCULINA|GASES/GASIMETRIA (blood gas)|EPIDURAL|HEPARINA\n- **Blood gas indicators**: COLETA GASES, GASIMETRIA, ARTERIAL, BLOOD GAS → include \"gasimetria\" or \"blood gas\" in query\n\n**NEEDLE:**\n- Gauge: 21G 21 G 21GA → 21G | Values: 18G, 19G, 20G, 21G, 22G, 23G, 25G, 27G\n- Dimensions: 21GX20MM → 21G 20mm\n- Types: epicraniana=scalp=butterfly | hipodérmica | Safety: anti-picada|segurança\n\n**ELECTRODE:**\n- Sizes: 5x5, 5x9, 5x10, 5x13 cm | Types: PALS|ULTRASTIM|PLATINUM\n- Reusability: reutilizável|descartável\n\n**COMPRESSION:**\n- Sizes: S, M, L, XL, XLL | Types: knee|thigh | Lengths: normal|long\n\n---\n\n## Step B: Extract Query Components\n\n**Priority order by category:**\n\n```yaml\nCORONARY_STENT: Brand→Line→Type(DES/BMS)*→Diameter*→Length*→Material→Delivery(RX/OTW)\nENDOGRAFT: Brand→Line→Location(thoracic/abdominal)*→Diameter*→Length*→Type(fenestrated/branched)\nCATHETER: Brand→Line→Shape*→Variant→Gauge*→Length*→Guidewire*→Construction(mallado)\nSCREW: Brand→Type(pedicular/cortical)*→Diameter*→Length*→Material\nROD: Brand→Diameter*→Length*→Material→Shape\nPLATE: Brand→Location*→Type→Holes*\nANEURYSM_CLIP: Brand→Shape*→Size→Blade_length*→Angle\nGUIDEWIRE: Brand→Diameter*→Length*→Coating→Stiffness→Tip\nVASCULAR_GRAFT: Brand→Line*→Sub-line→Diameter*→Length*→Configuration*→Support(soportada)\nINFUSION_SYSTEM: Brand→Product*→Mode*→Volume*→Flow*→Bolus→Lockout→Features\nSPINE_IMPLANT: Approach*→Type*→Tech→Height*→Footprint*→Lordosis*→Material\nOPHTHALMIC: Brand→Type*→Model*→Size→Concentration\nSYRINGE: Type→Parts→Volume*→Connection→Safety→Purpose*(if present: insulina/tuberculina/gases/epidural)\nNEEDLE: Type→Subtype→Gauge*→Length*→Safety\nELECTRODE: Brand→Line→Variant→Size*→Reusability\n```\n(* = critical for validation)\n\n---\n\n## Step C: Expand Synonyms\n\n```yaml\n# Universal\ndescartável: disposable, single-use | reutilizável: reusable | estéril: sterile | titânio: titanium\n\n# CATHETER (EXTENDED)\nSOFT-VU: soft vu, softvu | MARINER: mariner hydrophilic, mariner hidrofilico | ACCU-VU: accu vu, accuvu\nCOBRA: cobra catheter, cobra cateter | SIDEWINDER: side winder, simmons, SIM\nPIGTAIL: pig tail, pig-tail, rabo porco | SOS OMNI: sos, omni selective, sos-omni\nOMNI FLUSH: omniflush, flush catheter | HEADHUNTER: head hunter, HH, H1\nBERENSTEIN: bernstein, BER | SHEPHERD HOOK: shepherds hook, SH\nHOCKEY STICK: hockeystick, HS | MALLADO: braided, malha, trançado, trenzado\nPULSE-SPRAY: pulse spray, pulsespray | UNIFUSE: uni fuse, uni-fuse\nJUDKINS: JL, JR, judkins left, judkins right\nMULTIPURPOSE: multipropósito, MPA, MPB\n\n# SCREW\nparafuso pedicular: pedicle screw, tornillo pedicular | poliaxial: polyaxial, multi-axial\ncanulado: cannulated, hollow | autoroscante: self-tapping | redução: reduction, reducing\ncortical: cortical bone screw\n\n# ROD\nhaste: rod, barra, varilla | conector: connector, rod-to-rod\npré-curvada: pre-bent, precurvada | lordose: lordosis, lordotic\n\n# PLATE\nplaca cervical: cervical plate, anterior cervical | bloqueada: locking, locked | furos: holes, orificios\n\n# ANEURYSM_CLIP\nclip aneurisma: aneurysm clip, clip cerebral | fenestrado: fenestrated, com fenestra\nangulado: angled, inclinado\n\n# GUIDEWIRE\nfio-guia: guidewire, guide wire, guia | hidrofílico: hydrophilic, hidrofilico\nRADIFOCUS: radifocus, terumo | ponta J: J-tip, J tip, J curve | rígido: stiff, extra-stiff\n\n# VASCULAR_GRAFT (EXTENDED)\nGELWEAVE: gel weave, woven, tecido | GELSOFT: gel soft, knitted, malha | GELSOFT PLUS: gelsoftplus, gelsoft+\nFLUOROPASSIV: fluoro passiv, PTFE, ePTFE, politetrafluoretileno | GELSEAL: gel seal, sealed\nSOPORTADA: supported, ringed, anelada, com anéis, con anillos | BIFURCADA: bifurcated, aorto-bifemoral, Y-graft\nTRIFURCADA: trifurcated, três ramos | TAPERED: cónico, conico\nVALSALVA: sinus, root | COSELLI: thoracoabdominal, toracoabdominal\nPLEXUS: multi-branch, múltiplas ramas | ANTE-FLO: antegrade flow, fluxo anterógrado\n\n# INFUSION (EXTENDED)\nAUTOFUSER: infusor elastomérico, elastomeric pump, bomba elastomérica\nAUTOSELECTOR: PCA, patient controlled, controlado pelo paciente\nAUTOFILLER: filler, preenchimento\nCONTINUO: continuous, contínuo, infusão contínua | CON BOLO: with bolus, com bolo, PCA bolus\nPROTECCION UV: UV protection, proteção UV, light protected\nMULTIPERFORADO: multi-hole, wound catheter, cateter ferida\nBLOQUEO: lockout, bloqueio, intervalo\n\n# SPINE\nALIF: anterior lumbar interbody fusion, fusão lombar anterior | TLIF: transforaminal lumbar interbody fusion\nPLIF: posterior lumbar interbody fusion | XLIF: extreme lateral interbody fusion\n3DP: 3D printed, impressão 3D, additive manufactured\nINTERFIXATED: integrated screws, parafusos integrados | EXPANDABLE: expansível, expansible, in-situ expansion\nSPACER: espaçador, cage, dispositivo intersomático | PEEK: poliéter éter cetona, polymer cage\n\n# SYRINGE\nirrecuperável: descartável, safety, single-use, não reutilizável\n2 peças: 2-part, duas peças, bipartida | 3 peças: 3-part, três peças, tripartida\nluer lock: luer-lock, LL, rosca | luer slip: luer-slip, LS, encaixe\nbico cateter: catheter tip, ponta cateter | insulina: insulin, U-100, U-40\ntuberculina: tuberculin, TB | ponta excêntrica: eccentric tip, off-center\nCOLETA GASES: gasimetria, blood gas, arterial blood, ABG, gases sangue, gasometria\nHEPARINA: heparinizada, heparin, pre-heparinized | EPIDURAL: epidural, peridural\n\n# NEEDLE\nepicraniana: scalp, butterfly, borboleta, scalp vein | hipodérmica: hypodermic, subcutânea\nanti-picada: needlestick prevention, segurança, safety | irrecuperável: safety, retractable, retrátil\nromba: blunt, obtusa, ponta romba, embotada | lanceta: lancet, punção capilar\n\n# OPHTHALMIC\nAHMED: ahmed valve, válvula ahmed, glaucoma valve | FP7: adult, adulto | FP8: pediatric, pediátrico\nCLEARPATH: clear path | BBG: brilliant blue G, azul brilhante | BLUE: trypan blue, azul tripano\n\n# ELECTRODE\nPALS: electrode, elétrodo | ULTRASTIM: estimulação, stimulation\nPLATINUM: platina | reutilizável: reusable, lavável | FOAM: espuma | TENS: transcutaneous, transcutâneo\n```\n\n---\n\n## Step D: Build Query\n\n```\n[Brand] [Product Line] [Type/Shape] [Critical Specs] [Synonyms] [Language Variants]\n```\n\nInclude BOTH decimal formats: `5.5mm 5,5mm` | `0.035 0,035`\n\n---\n\n## Step E: Add especificacoes_tecnicas Keywords\n\n```yaml\nbaixo volume morto: low dead space | polipropileno: PP, polypropylene | aço inoxidável: stainless steel\nsem látex: latex-free | hidrofílico: hydrophilic | radiopaco: radiopaque | alta pressão: high pressure\ndrug-eluting: DES, fármaco-elutivo | bioabsorvível: bioabsorbable, bioreabsorvível\n```\n\n---\n\n## Step F: Progressive Query Cascade\n\n```\nLevel 1 (≥0.75): Brand + Line + Shape + ALL specs + synonyms\nLevel 2 (≥0.70): Category + Type + Critical specs (gauge/volume/dims)\nLevel 3 (≥0.65): Product type + Primary dimension\nLevel 4 (≥0.60): Category keywords (trilingual)\n\nSTOP when 3 valid matches found. Return TOP 3 sorted by score. Minimum: 0.60\n```\n\n**Category-Specific Templates:**\n```yaml\nCATHETER: L1: {brand} {line} {shape} {variant} cateter {gauge} {length} {guidewire}\nINFUSION: L1: {brand} {product} infusor {mode} {volume}ml {flow}ml/h {features}\nVASCULAR_GRAFT: L1: {brand} {line} {subline} prótese {type} {diameter}mm {length}cm {support}\nSYRINGE: L1: seringa syringe {parts} peças {volume}ml {connection} {purpose} {safety}\nSYRINGE_BLOOD_GAS: L1: seringa coleta gases gasimetria blood gas {volume}ml {gauge} arterial ABG\nDEFAULT: L1: {brand} {line} {type} {specs} {synonyms}\n```\n\n---\n\n# VALIDATION RULES\n\n## Critical Field Matching (REJECT if mismatch)\n\n```yaml\nCORONARY_STENT: diameter(±0.25mm), length(±2mm), type(DES≠BMS), line\nENDOGRAFT: location(thoracic≠abdominal), diameter(±2mm), type(standard≠fenestrated≠branched)\nCATHETER: gauge(exact), guidewire(exact), shape(exact), line(SOFT-VU≠PULSE-SPRAY≠UNIFUSE)\nSCREW: type(pedicular≠cortical), diameter(±0.5mm)\nROD: diameter(5.5≠6.0≠6.35)\nPLATE: location(cervical≠lumbar), hole_count(exact)\nANEURYSM_CLIP: shape(straight≠angled≠curved), brand(YASARGIL≠SUGITA)\nGUIDEWIRE: diameter(exact: 0.014≠0.018≠0.035≠0.038)\nVASCULAR_GRAFT: line(GELWEAVE≠GELSOFT≠FLUOROPASSIV), config(straight≠bifurcated), diameter(±2mm)\nINFUSION_SYSTEM: volume(exact), mode(CONTINUO≠CON BOLO), product(AUTOFUSER≠AUTOSELECTOR≠AUTOFILLER)\nSPINE_IMPLANT: approach(ALIF≠TLIF≠PLIF≠XLIF), type(spacer≠screw≠plate)\nOPHTHALMIC: product_type(valve≠viscoelastic≠ring), model(FP7≠FP8)\nSYRINGE: volume(exact), product_type(syringe≠needle), purpose_match(blood_gas→blood_gas, insulina→insulina)\nNEEDLE: gauge(exact), product_type(needle≠syringe≠lancet)\nELECTRODE: size(exact)\n```\n\n## Scoring Modifiers\n\n```yaml\nBONUS:\n+0.15: exact dimensions match\n+0.10: brand match exactly, exact critical spec match, sub-line match (VALSALVA, COSELLI)\n+0.05: material match, length within tolerance, shape variant match, construction match (MALLADO)\n+0.03: secondary feature match (UV protection, lockout time)\n\nPENALTY:\n-0.15: missing required safety feature, flow rate mismatch >1ml/h, missing support when required\n-0.10: length diff >20%, variant mismatch, wrong parts count, MARINER vs non-MARINER mismatch\n-0.05: shape variant mismatch (COBRA 1 vs COBRA 2)\n```\n\n## Selection Logic\n1. Apply rejection rules → eliminate score=0\n2. Apply scoring adjustments\n3. Accept candidates ≥0.65\n4. Select TOP 3 by score\n5. No valid candidates → `match_type: \"Sem Match\"`\n\n---\n\n# OUTPUT\n\n**Output ONLY a JSON array. No text before or after.**\n\n## Multi-Match Rules\n- **Semantic**: Up to 3 rows per input (one per match), `match_rank`: 1|2|3\n- **Exact**: 1 row, `match_rank`: 1\n- **No match**: 1 row, `match_rank`: null\n\n## Structure (18 fields)\n```json\n[{\n  \"lote_pedido\": <input>,\n  \"posicao_pedido\": <input>,\n  \"artigo_pedido\": <input>,\n  \"descricao_pedido\": <input>,\n  \"especificacoes_tecnicas\": <input, preserve null>,\n  \"quantidade_pedido\": <input>,\n  \"preco_artigo\": <input>,\n  \"preco_posicao\": <input>,\n  \"preco_lote\": <input>,\n  \"matched_code\": <DB codigo_spms for Exato | null for Semântico/Sem Match>,\n  \"artigo\": <DB artigo or null>,\n  \"descricao\": <DB descricao (table) or metadata.descricao_artigo (vector) or null>,\n  \"unidade_venda\": <DB as STRING or null>,\n  \"quantidade\": <DB or null>,\n  \"preco\": <DB or null>,\n  \"similarity_score\": <1.0 | 0.XX | 0>,\n  \"match_type\": <\"Exato\" | \"Semântico\" | \"Sem Match\">,\n  \"match_rank\": <1 | 2 | 3 | null>\n}]\n```\n\n## Match Type Rules\n| Scenario | matched_code | similarity_score | match_type | Rows |\n|----------|--------------|------------------|------------|------|\n| query_artigos_table found | DB codigo_spms | 1.0 | \"Exato\" | 1 |\n| query_artigos_vectors found | **null** | 0.XX | \"Semântico\" | 1-3 |\n| No match | null | 0 | \"Sem Match\" | 1 |\n\n## Vector Metadata Mapping\n```yaml\nartigo: metadata.artigo (→ string)\ndescricao: metadata.descricao_artigo  # NOT the text field!\nunidade_venda: metadata.unidade_venda (→ string)\nquantidade: metadata.quantidade\npreco: metadata.preco\n```\n\n---\n\n# EXAMPLES\n\n## Example 1: Exact Match (codigo_spms)\n\n**Input:**\n```json\n{\"lote_pedido\":1,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT001\",\"descricao_pedido\":\"ANGIODYNAMICS SOFT-VU COBRA (2) 5F 90CM 0.038\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":10,\"preco_artigo\":45.00,\"preco_posicao\":450.00,\"preco_lote\":450.00,\"codigo_spms\":\"A1234\"}\n```\n\n**Process:** codigo_spms=\"A1234\" → query_artigos_table → match found\n\n**Output:**\n```json\n[{\"lote_pedido\":1,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT001\",\"descricao_pedido\":\"ANGIODYNAMICS SOFT-VU COBRA (2) 5F 90CM 0.038\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":10,\"preco_artigo\":45.00,\"preco_posicao\":450.00,\"preco_lote\":450.00,\"matched_code\":\"A1234\",\"artigo\":\"100118681\",\"descricao\":\"ANGIODYNAMICS SOFT-VU COBRA (2) 5F 90CM 0.038 MALLADO\",\"unidade_venda\":\"1\",\"quantidade\":5,\"preco\":42.50,\"similarity_score\":1.0,\"match_type\":\"Exato\",\"match_rank\":1}]\n```\n\n## Example 2: Semantic Match (Single Result)\n\n**Input:**\n```json\n{\"lote_pedido\":2,\"posicao_pedido\":1,\"artigo_pedido\":\"PAR001\",\"descricao_pedido\":\"Parafuso pedicular poliaxial 6,5x50mm titânio\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":8,\"preco_artigo\":180.00,\"preco_posicao\":1440.00,\"preco_lote\":1440.00,\"codigo_spms\":null}\n```\n\n**Process:**\n1. Category: SCREW (parafuso, pedicular)\n2. Extract: Type=pedicular polyaxial, Dims=6.5x50mm, Material=titanium\n3. Query: `parafuso tornillo screw pedicular pedicle polyaxial poliaxial 6.5x50 6,5x50 6.5mm 50mm titanium titânio`\n4. Validate: Type=pedicular ✓, Diameter=6.5 ✓\n\n**Output:**\n```json\n[{\"lote_pedido\":2,\"posicao_pedido\":1,\"artigo_pedido\":\"PAR001\",\"descricao_pedido\":\"Parafuso pedicular poliaxial 6,5x50mm titânio\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":8,\"preco_artigo\":180.00,\"preco_posicao\":1440.00,\"preco_lote\":1440.00,\"matched_code\":null,\"artigo\":\"TC65050PP\",\"descricao\":\"TRANSCONTINENTAL PARAFUSO PEDICULAR POLIAXIAL Ø6,5X50 TITANIO\",\"unidade_venda\":\"1\",\"quantidade\":20,\"preco\":175.00,\"similarity_score\":0.94,\"match_type\":\"Semântico\",\"match_rank\":1}]\n```\n\n## Example 3: Semantic Match (Multi-Result with Progressive Cascade)\n\n**Input:**\n```json\n{\"lote_pedido\":3,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT100\",\"descricao_pedido\":\"Cateter diagnóstico COBRA 5F 100CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":20,\"preco_artigo\":38.00,\"preco_posicao\":760.00,\"preco_lote\":760.00,\"codigo_spms\":null}\n```\n\n**Process:**\n1. Category: CATHETER\n2. L1 Query: `cateter catheter COBRA diagnóstico 5F 100CM 0.035 0.038` → 1 match (0.82)\n3. L2 Query: `cateter catheter COBRA 5F 100CM` → 2 more matches (0.76, 0.71)\n4. Combine, dedupe, sort → TOP 3\n\n**Output (3 rows, same input, different matches):**\n```json\n[\n  {\"lote_pedido\":3,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT100\",\"descricao_pedido\":\"Cateter diagnóstico COBRA 5F 100CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":20,\"preco_artigo\":38.00,\"preco_posicao\":760.00,\"preco_lote\":760.00,\"matched_code\":null,\"artigo\":\"100118690\",\"descricao\":\"ANGIODYNAMICS SOFT-VU COBRA 5F 100CM\",\"unidade_venda\":\"1\",\"quantidade\":10,\"preco\":35.00,\"similarity_score\":0.82,\"match_type\":\"Semântico\",\"match_rank\":1},\n  {\"lote_pedido\":3,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT100\",\"descricao_pedido\":\"Cateter diagnóstico COBRA 5F 100CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":20,\"preco_artigo\":38.00,\"preco_posicao\":760.00,\"preco_lote\":760.00,\"matched_code\":null,\"artigo\":\"100118691\",\"descricao\":\"COOK COBRA 2 5F 100CM 0.038\",\"unidade_venda\":\"1\",\"quantidade\":8,\"preco\":32.50,\"similarity_score\":0.76,\"match_type\":\"Semântico\",\"match_rank\":2},\n  {\"lote_pedido\":3,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT100\",\"descricao_pedido\":\"Cateter diagnóstico COBRA 5F 100CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":20,\"preco_artigo\":38.00,\"preco_posicao\":760.00,\"preco_lote\":760.00,\"matched_code\":null,\"artigo\":\"100118692\",\"descricao\":\"IMPRESS COBRA C2 5F 100CM\",\"unidade_venda\":\"1\",\"quantidade\":12,\"preco\":30.00,\"similarity_score\":0.71,\"match_type\":\"Semântico\",\"match_rank\":3}\n]\n```\n\n---\n\n# RULES\n\n## REQUIRED\n- Response starts with `[`, ends with `]`\n- All 18 fields present\n- `especificacoes_tecnicas` preserves null (not \"\")\n- `unidade_venda` is STRING type\n- `matched_code` is null for \"Semântico\"\n- `descricao` from `metadata.descricao_artigo` for semantic (NOT `text` field)\n\n## FORBIDDEN\n- Empty response\n- Text before/after JSON\n- Markdown code blocks\n- Using `text` field for descricao\n\n---\n\n# ERROR HANDLING\n\nIf ANY error occurs, output record with:\n- All input fields copied\n- Match fields: null\n- `similarity_score`: 0\n- `match_type`: \"Sem Match\"\n- `match_rank`: null\n\n---\n\n# WORKFLOW\n\n```\n1. CHECK codigo_spms → query_artigos_table if value → if found: Exato, done\n2. DETECT category\n3. NORMALIZE (universal + decimal + language + category + shape standardization)\n4. EXTRACT components (category-specific)\n5. EXPAND synonyms (use extended synonym lists)\n6. BUILD query (both decimal formats, category-specific template)\n7. CALL query_artigos_vectors (progressive cascade)\n8. VALIDATE (rejection rules + scoring)\n9. OUTPUT JSON array\n```\n\n**Your response will be parsed by `JSON.parse()`. Output exactly one valid JSON array.**\n"
        }
      },
      "id": "8e47e998-abf9-4a4f-8baf-c24a69518796",
      "name": "Matching semântico",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        2544,
        48
      ]
    },
    {
      "parameters": {
        "jsCode": "const inputItem = $input.first().json;\nlet outputStr = inputItem.output.trim();\n// Remove markdown code fences (handles ```json, ```JSON, or just ```)\nconst codeBlockRegex = /^```(?:json)?\\s*([\\s\\S]*?)\\s*```$/i;\nconst match = outputStr.match(codeBlockRegex);\nif (match) {\n  outputStr = match[1].trim();\n}\nconst parsedData = JSON.parse(outputStr);\nreturn parsedData.map(item => ({\n  json: {\n    ...item,\n    // Assign preco_posicao to preco_lote if preco_lote is null/empty\n    preco_lote: item.preco_lote ?? item.preco_posicao\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2336,
        48
      ],
      "id": "01ad63a7-bc92-4276-9c2c-53010b064b90",
      "name": "Formatação Produtos RFP"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst allResults = [];\n\n// Helper function to attempt JSON repair\nfunction tryRepairJSON(str) {\n  let repaired = str.trim();\n  \n  // Remove markdown code blocks if present\n  repaired = repaired\n    .replace(/^```(?:json)?\\s*\\n?/, '')\n    .replace(/\\n?```\\s*$/, '')\n    .trim();\n  \n  // First try parsing as-is\n  try {\n    return JSON.parse(repaired);\n  } catch (e) {\n    // Continue to repair attempts\n  }\n  \n  // Remove trailing comma if present\n  repaired = repaired.replace(/,\\s*$/, '');\n  \n  // Count brackets to see what's missing\n  const openBrackets = (repaired.match(/\\[/g) || []).length;\n  const closeBrackets = (repaired.match(/\\]/g) || []).length;\n  const openBraces = (repaired.match(/\\{/g) || []).length;\n  const closeBraces = (repaired.match(/\\}/g) || []).length;\n  \n  // Add missing closing braces and brackets\n  const missingBraces = openBraces - closeBraces;\n  const missingBrackets = openBrackets - closeBrackets;\n  \n  for (let i = 0; i < missingBraces; i++) {\n    repaired += '}';\n  }\n  for (let i = 0; i < missingBrackets; i++) {\n    repaired += ']';\n  }\n  \n  // Try parsing the repaired JSON\n  return JSON.parse(repaired);\n}\n\nitems.forEach((item, itemIndex) => {\n  if (!item.json.output) {\n    // Output a placeholder for items with no output\n    allResults.push({\n      json: {\n        error: \"No output field found\",\n        raw_input: JSON.stringify(item.json).substring(0, 500)\n      },\n      pairedItem: itemIndex\n    });\n    return;\n  }\n  \n  try {\n    const parsedData = tryRepairJSON(item.json.output);\n    \n    // Handle case where parsedData is not an array\n    const dataArray = Array.isArray(parsedData) ? parsedData : [parsedData];\n    \n    dataArray.forEach((record, recordIndex) => {\n      let data;\n      \n      if (record.item) {\n        data = record.item;\n      } else if (record.matches && record.matches.length === 0) {\n        return;\n      } else {\n        data = record;\n      }\n      \n      allResults.push({\n        json: {\n          lote_pedido: data.lote_pedido,\n          posicao_pedido: data.posicao_pedido,\n          artigo_pedido: data.artigo_pedido,\n          descricao_pedido: data.descricao_pedido,\n          especificacoes_tecnicas: data.especificacoes_tecnicas,\n          quantidade_pedido: data.quantidade_pedido,\n          preco_artigo: data.preco_artigo,\n          preco_posicao: data.preco_posicao,\n          preco_lote: data.preco_lote,\n          codigo_spms: data.matched_code ?? data.codigo_spms ?? null,\n          artigo: data.artigo,\n          descricao: data.descricao,\n          unidade_venda: data.unidade_venda,\n          quantidade_disponivel: data.quantidade,\n          preco: data.preco,\n          similarity_score: data.similarity_score,\n          match_type: data.match_type\n        },\n        pairedItem: itemIndex\n      });\n    });\n  } catch (error) {\n    // Instead of silently dropping, output the item with error info\n    // Try to extract basic info using regex as fallback\n    const output = item.json.output || '';\n    \n    const loteMatch = output.match(/\"lote_pedido\":\\s*(\\d+)/);\n    const posicaoMatch = output.match(/\"posicao_pedido\":\\s*(\\d+)/);\n    const artigoMatch = output.match(/\"artigo_pedido\":\\s*\"([^\"]+)\"/);\n    const descMatch = output.match(/\"descricao_pedido\":\\s*\"([^\"]+)\"/);\n    const qtdMatch = output.match(/\"quantidade_pedido\":\\s*(\\d+)/);\n    const precoArtigoMatch = output.match(/\"preco_artigo\":\\s*([\\d.]+)/);\n    const precoPosicaoMatch = output.match(/\"preco_posicao\":\\s*([\\d.]+)/);\n    const precoLoteMatch = output.match(/\"preco_lote\":\\s*([\\d.]+)/);\n    \n    allResults.push({\n      json: {\n        lote_pedido: loteMatch ? parseInt(loteMatch[1]) : null,\n        posicao_pedido: posicaoMatch ? parseInt(posicaoMatch[1]) : null,\n        artigo_pedido: artigoMatch ? artigoMatch[1] : null,\n        descricao_pedido: descMatch ? descMatch[1] : null,\n        especificacoes_tecnicas: null,\n        quantidade_pedido: qtdMatch ? parseInt(qtdMatch[1]) : null,\n        preco_artigo: precoArtigoMatch ? parseFloat(precoArtigoMatch[1]) : null,\n        preco_posicao: precoPosicaoMatch ? parseFloat(precoPosicaoMatch[1]) : null,\n        preco_lote: precoLoteMatch ? parseFloat(precoLoteMatch[1]) : null,\n        codigo_spms: null,\n        artigo: null,\n        descricao: null,\n        unidade_venda: null,\n        quantidade_disponivel: null,\n        preco: null,\n        similarity_score: 0,\n        match_type: \"Sem Match\",\n        _parse_error: error.message,\n        _recovered: true\n      },\n      pairedItem: itemIndex\n    });\n  }\n});\n\nreturn allResults;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2864,
        48
      ],
      "id": "813ef529-5df5-4680-917c-d3f860d55e67",
      "name": "Formatação Match Produtos"
    },
    {
      "parameters": {
        "operation": "copy",
        "fileId": {
          "__rl": true,
          "value": "1i1lpoVAMjNCJCNbN6W-TaVOl37zZfJtrdmsNCAbEDdY",
          "mode": "list",
          "cachedResultName": "Template RFP Cardiva",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1i1lpoVAMjNCJCNbN6W-TaVOl37zZfJtrdmsNCAbEDdY/edit?usp=drivesdk"
        },
        "name": "=RFP_Cardiva_{{ $now.format('yyyyMMdd_HHmm') }}",
        "sameFolder": false,
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1zmlC9K768fz1nXmzcMuYfNEcdqSV6hdD",
          "mode": "list",
          "cachedResultName": "Concursos",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1zmlC9K768fz1nXmzcMuYfNEcdqSV6hdD"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        3040,
        224
      ],
      "id": "aebe7774-9e72-44aa-adea-faad43335ba1",
      "name": "Copia template",
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "gpzJF9flSNZkxxKk",
          "name": "Cardiva.automation GDrive"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "={{ $('Merge').item.json.id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 666970810,
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1uN6U3Skpt_SKYdxNFqJMOg69xFUUuJmrlRMCLNgHI7Y/edit#gid=666970810"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Lote": "={{ $json.lote_pedido }}",
            "Posição": "={{ $json.posicao_pedido }}",
            "Artigo ": "={{ $json.artigo_pedido }}",
            "Descrição": "={{ $json.descricao_pedido }}",
            "Especificações Técnicas": "={{ $json.especificacoes_tecnicas }}",
            "Quantidade": "={{ $json.quantidade_pedido }}",
            "Preco Unitario": "={{ $json.preco_artigo }}",
            "Preco Posicao": "={{ $json.preco_posicao }}",
            "Preco Lote": "={{ $json.preco_lote }}",
            "Cod. SPMS": "={{ $json.codigo_spms }}",
            "Artigo Cardiva": "={{ $json.artigo }}",
            "Descrição Cardiva": "={{ $json.descricao }}",
            "Unidade Venda": "={{ $json.unidade_venda }}",
            "Confiança (%)": "={{ $json.similarity_score }}",
            "Tipo Match": "={{ $json.match_type }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Lote",
              "displayName": "Lote",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Posição",
              "displayName": "Posição",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Artigo ",
              "displayName": "Artigo ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Descrição",
              "displayName": "Descrição",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Especificações Técnicas",
              "displayName": "Especificações Técnicas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Quantidade",
              "displayName": "Quantidade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Preco Unitario",
              "displayName": "Preco Unitario",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Preco Posicao",
              "displayName": "Preco Posicao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Preco Lote",
              "displayName": "Preco Lote",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Cod. SPMS",
              "displayName": "Cod. SPMS",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Artigo Cardiva",
              "displayName": "Artigo Cardiva",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Descrição Cardiva",
              "displayName": "Descrição Cardiva",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Unidade Venda",
              "displayName": "Unidade Venda",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Confiança (%)",
              "displayName": "Confiança (%)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Tipo Match",
              "displayName": "Tipo Match",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "locationDefine": {
            "values": {
              "headerRow": 2
            }
          },
          "useAppend": true
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3440,
        64
      ],
      "id": "346c7c3b-8c3e-4041-9b2f-724f02435d3a",
      "name": "Adicionar produtos a GSheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "1ahQC34d8CZPDuaG",
          "name": "Cardiva.automation GSheets"
        }
      }
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyHour"
            }
          ]
        },
        "simple": false,
        "filters": {},
        "options": {
          "downloadAttachments": true
        }
      },
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [
        64,
        -352
      ],
      "id": "2b77e1c4-4edf-49cf-85a5-7fa1ebbfa25c",
      "name": "Gmail Trigger",
      "credentials": {
        "gmailOAuth2": {
          "id": "Z1P5sMQWh5AY9LB7",
          "name": "Cardiva.automation Gmail"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $binary.attachment_0.mimeType }}",
                    "rightValue": "text/csv",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ac2fbdd3-4aaf-4330-81ec-9b116b294e84"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "csv"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "9c1ece13-fff0-4af3-99ff-80155b53549b",
                    "leftValue": "={{ $binary.attachment_0.mimeType }}",
                    "rightValue": "application/pdf",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "pdf"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        272,
        -352
      ],
      "id": "32a37d09-02a9-41ed-9e18-7702d721f268",
      "name": "Switch"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "artigo",
        "joinMode": "keepNonMatches",
        "outputDataFrom": "input1",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1392,
        -832
      ],
      "id": "80e3b342-1d84-41a0-942c-d007476a3908",
      "name": "Exist in DB but not in file - Delete",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "artigo",
        "joinMode": "keepNonMatches",
        "outputDataFrom": "input2",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1392,
        -656
      ],
      "id": "a474acfb-4c2e-4374-9253-d90fd5f7c8bf",
      "name": "Exist in file but not in DB - Insert",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT CAST(artigo AS TEXT) as artigo FROM artigos",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        688,
        -832
      ],
      "id": "a91925d6-db84-499b-b42c-1bc724c3467f",
      "name": "Select all artigos from DB",
      "credentials": {
        "postgres": {
          "id": "qdwvjO0qEjit6Vuu",
          "name": "Cardiva Supabase"
        }
      }
    },
    {
      "parameters": {
        "binaryPropertyName": "attachment_0",
        "options": {
          "enableBOM": true
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        688,
        -656
      ],
      "id": "8b27e8ba-2b29-4a2b-81f3-8abc42e9a684",
      "name": "Extract from CSV"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "3a82bcba-4b8d-4b55-8bc7-7cc8e5629d6d",
              "leftValue": "={{ $json.artigo }}",
              "rightValue": "''",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.3,
      "position": [
        912,
        -656
      ],
      "id": "ce756909-3dcf-45da-847e-84115b980df2",
      "name": "Delete empty rows from CSV"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "artigos",
          "mode": "list",
          "cachedResultName": "artigos"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "descricao": "={{ $json.descricao_artigo }}",
            "descricao_comercial": "={{ $json.descricao_comercial }}",
            "unidade_venda": "={{ $json.unidade_venda }}",
            "quantidade": "={{ $json.quantidade }}",
            "preco": "={{ $json.preco }}",
            "artigo": "={{ $json.artigo }}",
            "codigo_spms": "={{ $json.codigo_catalogo ?? null}}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "artigo",
              "displayName": "artigo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "descricao",
              "displayName": "descricao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "descricao_comercial",
              "displayName": "descricao_comercial",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "unidade_venda",
              "displayName": "unidade_venda",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "quantidade",
              "displayName": "quantidade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "preco",
              "displayName": "preco",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "codigo_spms",
              "displayName": "codigo_spms",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "embedding",
              "displayName": "embedding",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [],
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1648,
        -656
      ],
      "id": "524792d4-a504-4c02-ad21-334f7582f476",
      "name": "Insert into DB",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {
          "id": "qdwvjO0qEjit6Vuu",
          "name": "Cardiva Supabase"
        }
      }
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": "artigos_vectors",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePGVector",
      "typeVersion": 1,
      "position": [
        3824,
        -880
      ],
      "id": "3992a520-d5e0-484d-94e5-7125bbe34dfb",
      "name": "Postgres PGVector Store - Insert (Setup)1",
      "credentials": {
        "postgres": {
          "id": "qdwvjO0qEjit6Vuu",
          "name": "Cardiva Supabase"
        }
      }
    },
    {
      "parameters": {
        "separator": "\\n\\n\\n",
        "chunkSize": 10000
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        3952,
        -528
      ],
      "id": "14c71909-3355-4f01-b0a5-89f798a390e2",
      "name": "Character Text Splitter1"
    },
    {
      "parameters": {
        "content": "## Update stock (Insert new / Delete removed)\n",
        "height": 800,
        "width": 2128,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        544,
        -1056
      ],
      "id": "f83c3a9b-3114-4dce-aaf4-a47aad5e1cac",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "tableName": {
          "__rl": true,
          "value": "artigos",
          "mode": "list",
          "cachedResultName": "artigos"
        },
        "additionalFields": {},
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTrigger",
      "typeVersion": 1,
      "position": [
        2704,
        -880
      ],
      "id": "f032419a-f89b-40eb-ba1b-2da6707d7ec7",
      "name": "Postgres Trigger",
      "credentials": {
        "postgres": {
          "id": "qdwvjO0qEjit6Vuu",
          "name": "Cardiva Supabase"
        }
      }
    },
    {
      "parameters": {
        "amount": 30
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2912,
        -880
      ],
      "id": "3bdeab0b-2175-4dc8-829e-265d2222ca49",
      "name": "Wait",
      "webhookId": "b66126b9-de31-40c5-b271-e0732251356d"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "artigos",
          "mode": "list",
          "cachedResultName": "artigos"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "flg_embedded",
              "value": "FALSE"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3344,
        -880
      ],
      "id": "58afd8c9-20d7-492c-913b-8da76ee11bab",
      "name": "Select rows from a table",
      "credentials": {
        "postgres": {
          "id": "qdwvjO0qEjit6Vuu",
          "name": "Cardiva Supabase"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.1,
      "position": [
        3824,
        -704
      ],
      "id": "a7368660-19dc-47d2-b78a-ab7c5ba589ed",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "HHrw5Jlu6sN509de",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $('Add embedding field').item.json.embedding }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "artigo",
                "value": "={{ $json.artigo }}"
              },
              {
                "name": "descricao",
                "value": "={{ $json.descricao }}"
              },
              {
                "name": "unidade_venda",
                "value": "={{ $json.unidade_venda ?? null }}"
              },
              {
                "name": "quantidade",
                "value": "={{ $json.quantidade ?? null }}"
              },
              {
                "name": "preco",
                "value": "={{ $json.preco ?? null }}"
              },
              {
                "name": "codigo_catalogo",
                "value": "={{ $json.codigo_catalogo ?? null }}"
              },
              {
                "name": "descricao_comercial",
                "value": "={{ $json.descricao_comercial }}"
              }
            ]
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        3952,
        -704
      ],
      "id": "c3d21d16-0b96-4cc8-b53e-d2ced5941b4a",
      "name": "Default Data Loader"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fda7b7ea-4cb9-43d1-bd1d-fef35d8dbdb9",
              "name": "embedding",
              "value": "={{ $json.descricao }} - {{ $json.descricao_comercial }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3584,
        -880
      ],
      "id": "f957708e-728f-42d8-bbf5-b0bd3ccd49ba",
      "name": "Add embedding field"
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "artigos",
          "mode": "list",
          "cachedResultName": "artigos"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "flg_embedded": true,
            "artigo": "={{ $json.metadata.artigo }}"
          },
          "matchingColumns": [
            "artigo"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "artigo",
              "displayName": "artigo",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "descricao",
              "displayName": "descricao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "descricao_comercial",
              "displayName": "descricao_comercial",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "unidade_venda",
              "displayName": "unidade_venda",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "quantidade",
              "displayName": "quantidade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "preco",
              "displayName": "preco",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "codigo_spms",
              "displayName": "codigo_spms",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "flg_embedded",
              "displayName": "flg_embedded",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4192,
        -880
      ],
      "id": "742c591b-7079-4a97-b7bd-11738dffe7fe",
      "name": "Update Flg_embedded",
      "credentials": {
        "postgres": {
          "id": "qdwvjO0qEjit6Vuu",
          "name": "Cardiva Supabase"
        }
      }
    },
    {
      "parameters": {
        "content": "## Add new embeddings (postgres insert trigger)\n",
        "height": 656,
        "width": 1568,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2848,
        -992
      ],
      "id": "dc4a614f-9760-4849-b6f2-64ec81266ebe",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "artigos",
          "mode": "list",
          "cachedResultName": "artigos"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "artigo",
              "value": "={{ $json.artigo }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1648,
        -1024
      ],
      "id": "75ae5f61-bed3-463f-83ca-4fa04971f567",
      "name": "Delete from DB",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {
          "id": "qdwvjO0qEjit6Vuu",
          "name": "Cardiva Supabase"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM artigos_vectors\nWHERE metadata->>'artigo' = '{{ $json.artigo }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1648,
        -832
      ],
      "id": "1efd223a-ef61-45df-8667-b3a99a192e5b",
      "name": "Delete from Vector Store",
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {
          "id": "qdwvjO0qEjit6Vuu",
          "name": "Cardiva Supabase"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        3120,
        -672
      ],
      "id": "b564babd-3ac2-4ea9-9c16-31d78e316547",
      "name": "When clicking ‘Execute workflow’",
      "disabled": true
    },
    {
      "parameters": {
        "resource": "draft",
        "subject": "Análise IA caderno encargos",
        "message": "=https://docs.google.com/spreadsheets/d/{{ $('Copia template').item.json.id }}/edit",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        3888,
        64
      ],
      "id": "6e4193b1-1d66-44e1-acec-038746d1a236",
      "name": "Create a draft",
      "webhookId": "8eff36ac-e3c2-495e-8cb2-0f1981ea73fb",
      "credentials": {
        "gmailOAuth2": {
          "id": "Z1P5sMQWh5AY9LB7",
          "name": "Cardiva.automation Gmail"
        }
      }
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        2288,
        288
      ],
      "id": "22406391-c02e-41a2-9496-90a9aba38bb2",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "mlwfCzPRF097AsCS",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Exact match lookup in the artigos database table by codigo_spms.\n\nWHEN TO USE:\n- Input has codigo_spms with a value (e.g., \"S1988\", \"A5962\", \"L666\")\n- This is your FIRST choice when codigo_spms is not null\n\nWHEN NOT TO USE:\n- codigo_spms is null or empty → use query_artigos_vectors instead\n\nHOW TO USE:\nProvide a SQL query like:\nSELECT artigo, descricao, descricao_comercial, unidade_venda, quantidade, preco, codigo_spms \nFROM artigos \nWHERE codigo_spms = 'VALUE'\nLIMIT 1;\n\nReplace 'VALUE' with the actual codigo_spms from input (e.g., 'S1988', 'A5962').\n\nAFTER CALLING:\n- If results returned → Match found, use the data\n- If no results → Call query_artigos_vectors as fallback",
        "operation": "executeQuery",
        "query": "{{ $fromAI('sql_query') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.5,
      "position": [
        2464,
        288
      ],
      "id": "c2022d7e-cee6-4792-a8e4-bf0d426b39d4",
      "name": "query_artigos_table",
      "credentials": {
        "postgres": {
          "id": "qdwvjO0qEjit6Vuu",
          "name": "Cardiva Supabase"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "Semantic similarity search in the product vector store.\n\nWHEN TO USE:\n- codigo_spms is null or empty in input, OR\n- query_artigos_table returned no results\n\nHOW TO USE:\nBuild a search query from descricao_pedido by extracting:\n- Product type: agulha, seringa, lanceta, cateter\n- Specifications: 21G, 25mm, 5ml, 0.8x25\n- Features: segurança, anti-picada, luer lock, insulina\n\nExamples:\n- \"agulha epicraniana segurança 21G 20mm\"\n- \"seringa irrecuperável 5ml\"\n- \"lanceta capilar 21G\"\n\nUse top_k=10 for comprehensive results.",
        "tableName": "artigos_vectors",
        "topK": 10,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePGVector",
      "typeVersion": 1.3,
      "position": [
        2624,
        288
      ],
      "id": "6a7e8c7c-6258-4380-8dee-d72476d6aa0d",
      "name": "query_artigos_vectors",
      "credentials": {
        "postgres": {
          "id": "qdwvjO0qEjit6Vuu",
          "name": "Cardiva Supabase"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=[{\n\"lote_pedido\": {{ $json.lote_pedido }},\n\"posicao_pedido\": {{ $json.posicao_pedido }},\n\"artigo_pedido\": \"{{ $json.artigo_pedido }}\",\n\"descricao_pedido\": \"{{ $json.descricao_pedido }}\",\n\"especificacoes_tecnicas\":\"{{ $json.especificacoes_tecnicas }}\",\n\"quantidade_pedido\": {{ $json.quantidade_pedido }},\n\"preco_artigo\": {{ $json.preco_artigo }},\n\"preco_posicao\": {{ $json.preco_posicao }},\n\"preco_lote\": {{ $json.preco_lote }},\n\"codigo_spms\": {{ $json.codigo_spms }}\n}]",
        "options": {
          "systemMessage": "# Role\n\nPharmaceutical & Medical Device Product Matching Agent. Match RFP items to inventory database products.\n\n# Your Task\n\nFor each input item, you MUST:\n1. **Use tools to search** the database for a matching product\n2. **Output a JSON array** with the match result\n\n---\n\n# STEP 1: USE TOOLS TO FIND MATCHES\n\n## Tool Selection Logic\n\n**Check the input `codigo_spms` field and follow these rules:**\n\n- **If `codigo_spms` has a value** (e.g., \"S1988\", \"A5962\", \"L666\"):\n  1. Call `query_artigos_table` first\n  2. If match found → use the data, go to STEP 2\n  3. If no match → call `query_artigos_vectors` as fallback\n\n- **If `codigo_spms` is null or empty**:\n  1. Skip `query_artigos_table`\n  2. Call `query_artigos_vectors` directly\n\n---\n\n## How to use `query_artigos_table`\n\n**Purpose:** Exact lookup by catalog code.\n\n**When:** Input has `codigo_spms` with a value.\n\n**Call with SQL query:**\n```sql\nSELECT artigo, descricao, descricao_comercial, unidade_venda, quantidade, preco, codigo_spms\nFROM artigos\nWHERE codigo_spms = 'VALUE'\nLIMIT 1;\n```\n\nReplace 'VALUE' with the actual codigo_spms (e.g., 'S1988', 'A5962', 'L666').\n\n**Examples:**\n- Input has `\"codigo_spms\": \"S1988\"` → Query: `WHERE codigo_spms = 'S1988'`\n- Input has `\"codigo_spms\": \"A5962\"` → Query: `WHERE codigo_spms = 'A5962'`\n- Input has `\"codigo_spms\": \"L666\"` → Query: `WHERE codigo_spms = 'L666'`\n\n---\n\n## How to use `query_artigos_vectors`\n\n**Purpose:** Semantic similarity search.\n\n**When:**\n- Input `codigo_spms` is null or empty, OR\n- `query_artigos_table` returned no results\n\n---\n\n### Step 0: Detect Product Category\n\n**CRITICAL: Before any processing, identify the product category to apply correct normalization and validation rules.**\n\nScan `descricao_pedido` for category indicators:\n\n| Category | Detection Keywords | Priority |\n|----------|-------------------|----------|\n| **CORONARY_STENT** | IVASCULAR, INTREGAL, ARMADA, OPTIMA, COROFLEX, PROKINETIC, DES, BMS, stent coronário, drug-eluting, fármaco-elutivo, prótesis coronaria, balão coronário, PTCA, angioplastia | 1 |\n| **ENDOGRAFT** | GORE, EXCLUDER, VIABAHN, RELAY, ZENITH, ENDURANT, ANACONDA, endoprótese, endograft, stent-graft, TEVAR, EVAR, aneurisma, aórtico, fenestrada, branched | 2 |\n| **CATHETER** | ANGIODYNAMICS, SOFT-VU, MARINER, ACCU-VU, PULSE-SPRAY, UNIFUSE, COOK, cateter, catheter, catéter, pigtail, cobra, sidewinder, berenstein, omni flush, headhunter, diagnóstico, angiografia | 3 |\n| **VASCULAR_GRAFT** | VASCUTEK, GELWEAVE, GELSOFT, FLUOROPASSIV, GELSEAL, DACRON, prótese vascular, graft, enxerto, bifurcad, trifurcad, aorto-bifemoral | 4 |\n| **SCREW** | parafuso, tornillo, screw, pedicular, pedicle, cortical, canulado, cannulated, poliaxial, polyaxial, monoaxial, autoroscante, self-tapping, TRANSCONTINENTAL, REVERE | 5 |\n| **ROD** | haste, barra, varilla, rod, titanium rod, conectora, tulipa, PEEK rod, CoCr rod | 6 |\n| **PLATE** | placa, plate, cervical plate, anterior plate, lateral plate, TRANSCONTINENTAL | 7 |\n| **ANEURYSM_CLIP** | clip aneurisma, aneurysm clip, YASARGIL, SUGITA, AESCULAP, microvascular clip, clip cerebral, neurocirurgia | 8 |\n| **SPINE_IMPLANT** | ALIF, TLIF, PLIF, XLIF, spacer, cage, vertebral, intersomático, fusão, PEEK cage, expandable, interfixated, 3DP, 3D printed | 9 |\n| **GUIDEWIRE** | guia, guidewire, fio-guia, mandril, TERUMO, ASAHI, RADIFOCUS, hydrophilic wire, 0.014, 0.018, 0.035, 0.038 | 10 |\n| **INFUSION_SYSTEM** | ACE MEDICAL, AUTOFUSER, AUTOSELECTOR, AUTOFILLER, infusor, bomba infusão, elastomérico, PCA | 11 |\n| **VASCULAR_ACCESS** | SMARTPORT, BIOFLO, DURAMAX, port, cateter central, PICC, CVC, reservatório implantável | 12 |\n| **ABLATION** | NANOKNIFE, SOLERO, VENACURE, ablação, radiofrequência, microondas, IRE, MWA, laser ablation | 13 |\n| **OPHTHALMIC** | AJL, Ahmed, glaucoma, válvula ocular, córnea, vitreo, oftálm, trépano, viscoelástico, intraocular | 14 |\n| **SURGICAL_INSTRUMENT** | SCANLAN, forceps, clamp, porta-aguja, tijera, pinça, tesoura, SURG-I-LOOP, dissector | 15 |\n| **AIRWAY** | AIRTRAQ, laringoscópio, videolaringoscópio, intubação, via aérea, tubo endotraqueal | 16 |\n| **ELECTRODE** | AXELGAARD, PALS, ULTRASTIM, elétrodo, electrodo, TENS, estimulação, neuroestimulação | 17 |\n| **SYRINGE** | seringa, syringe, jeringa, luer lock, luer slip, 3 peças, 2 peças, descartável | 18 |\n| **NEEDLE** | agulha, needle, aguja, hipodérmica, epicraniana, scalp, lanceta, punção, biopsia | 19 |\n| **COMPRESSION** | ACTICO, meia compressão, compressiva, úlcera, TPS, UlcerSys, anti-embolismo | 20 |\n| **GENERAL** | (default if no match) | 99 |\n\n**Detection Logic:**\n```\nFOR each category in priority order:\n  IF descricao_pedido contains ANY keyword (case-insensitive):\n    RETURN category\n    BREAK\nRETURN \"GENERAL\"\n```\n\n---\n\n### Step A: Normalize Input Text\n\n#### A.1 Universal Normalization (apply to ALL categories)\n\n| Pattern | Replace with | Notes |\n|---------|--------------|-------|\n| `\\\\` | ` ` (space) | Escaped backslash |\n| `/` | ` ` (space) | Forward slash |\n| `(` `)` | ` ` (space) | Parentheses - but preserve content |\n| `\"` `'` `` ` `` | ` ` (space) | Quotes |\n| `\\`\\`` | ` ` (space) | Double backticks |\n| Multiple spaces | single space | Collapse whitespace |\n| `C/` `C\\` `C\\\\` `C\\SIST.` `C\\\\SIST.` | com sistema | Portuguese \"with system\" |\n| `S/` `S\\` | sem | Portuguese \"without\" |\n| `P/` | para | Portuguese \"for\" |\n| `IRRECUP.` `IRRECUPERAVEL` | irrecuperável | Disposable |\n| `EST.` `ESTERIL` | estéril | Sterile |\n| `Ø` | (extract number as diameter) | Diameter symbol - 3,140 occurrences |\n| `°` | (extract number as angle) | Degree symbol - 578 occurrences |\n| `®` `™` | ` ` (space) | Trademark symbols |\n\n#### A.1.1 Decimal Format Normalization (CRITICAL - 32% of products use comma)\n\n| Pattern | Replace with | Example |\n|---------|--------------|---------|\n| `5,5` `5,50` | 5.5 | European decimal to standard |\n| `6,5` `6,50` | 6.5 | European decimal to standard |\n| `7,5` `7,50` | 7.5 | European decimal to standard |\n| `0,035` | 0.035 | Guidewire diameter |\n| `0,038` | 0.038 | Guidewire diameter |\n| `X,Y` where X,Y are digits | X.Y | General decimal normalization |\n\n**Important:** The database uses BOTH comma and dot decimals. Always search for BOTH formats:\n- `5.5mm` AND `5,5mm`\n- `0.035` AND `0,035`\n\n#### A.2 Language Bridging (Portuguese ↔ Spanish ↔ English)\n\n**The database contains Portuguese, Spanish, AND English descriptions. Always include all language variants in your search.**\n\n| Portuguese | Spanish | English | Include All |\n|------------|---------|---------|-------------|\n| cateter | catéter | catheter | ✓ |\n| agulha | aguja | needle | ✓ |\n| seringa | jeringa | syringe | ✓ |\n| comprimento | longitud | length | ✓ |\n| diâmetro | diámetro | diameter | ✓ |\n| parafuso | tornillo | screw | ✓ |\n| placa | placa | plate | ✓ |\n| haste | varilla | rod | ✓ |\n| stent | stent | stent | ✓ |\n| prótese | prótesis | prosthesis | ✓ |\n| suportada | soportada | supported | ✓ |\n| malha, trançado | mallado | braided | ✓ |\n| recto, reto | recto | straight | ✓ |\n| ponta | punta | tip | ✓ |\n| curva | curva | curved | ✓ |\n| ângulo | ángulo | angle | ✓ |\n| fio-guia | guía | guidewire | ✓ |\n\n#### A.3 Category-Specific Normalization\n\n---\n\n##### CORONARY_STENT Category Normalization\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `2.5X18` `2.5x18` `2,5X18` `2,5x18` | 2.5x18 | Diameter x Length |\n| `3.0X24` `3,0X24` | 3.0x24 | Diameter x Length |\n| `DES` `DRUG ELUTING` `FARMACOACTIVO` | drug-eluting DES | Drug-eluting stent |\n| `BMS` `BARE METAL` | bare-metal BMS | Bare-metal stent |\n| `CROMO COBALTO` `CROCOBALTO` `CoCr` | CoCr cromo-cobalto | Cobalt-chromium |\n| `PTFE` `COBERTO` `COVERED` | covered revestido | Covered stent |\n| `RX` `RAPIDA TROCA` | rapid-exchange RX | Delivery system |\n| `OTW` `OVER THE WIRE` | over-the-wire OTW | Delivery system |\n\n**Coronary Stent Diameter Values (from database):**\n- 2.0, 2.25, 2.5, 2.75, 3.0, 3.5, 4.0, 4.5, 5.0 mm\n\n**Coronary Stent Length Values (from database):**\n- 8, 9, 12, 13, 14, 15, 16, 18, 19, 20, 22, 23, 24, 26, 28, 30, 32, 33, 36, 38, 40 mm\n\n---\n\n##### ENDOGRAFT Category Normalization\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `32X150` `32x150` | 32x150 | Diameter x Length |\n| `FENESTRADA` `FENESTRATED` | fenestrada fenestrated | Fenestrated graft |\n| `BRANCHED` `RAMIFICADA` | branched ramificada | Branched graft |\n| `TEVAR` | TEVAR thoracic | Thoracic repair |\n| `EVAR` | EVAR abdominal | Abdominal repair |\n| `AORTICO` `AÓRTICO` | aortic aórtico | Aortic |\n| `ILIACO` `ILÍACO` | iliac ilíaco | Iliac |\n| `CUFF` `EXTENSAO` | extension cuff | Extension piece |\n| `PROXIMAL` `DISTAL` | (preserve) | Position indicator |\n\n**Endograft Diameter Values (from database):**\n- 16, 20, 21, 22, 23, 24, 25, 26, 27, 28, 30, 31, 32, 34, 36, 38, 40, 42, 44, 46 mm\n\n---\n\n##### CATHETER Category Normalization\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `4F` `4 F` `4FR` `4 FR` | 4F | French gauge |\n| `5F` `5 F` `5FR` `5 FR` | 5F | French gauge |\n| `6F` `6 F` `6FR` `6 FR` | 6F | French gauge |\n| `7F` `7 F` `7FR` `7 FR` | 7F | French gauge |\n| `8F` `8 F` `8FR` `8 FR` | 8F | Extended gauge |\n| `9F` - `26F` | NF format | Extended French gauges in database |\n| `0.035\"` `0.035``` `.035\"` `.035` `035\"` `0,035` | 0.035 | Guidewire |\n| `0.038\"` `0.038``` `.038\"` `.038` `038\"` `0,038` | 0.038 | Guidewire |\n| `0.018\"` `0,018` | 0.018 | Guidewire |\n| `0.014\"` `0,014` | 0.014 | Guidewire (coronary) |\n| `65CM` `65 CM` `65cm` `65 cm` | 65CM | Length |\n| `90CM` `90 CM` `90cm` | 90CM | Length |\n| `100CM` `100 CM` `100cm` | 100CM | Length |\n| `130CM` `130 CM` `130cm` | 130CM | Length |\n| `145CM` `145 CM` | 145CM | Common length (288 products) |\n| `150CM` `150 CM` | 150CM | Common length (215 products) |\n| `MALLADO` | mallado braided | Braided construction |\n| `PUNTA` `PUNTA 3CM` | punta tip | Tip specification |\n| `(1)` `(2)` `(3)` `(0)` | 1, 2, 3, 0 | Shape variant number |\n\n**Extended French Gauge Values (from database):**\n- 2F, 3F, 4F, 5F, 6F, 7F, 8F, 9F, 10F, 11F, 12F, 14F, 16F, 18F, 20F, 22F, 24F, 26F\n\n**Catheter Length Values (from database):**\n- Common: 65, 80, 90, 100, 110, 120, 130, 145, 150 CM\n- Range: 1CM to 300CM\n\n**Catheter Shape Standardization:**\n\n| Variations | Standardize to |\n|------------|----------------|\n| COBRA, COBRA1, COBRA 1, COBRA(1) | COBRA 1 |\n| SIDEWINDER, SIDE WINDER, SIMMONS | SIDEWINDER |\n| SOS OMNI, SOS-OMNI, SOSOMNI | SOS OMNI |\n| PIGTAIL, PIG TAIL, PIG-TAIL | PIGTAIL |\n| OMNI FLUSH, OMNIFLUSH, OMNI-FLUSH | OMNI FLUSH |\n| HEADHUNTER, HEAD HUNTER | HEADHUNTER |\n| BERENSTEIN, BERNSTEIN | BERENSTEIN |\n| SHEPHERD HOOK, SHEPHERDS HOOK, SHEPHERD'S HOOK | SHEPHERD HOOK |\n| HOCKEY STICK, HOCKEYSTICK | HOCKEY STICK |\n| MULTIPURPOSE, MULTIPROPÓSITO, MPA, MPB | MULTIPURPOSE |\n| JUDKINS, JL, JR | JUDKINS |\n\n---\n\n##### SCREW Category Normalization (NEW - 2,525 products)\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `5.5X45` `5,5X45` `Ø5.5X45` `Ø5,5X45` | 5.5x45 | Diameter x Length |\n| `6.5X50` `6,5X50` | 6.5x50 | Diameter x Length |\n| `7.5X55` `7,5X55` | 7.5x55 | Diameter x Length |\n| `PEDICULAR` `PEDICLE` `PEDÍCULO` | pedicular pedicle | Pedicle screw |\n| `POLIAXIAL` `POLYAXIAL` | polyaxial poliaxial | Multi-angle screw |\n| `MONOAXIAL` `UNIAXIAL` | monoaxial uniaxial | Fixed-angle screw |\n| `CANULADO` `CANNULATED` | cannulated canulado | Hollow screw |\n| `CORTICAL` | cortical | Cortical screw |\n| `AUTOROSCANTE` `SELF-TAPPING` | self-tapping autoroscante | Self-tapping |\n| `REDUCCION` `REDUÇÃO` `REDUCTION` | reduction redução | Reduction screw |\n| `TITANIO` `TITANIUM` `TI` | titanium titânio | Material |\n\n**Screw Diameter Values (from database):**\n- 3.5, 4.0, 4.35, 4.5, 5.0, 5.5, 6.0, 6.5, 7.0, 7.5, 8.0, 8.5, 9.0, 10.0, 11.0, 12.0 mm\n- Most common: 5.5mm (434), 6.5mm (423), 7.5mm (260)\n\n**Screw Length Values (from database):**\n- Range: 20mm to 130mm\n- Common: 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80 mm\n\n---\n\n##### ROD Category Normalization (NEW - 901 products)\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `5.5X500` `5,5X500` | 5.5x500 | Diameter x Length |\n| `6.0X300` `6,0X300` | 6.0x300 | Diameter x Length |\n| `TITANIO` `TITANIUM` | titanium titânio | Material |\n| `COBALTO CROMO` `CoCr` | CoCr cobalt-chrome | Material |\n| `PEEK` | PEEK | Material |\n| `CURVA` `CURVED` `PRECURVADA` | curved curva | Pre-curved |\n| `RECTA` `STRAIGHT` | straight recta | Straight |\n| `CONECTOR` `CONNECTOR` | connector conector | Rod connector |\n\n---\n\n##### PLATE Category Normalization (NEW - 541 products)\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `CERVICAL` | cervical | Cervical plate |\n| `ANTERIOR` | anterior | Anterior plate |\n| `LATERAL` | lateral | Lateral plate |\n| `2 FUROS` `2 HOLES` `2H` | 2 holes 2 furos | Hole count |\n| `4 FUROS` `4 HOLES` `4H` | 4 holes 4 furos | Hole count |\n| `BLOQUEADA` `LOCKING` | locking bloqueada | Locking plate |\n| `TITANIO` `TITANIUM` | titanium titânio | Material |\n\n---\n\n##### ANEURYSM_CLIP Category Normalization (NEW - 458 products)\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `ANGULADO` `ANGLED` | angled angulado | Clip angle |\n| `RETO` `RECTO` `STRAIGHT` | straight reto | Straight clip |\n| `CURVO` `CURVED` | curved curvo | Curved clip |\n| `FENESTRADO` `FENESTRATED` | fenestrated fenestrado | Fenestrated |\n| `YASARGIL` | YASARGIL | Brand |\n| `SUGITA` | SUGITA | Brand |\n| `MINI` `STANDARD` `MAXI` | (preserve) | Size category |\n| `5MM` `7MM` `9MM` `11MM` | (extract dimension) | Blade length |\n| `TITANIO` `TITANIUM` | titanium titânio | Material |\n\n---\n\n##### GUIDEWIRE Category Normalization (NEW)\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `0.014\"` `0,014` `.014` | 0.014 | Coronary size |\n| `0.018\"` `0,018` `.018` | 0.018 | Peripheral size |\n| `0.035\"` `0,035` `.035` | 0.035 | Standard size |\n| `0.038\"` `0,038` `.038` | 0.038 | Large size |\n| `150CM` `180CM` `260CM` `300CM` | (preserve) | Length |\n| `HIDROFILICO` `HYDROPHILIC` | hydrophilic hidrofílico | Coating |\n| `STIFF` `RIGIDO` `RÍGIDO` | stiff rígido | Stiffness |\n| `FLOPPY` `MACIO` | floppy macio | Stiffness |\n| `J TIP` `PONTA J` | J-tip ponta J | Tip shape |\n| `STRAIGHT` `RETO` | straight reto | Tip shape |\n| `RADIFOCUS` `TERUMO` `ASAHI` | (brand) | Brands |\n\n**Guidewire Diameter Values (from database):**\n- 0.010\", 0.014\", 0.018\", 0.021\", 0.025\", 0.032\", 0.035\", 0.038\"\n\n---\n\n##### VASCULAR_GRAFT Category Normalization\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `12X6` `12x6` `12 X 6` `12 x 6` | 12x6 | Diameter configuration |\n| `14X7X7` `14x7x7` | 14x7x7 | Trifurcated dimensions |\n| `SOPORTADA` `SUPORTADA` | soportada supported ringed | Ringed/supported |\n| `BIFURCADA` `BIF` `BIFURCATED` | bifurcada bifurcated | Bifurcated |\n| `TRIFURCADA` `TRIFURCATED` | trifurcada trifurcated | Trifurcated |\n| `ANILL ASIM` `ANILLOS ASIMETRICOS` | anillos asimétricos | Asymmetric rings |\n| `PF` | pre-formed | Pre-formed |\n| `EQUI-FLO` `EQUIFLO` | equi-flo | Equal flow design |\n| `TAPERED` | tapered cónico | Tapered |\n| `@15` `@10` | branch angle | Branch configuration |\n| `ESPESOR 0.52 MM` `0.52MM` `0,52MM` | espesor 0.52mm | Wall thickness |\n\n**Graft Product Line Standardization:**\n\n| Variations | Standardize to |\n|------------|----------------|\n| GELWEAVE, GEL WEAVE, GEL-WEAVE | GELWEAVE |\n| GELSOFT, GEL SOFT, GEL-SOFT | GELSOFT |\n| GELSOFT PLUS | GELSOFT PLUS |\n| FLUOROPASSIV, FLUORO PASSIV, FLUORO-PASSIV | FLUOROPASSIV |\n| GELSEAL, GEL SEAL | GELSEAL |\n\n---\n\n##### INFUSION_SYSTEM Category Normalization\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `100/0,5` `100/0.5` | 100ml 0.5ml/h | Volume/flow |\n| `275/2,0` `275/2.0` | 275ml 2.0ml/h | Volume/flow |\n| `550/6,00` `550/6.00` | 550ml 6.0ml/h | Volume/flow |\n| `150/2,0` `150/2.0` | 150ml 2.0ml/h | Volume/flow (common pattern) |\n| `(8 DIAS)` `8 DIAS` `8DIAS` | 8 dias duration | Duration |\n| `(1 DIA 6 HORAS)` | 1 dia 6 horas | Duration |\n| `CON BOLO` `C/ BOLO` `COM BOLO` | com bolo bolus | With bolus |\n| `CONTINUO` `CONTÍNUO` | contínuo continuous | Continuous mode |\n| `CONTINUO+BOLO` `CONTINUO + BOLO` | contínuo+bolo | Combined mode |\n| `CON PROTECCION UV` `PROTECÇÃO UV` `UV` | proteção UV | UV protection |\n| `BLOQUEO 15´` `BLOQUEO 15'` `BLOQUEIO 15` | bloqueio 15min | Lockout time |\n| `ML DE BOLO` `ML BOLO` | ml bolo | Bolus volume |\n\n**Infusion Volume Categories:**\n\n| Volume | Duration Range (typical) |\n|--------|-------------------------|\n| 60ml | 6 hours - 5 days |\n| 100ml | 1 day - 16 days |\n| 150ml | 15 hours - 12.5 days |\n| 275ml | 1 day - 7+ days |\n| 400ml | 1.5 days - 8+ days |\n| 550ml | 2 days - 23 days |\n\n---\n\n##### SPINE_IMPLANT Category Normalization\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `10x34x24mm` `10X34X24MM` `10x34x24` | 10x34x24mm | Dimensions |\n| `8°` `8 graus` `8 degrees` | 8° | Lordotic angle |\n| `10°` `10 graus` | 10° | Lordotic angle |\n| `15°` `15 graus` | 15° | Lordotic angle |\n| `8-12mm` `8-12` `8 A 12` | 8-12mm | Expansion range |\n| `ALIF` | ALIF anterior lumbar | Anterior approach |\n| `TLIF` | TLIF transforaminal | Transforaminal approach |\n| `PLIF` | PLIF posterior | Posterior approach |\n| `XLIF` | XLIF lateral | Lateral approach |\n| `3DP` `3D PRINTED` | 3DP 3D-printed | 3D printed |\n| `INTERFIXATED` | interfixated integrated screws | With integrated fixation |\n| `FIXED ANGLE` | fixed angle ângulo fixo | Fixed angle screw |\n| `VARIABLE ANGLE` | variable angle ângulo variável | Variable angle screw |\n| `EXPANDABLE` `EXPANSIVEL` | expandable expansível | Expandable cage |\n| `PEEK` | PEEK | Material |\n| `TITANIO` `TITANIUM` | titanium titânio | Material |\n\n**Spine Implant Angle Values (from database):**\n- 0°, 4°, 6°, 8°, 10°, 12°, 15°, 20°, 25°, 30°\n\n---\n\n##### OPHTHALMIC Category Normalization\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `0,6G` `0.6G` `0,6g` | 0.6g | Weight (eyelid implant) |\n| `1,4%` `1.4%` | 1.4% | Concentration |\n| `FP7` `FP8` | FP7 / FP8 | Ahmed valve model |\n| `27G` | 27G | Cannula gauge |\n| `7.00MM` `7.00mm` `7,00MM` | 7.00mm | Trephine diameter |\n| `ZO5MM` `ZO 5MM` | ZO 5mm | Optical zone |\n| `160º CCW` `160 CCW` | 160° CCW | Arc and direction |\n| `0,15-0,25MM` `0.15-0.25MM` | 0.15-0.25mm | Thickness range |\n\n---\n\n##### SYRINGE Category Normalization\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `2/PECAS` `2 PECAS` `2/PEÇAS` `2-PECAS` | 2 peças | 2-part syringe |\n| `3/PECAS` `3 PECAS` `3/PEÇAS` `3-PECAS` | 3 peças | 3-part syringe |\n| `5ML` `5 ML` `5ml` `5 ml` | 5ml | Volume |\n| `LUER LOCK` `LUER-LOCK` `LL` | luer lock | Connection type |\n| `LUER SLIP` `LUER-SLIP` `LS` | luer slip | Connection type |\n| `BICO CATETER` `BICO CATÉTER` | bico cateter catheter tip | Catheter tip |\n| `PONTA EXCENTRICA` `PONTA EXCÊNTRICA` | ponta excêntrica | Eccentric tip |\n| `INSULINA` `INSULIN` | insulina insulin | Insulin syringe |\n| `TUBERCULINA` | tuberculina tuberculin | Tuberculin syringe |\n| `U-100` `U100` | U-100 | Insulin concentration |\n\n---\n\n##### NEEDLE Category Normalization\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `21G` `21 G` `21GA` `21 GA` | 21G | Gauge |\n| `21GX20MM` `21G X 20MM` `21Gx20mm` | 21G 20mm | Gauge and length |\n| `0,8X25` `0.8X25` `0,8 X 25` | 0.8x25mm | Diameter x length |\n| `EPICRANIANA` `EPICRANEANA` | epicraniana scalp butterfly | Scalp vein needle |\n| `ANTI PICADA` `ANTI-PICADA` `ANTIPICADA` | anti-picada safety | Safety mechanism |\n| `SEGURANÇA` `SEGURIDAD` `SAFETY` | segurança safety | Safety feature |\n| `HIPODÉRMICA` `HIPODERMICA` | hipodérmica hypodermic | Hypodermic needle |\n| `ROMBA` `BLUNT` | romba blunt | Blunt tip |\n| `PUNCAO CAPILAR` `PUNÇÃO CAPILAR` | punção capilar | Capillary puncture |\n\n---\n\n##### SURGICAL_INSTRUMENT Category Normalization\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `18CM` `18 CM` `18cm` | 18cm | Length |\n| `MANGO REDONDO` `ROUND HANDLE` | mango redondo round handle | Handle type |\n| `DIAMOND DUST` | diamond dust | Jaw coating |\n| `PUNTA RECTA` `STRAIGHT TIP` | punta recta straight | Tip type |\n| `PUNTA CURVA` `CURVED TIP` | punta curva curved | Tip type |\n| `ANGULADA 45º` `45° ANGLED` | angulada 45° | Angle |\n| `CON FRENO` `WITH LOCK` | con freno with lock | Locking mechanism |\n| `SIN FRENO` `WITHOUT LOCK` | sin freno without lock | No lock |\n| `BAYONETA` `BAYONET` | bayoneta bayonet | Bayonet style |\n| `MICRO` | micro microsurgery | Microsurgery |\n\n---\n\n##### ELECTRODE Category Normalization\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `5X5CM` `5x5cm` `5 X 5 CM` | 5x5cm | Size |\n| `5X9CM` `5x9cm` | 5x9cm | Size |\n| `REUTILIZABLE` `REUTILIZÁVEL` | reutilizável reusable | Reusable |\n| `DESCARTAVEL` `DESECHABLE` | descartável disposable | Disposable |\n| `FOAM` `ESPUMA` | foam espuma | Material |\n| `SPUNLACE` | spunlace | Material |\n| `PLATINUM` `PLATINIUM` | platinum | Electrode type |\n\n---\n\n##### COMPRESSION Category Normalization\n\n| Pattern | Normalize to | Example |\n|---------|--------------|---------|\n| `TALLA S/M` `TAMANHO S/M` `SIZE S/M` | tamanho S/M | Size |\n| `TALLA L/XL` `TAMANHO L/XL` | tamanho L/XL | Size |\n| `KNEE` `JOELHO` | joelho knee | Knee length |\n| `THIGH` `COXA` | coxa thigh | Thigh length |\n| `LONG` `LONGO` `COMPRIDO` | longo long | Long variant |\n| `NORMAL` `STANDARD` | normal standard | Standard length |\n| `ULCERSYS` `ULCER SYS` | UlcerSys | Product line |\n| `TPS` | TPS | Product line |\n\n---\n\n### Step B: Extract Query Components\n\n**Extract components based on the detected category, in priority order:**\n\n#### CORONARY_STENT Components (NEW):\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | IVASCULAR, ABBOTT, MEDTRONIC, BOSTON SCIENTIFIC | Yes |\n| 2 | **Product Line** | INTREGAL, ARMADA, OPTIMA, COROFLEX, XIENCE | Yes |\n| 3 | **Type** | DES (drug-eluting), BMS (bare-metal) | Critical |\n| 4 | **Diameter** | 2.0-5.0mm | Critical |\n| 5 | **Length** | 8-40mm | Critical |\n| 6 | **Material** | CoCr, PtCr, Stainless Steel | Important |\n| 7 | **Delivery System** | RX, OTW | If present |\n\n#### ENDOGRAFT Components (NEW):\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | GORE, MEDTRONIC, COOK, BOLTON | Yes |\n| 2 | **Product Line** | EXCLUDER, VIABAHN, ZENITH, RELAY | Yes |\n| 3 | **Location** | Thoracic (TEVAR), Abdominal (EVAR), Iliac | Critical |\n| 4 | **Diameter** | 16-46mm | Critical |\n| 5 | **Length** | 50-200mm | Critical |\n| 6 | **Type** | Fenestrated, Branched, Standard | Important |\n| 7 | **Component** | Main body, Extension, Cuff | If present |\n\n#### CATHETER Components:\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | ANGIODYNAMICS, MEDTRONIC, CARDIVA, COOK | Yes |\n| 2 | **Product Line** | SOFT-VU, MARINER, ACCU-VU, PULSE-SPRAY, UNIFUSE, LAMBDA, SENTRANT, TALENT | Yes |\n| 3 | **Shape** | COBRA, SIDEWINDER, PIGTAIL, BERENSTEIN, HOOK, SOS OMNI, NEWTON, HEADHUNTER, VERTEBRAL, SHEPHERD, BENTSON, HOCKEY STICK, RIM, MPA, MPB, JB, OMNI FLUSH, RECTO, RENAL, MIKAELSSON, KUMPE, MANI, RC1, RC2, MULTIPROP, COBRITA, LEVIN, OSBORNE, NAVIGATE, SHARP ANGLE, OMEGA, ARC, JUDKINS, JL, JR | Shape-specific |\n| 4 | **Shape Variant** | 0, 1, 2, 3 (number after shape) | If present |\n| 5 | **French Gauge** | 2F-26F | Critical |\n| 6 | **Length** | 1CM - 300CM | Critical |\n| 7 | **Guidewire** | 0.014, 0.018, 0.025, 0.035, 0.038 | Critical |\n| 8 | **Construction** | MALLADO (braided), standard | If present |\n| 9 | **Special Features** | PUNTA, SEGMENTO, ORIFICIOS LATERALES | If present |\n\n#### SCREW Components (NEW):\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | TRANSCONTINENTAL, REVERE, ANKURA, DePuy, Medtronic | Yes |\n| 2 | **Type** | Pedicular, Cortical, Cannulated, Polyaxial, Monoaxial | Critical |\n| 3 | **Diameter** | 3.5-12.0mm | Critical |\n| 4 | **Length** | 20-130mm | Critical |\n| 5 | **Material** | Titanium, Stainless Steel | Important |\n| 6 | **Features** | Reduction, Self-tapping | If present |\n\n#### ROD Components (NEW):\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | TRANSCONTINENTAL, REVERE, DePuy | Yes |\n| 2 | **Diameter** | 5.5mm, 6.0mm, 6.35mm | Critical |\n| 3 | **Length** | 30-500mm | Critical |\n| 4 | **Material** | Titanium, CoCr, PEEK | Important |\n| 5 | **Shape** | Straight, Pre-curved | If present |\n\n#### PLATE Components (NEW):\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | TRANSCONTINENTAL, DePuy, Synthes | Yes |\n| 2 | **Location** | Cervical, Lumbar, Thoracic | Critical |\n| 3 | **Type** | Anterior, Lateral, Locking | Important |\n| 4 | **Holes** | 2, 3, 4, 5, 6 holes | Critical |\n| 5 | **Material** | Titanium | Important |\n\n#### ANEURYSM_CLIP Components (NEW):\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | YASARGIL, SUGITA, AESCULAP | Yes |\n| 2 | **Shape** | Straight, Angled, Curved, Fenestrated | Critical |\n| 3 | **Size** | Mini, Standard, Maxi | Important |\n| 4 | **Blade Length** | 5mm, 7mm, 9mm, 11mm, 15mm | Critical |\n| 5 | **Material** | Titanium, Cobalt | Important |\n| 6 | **Angle** | 45°, 60°, 90° (if angled) | If present |\n\n#### GUIDEWIRE Components (NEW):\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | TERUMO, ASAHI, COOK, BOSTON SCIENTIFIC | Yes |\n| 2 | **Diameter** | 0.014\", 0.018\", 0.035\", 0.038\" | Critical |\n| 3 | **Length** | 150cm, 180cm, 260cm, 300cm | Critical |\n| 4 | **Coating** | Hydrophilic, PTFE, Polymer | Important |\n| 5 | **Stiffness** | Floppy, Standard, Stiff, Extra-stiff | Important |\n| 6 | **Tip** | J-tip, Straight, Angled | If present |\n\n#### VASCULAR_GRAFT Components:\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | VASCUTEK | Yes |\n| 2 | **Product Line** | GELWEAVE, GELSOFT, GELSOFT PLUS, FLUOROPASSIV, GELSEAL | Yes |\n| 3 | **Sub-line** | VALSALVA, COSELLI, PLEXUS, ANTE-FLO | If present |\n| 4 | **Primary Diameter** | 6-38mm | Critical |\n| 5 | **Length** | 10-60cm or configuration | Critical |\n| 6 | **Configuration** | Straight, Bifurcated, Trifurcated | Critical |\n| 7 | **Branch Specs** | Secondary diameters (e.g., 14x7x7) | If bifurcated/trifurcated |\n| 8 | **Support** | SOPORTADA/Supported/Ringed | Important |\n| 9 | **Special** | TAPERED, PRECURVADA, branch angles (@15) | If present |\n\n#### INFUSION_SYSTEM Components:\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | ACE MEDICAL | Yes |\n| 2 | **Product** | AUTOFUSER, AUTOSELECTOR, AUTOFILLER | Yes |\n| 3 | **Mode** | CONTINUO, CON BOLO, CONTINUO+BOLO | Critical |\n| 4 | **Volume** | 60, 100, 150, 275, 400, 550 (ml) | Critical |\n| 5 | **Flow Rate** | 0.25 - 250 (ml/h) | Critical |\n| 6 | **Bolus Volume** | 0.5, 1, 2, 5 (ml) | If CON BOLO |\n| 7 | **Lockout Time** | 10, 15, 30, 60 (minutes) | If AUTOSELECTOR |\n| 8 | **UV Protection** | CON PROTECCION UV | If present |\n| 9 | **Duration** | X dias, X horas | Informational |\n\n#### SPINE_IMPLANT Components:\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Approach** | ALIF, TLIF, PLIF, XLIF | Yes |\n| 2 | **Type** | Spacer, Cage, Screw, Plate | Yes |\n| 3 | **Technology** | 3DP, Interfixated, Expandable (Exp.) | Important |\n| 4 | **Height** | 6, 8, 10, 12mm | Critical for spacers |\n| 5 | **Footprint** | Width x Depth (e.g., 34x24mm, 38x30mm) | Critical |\n| 6 | **Lordosis** | 0°, 4°, 6°, 8°, 10°, 12°, 15°, 20°, 25°, 30° | Critical |\n| 7 | **Expansion Range** | 8-12mm, 9-13mm, 10-14mm, 12-16mm | For expandable |\n| 8 | **Screw Diameter** | 5.5mm, 6.5mm, 7.5mm | For screws |\n| 9 | **Screw Length** | 20-57mm | For screws |\n| 10 | **Angle Type** | Fixed, Variable | For screws |\n| 11 | **Material** | PEEK, Titanium, 3D-printed Titanium | Important |\n\n#### OPHTHALMIC Components:\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | AJL, AHMED, NEW WORLD MEDICAL | Yes |\n| 2 | **Product Type** | Valve, Viscoelastic, Dye, Ring, Implant, Trephine | Yes |\n| 3 | **Model** | FP7, FP8, Clearpath 250/350, PRO+, ALOS | Important |\n| 4 | **Size/Weight** | Diameter (mm), Weight (g) | Product-specific |\n| 5 | **Concentration** | 0.025%, 0.06%, 1%, 1.4%, 2%, 3% | For viscoelastics/dyes |\n| 6 | **Optical Zone** | ZO 5mm, ZO 6mm | For rings |\n| 7 | **Arc/Direction** | 160°, 210° CCW/CW | For rings |\n| 8 | **Thickness** | 0.15-0.25mm, 0.15-0.30mm | For rings |\n\n#### SYRINGE Components:\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Product Type** | seringa, syringe, jeringa | Yes |\n| 2 | **Parts** | 2 peças, 3 peças | Important |\n| 3 | **Volume** | 1ml, 2ml, 5ml, 10ml, 20ml, 50ml, 100ml | Critical |\n| 4 | **Connection** | Luer Lock, Luer Slip, Bico Cateter | Important |\n| 5 | **Purpose** | Insulina, Tuberculina, Gases, Epidural | If specific |\n| 6 | **Safety** | Irrecuperável, Segurança | Important |\n| 7 | **Special** | Ponta excêntrica, baixo volume morto | If present |\n\n#### NEEDLE Components:\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Product Type** | agulha, needle, aguja, lanceta | Yes |\n| 2 | **Subtype** | Hipodérmica, Epicraniana, Punção | Important |\n| 3 | **Gauge** | 18G, 19G, 20G, 21G, 22G, 23G, 25G, 27G | Critical |\n| 4 | **Length/Dimensions** | Xmm or X.XxYmm | Critical |\n| 5 | **Safety Features** | Anti-picada, Segurança, Irrecuperável | Important |\n| 6 | **Tip Type** | Romba (blunt), Bisel | If specified |\n| 7 | **Connection** | Luer Lock, Luer Slip | If specified |\n\n#### SURGICAL_INSTRUMENT Components:\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | SCANLAN | Yes |\n| 2 | **Instrument Type** | Forceps, Clamp, Porta-agujas, Scissors, Knife | Yes |\n| 3 | **Specific Model** | JACOBSON, DENNIS, RESANO, STEVENS | Important |\n| 4 | **Size** | Length in cm | Important |\n| 5 | **Tip/Jaw Type** | Diamond dust, Recta, Curva, Angulada | Important |\n| 6 | **Handle Type** | Redondo, Bayoneta | If specified |\n| 7 | **Lock** | Con freno, Sin freno | If specified |\n| 8 | **Special Features** | Micro, Legacy, Never Shear | If present |\n\n#### ELECTRODE Components:\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | AXELGAARD | Yes |\n| 2 | **Product Line** | PALS, ULTRASTIM | Yes |\n| 3 | **Variant** | PLATINUM, BLUE, SPUNLACE | Important |\n| 4 | **Size** | 5x5cm, 5x9cm, 5x10cm, 5x13cm, 4x9cm | Critical |\n| 5 | **Reusability** | Reutilizável, Descartável | Important |\n| 6 | **Material** | FOAM, SPUNLACE | If specified |\n\n#### VASCULAR_ACCESS Components:\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | ANGIODYNAMICS | Yes |\n| 2 | **Product** | SMARTPORT, SMARTPORT+, BIOFLO, DURAMAX | Yes |\n| 3 | **Material** | Silicone, Poliuretano, BIOFLO, Plástico | Important |\n| 4 | **French Size** | 5FR, 6FR, 8FR, 9.6FR | Critical |\n| 5 | **Length** | 24CM, 28CM | If specified |\n| 6 | **Special** | Relleno (filled), Orificios de sutura | If present |\n\n#### ABLATION Components:\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | ANGIODYNAMICS | Yes |\n| 2 | **System** | NANOKNIFE (IRE), SOLERO (MWA), VENACURE (Laser) | Yes |\n| 3 | **Component Type** | Generador, Sonda, Antena, Kit | Yes |\n| 4 | **Length** | 14cm, 15cm, 19cm, 25cm, 29cm | For probes/antennas |\n| 5 | **Wavelength** | 1470nm | For laser |\n\n#### COMPRESSION Components:\n\n| Priority | Component | Pattern/Keywords | Required |\n|----------|-----------|------------------|----------|\n| 1 | **Brand** | ACTICO | Yes |\n| 2 | **Product Line** | TPS, UlcerSys, Silk | Yes |\n| 3 | **Location** | Knee, Thigh | Important |\n| 4 | **Size** | S, M, L, XL, XLL | Critical |\n| 5 | **Length Variant** | Normal, Long, Short, Standard | Important |\n\n---\n\n### Step C: Expand with Synonyms\n\n**Add synonyms based on detected category to improve matching:**\n\n#### Universal Synonyms (all categories):\n\n| Term Found | Also Include |\n|------------|--------------|\n| descartável, descartable | disposable, single-use, uso único |\n| reutilizável, reutilizable | reusable, multi-use |\n| estéril, esteril | sterile, sterilized |\n| titânio, titanio | titanium |\n| aço inoxidável | stainless steel, acero inoxidable |\n\n#### CORONARY_STENT Synonyms (NEW):\n\n| Term | Also Search |\n|------|-------------|\n| IVASCULAR | ivascular stent coronário |\n| INTREGAL | intregal coronary |\n| DES | drug-eluting, fármaco-elutivo, liberador de fármaco |\n| BMS | bare-metal, metálico, sin recubrimiento |\n| CoCr | cromo-cobalto, cobalt chromium |\n| RX | rapid-exchange, troca rápida |\n| PTCA | angioplastia coronária, coronary angioplasty |\n\n#### ENDOGRAFT Synonyms (NEW):\n\n| Term | Also Search |\n|------|-------------|\n| GORE | excluder, viabahn, TAG |\n| endograft | endoprótese, stent-graft, endovascular graft |\n| TEVAR | thoracic endovascular repair, torácico |\n| EVAR | endovascular aneurysm repair, abdominal |\n| fenestrada | fenestrated, con fenestras |\n| branched | ramificada, com ramos |\n| iliaco | iliac, ilíaco, iliac extension |\n\n#### CATHETER Synonyms:\n\n| Term | Also Search |\n|------|-------------|\n| SOFT-VU | soft vu, softvu, soft-vu |\n| MARINER | mariner hydrophilic, mariner hidrofilico |\n| ACCU-VU | accu vu, accuvu |\n| COBRA | cobra catheter, cobra cateter |\n| SIDEWINDER | side winder, simmons, SIM |\n| PIGTAIL | pig tail, pig-tail, coleta |\n| SOS OMNI | sos, omni selective, sos-omni |\n| OMNI FLUSH | omniflush, flush catheter |\n| HEADHUNTER | head hunter, HH, H1 |\n| BERENSTEIN | bernstein, BER |\n| SHEPHERD HOOK | shepherds hook, SH |\n| HOCKEY STICK | hockeystick, HS |\n| MALLADO | braided, malha, trançado, trenzado |\n| PULSE-SPRAY | pulse spray, pulsespray |\n| UNIFUSE | uni fuse, uni-fuse |\n| JUDKINS | JL, JR, judkins left, judkins right |\n\n#### SCREW Synonyms (NEW):\n\n| Term | Also Search |\n|------|-------------|\n| parafuso pedicular | pedicle screw, tornillo pedicular |\n| poliaxial | polyaxial, multi-axial |\n| monoaxial | uniaxial, fixed-axis |\n| canulado | cannulated, hollow |\n| autoroscante | self-tapping, autorroscante |\n| redução | reduction, reducing |\n| cortical | cortical bone screw |\n\n#### ROD Synonyms (NEW):\n\n| Term | Also Search |\n|------|-------------|\n| haste | rod, barra, varilla |\n| conector | connector, rod-to-rod |\n| pré-curvada | pre-bent, precurvada |\n| lordose | lordosis, lordotic |\n\n#### PLATE Synonyms (NEW):\n\n| Term | Also Search |\n|------|-------------|\n| placa cervical | cervical plate, anterior cervical |\n| bloqueada | locking, locked |\n| furos | holes, orificios |\n\n#### ANEURYSM_CLIP Synonyms (NEW):\n\n| Term | Also Search |\n|------|-------------|\n| clip aneurisma | aneurysm clip, clip cerebral |\n| YASARGIL | yasargil clip |\n| fenestrado | fenestrated, com fenestra |\n| angulado | angled, inclinado |\n\n#### GUIDEWIRE Synonyms (NEW):\n\n| Term | Also Search |\n|------|-------------|\n| fio-guia | guidewire, guide wire, guia |\n| hidrofílico | hydrophilic, hidrofilico |\n| RADIFOCUS | radifocus, terumo |\n| ponta J | J-tip, J tip, J curve |\n| rígido | stiff, extra-stiff |\n\n#### VASCULAR_GRAFT Synonyms:\n\n| Term | Also Search |\n|------|-------------|\n| GELWEAVE | gel weave, woven, tecido |\n| GELSOFT | gel soft, knitted, malha |\n| GELSOFT PLUS | gelsoftplus, gelsoft+ |\n| FLUOROPASSIV | fluoro passiv, PTFE, ePTFE, politetrafluoretileno |\n| GELSEAL | gel seal, sealed |\n| SOPORTADA | supported, ringed, anelada, com anéis, con anillos |\n| BIFURCADA | bifurcated, aorto-bifemoral, Y-graft |\n| TRIFURCADA | trifurcated, três ramos |\n| VALSALVA | sinus, root |\n| COSELLI | thoracoabdominal, toracoabdominal |\n| PLEXUS | multi-branch, múltiplas ramas |\n| ANTE-FLO | antegrade flow, fluxo anterógrado |\n| TAPERED | cónico, conico, tapered |\n\n#### INFUSION_SYSTEM Synonyms:\n\n| Term | Also Search |\n|------|-------------|\n| AUTOFUSER | infusor elastomérico, elastomeric pump, bomba elastomérica |\n| AUTOSELECTOR | PCA, patient controlled, controlado pelo paciente |\n| CONTINUO | continuous, contínuo, infusão contínua |\n| CON BOLO | with bolus, com bolo, PCA bolus |\n| PROTECCION UV | UV protection, proteção UV, light protected |\n| MULTIPERFORADO | multi-hole, wound catheter, cateter ferida |\n\n#### SPINE_IMPLANT Synonyms:\n\n| Term | Also Search |\n|------|-------------|\n| ALIF | anterior lumbar interbody fusion, fusão lombar anterior |\n| TLIF | transforaminal lumbar interbody fusion, fusão transforaminal |\n| PLIF | posterior lumbar interbody fusion, fusão posterior |\n| XLIF | extreme lateral interbody fusion, fusão lateral |\n| 3DP | 3D printed, impressão 3D, additive manufactured |\n| INTERFIXATED | integrated screws, parafusos integrados |\n| EXPANDABLE | expansível, expansible, in-situ expansion |\n| SPACER | espaçador, cage, dispositivo intersomático |\n| THREADED STAPLE | agrafo roscado, staple |\n| PEEK | poliéter éter cetona, polymer cage |\n\n#### OPHTHALMIC Synonyms:\n\n| Term | Also Search |\n|------|-------------|\n| AHMED | ahmed valve, válvula ahmed, glaucoma valve |\n| FP7 | adult, adulto |\n| FP8 | pediatric, pediátrico |\n| CLEARPATH | clear path |\n| VISC | viscoelastic, viscoelástico, hialuronato |\n| BBG | brilliant blue G, azul brilhante |\n| BLUE | trypan blue, azul tripano |\n| ALOS | eyelid weight, peso palpebral, gold weight |\n| PRO+ | intracorneal ring, anel intracorneano |\n| TREPHINE | trépano, punch, receptor |\n| CONFORMER | conformador |\n| SYMBLEFARON | simbléfaro |\n\n#### SYRINGE Synonyms:\n\n| Term | Also Search |\n|------|-------------|\n| irrecuperável | descartável, safety, single-use, não reutilizável |\n| 2 peças | 2-part, duas peças, bipartida |\n| 3 peças | 3-part, três peças, tripartida |\n| luer lock | luer-lock, LL, rosca |\n| luer slip | luer-slip, LS, encaixe |\n| bico cateter | catheter tip, ponta cateter |\n| insulina | insulin, U-100, U-40 |\n| tuberculina | tuberculin, TB |\n| ponta excêntrica | eccentric tip, off-center |\n\n#### NEEDLE Synonyms:\n\n| Term | Also Search |\n|------|-------------|\n| epicraniana | scalp, butterfly, borboleta, scalp vein |\n| hipodérmica | hypodermic, subcutânea |\n| anti-picada | needlestick prevention, segurança, safety |\n| irrecuperável | safety, retractable, retrátil |\n| romba | blunt, obtusa, ponta romba, embotada |\n| lanceta | lancet, punção capilar |\n| punção | puncture, aspiração |\n\n#### SURGICAL_INSTRUMENT Synonyms:\n\n| Term | Also Search |\n|------|-------------|\n| SURG-I-LOOP | vessel loop, laço vascular |\n| porta-agujas | needle holder, porta agulhas |\n| forceps | pinça, fórceps |\n| clamp | grampo, pinça hemostática |\n| tijera | scissors, tesoura |\n| diamond dust | diamante, carbide |\n| micro | microsurgery, microcirurgia |\n\n#### ELECTRODE Synonyms:\n\n| Term | Also Search |\n|------|-------------|\n| PALS | electrode, elétrodo |\n| ULTRASTIM | estimulação, stimulation |\n| PLATINUM | platina |\n| reutilizável | reusable, lavável |\n| FOAM | espuma |\n| TENS | transcutaneous, transcutâneo |\n\n---\n\n### Step D: Build Final Search Query\n\n**Combine extracted components into a search query following this structure:**\n\n```\n[Brand] [Product Line] [Model/Shape] [Variant] [Critical Specs] [Secondary Specs] [Synonyms]\n```\n\n**Query Building Examples by Category:**\n\n#### CORONARY_STENT Example (NEW):\n- **Input:** \"IVASCULAR INTREGAL DES 3.0X24MM CoCr\"\n- **Extracted:** Brand=IVASCULAR, Line=INTREGAL, Type=DES, Dims=3.0x24mm, Material=CoCr\n- **Query:** `IVASCULAR INTREGAL DES drug-eluting 3.0x24 3,0x24 3.0mm 24mm CoCr cromo-cobalto stent coronário`\n\n#### ENDOGRAFT Example (NEW):\n- **Input:** \"GORE EXCLUDER C3 MAIN BODY 28X14X140\"\n- **Extracted:** Brand=GORE, Line=EXCLUDER, Component=main body, Dims=28x14x140\n- **Query:** `GORE EXCLUDER C3 main body 28x14x140 28mm 140mm EVAR endograft endoprótese abdominal aórtico`\n\n#### SCREW Example (NEW):\n- **Input:** \"PARAFUSO PEDICULAR POLIAXIAL 6.5X50MM TITANIO\"\n- **Extracted:** Type=pedicular, Variant=polyaxial, Dims=6.5x50, Material=titanium\n- **Query:** `parafuso tornillo screw pedicular pedicle polyaxial poliaxial 6.5x50 6,5x50 6.5mm 50mm titanium titânio`\n\n#### CATHETER Example:\n- **Input:** \"ANGIODYNAMICS SOFT-VU COBRA (2) 5F 90CM 0.038`` MALLADO\"\n- **Extracted:** Brand=ANGIODYNAMICS, Line=SOFT-VU, Shape=COBRA, Variant=2, Gauge=5F, Length=90CM, Wire=0.038, Construction=MALLADO\n- **Query:** `ANGIODYNAMICS SOFT-VU COBRA 2 5F 90CM 0.038 0,038 mallado braided cateter catheter catéter`\n\n#### VASCULAR_GRAFT Example:\n- **Input:** \"VASCUTEK GELSOFT PLUS SOPORTADA 10X100\"\n- **Extracted:** Brand=VASCUTEK, Line=GELSOFT PLUS, Support=SOPORTADA, Dims=10x100\n- **Query:** `VASCUTEK GELSOFT PLUS soportada supported ringed 10x100 10mm 100cm graft prótese`\n\n#### INFUSION_SYSTEM Example:\n- **Input:** \"ACE MEDICAL AUTOFUSER CONTINUO 275/2,0 (5 DIAS)\"\n- **Extracted:** Brand=ACE MEDICAL, Product=AUTOFUSER, Mode=CONTINUO, Volume=275ml, Flow=2.0ml/h\n- **Query:** `ACE MEDICAL AUTOFUSER contínuo continuous 275ml 2.0ml/h 2,0ml/h infusor elastomérico`\n\n#### SYRINGE Example:\n- **Input:** \"SERINGA IRRECUP. 3/PECAS-5ML\"\n- **Extracted:** Type=seringa, Safety=irrecuperável, Parts=3 peças, Volume=5ml\n- **Query:** `seringa syringe jeringa irrecuperável descartável safety 3 peças 3-part 5ml`\n\n#### NEEDLE Example:\n- **Input:** \"AGULHA EPICRANIANA COM SISTEMA SEGURANÇA 21GX20MM\"\n- **Extracted:** Type=agulha, Subtype=epicraniana, Safety=segurança, Gauge=21G, Length=20mm\n- **Query:** `agulha needle aguja epicraniana scalp butterfly segurança safety 21G 20mm`\n\n#### SPINE_IMPLANT Example:\n- **Input:** \"3DP Interfixated ALIF, 10x34x24mm 15°\"\n- **Extracted:** Tech=3DP, Type=Interfixated ALIF, Dims=10x34x24mm, Lordosis=15°\n- **Query:** `3DP 3D-printed ALIF interfixated integrated screws 10x34x24mm 15° spacer cage lombar PEEK titanium`\n\n---\n\n### Step E: Include especificacoes_tecnicas Keywords\n\n**If `especificacoes_tecnicas` is not null, extract additional keywords and add to query:**\n\n| Spec Text | Keywords to Add |\n|-----------|-----------------|\n| \"baixo volume morto\" | low dead space, dead space mínimo |\n| \"polipropileno\" | polipropileno, PP, polypropylene |\n| \"aço inoxidável\" | stainless steel, aço, acero inoxidable |\n| \"sem látex\" | latex-free, sin látex |\n| \"ponta excêntrica\" | eccentric tip, off-center |\n| \"sistema anti picada\" | anti-picada, needlestick safety |\n| \"fechar de forma fácil\" | easy close, fecho fácil |\n| \"hidrofílico\" | hydrophilic, hidrofilico |\n| \"radiopaco\" | radiopaque, radioopaco |\n| \"graduada\" | graduated, graduado, marcada |\n| \"cônica\" | tapered, cónica |\n| \"alta pressão\" | high pressure, alta presión |\n| \"drug-eluting\" | DES, fármaco-elutivo |\n| \"bioabsorvível\" | bioabsorbable, bioreabsorvível |\n\n---\n\n## Step F: Progressive Query Strategy (MULTI-LEVEL SEARCH)\n\n**CRITICAL: Instead of a single query, use a progressive cascade to maximize match quality.**\n\n### Strategy Overview\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                    PROGRESSIVE QUERY CASCADE                     │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                  │\n│  Level 1: SPECIFIC (All components)                             │\n│  ├─ Brand + Product Line + Model + All Specs + Synonyms         │\n│  └─ Accept if: ANY result ≥ 0.75 similarity                     │\n│                                                                  │\n│  Level 2: CORE SPECS (if Level 1 found < 3 results ≥ 0.70)      │\n│  ├─ Category + Shape/Type + Critical Specs (gauge/volume/dims)  │\n│  └─ Accept if: ANY result ≥ 0.70 similarity                     │\n│                                                                  │\n│  Level 3: CATEGORY + DIMENSIONS (if Level 2 insufficient)       │\n│  ├─ Product type + Primary dimensions only                      │\n│  └─ Accept if: ANY result ≥ 0.65 similarity                     │\n│                                                                  │\n│  Level 4: CATEGORY ONLY (fallback if needed)                    │\n│  ├─ Just category keywords (trilingual)                         │\n│  └─ Accept if: ANY result ≥ 0.60 similarity                     │\n│                                                                  │\n│  RETURN: Up to TOP 3 matches (score ≥ 0.60) across all levels   │\n│  If no results ≥ 0.60 at any level → \"Sem Match\"                │\n│                                                                  │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### Execution Rules\n\n1. **Start at Level 1** with most specific query\n2. **Collect valid matches** (score ≥ threshold for that level)\n3. **If < 3 valid matches**, proceed to next level\n4. **Combine results** from all levels, remove duplicates (by artigo code)\n5. **Return TOP 3** unique matches sorted by similarity_score descending\n6. **Minimum threshold: 0.60** - never return matches below this\n\n### Category-Specific Query Templates\n\n#### CORONARY_STENT Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {product_line} stent coronário {diameter}mm {length}mm {coating} DES BMS` | 0.75 |\n| 2 | `stent coronário {diameter}mm {length}mm {coating}` | 0.70 |\n| 3 | `stent coronary coronário {diameter}mm` | 0.65 |\n| 4 | `stent coronary coronário drug-eluting bare-metal` | 0.60 |\n\n#### ENDOGRAFT Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {product_line} endoprótese {location} {diameter}mm {length}mm` | 0.75 |\n| 2 | `endoprótese endograft {location} {diameter}mm {length}mm` | 0.70 |\n| 3 | `endoprótese endograft stent-graft {diameter}mm` | 0.65 |\n| 4 | `endoprótese endograft TEVAR EVAR aórtico` | 0.60 |\n\n#### CATHETER Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {product_line} {shape} {variant} cateter {gauge} {length} {guidewire}` | 0.75 |\n| 2 | `cateter catheter {shape} {gauge} {guidewire} {length}` | 0.70 |\n| 3 | `cateter catheter catéter {gauge} {length}` | 0.65 |\n| 4 | `cateter catheter catéter diagnóstico angiografia` | 0.60 |\n\n#### VASCULAR_GRAFT Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {product_line} prótese vascular {type} {diameter}mm {length}cm` | 0.75 |\n| 2 | `prótese vascular graft {type} {diameter}mm` | 0.70 |\n| 3 | `prótese vascular graft DACRON {diameter}mm` | 0.65 |\n| 4 | `prótese vascular graft enxerto bifurcad` | 0.60 |\n\n#### SCREW Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} parafuso {type} {diameter}mm {length}mm {material}` | 0.75 |\n| 2 | `parafuso {type} {diameter}mm {length}mm` | 0.70 |\n| 3 | `parafuso screw tornillo {diameter}mm` | 0.65 |\n| 4 | `parafuso pedicular screw spine vertebral` | 0.60 |\n\n#### ROD Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} haste barra {diameter}mm {length}mm {material}` | 0.75 |\n| 2 | `haste barra rod {diameter}mm {length}mm` | 0.70 |\n| 3 | `haste rod varilla {diameter}mm spine` | 0.65 |\n| 4 | `haste barra rod spine titanium PEEK CoCr` | 0.60 |\n\n#### PLATE Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} placa {type} {length}mm {holes} furos` | 0.75 |\n| 2 | `placa plate {type} {length}mm` | 0.70 |\n| 3 | `placa plate cervical anterior {holes}` | 0.65 |\n| 4 | `placa plate cervical vertebral spine` | 0.60 |\n\n#### ANEURYSM_CLIP Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} clip aneurisma {type} {size}mm {angle}°` | 0.75 |\n| 2 | `clip aneurisma {type} {size}mm` | 0.70 |\n| 3 | `clip aneurysm cerebral {size}mm` | 0.65 |\n| 4 | `clip aneurisma aneurysm microvascular neurocirurgia` | 0.60 |\n\n#### SPINE_IMPLANT Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {type} cage spacer {dimensions} {lordosis}° {material}` | 0.75 |\n| 2 | `cage spacer {type} {dimensions} {lordosis}°` | 0.70 |\n| 3 | `cage spacer intersomático {height}mm` | 0.65 |\n| 4 | `cage spacer ALIF TLIF PLIF XLIF fusão vertebral PEEK` | 0.60 |\n\n#### GUIDEWIRE Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} guia fio-guia {diameter} {length}cm {tip} {coating}` | 0.75 |\n| 2 | `guia guidewire fio-guia {diameter} {length}cm {tip}` | 0.70 |\n| 3 | `guia guidewire {diameter} {coating}` | 0.65 |\n| 4 | `guia guidewire fio-guia mandril hydrophilic` | 0.60 |\n\n#### INFUSION_SYSTEM Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {product} infusor {mode} {volume}ml {flow}ml/h` | 0.75 |\n| 2 | `infusor elastomérico {mode} {volume}ml {flow}ml/h` | 0.70 |\n| 3 | `infusor elastomérico {volume}ml bomba` | 0.65 |\n| 4 | `infusor elastomérico bomba infusão PCA continuous` | 0.60 |\n\n#### VASCULAR_ACCESS Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {product} port cateter {lumen} {french} {length}cm` | 0.75 |\n| 2 | `port cateter central {lumen} {french}` | 0.70 |\n| 3 | `port PICC CVC cateter central {french}` | 0.65 |\n| 4 | `port cateter central PICC CVC reservatório implantável` | 0.60 |\n\n#### ABLATION Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {product} ablação {modality} {needle_gauge} {length}cm` | 0.75 |\n| 2 | `ablação {modality} {needle_gauge} {length}cm` | 0.70 |\n| 3 | `ablação radiofrequência microondas {length}cm` | 0.65 |\n| 4 | `ablação ablation radiofrequência MWA IRE laser` | 0.60 |\n\n#### OPHTHALMIC Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {product} {type} oftálmico {size}mm` | 0.75 |\n| 2 | `{type} oftálmico ocular {size}mm` | 0.70 |\n| 3 | `válvula glaucoma oftálmico {size}` | 0.65 |\n| 4 | `oftálmico ocular glaucoma válvula córnea vitreo` | 0.60 |\n\n#### SURGICAL_INSTRUMENT Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {type} {subtype} {size}mm cirúrgico` | 0.75 |\n| 2 | `{type} {subtype} cirúrgico {size}mm` | 0.70 |\n| 3 | `{type} instrumento cirúrgico` | 0.65 |\n| 4 | `forceps clamp pinça tesoura porta-agulha cirúrgico` | 0.60 |\n\n#### AIRWAY Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {product} via aérea {type} {size}` | 0.75 |\n| 2 | `via aérea laringoscópio {type} {size}` | 0.70 |\n| 3 | `via aérea intubação {size}` | 0.65 |\n| 4 | `via aérea laringoscópio intubação videolaringoscópio` | 0.60 |\n\n#### ELECTRODE Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} elétrodo {type} {size}cm {application}` | 0.75 |\n| 2 | `elétrodo {type} {size}cm estimulação` | 0.70 |\n| 3 | `elétrodo electrodo TENS {size}` | 0.65 |\n| 4 | `elétrodo electrodo TENS estimulação neuroestimulação` | 0.60 |\n\n#### SYRINGE Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} seringa {volume}ml {type} {pieces} peças {tip}` | 0.75 |\n| 2 | `seringa {volume}ml {type} {tip}` | 0.70 |\n| 3 | `seringa syringe jeringa {volume}ml` | 0.65 |\n| 4 | `seringa syringe jeringa luer descartável` | 0.60 |\n\n#### NEEDLE Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} agulha {type} {gauge} {length}mm {safety}` | 0.75 |\n| 2 | `agulha {type} {gauge} {length}mm` | 0.70 |\n| 3 | `agulha needle aguja {gauge} {length}mm` | 0.65 |\n| 4 | `agulha needle aguja hipodérmica epicraniana lanceta` | 0.60 |\n\n#### COMPRESSION Templates:\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {product} compressão {type} {size} {pressure}mmHg` | 0.75 |\n| 2 | `compressão meia {type} {size} {pressure}` | 0.70 |\n| 3 | `meia compressão compressiva {size}` | 0.65 |\n| 4 | `meia compressão compressiva úlcera anti-embolismo TPS` | 0.60 |\n\n#### GENERAL Templates (fallback):\n| Level | Template | Threshold |\n|-------|----------|-----------|\n| 1 | `{brand} {full_description_normalized}` | 0.75 |\n| 2 | `{key_specs_only}` | 0.70 |\n| 3 | `{product_type} {primary_dimension}` | 0.65 |\n| 4 | `{product_type}` | 0.60 |\n\n---\n\n## Post-Search Validation\n\n**After `query_artigos_vectors` returns results, validate and filter candidates based on category-specific rules:**\n\n### Universal Rejection Rules (ALL categories):\n\n| Check | Rule |\n|-------|------|\n| **Product Category** | MUST match - catheter ≠ graft ≠ syringe ≠ needle ≠ stent ≠ screw |\n| **Brand** | If specified in RFP, should match (score penalty if different) |\n\n---\n\n### CORONARY_STENT Validation Rules (NEW):\n\n#### REJECTION (score = 0, do not return):\n\n| Check | Rule | Example |\n|-------|------|---------|\n| Stent Diameter | Must match within ±0.25mm | 3.0 ≠ 3.5 |\n| Stent Length | Must match within ±2mm | 24mm ≠ 28mm |\n| Stent Type | DES ≠ BMS | drug-eluting ≠ bare-metal |\n| Product Line | Must match | INTREGAL ≠ ARMADA |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Exact dimensions match | +0.15 |\n| Brand matches exactly | +0.10 |\n| Material matches (CoCr, etc.) | +0.05 |\n| Delivery system matches (RX/OTW) | +0.03 |\n| Type mismatch (DES vs BMS) | REJECT |\n\n---\n\n### ENDOGRAFT Validation Rules (NEW):\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Location | Thoracic ≠ Abdominal ≠ Iliac |\n| Diameter | Must match within ±2mm |\n| Type | Standard ≠ Fenestrated ≠ Branched |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Exact diameter match | +0.10 |\n| Length within ±10mm | +0.05 |\n| Component type matches | +0.10 |\n| Brand matches | +0.05 |\n| Location mismatch | REJECT |\n\n---\n\n### SCREW Validation Rules (NEW):\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Screw Type | Pedicular ≠ Cortical ≠ Cannulated |\n| Diameter | Must match within ±0.5mm |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Exact diameter match | +0.15 |\n| Length within ±5mm | +0.05 |\n| Length exact match | +0.10 |\n| Type matches (polyaxial/monoaxial) | +0.10 |\n| Material matches | +0.05 |\n| Diameter mismatch >1mm | REJECT |\n\n---\n\n### ROD Validation Rules (NEW):\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Diameter | Must match: 5.5 ≠ 6.0 ≠ 6.35 |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Exact diameter match | +0.15 |\n| Length within ±50mm | +0.05 |\n| Material matches | +0.05 |\n| Shape matches (curved/straight) | +0.05 |\n\n---\n\n### PLATE Validation Rules (NEW):\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Location | Cervical ≠ Lumbar ≠ Thoracic |\n| Hole Count | Must match |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Exact hole count match | +0.15 |\n| Type matches (locking, etc.) | +0.10 |\n| Brand matches | +0.05 |\n\n---\n\n### ANEURYSM_CLIP Validation Rules (NEW):\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Clip Shape | Straight ≠ Angled ≠ Curved |\n| Brand | YASARGIL ≠ SUGITA (different systems) |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Blade length matches | +0.15 |\n| Shape matches exactly | +0.10 |\n| Size category matches | +0.05 |\n| Material matches | +0.05 |\n\n---\n\n### GUIDEWIRE Validation Rules (NEW):\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Diameter | Must match EXACTLY: 0.014 ≠ 0.018 ≠ 0.035 ≠ 0.038 |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Diameter exact match | +0.15 |\n| Length within ±20cm | +0.05 |\n| Coating matches | +0.05 |\n| Stiffness matches | +0.05 |\n| Tip shape matches | +0.03 |\n| Diameter mismatch | REJECT |\n\n---\n\n### CATHETER Validation Rules:\n\n#### REJECTION (score = 0, do not return):\n\n| Check | Rule | Example |\n|-------|------|---------|\n| French Gauge | Must match EXACTLY | 4F ≠ 5F ≠ 6F ≠ 7F |\n| Guidewire | Must match EXACTLY | 0.014 ≠ 0.018 ≠ 0.035 ≠ 0.038 |\n| Primary Shape | Must match | COBRA ≠ SIDEWINDER ≠ PIGTAIL |\n| Product Line | Must match category | SOFT-VU ≠ PULSE-SPRAY ≠ UNIFUSE |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Brand matches exactly | +0.10 |\n| Shape variant matches (1, 2, 3) | +0.05 |\n| Length within ±10cm | +0.03 |\n| Length exact match | +0.05 |\n| Construction matches (MALLADO) | +0.05 |\n| MARINER vs non-MARINER mismatch | -0.10 |\n| Shape variant mismatch | -0.05 |\n| Length difference >20cm | -0.10 |\n\n---\n\n### VASCULAR_GRAFT Validation Rules:\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Product Line | GELWEAVE ≠ GELSOFT ≠ FLUOROPASSIV |\n| Configuration | Straight ≠ Bifurcated ≠ Trifurcated |\n| Primary Diameter | Must match within ±2mm |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Exact diameter match | +0.10 |\n| Length within ±5cm | +0.05 |\n| Support type matches (SOPORTADA) | +0.05 |\n| Sub-line matches (VALSALVA, COSELLI) | +0.10 |\n| Branch dimensions match | +0.05 |\n| Missing support feature when required | -0.15 |\n\n---\n\n### INFUSION_SYSTEM Validation Rules:\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Volume | Must match EXACTLY: 60 ≠ 100 ≠ 150 ≠ 275 ≠ 400 ≠ 550 |\n| Mode | CONTINUO ≠ CON BOLO ≠ CONTINUO+BOLO |\n| Product | AUTOFUSER ≠ AUTOSELECTOR |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Flow rate matches exactly | +0.10 |\n| Flow rate within ±0.5ml/h | +0.05 |\n| Bolus parameters match | +0.05 |\n| Lockout time matches | +0.05 |\n| UV protection matches | +0.03 |\n| Flow rate mismatch >1ml/h | -0.15 |\n\n---\n\n### SPINE_IMPLANT Validation Rules:\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Approach | ALIF ≠ TLIF ≠ PLIF ≠ XLIF |\n| Implant Type | Spacer ≠ Screw ≠ Plate |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Exact dimensions match | +0.15 |\n| Lordosis angle matches | +0.10 |\n| Expansion range matches | +0.05 |\n| Screw diameter matches | +0.10 |\n| Screw length within ±3mm | +0.05 |\n| Technology matches (3DP, Interfixated) | +0.05 |\n| Angle type matches (Fixed/Variable) | +0.05 |\n| Material matches (PEEK, Titanium) | +0.05 |\n\n---\n\n### OPHTHALMIC Validation Rules:\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Product Type | Valve ≠ Viscoelastic ≠ Dye ≠ Ring ≠ Trephine |\n| Model | FP7 ≠ FP8 (adult vs pediatric) |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Model matches exactly | +0.15 |\n| Concentration matches | +0.10 |\n| Size/diameter matches | +0.10 |\n| Weight matches (implants) | +0.10 |\n| Arc and direction match (rings) | +0.05 |\n\n---\n\n### SYRINGE Validation Rules:\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Product Type | Syringe ≠ Needle ≠ Lancet |\n| Volume | Must match EXACTLY: 1ml ≠ 2ml ≠ 5ml ≠ 10ml ≠ 20ml |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Parts match (2 vs 3 peças) | +0.10 |\n| Connection type matches | +0.05 |\n| Safety feature matches | +0.05 |\n| Purpose matches (insulin, etc.) | +0.05 |\n| Missing safety when required | -0.15 |\n| Wrong number of parts | -0.10 |\n\n---\n\n### NEEDLE Validation Rules:\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Product Type | Needle ≠ Syringe ≠ Lancet (unless lancet requested) |\n| Gauge | Must match EXACTLY: 18G ≠ 19G ≠ 20G ≠ 21G ≠ 23G |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Subtype matches (epicraniana, hipodérmica) | +0.10 |\n| Length within ±3mm | +0.05 |\n| Length exact match | +0.08 |\n| Safety feature matches | +0.05 |\n| Tip type matches (blunt, etc.) | +0.05 |\n| Missing safety when required | -0.15 |\n| Length difference >5mm | -0.10 |\n\n---\n\n### SURGICAL_INSTRUMENT Validation Rules:\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Instrument Type | Forceps ≠ Clamp ≠ Scissors ≠ Needle holder |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Model matches exactly | +0.15 |\n| Size within ±1cm | +0.05 |\n| Tip type matches | +0.05 |\n| Handle type matches | +0.03 |\n| Lock feature matches | +0.03 |\n\n---\n\n### ELECTRODE Validation Rules:\n\n#### REJECTION (score = 0):\n\n| Check | Rule |\n|-------|------|\n| Size | Must match: 5x5 ≠ 5x9 ≠ 5x10 ≠ 5x13 |\n\n#### SCORING ADJUSTMENTS:\n\n| Condition | Score Adjustment |\n|-----------|------------------|\n| Product line matches (PALS vs ULTRASTIM) | +0.10 |\n| Variant matches (PLATINUM, BLUE) | +0.05 |\n| Reusability matches | +0.05 |\n| Material matches | +0.03 |\n\n---\n\n### Final Selection Logic:\n\n1. Apply rejection rules - eliminate candidates with score = 0\n2. Apply scoring adjustments to remaining candidates\n3. **Accept** candidates with adjusted score ≥ 0.65\n4. **Select** the candidate with the HIGHEST adjusted score\n5. If NO candidates pass validation → return `match_type: \"Sem Match\"`\n\n---\n\n# STEP 2: OUTPUT JSON RESULT\n\nAfter using tools, output ONLY a JSON array. No text before or after.\n\n## ⛔ ABSOLUTE RULES ⛔\n\n**YOU MUST ALWAYS OUTPUT A VALID JSON ARRAY.**\n\n- **NEVER output an empty response**\n- If tools fail, timeout, or return errors → Output the record with `match_type: \"Sem Match\"` and null values for match fields\n\n## Output Structure (18 fields required)\n\n### Multi-Match Output Rules (IMPORTANT!)\n\n**For SEMANTIC matches (`query_artigos_vectors`):**\n- Output **UP TO 3 ROWS** per input item (one row per valid match)\n- Each row contains the **SAME INPUT DATA** duplicated\n- Use `match_rank` field to indicate position (1 = best match, 2 = second, 3 = third)\n- Only include matches with `similarity_score` ≥ 0.60\n\n**For EXACT matches (`query_artigos_table`):**\n- Output **1 ROW** only (the exact match)\n- `match_rank` = 1\n\n**For NO MATCH:**\n- Output **1 ROW** with null values and `match_type: \"Sem Match\"`\n- `match_rank` = null\n\n```json\n[{\n  \"lote_pedido\": <from input>,\n  \"posicao_pedido\": <from input>,\n  \"artigo_pedido\": <from input>,\n  \"descricao_pedido\": <from input>,\n  \"especificacoes_tecnicas\": <from input, keep null as null>,\n  \"quantidade_pedido\": <from input>,\n  \"preco_artigo\": <from input>,\n  \"preco_posicao\": <from input>,\n  \"preco_lote\": <from input>,\n  \"matched_code\": <see rules below>,\n  \"artigo\": <DB artigo or null>,\n  \"descricao\": <DB descricao or null>,\n  \"unidade_venda\": <DB unidade_venda as string or null>,\n  \"quantidade\": <DB quantidade or null>,\n  \"preco\": <DB preco or null>,\n  \"similarity_score\": <1.0 | 0.XX | 0>,\n  \"match_type\": <\"Exato\" | \"Semântico\" | \"Sem Match\">,\n  \"match_rank\": <1 | 2 | 3 | null>\n}]\n```\n\n### Example: Semantic search returns 3 matches\n\n**Input:** 1 item\n**Output:** 3 rows (same input data, different matches)\n\n```json\n[\n  {\"lote_pedido\":1,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT001\",\"descricao_pedido\":\"Cateter COBRA 5F 90CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":10,\"preco_artigo\":45.00,\"preco_posicao\":450.00,\"preco_lote\":450.00,\"matched_code\":null,\"artigo\":\"100118681\",\"descricao\":\"ANGIODYNAMICS SOFT-VU COBRA 5F 90CM\",\"unidade_venda\":\"1\",\"quantidade\":5,\"preco\":42.50,\"similarity_score\":0.92,\"match_type\":\"Semântico\",\"match_rank\":1},\n  {\"lote_pedido\":1,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT001\",\"descricao_pedido\":\"Cateter COBRA 5F 90CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":10,\"preco_artigo\":45.00,\"preco_posicao\":450.00,\"preco_lote\":450.00,\"matched_code\":null,\"artigo\":\"100118682\",\"descricao\":\"COOK COBRA 2 5F 90CM\",\"unidade_venda\":\"1\",\"quantidade\":8,\"preco\":40.00,\"similarity_score\":0.85,\"match_type\":\"Semântico\",\"match_rank\":2},\n  {\"lote_pedido\":1,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT001\",\"descricao_pedido\":\"Cateter COBRA 5F 90CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":10,\"preco_artigo\":45.00,\"preco_posicao\":450.00,\"preco_lote\":450.00,\"matched_code\":null,\"artigo\":\"100118683\",\"descricao\":\"IMPRESS COBRA C2 5F 90CM\",\"unidade_venda\":\"1\",\"quantidade\":10,\"preco\":38.00,\"similarity_score\":0.78,\"match_type\":\"Semântico\",\"match_rank\":3}\n]\n```\n\n## Match Type Rules\n\n| Scenario | matched_code | similarity_score | match_type | match_rank | Rows |\n|----------|--------------|------------------|------------|------------|------|\n| query_artigos_table found exact match | DB codigo_spms value | 1.0 | **\"Exato\"** | 1 | 1 row |\n| query_artigos_vectors found 1-3 valid matches | **null** | 0.XX | **\"Semântico\"** | 1, 2, or 3 | 1-3 rows |\n| No suitable match found | null | 0 | **\"Sem Match\"** | null | 1 row |\n\n### ⚠️ IMPORTANT: matched_code Rules\n\n- **\"Exato\"** match: `matched_code` = the codigo_spms value from the database\n- **\"Semântico\"** match: `matched_code` = **null** (even if DB has a codigo_spms)\n- **\"Sem Match\"**: `matched_code` = null\n\n---\n\n# ⚠️ CRITICAL OUTPUT RULES ⚠️\n\n## FORBIDDEN - NEVER DO THESE:\n\n❌ Empty response\n❌ Text before the JSON array\n❌ Text after the JSON array\n❌ Markdown code blocks (no ```json or ```)\n❌ \"end of output\", \"RJ\", or ANY characters after `]`\n❌ \"I found...\", \"The query returned...\", \"Based on...\"\n❌ Bullet points or descriptions\n❌ Empty string \"\" for null values - use actual `null`\n\n## REQUIRED - ALWAYS DO THESE:\n\n✅ Response starts IMMEDIATELY with `[`\n✅ Response ends IMMEDIATELY with `]`\n✅ ONLY the JSON array, nothing else\n✅ Preserve `null` from input as `null` (not \"\")\n✅ All 18 fields present in every record (including `match_rank`)\n✅ `unidade_venda` must be string type (e.g., \"100\" not 100)\n✅ `matched_code` must be null for \"Semântico\" matches\n✅ For semantic matches: output 1-3 rows per input (one per match)\n\n---\n\n# FIELD RULES\n\n| Field | Source | Type | Notes |\n|-------|--------|------|-------|\n| `lote_pedido` | input | number | copy exactly |\n| `posicao_pedido` | input | number | copy exactly |\n| `artigo_pedido` | input | string | copy exactly |\n| `descricao_pedido` | input | string | copy exactly |\n| `especificacoes_tecnicas` | input | string/null | **PRESERVE null, NOT \"\"** |\n| `quantidade_pedido` | input | number | copy exactly |\n| `preco_artigo` | input | number/null | copy exactly |\n| `preco_posicao` | input | number/null | copy exactly |\n| `preco_lote` | input | number/null | copy exactly |\n| `matched_code` | DB/null | string/null | **null for Semântico matches** |\n| `artigo` | DB artigo | string/null | null if no match |\n| `descricao` | DB descricao | string/null | null if no match |\n| `unidade_venda` | DB unidade_venda | **string**/null | always string type |\n| `quantidade` | DB quantidade | number/null | null if no match |\n| `preco` | DB preco | number/null | null if no match |\n| `similarity_score` | calculated | number | 1.0 / 0.XX / 0 |\n| `match_type` | calculated | string | \"Exato\" / \"Semântico\" / \"Sem Match\" |\n| `match_rank` | calculated | number/null | 1, 2, or 3 for matches; null for \"Sem Match\" |\n\n---\n\n# ERROR HANDLING\n\n**If ANY error occurs (tool timeout, empty result, API error):**\n\n1. DO NOT return empty output\n2. DO NOT explain the error\n3. Output the record with:\n   - All input fields copied exactly\n   - `matched_code`: null\n   - `artigo`: null\n   - `descricao`: null\n   - `unidade_venda`: null\n   - `quantidade`: null\n   - `preco`: null\n   - `similarity_score`: 0\n   - `match_type`: \"Sem Match\"\n   - `match_rank`: null\n\n---\n\n# COMPLETE WORKFLOW EXAMPLES\n\n## Example 0: PROGRESSIVE CASCADE with Multi-Match Output (NEW!)\n\n**This example demonstrates the full progressive query strategy with 3 matches returned.**\n\n**Input:**\n```json\n{\n  \"lote_pedido\": 1,\n  \"posicao_pedido\": 1,\n  \"artigo_pedido\": \"CAT100\",\n  \"descricao_pedido\": \"Cateter diagnóstico COBRA 5F 100CM\",\n  \"especificacoes_tecnicas\": null,\n  \"quantidade_pedido\": 20,\n  \"preco_artigo\": 38.00,\n  \"preco_posicao\": 760.00,\n  \"preco_lote\": 760.00,\n  \"codigo_spms\": null\n}\n```\n\n**Process - Progressive Cascade:**\n\n**Step 1: Detect Category** → CATHETER (keyword: cateter, cobra)\n\n**Step 2: Level 1 Query (Full Specificity)**\n- Template: `{brand} {product_line} {shape} {variant} cateter {gauge} {length} {guidewire}`\n- Query: `cateter catheter COBRA diagnóstico 5F 100CM 0.035 0.038`\n- Results: 1 match with score 0.82 (≥0.75 ✓)\n- Status: Found 1 match, need more → Continue to Level 2\n\n**Step 3: Level 2 Query (Core Specs)**\n- Template: `cateter catheter {shape} {gauge} {guidewire} {length}`\n- Query: `cateter catheter COBRA 5F 100CM`\n- Results: 2 additional matches with scores 0.76, 0.71 (≥0.70 ✓)\n- Status: Found 3 total matches → STOP (enough matches)\n\n**Step 4: Combine and Sort Results**\n- Remove duplicates (by artigo code)\n- Sort by similarity_score descending\n- Take top 3\n\n**Step 5: Output 3 Rows (one per match)**\n\n**Output:**\n```json\n[\n  {\"lote_pedido\":1,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT100\",\"descricao_pedido\":\"Cateter diagnóstico COBRA 5F 100CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":20,\"preco_artigo\":38.00,\"preco_posicao\":760.00,\"preco_lote\":760.00,\"matched_code\":null,\"artigo\":\"100118690\",\"descricao\":\"ANGIODYNAMICS SOFT-VU COBRA 5F 100CM\",\"unidade_venda\":\"1\",\"quantidade\":10,\"preco\":35.00,\"similarity_score\":0.82,\"match_type\":\"Semântico\",\"match_rank\":1},\n  {\"lote_pedido\":1,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT100\",\"descricao_pedido\":\"Cateter diagnóstico COBRA 5F 100CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":20,\"preco_artigo\":38.00,\"preco_posicao\":760.00,\"preco_lote\":760.00,\"matched_code\":null,\"artigo\":\"100118691\",\"descricao\":\"COOK COBRA 2 5F 100CM 0.038\",\"unidade_venda\":\"1\",\"quantidade\":8,\"preco\":32.50,\"similarity_score\":0.76,\"match_type\":\"Semântico\",\"match_rank\":2},\n  {\"lote_pedido\":1,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT100\",\"descricao_pedido\":\"Cateter diagnóstico COBRA 5F 100CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":20,\"preco_artigo\":38.00,\"preco_posicao\":760.00,\"preco_lote\":760.00,\"matched_code\":null,\"artigo\":\"100118692\",\"descricao\":\"IMPRESS COBRA C2 5F 100CM\",\"unidade_venda\":\"1\",\"quantidade\":12,\"preco\":30.00,\"similarity_score\":0.71,\"match_type\":\"Semântico\",\"match_rank\":3}\n]\n```\n\n**Key Points:**\n- ✅ Input data is **duplicated** in each row\n- ✅ Each row has a different **match** (artigo, descricao, preco)\n- ✅ `match_rank` indicates order (1=best, 2=second, 3=third)\n- ✅ Business user can choose which match to use\n- ✅ Progressive cascade found matches at Level 1 and Level 2\n\n---\n\n## Example 1: CORONARY_STENT - Semantic match (NEW)\n\n**Input:**\n```json\n{\n  \"lote_pedido\": 1,\n  \"posicao_pedido\": 1,\n  \"artigo_pedido\": \"STN001\",\n  \"descricao_pedido\": \"Stent coronário DES 3.0x24mm cromo-cobalto\",\n  \"especificacoes_tecnicas\": \"Drug-eluting, rapid-exchange\",\n  \"quantidade_pedido\": 5,\n  \"preco_artigo\": 850.00,\n  \"preco_posicao\": 4250.00,\n  \"preco_lote\": 4250.00,\n  \"codigo_spms\": null\n}\n```\n\n**Process:**\n1. Detect category: CORONARY_STENT (keywords: stent coronário, DES)\n2. Extract: Type=DES, Diameter=3.0mm, Length=24mm, Material=CoCr\n3. Build query: `stent coronário DES drug-eluting fármaco-elutivo 3.0x24 3,0x24 3.0mm 24mm CoCr cromo-cobalto rapid-exchange RX`\n4. Validate: Type=DES ✓, Diameter=3.0 ✓, Length=24 ✓\n5. Best match: \"IVASCULAR INTREGAL DES 3.0X24 CoCr\" with score 0.92\n\n**Output:**\n```json\n[{\"lote_pedido\":1,\"posicao_pedido\":1,\"artigo_pedido\":\"STN001\",\"descricao_pedido\":\"Stent coronário DES 3.0x24mm cromo-cobalto\",\"especificacoes_tecnicas\":\"Drug-eluting, rapid-exchange\",\"quantidade_pedido\":5,\"preco_artigo\":850.00,\"preco_posicao\":4250.00,\"preco_lote\":4250.00,\"matched_code\":null,\"artigo\":\"IVS30024\",\"descricao\":\"IVASCULAR INTREGAL DES 3.0X24 CoCr\",\"unidade_venda\":\"1\",\"quantidade\":10,\"preco\":820.00,\"similarity_score\":0.92,\"match_type\":\"Semântico\",\"match_rank\":1}]\n```\n\n---\n\n## Example 2: SCREW - Semantic match (NEW)\n\n**Input:**\n```json\n{\n  \"lote_pedido\": 2,\n  \"posicao_pedido\": 1,\n  \"artigo_pedido\": \"PAR001\",\n  \"descricao_pedido\": \"Parafuso pedicular poliaxial 6,5x50mm titânio\",\n  \"especificacoes_tecnicas\": null,\n  \"quantidade_pedido\": 8,\n  \"preco_artigo\": 180.00,\n  \"preco_posicao\": 1440.00,\n  \"preco_lote\": 1440.00,\n  \"codigo_spms\": null\n}\n```\n\n**Process:**\n1. Detect category: SCREW (keywords: parafuso, pedicular)\n2. Extract: Type=pedicular polyaxial, Dims=6.5x50mm, Material=titanium\n3. Build query: `parafuso tornillo screw pedicular pedicle polyaxial poliaxial 6.5x50 6,5x50 6.5mm 50mm titanium titânio`\n4. Validate: Type=pedicular ✓, Diameter=6.5 ✓, Length=50 ✓\n5. Best match: \"TRANSCONTINENTAL PARAFUSO PEDICULAR POLIAXIAL Ø6,5X50 TITANIO\" with score 0.94\n\n**Output:**\n```json\n[{\"lote_pedido\":2,\"posicao_pedido\":1,\"artigo_pedido\":\"PAR001\",\"descricao_pedido\":\"Parafuso pedicular poliaxial 6,5x50mm titânio\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":8,\"preco_artigo\":180.00,\"preco_posicao\":1440.00,\"preco_lote\":1440.00,\"matched_code\":null,\"artigo\":\"TC65050PP\",\"descricao\":\"TRANSCONTINENTAL PARAFUSO PEDICULAR POLIAXIAL Ø6,5X50 TITANIO\",\"unidade_venda\":\"1\",\"quantidade\":20,\"preco\":175.00,\"similarity_score\":0.94,\"match_type\":\"Semântico\",\"match_rank\":1}]\n```\n\n---\n\n## Example 3: CATHETER - Exact match via codigo_spms\n\n**Input:**\n```json\n{\n  \"lote_pedido\": 3,\n  \"posicao_pedido\": 1,\n  \"artigo_pedido\": \"CAT001\",\n  \"descricao_pedido\": \"ANGIODYNAMICS SOFT-VU COBRA (2) 5F 90CM 0.038\",\n  \"especificacoes_tecnicas\": null,\n  \"quantidade_pedido\": 10,\n  \"preco_artigo\": 45.00,\n  \"preco_posicao\": 450.00,\n  \"preco_lote\": 450.00,\n  \"codigo_spms\": \"A1234\"\n}\n```\n\n**Process:**\n1. codigo_spms has value \"A1234\" → Call `query_artigos_table` with `WHERE codigo_spms = 'A1234'`\n2. Match found → Use data\n\n**Output:**\n```json\n[{\"lote_pedido\":3,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT001\",\"descricao_pedido\":\"ANGIODYNAMICS SOFT-VU COBRA (2) 5F 90CM 0.038\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":10,\"preco_artigo\":45.00,\"preco_posicao\":450.00,\"preco_lote\":450.00,\"matched_code\":\"A1234\",\"artigo\":\"100118681\",\"descricao\":\"ANGIODYNAMICS SOFT-VU COBRA (2) 5F 90CM 0.038 `` MALLADO\",\"unidade_venda\":\"1\",\"quantidade\":5,\"preco\":42.50,\"similarity_score\":1.0,\"match_type\":\"Exato\",\"match_rank\":1}]\n```\n\n---\n\n## Example 4: CATHETER - Semantic match\n\n**Input:**\n```json\n{\n  \"lote_pedido\": 4,\n  \"posicao_pedido\": 1,\n  \"artigo_pedido\": \"CAT002\",\n  \"descricao_pedido\": \"Cateter diagnóstico Cobra 2, 5F, 90cm, guia 0.038\",\n  \"especificacoes_tecnicas\": \"Revestimento hidrofílico preferencial\",\n  \"quantidade_pedido\": 20,\n  \"preco_artigo\": 40.00,\n  \"preco_posicao\": 800.00,\n  \"preco_lote\": 800.00,\n  \"codigo_spms\": null\n}\n```\n\n**Process:**\n1. Detect category: CATHETER (keywords: cateter, cobra)\n2. Normalize: \"cateter diagnóstico cobra 2 5F 90cm guia 0.038\"\n3. Extract: Shape=COBRA, Variant=2, Gauge=5F, Length=90CM, Wire=0.038\n4. Build query: `ANGIODYNAMICS SOFT-VU COBRA 2 5F 90CM 0.038 0,038 cateter catheter catéter cobra diagnostic diagnóstico hidrofílico hydrophilic`\n5. Validate results:\n   - Check French gauge = 5F ✓\n   - Check guidewire = 0.038 ✓\n   - Check shape = COBRA ✓\n6. Best match: \"ANGIODYNAMICS SOFT-VU COBRA (2) 5F 90CM 0.038 `` MALLADO\" with score 0.89\n\n**Output:**\n```json\n[{\"lote_pedido\":4,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT002\",\"descricao_pedido\":\"Cateter diagnóstico Cobra 2, 5F, 90cm, guia 0.038\",\"especificacoes_tecnicas\":\"Revestimento hidrofílico preferencial\",\"quantidade_pedido\":20,\"preco_artigo\":40.00,\"preco_posicao\":800.00,\"preco_lote\":800.00,\"matched_code\":null,\"artigo\":\"100118681\",\"descricao\":\"ANGIODYNAMICS SOFT-VU COBRA (2) 5F 90CM 0.038 `` MALLADO\",\"unidade_venda\":\"1\",\"quantidade\":5,\"preco\":42.50,\"similarity_score\":0.89,\"match_type\":\"Semântico\",\"match_rank\":1}]\n```\n\n---\n\n## Example 5: VASCULAR_GRAFT - Semantic match\n\n**Input:**\n```json\n{\n  \"lote_pedido\": 5,\n  \"posicao_pedido\": 1,\n  \"artigo_pedido\": \"GRF001\",\n  \"descricao_pedido\": \"Prótese vascular PTFE suportada 8mm x 70cm\",\n  \"especificacoes_tecnicas\": null,\n  \"quantidade_pedido\": 5,\n  \"preco_artigo\": 350.00,\n  \"preco_posicao\": 1750.00,\n  \"preco_lote\": 1750.00,\n  \"codigo_spms\": null\n}\n```\n\n**Process:**\n1. Detect category: VASCULAR_GRAFT (keywords: prótese vascular, PTFE, suportada)\n2. Normalize: \"prótese vascular PTFE suportada 8mm 70cm\"\n3. Extract: Type=PTFE, Support=suportada, Diameter=8mm, Length=70cm\n4. Build query: `VASCUTEK FLUOROPASSIV PTFE ePTFE suportada soportada supported ringed 8mm 70cm 8x70 prótese vascular graft`\n5. Validate: Diameter=8, Length=70, Supported ✓\n6. Best match: \"VASCUTEK FLUOROPASSIV SOPORTADA 8X70\" with score 0.92\n\n**Output:**\n```json\n[{\"lote_pedido\":5,\"posicao_pedido\":1,\"artigo_pedido\":\"GRF001\",\"descricao_pedido\":\"Prótese vascular PTFE suportada 8mm x 70cm\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":5,\"preco_artigo\":350.00,\"preco_posicao\":1750.00,\"preco_lote\":1750.00,\"matched_code\":null,\"artigo\":\"103005826\",\"descricao\":\"VASCUTEK FLUOROPASSIV SOPORTADA 8X70\",\"unidade_venda\":\"1\",\"quantidade\":3,\"preco\":320.00,\"similarity_score\":0.92,\"match_type\":\"Semântico\",\"match_rank\":1}]\n```\n\n---\n\n## Example 6: INFUSION_SYSTEM - Semantic match\n\n**Input:**\n```json\n{\n  \"lote_pedido\": 6,\n  \"posicao_pedido\": 1,\n  \"artigo_pedido\": \"INF001\",\n  \"descricao_pedido\": \"Infusor elastomérico 275ml contínuo 2ml/h\",\n  \"especificacoes_tecnicas\": \"Duração aproximada 5 dias\",\n  \"quantidade_pedido\": 50,\n  \"preco_artigo\": 28.00,\n  \"preco_posicao\": 1400.00,\n  \"preco_lote\": 1400.00,\n  \"codigo_spms\": null\n}\n```\n\n**Process:**\n1. Detect category: INFUSION_SYSTEM (keywords: infusor, elastomérico)\n2. Extract: Volume=275ml, Mode=contínuo, Flow=2ml/h\n3. Build query: `ACE MEDICAL AUTOFUSER contínuo continuous 275ml 2.0ml/h 2,0ml/h 5 dias infusor elastomérico`\n4. Validate: Volume=275 ✓, Mode=CONTINUO ✓, Flow≈2.0 ✓\n5. Best match: \"ACE MEDICAL AUTOFUSER CONTINUO 275/2,0 (5 DIAS)\" with score 0.94\n\n**Output:**\n```json\n[{\"lote_pedido\":6,\"posicao_pedido\":1,\"artigo_pedido\":\"INF001\",\"descricao_pedido\":\"Infusor elastomérico 275ml contínuo 2ml/h\",\"especificacoes_tecnicas\":\"Duração aproximada 5 dias\",\"quantidade_pedido\":50,\"preco_artigo\":28.00,\"preco_posicao\":1400.00,\"preco_lote\":1400.00,\"matched_code\":null,\"artigo\":\"ACE275C2\",\"descricao\":\"ACE MEDICAL AUTOFUSER CONTINUO 275/2,0 (5 DIAS)\",\"unidade_venda\":\"1\",\"quantidade\":100,\"preco\":25.50,\"similarity_score\":0.94,\"match_type\":\"Semântico\",\"match_rank\":1}]\n```\n\n---\n\n## Example 7: NEEDLE - Semantic match with safety feature\n\n**Input:**\n```json\n{\n  \"lote_pedido\": 7,\n  \"posicao_pedido\": 1,\n  \"artigo_pedido\": \"AGU001\",\n  \"descricao_pedido\": \"AGULHA EPICRANIANA COM SISTEMA SEGURANÇA 21GX20MM\",\n  \"especificacoes_tecnicas\": \"O sistema anti picada deverá fechar de forma fácil e segura\",\n  \"quantidade_pedido\": 100,\n  \"preco_artigo\": 0.132,\n  \"preco_posicao\": 13.20,\n  \"preco_lote\": 13.20,\n  \"codigo_spms\": null\n}\n```\n\n**Process:**\n1. Detect category: NEEDLE (keywords: agulha, epicraniana)\n2. Normalize: \"agulha epicraniana com sistema segurança 21G 20mm\"\n3. Extract: Type=agulha, Subtype=epicraniana, Safety=segurança, Gauge=21G, Length=20mm\n4. Add from specs: anti-picada, safety\n5. Build query: `agulha needle aguja epicraniana scalp butterfly segurança safety anti-picada 21G 20mm com sistema`\n6. Validate: Gauge=21G ✓, Type=epicraniana ✓\n7. Select best match with safety feature\n\n**Output:**\n```json\n[{\"lote_pedido\":7,\"posicao_pedido\":1,\"artigo_pedido\":\"AGU001\",\"descricao_pedido\":\"AGULHA EPICRANIANA COM SISTEMA SEGURANÇA 21GX20MM\",\"especificacoes_tecnicas\":\"O sistema anti picada deverá fechar de forma fácil e segura\",\"quantidade_pedido\":100,\"preco_artigo\":0.132,\"preco_posicao\":13.20,\"preco_lote\":13.20,\"matched_code\":null,\"artigo\":\"12021107\",\"descricao\":\"Agulha epicraniana 21G safety\",\"unidade_venda\":\"100\",\"quantidade\":50,\"preco\":12.50,\"similarity_score\":0.91,\"match_type\":\"Semântico\",\"match_rank\":1}]\n```\n\n---\n\n## Example 8: No match found (wrong gauge available)\n\n**Input:**\n```json\n{\n  \"lote_pedido\": 8,\n  \"posicao_pedido\": 1,\n  \"artigo_pedido\": \"CAT003\",\n  \"descricao_pedido\": \"ANGIODYNAMICS SOFT-VU COBRA (2) 7F 90CM 0.038\",\n  \"especificacoes_tecnicas\": null,\n  \"quantidade_pedido\": 5,\n  \"preco_artigo\": 50.00,\n  \"preco_posicao\": 250.00,\n  \"preco_lote\": 250.00,\n  \"codigo_spms\": null\n}\n```\n\n**Process:**\n1. Detect category: CATHETER\n2. Extract: Gauge=7F (not common for this shape), Shape=COBRA 2, Length=90CM, Wire=0.038\n3. Search returns COBRA catheters but only 4F, 5F, 6F available in this product line\n4. Validation: 7F ≠ 4F, 5F, 6F → All candidates REJECTED\n\n**Output:**\n```json\n[{\"lote_pedido\":8,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT003\",\"descricao_pedido\":\"ANGIODYNAMICS SOFT-VU COBRA (2) 7F 90CM 0.038\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":5,\"preco_artigo\":50.00,\"preco_posicao\":250.00,\"preco_lote\":250.00,\"matched_code\":null,\"artigo\":null,\"descricao\":null,\"unidade_venda\":null,\"quantidade\":null,\"preco\":null,\"similarity_score\":0,\"match_type\":\"Sem Match\",\"match_rank\":null}]\n```\n\n---\n\n## Example 9: SPINE_IMPLANT - Semantic match\n\n**Input:**\n```json\n{\n  \"lote_pedido\": 9,\n  \"posicao_pedido\": 1,\n  \"artigo_pedido\": \"SPI001\",\n  \"descricao_pedido\": \"Cage ALIF 3D printed 10x34x24mm lordose 15°\",\n  \"especificacoes_tecnicas\": \"Com parafusos integrados\",\n  \"quantidade_pedido\": 2,\n  \"preco_artigo\": 1200.00,\n  \"preco_posicao\": 2400.00,\n  \"preco_lote\": 2400.00,\n  \"codigo_spms\": null\n}\n```\n\n**Process:**\n1. Detect category: SPINE_IMPLANT (keywords: cage, ALIF, 3D printed)\n2. Extract: Approach=ALIF, Tech=3DP, Dims=10x34x24mm, Lordosis=15°\n3. From specs: parafusos integrados → Interfixated\n4. Build query: `3DP 3D-printed ALIF interfixated integrated 10x34x24mm 15° cage spacer lombar anterior PEEK titanium`\n5. Validate dimensions and lordosis\n6. Best match: \"3DP Interfixated ALIF, 10x34x24mm 15°\" with score 0.96\n\n**Output:**\n```json\n[{\"lote_pedido\":9,\"posicao_pedido\":1,\"artigo_pedido\":\"SPI001\",\"descricao_pedido\":\"Cage ALIF 3D printed 10x34x24mm lordose 15°\",\"especificacoes_tecnicas\":\"Com parafusos integrados\",\"quantidade_pedido\":2,\"preco_artigo\":1200.00,\"preco_posicao\":2400.00,\"preco_lote\":2400.00,\"matched_code\":null,\"artigo\":\"3DPALIF1034241510\",\"descricao\":\"3DP Interfixated ALIF, 10x34x24mm 15°\",\"unidade_venda\":\"1\",\"quantidade\":4,\"preco\":1150.00,\"similarity_score\":0.96,\"match_type\":\"Semântico\",\"match_rank\":1}]\n```\n\n---\n\n## ❌ WRONG Examples - DO NOT DO THIS:\n\n### Wrong: Text after JSON\n```\n[{\"lote_pedido\":1,...}]\n\nThe search found a matching product.\n```\n\n### Wrong: Markdown formatting\n```json\n[{\"lote_pedido\":1,...}]\n```\n\n### Wrong: Empty string instead of null\n```json\n[{\"lote_pedido\":1,...,\"especificacoes_tecnicas\":\"\",...\"match_type\":\"Exato\"}]\n```\n\n### Wrong: matched_code with value for Semântico match\n```json\n[{\"lote_pedido\":1,...,\"matched_code\":\"A1234\",...,\"match_type\":\"Semântico\",\"match_rank\":1}]\n```\n\n### Wrong: Explanatory text before JSON\n```\nBased on the search, I found the following match:\n[{\"lote_pedido\":1,...}]\n```\n\n---\n\n# PRE-OUTPUT CHECKLIST\n\nBefore responding, verify:\n\n1. ☐ Output is NOT empty\n2. ☐ First character is `[`\n3. ☐ Last character is `]`\n4. ☐ NOTHING before `[`\n5. ☐ NOTHING after `]`\n6. ☐ NO markdown (no ```)\n7. ☐ `especificacoes_tecnicas` preserves null (not \"\")\n8. ☐ `unidade_venda` is string type (e.g., \"100\" not 100)\n9. ☐ All 17 fields present\n10. ☐ `match_type` is exactly: \"Exato\", \"Semântico\", or \"Sem Match\"\n11. ☐ `matched_code` is null for \"Semântico\" matches\n12. ☐ JSON is valid\n13. ☐ Category-specific validation was applied\n14. ☐ Critical specs (gauge, volume, dimensions) were validated\n15. ☐ Decimal format normalized (comma → dot) before comparison\n\n---\n\n# WORKFLOW SUMMARY\n\n```\n1. READ input item\n\n2. CHECK codigo_spms\n   ├─ Has value → query_artigos_table\n   │             ├─ Found → match_type=\"Exato\", go to OUTPUT\n   │             └─ Not found → continue to vector search\n   └─ Null/empty → continue to vector search\n\n3. DETECT product category (Step 0)\n   - NEW categories: CORONARY_STENT, ENDOGRAFT, SCREW, ROD, PLATE, ANEURYSM_CLIP, GUIDEWIRE\n\n4. NORMALIZE input text (Step A)\n   ├─ Apply universal normalization\n   ├─ Apply decimal format normalization (comma → dot)\n   ├─ Apply language bridging (PT↔ES↔EN)\n   └─ Apply category-specific normalization\n\n5. EXTRACT query components (Step B)\n   └─ Use category-specific extraction rules\n\n6. EXPAND with synonyms (Step C)\n   └─ Use category-specific synonym tables\n\n7. BUILD search query (Step D)\n   ├─ Include BOTH decimal formats (5.5 AND 5,5)\n   └─ Include especificacoes_tecnicas keywords (Step E)\n\n8. CALL query_artigos_vectors\n\n9. VALIDATE results\n   ├─ Apply category-specific rejection rules\n   ├─ Apply scoring adjustments\n   └─ Select best candidate ≥ 0.65 score\n\n10. OUTPUT JSON array\n    ├─ Match found → include all DB fields\n    └─ No match → null values, match_type=\"Sem Match\"\n```\n\n---\n\n# CRITICAL REMINDER\n\nYour response will be parsed by `JSON.parse()`.\n\n- Empty response = **WORKFLOW FAILURE**\n- Text after `]` = **WORKFLOW FAILURE**\n- Invalid JSON = **WORKFLOW FAILURE**\n\n**ALWAYS output exactly one valid JSON array. Nothing more. Nothing less.**"
        }
      },
      "id": "44f6b72c-717c-4289-bd14-739b75c9c6f7",
      "name": "Matching semântico2",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        2368,
        624
      ],
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst allResults = [];\n\nitems.forEach((item, itemIndex) => {\n  if (!item.json.output) {\n    console.log(\"WARNING: No output field found!\");\n    return;\n  }\n  \n  try {\n    // Strip markdown code blocks if present\n    let outputString = item.json.output;\n    outputString = outputString\n      .replace(/^```(?:json)?\\s*\\n?/, '')  // Remove opening ```json or ```\n      .replace(/\\n?```\\s*$/, '')            // Remove closing ```\n      .trim();\n    \n    const parsedData = JSON.parse(outputString);\n    \n    parsedData.forEach((record, recordIndex) => {\n      let data;\n      \n      if (record.item) {\n        data = record.item;\n      } else if (record.matches && record.matches.length === 0) {\n        return;\n      } else {\n        data = record;\n      }\n      \n      allResults.push({\n        json: {\n          lote_pedido: data.lote_pedido,\n          posicao_pedido: data.posicao_pedido,\n          artigo_pedido: data.artigo_pedido,\n          descricao_pedido: data.descricao_pedido,\n          especificacoes_tecnicas: data.especificacoes_tecnicas,\n          quantidade_pedido: data.quantidade_pedido,\n          preco_artigo: data.preco_artigo,\n          preco_posicao: data.preco_posicao,\n          preco_lote: data.preco_lote,\n          codigo_spms: data.matched_code,\n          artigo: data.artigo,\n          descricao: data.descricao,\n          unidade_venda: data.unidade_venda,\n          quantidade_disponivel: data.quantidade,\n          preco: data.preco,\n          similarity_score: data.similarity_score,\n          match_type: data.match_type\n        },\n        pairedItem: itemIndex\n      });\n    });\n  } catch (error) {\n    console.error(\"Error processing item:\", error.message);\n    console.error(\"Raw output:\", item.json.output?.substring(0, 200)); // Debug: show first 200 chars\n  }\n});\n\nreturn allResults;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3152,
        640
      ],
      "id": "88127904-911a-45ed-b79c-923d2b1c1932",
      "name": "Formatação Match Produtos1",
      "disabled": true
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=[{\n\"lote_pedido\": {{ $json.lote_pedido }},\n\"posicao_pedido\": {{ $json.posicao_pedido }},\n\"artigo_pedido\": \"{{ $json.artigo_pedido }}\",\n\"descricao_pedido\": \"{{ $json.descricao_pedido }}\",\n\"especificacoes_tecnicas\":\"{{ $json.especificacoes_tecnicas }}\",\n\"quantidade_pedido\": {{ $json.quantidade_pedido }},\n\"preco_artigo\": {{ $json.preco_artigo }},\n\"preco_posicao\": {{ $json.preco_posicao }},\n\"preco_lote\": {{ $json.preco_lote }},\n\"codigo_spms\": {{ $json.codigo_spms }}\n}]",
        "options": {
          "systemMessage": "# Role\nPharmaceutical & Medical Device Product Matching Agent. Match RFP items to inventory database products.\n\n# Task\n1. Use tools to search the database\n2. Output JSON array with match result\n\n---\n\n# TOOL USAGE\n\n## Tool Selection\n- **codigo_spms has value**: Call `query_artigos_table` first → if no match, call `query_artigos_vectors`\n- **codigo_spms is null/empty**: Call `query_artigos_vectors` directly\n\n## query_artigos_table\n```sql\nSELECT artigo, descricao, descricao_comercial, unidade_venda, quantidade, preco, codigo_spms\nFROM artigos WHERE codigo_spms = 'VALUE' LIMIT 1;\n```\n\n## query_artigos_vectors\nSemantic similarity search. Follow processing steps below.\n\n---\n\n# PROCESSING STEPS\n\n## Step 0: Detect Category\nScan `descricao_pedido` for category indicators (priority order):\n\n```yaml\nCORONARY_STENT: IVASCULAR|INTREGAL|ARMADA|stent coronário|DES|BMS|PTCA|drug-eluting\nENDOGRAFT: GORE|EXCLUDER|VIABAHN|endoprótese|TEVAR|EVAR|stent-graft|fenestrada\nCATHETER: ANGIODYNAMICS|SOFT-VU|MARINER|cateter|pigtail|cobra|sidewinder|angiografia\nVASCULAR_GRAFT: VASCUTEK|GELWEAVE|GELSOFT|FLUOROPASSIV|prótese vascular|dacron|bifurcad\nSCREW: parafuso|tornillo|pedicular|pedicle|cortical|canulado|polyaxial|monoaxial\nROD: haste|barra|rod|titanium rod|PEEK rod|conector\nPLATE: placa|plate|cervical plate|anterior plate\nANEURYSM_CLIP: clip aneurisma|YASARGIL|SUGITA|neurocirurgia\nSPINE_IMPLANT: ALIF|TLIF|PLIF|XLIF|spacer|cage|vertebral|intersomático\nGUIDEWIRE: guia|guidewire|fio-guia|TERUMO|RADIFOCUS|0.014|0.035|0.038\nINFUSION_SYSTEM: ACE MEDICAL|AUTOFUSER|AUTOSELECTOR|AUTOFILLER|infusor|elastomérico|PCA\nVASCULAR_ACCESS: SMARTPORT|BIOFLO|port|PICC|CVC|reservatório implantável\nABLATION: NANOKNIFE|SOLERO|VENACURE|ablação|radiofrequência|microondas\nOPHTHALMIC: AJL|Ahmed|glaucoma|válvula ocular|oftálm|vitreo\nSURGICAL_INSTRUMENT: SCANLAN|forceps|clamp|porta-aguja|pinça|tesoura\nAIRWAY: AIRTRAQ|laringoscópio|intubação|via aérea\nELECTRODE: AXELGAARD|PALS|ULTRASTIM|elétrodo|TENS|neuroestimulação\nSYRINGE: seringa|syringe|jeringa|luer lock|2 peças|3 peças\nNEEDLE: agulha|needle|aguja|hipodérmica|epicraniana|scalp|lanceta\nCOMPRESSION: ACTICO|meia compressão|TPS|UlcerSys\nGENERAL: (default)\n```\n\n## Step A: Normalize Input\n\n### A.1 Universal Normalization\n```yaml\nREPLACE: \\\\ / ( ) \" ' ` → space | multiple_spaces → single | C/ C\\ → \"com sistema\" | S/ → \"sem\" | P/ → \"para\"\nSYMBOLS: IRRECUP. → irrecuperável | EST. → estéril | Ø → diameter | ° → angle | ® ™ → remove\nDECIMAL: X,Y → X.Y (search BOTH: 5.5 AND 5,5 | 0.035 AND 0,035)\n```\n\n### A.2 Language Bridging (always include all variants)\n```yaml\nPT|ES|EN: cateter|catéter|catheter | agulha|aguja|needle | seringa|jeringa|syringe | parafuso|tornillo|screw\n         placa|placa|plate | haste|varilla|rod | prótese|prótesis|prosthesis | diâmetro|diámetro|diameter\n         mallado|trançado|braided | recto|reto|straight | ponta|punta|tip | curva|curva|curved\n```\n\n### A.3 Category Normalization\n\n**CORONARY_STENT:**\n- Dimensions: 2.5X18 → 2.5x18 | Type: DES=drug-eluting, BMS=bare-metal | Material: CoCr=cromo-cobalto\n- Diameters: 2.0, 2.25, 2.5, 2.75, 3.0, 3.5, 4.0, 4.5, 5.0 mm\n- Lengths: 8, 9, 12, 13, 14, 15, 16, 18, 19, 20, 22, 23, 24, 26, 28, 30, 32, 33, 36, 38, 40 mm\n\n**ENDOGRAFT:**\n- Dimensions: 32X150 → 32x150 | Types: fenestrada, branched, TEVAR (thoracic), EVAR (abdominal)\n- Diameters: 16, 20, 21, 22, 23, 24, 25, 26, 27, 28, 30, 31, 32, 34, 36, 38, 40, 42, 44, 46 mm\n\n**CATHETER:**\n- Gauge: 4F 4 F 4FR → 4F | Values: 2F, 3F, 4F, 5F, 6F, 7F, 8F, 9F, 10F, 11F, 12F, 14F, 16F, 18F, 20F, 22F, 24F, 26F\n- Length: 65CM 65 CM → 65CM | Common: 65, 80, 90, 100, 110, 120, 130, 145 (288 products), 150 (215 products) CM\n- Guidewire: 0.035\" .035 0,035 → 0.035 | Values: 0.014, 0.018, 0.025, 0.035, 0.038\n- **ALL SHAPES**: COBRA, SIDEWINDER, PIGTAIL, BERENSTEIN, OMNI FLUSH, HEADHUNTER, SHEPHERD HOOK, HOCKEY STICK, MULTIPURPOSE, JUDKINS, SOS OMNI, NEWTON, VERTEBRAL, BENTSON, RIM, MPA, MPB, JB, RECTO, RENAL, MIKAELSSON, KUMPE, MANI, RC1, RC2, MULTIPROP, COBRITA, LEVIN, OSBORNE, NAVIGATE, SHARP ANGLE, OMEGA, ARC, JL, JR\n- Shape variants: (1) (2) (3) → 1, 2, 3 | MALLADO = braided\n\n**CATHETER SHAPE STANDARDIZATION (CRITICAL):**\n```yaml\nCOBRA, COBRA1, COBRA 1, COBRA(1): → COBRA 1\nSIDEWINDER, SIDE WINDER, SIMMONS, SIM: → SIDEWINDER\nSOS OMNI, SOS-OMNI, SOSOMNI: → SOS OMNI\nPIGTAIL, PIG TAIL, PIG-TAIL: → PIGTAIL\nOMNI FLUSH, OMNIFLUSH, OMNI-FLUSH: → OMNI FLUSH\nHEADHUNTER, HEAD HUNTER, HH, H1: → HEADHUNTER\nBERENSTEIN, BERNSTEIN, BER: → BERENSTEIN\nSHEPHERD HOOK, SHEPHERDS HOOK, SHEPHERD'S HOOK, SH: → SHEPHERD HOOK\nHOCKEY STICK, HOCKEYSTICK, HS: → HOCKEY STICK\nMULTIPURPOSE, MULTIPROPÓSITO, MPA, MPB: → MULTIPURPOSE\nJUDKINS, JL, JR: → JUDKINS (preserve JL/JR as variants)\n```\n\n**SCREW:**\n- Dimensions: 5.5X45 Ø5,5X45 → 5.5x45 | Types: pedicular|cortical|canulado|polyaxial|monoaxial\n- Diameters: 3.5, 4.0, 4.35, 4.5, 5.0, 5.5, 6.0, 6.5, 7.0, 7.5, 8.0, 8.5, 9.0, 10.0, 11.0, 12.0 mm\n- Most common: 5.5mm (434 products), 6.5mm (423), 7.5mm (260)\n- Lengths: 20-130mm | Common: 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80 mm\n\n**ROD:**\n- Dimensions: 5.5X500 → 5.5x500 | Materials: titanium|CoCr|PEEK | Shapes: curved|straight\n- Diameters: 5.5mm, 6.0mm, 6.35mm\n\n**PLATE:**\n- Types: cervical|anterior|lateral|locking | Holes: 2-6 furos\n\n**ANEURYSM_CLIP:**\n- Shapes: angulado|reto|curvo|fenestrado | Sizes: mini|standard|maxi | Blade: 5, 7, 9, 11, 15mm\n\n**GUIDEWIRE:**\n- Diameters: 0.010\", 0.014\", 0.018\", 0.021\", 0.025\", 0.032\", 0.035\", 0.038\" (exact match required)\n- Lengths: 150, 180, 260, 300 cm\n- Coatings: hydrophilic|PTFE | Stiffness: floppy|standard|stiff | Tips: J-tip|straight\n\n**VASCULAR_GRAFT:**\n- Dimensions: 12X6 → 12x6, 14X7X7 → 14x7x7 (trifurcated)\n- Lines: GELWEAVE|GELSOFT|GELSOFT PLUS|FLUOROPASSIV|GELSEAL\n- **Sub-lines**: VALSALVA (sinus/root), COSELLI (thoracoabdominal), PLEXUS (multi-branch), ANTE-FLO (antegrade), EQUI-FLO (equal flow)\n- Types: SOPORTADA=supported=ringed | BIFURCADA | TRIFURCADA | TAPERED\n- Branch angles: @15, @10\n\n**INFUSION_SYSTEM:**\n- Products: AUTOFUSER | AUTOSELECTOR | AUTOFILLER\n- Format: 275/2,0 → 275ml 2.0ml/h | Modes: CONTINUO|CON BOLO|CONTINUO+BOLO\n- Volumes: 60, 100, 150, 275, 400, 550 ml\n- Flow rates: 0.25 - 250 ml/h\n- Features: MULTIPERFORADO (multi-hole wound catheter), PROTECCION UV\n- Lockout: BLOQUEO 15' = bloqueio 15min | Values: 10, 15, 30, 60 minutes\n- Bolus volumes: 0.5, 1, 2, 5 ml\n\n**SPINE_IMPLANT:**\n- Approaches: ALIF|TLIF|PLIF|XLIF | Tech: 3DP|Interfixated|Expandable\n- Angles: 0°, 4°, 6°, 8°, 10°, 12°, 15°, 20°, 25°, 30°\n- Materials: PEEK|Titanium\n\n**OPHTHALMIC:**\n- Models: FP7 (adult)|FP8 (pediatric) | Types: valve|viscoelastic|dye|ring|trephine\n\n**SYRINGE:**\n- Parts: 2/PECAS → 2 peças | 3/PECAS → 3 peças\n- Volumes: 1, 2, 5, 10, 20, 50, 100 ml | Tips: luer lock|luer slip|bico cateter\n\n**NEEDLE:**\n- Gauge: 21G 21 G 21GA → 21G | Values: 18G, 19G, 20G, 21G, 22G, 23G, 25G, 27G\n- Dimensions: 21GX20MM → 21G 20mm\n- Types: epicraniana=scalp=butterfly | hipodérmica | Safety: anti-picada|segurança\n\n**ELECTRODE:**\n- Sizes: 5x5, 5x9, 5x10, 5x13 cm | Types: PALS|ULTRASTIM|PLATINUM\n- Reusability: reutilizável|descartável\n\n**COMPRESSION:**\n- Sizes: S, M, L, XL, XLL | Types: knee|thigh | Lengths: normal|long\n\n---\n\n## Step B: Extract Query Components\n\n**Priority order by category:**\n\n```yaml\nCORONARY_STENT: Brand→Line→Type(DES/BMS)*→Diameter*→Length*→Material→Delivery(RX/OTW)\nENDOGRAFT: Brand→Line→Location(thoracic/abdominal)*→Diameter*→Length*→Type(fenestrated/branched)\nCATHETER: Brand→Line→Shape*→Variant→Gauge*→Length*→Guidewire*→Construction(mallado)\nSCREW: Brand→Type(pedicular/cortical)*→Diameter*→Length*→Material\nROD: Brand→Diameter*→Length*→Material→Shape\nPLATE: Brand→Location*→Type→Holes*\nANEURYSM_CLIP: Brand→Shape*→Size→Blade_length*→Angle\nGUIDEWIRE: Brand→Diameter*→Length*→Coating→Stiffness→Tip\nVASCULAR_GRAFT: Brand→Line*→Sub-line→Diameter*→Length*→Configuration*→Support(soportada)\nINFUSION_SYSTEM: Brand→Product*→Mode*→Volume*→Flow*→Bolus→Lockout→Features\nSPINE_IMPLANT: Approach*→Type*→Tech→Height*→Footprint*→Lordosis*→Material\nOPHTHALMIC: Brand→Type*→Model*→Size→Concentration\nSYRINGE: Type→Parts→Volume*→Connection→Safety\nNEEDLE: Type→Subtype→Gauge*→Length*→Safety\nELECTRODE: Brand→Line→Variant→Size*→Reusability\n```\n(* = critical for validation)\n\n---\n\n## Step C: Expand Synonyms\n\n```yaml\n# Universal\ndescartável: disposable, single-use | reutilizável: reusable | estéril: sterile | titânio: titanium\n\n# CATHETER (EXTENDED)\nSOFT-VU: soft vu, softvu | MARINER: mariner hydrophilic, mariner hidrofilico | ACCU-VU: accu vu, accuvu\nCOBRA: cobra catheter, cobra cateter | SIDEWINDER: side winder, simmons, SIM\nPIGTAIL: pig tail, pig-tail, coleta | SOS OMNI: sos, omni selective, sos-omni\nOMNI FLUSH: omniflush, flush catheter | HEADHUNTER: head hunter, HH, H1\nBERENSTEIN: bernstein, BER | SHEPHERD HOOK: shepherds hook, SH\nHOCKEY STICK: hockeystick, HS | MALLADO: braided, malha, trançado, trenzado\nPULSE-SPRAY: pulse spray, pulsespray | UNIFUSE: uni fuse, uni-fuse\nJUDKINS: JL, JR, judkins left, judkins right\nMULTIPURPOSE: multipropósito, MPA, MPB\n\n# SCREW\nparafuso pedicular: pedicle screw, tornillo pedicular | poliaxial: polyaxial, multi-axial\ncanulado: cannulated, hollow | autoroscante: self-tapping | redução: reduction, reducing\ncortical: cortical bone screw\n\n# ROD\nhaste: rod, barra, varilla | conector: connector, rod-to-rod\npré-curvada: pre-bent, precurvada | lordose: lordosis, lordotic\n\n# PLATE\nplaca cervical: cervical plate, anterior cervical | bloqueada: locking, locked | furos: holes, orificios\n\n# ANEURYSM_CLIP\nclip aneurisma: aneurysm clip, clip cerebral | fenestrado: fenestrated, com fenestra\nangulado: angled, inclinado\n\n# GUIDEWIRE\nfio-guia: guidewire, guide wire, guia | hidrofílico: hydrophilic, hidrofilico\nRADIFOCUS: radifocus, terumo | ponta J: J-tip, J tip, J curve | rígido: stiff, extra-stiff\n\n# VASCULAR_GRAFT (EXTENDED)\nGELWEAVE: gel weave, woven, tecido | GELSOFT: gel soft, knitted, malha | GELSOFT PLUS: gelsoftplus, gelsoft+\nFLUOROPASSIV: fluoro passiv, PTFE, ePTFE, politetrafluoretileno | GELSEAL: gel seal, sealed\nSOPORTADA: supported, ringed, anelada, com anéis, con anillos | BIFURCADA: bifurcated, aorto-bifemoral, Y-graft\nTRIFURCADA: trifurcated, três ramos | TAPERED: cónico, conico\nVALSALVA: sinus, root | COSELLI: thoracoabdominal, toracoabdominal\nPLEXUS: multi-branch, múltiplas ramas | ANTE-FLO: antegrade flow, fluxo anterógrado\n\n# INFUSION (EXTENDED)\nAUTOFUSER: infusor elastomérico, elastomeric pump, bomba elastomérica\nAUTOSELECTOR: PCA, patient controlled, controlado pelo paciente\nAUTOFILLER: filler, preenchimento\nCONTINUO: continuous, contínuo, infusão contínua | CON BOLO: with bolus, com bolo, PCA bolus\nPROTECCION UV: UV protection, proteção UV, light protected\nMULTIPERFORADO: multi-hole, wound catheter, cateter ferida\nBLOQUEO: lockout, bloqueio, intervalo\n\n# SPINE\nALIF: anterior lumbar interbody fusion, fusão lombar anterior | TLIF: transforaminal lumbar interbody fusion\nPLIF: posterior lumbar interbody fusion | XLIF: extreme lateral interbody fusion\n3DP: 3D printed, impressão 3D, additive manufactured\nINTERFIXATED: integrated screws, parafusos integrados | EXPANDABLE: expansível, expansible, in-situ expansion\nSPACER: espaçador, cage, dispositivo intersomático | PEEK: poliéter éter cetona, polymer cage\n\n# SYRINGE\nirrecuperável: descartável, safety, single-use, não reutilizável\n2 peças: 2-part, duas peças, bipartida | 3 peças: 3-part, três peças, tripartida\nluer lock: luer-lock, LL, rosca | luer slip: luer-slip, LS, encaixe\nbico cateter: catheter tip, ponta cateter | insulina: insulin, U-100, U-40\ntuberculina: tuberculin, TB | ponta excêntrica: eccentric tip, off-center\n\n# NEEDLE\nepicraniana: scalp, butterfly, borboleta, scalp vein | hipodérmica: hypodermic, subcutânea\nanti-picada: needlestick prevention, segurança, safety | irrecuperável: safety, retractable, retrátil\nromba: blunt, obtusa, ponta romba, embotada | lanceta: lancet, punção capilar\n\n# OPHTHALMIC\nAHMED: ahmed valve, válvula ahmed, glaucoma valve | FP7: adult, adulto | FP8: pediatric, pediátrico\nCLEARPATH: clear path | BBG: brilliant blue G, azul brilhante | BLUE: trypan blue, azul tripano\n\n# ELECTRODE\nPALS: electrode, elétrodo | ULTRASTIM: estimulação, stimulation\nPLATINUM: platina | reutilizável: reusable, lavável | FOAM: espuma | TENS: transcutaneous, transcutâneo\n```\n\n---\n\n## Step D: Build Query\n\n```\n[Brand] [Product Line] [Type/Shape] [Critical Specs] [Synonyms] [Language Variants]\n```\n\nInclude BOTH decimal formats: `5.5mm 5,5mm` | `0.035 0,035`\n\n---\n\n## Step E: Add especificacoes_tecnicas Keywords\n\n```yaml\nbaixo volume morto: low dead space | polipropileno: PP, polypropylene | aço inoxidável: stainless steel\nsem látex: latex-free | hidrofílico: hydrophilic | radiopaco: radiopaque | alta pressão: high pressure\ndrug-eluting: DES, fármaco-elutivo | bioabsorvível: bioabsorbable, bioreabsorvível\n```\n\n---\n\n## Step F: Progressive Query Cascade\n\n```\nLevel 1 (≥0.75): Brand + Line + Shape + ALL specs + synonyms\nLevel 2 (≥0.70): Category + Type + Critical specs (gauge/volume/dims)\nLevel 3 (≥0.65): Product type + Primary dimension\nLevel 4 (≥0.60): Category keywords (trilingual)\n\nSTOP when 3 valid matches found. Return TOP 3 sorted by score. Minimum: 0.60\n```\n\n**Category-Specific Templates:**\n```yaml\nCATHETER: L1: {brand} {line} {shape} {variant} cateter {gauge} {length} {guidewire}\nINFUSION: L1: {brand} {product} infusor {mode} {volume}ml {flow}ml/h {features}\nVASCULAR_GRAFT: L1: {brand} {line} {subline} prótese {type} {diameter}mm {length}cm {support}\nDEFAULT: L1: {brand} {line} {type} {specs} {synonyms}\n```\n\n---\n\n# VALIDATION RULES\n\n## Critical Field Matching (REJECT if mismatch)\n\n```yaml\nCORONARY_STENT: diameter(±0.25mm), length(±2mm), type(DES≠BMS), line\nENDOGRAFT: location(thoracic≠abdominal), diameter(±2mm), type(standard≠fenestrated≠branched)\nCATHETER: gauge(exact), guidewire(exact), shape(exact), line(SOFT-VU≠PULSE-SPRAY≠UNIFUSE)\nSCREW: type(pedicular≠cortical), diameter(±0.5mm)\nROD: diameter(5.5≠6.0≠6.35)\nPLATE: location(cervical≠lumbar), hole_count(exact)\nANEURYSM_CLIP: shape(straight≠angled≠curved), brand(YASARGIL≠SUGITA)\nGUIDEWIRE: diameter(exact: 0.014≠0.018≠0.035≠0.038)\nVASCULAR_GRAFT: line(GELWEAVE≠GELSOFT≠FLUOROPASSIV), config(straight≠bifurcated), diameter(±2mm)\nINFUSION_SYSTEM: volume(exact), mode(CONTINUO≠CON BOLO), product(AUTOFUSER≠AUTOSELECTOR≠AUTOFILLER)\nSPINE_IMPLANT: approach(ALIF≠TLIF≠PLIF≠XLIF), type(spacer≠screw≠plate)\nOPHTHALMIC: product_type(valve≠viscoelastic≠ring), model(FP7≠FP8)\nSYRINGE: volume(exact), product_type(syringe≠needle)\nNEEDLE: gauge(exact), product_type(needle≠syringe≠lancet)\nELECTRODE: size(exact)\n```\n\n## Scoring Modifiers\n\n```yaml\nBONUS:\n+0.15: exact dimensions match\n+0.10: brand match exactly, exact critical spec match, sub-line match (VALSALVA, COSELLI)\n+0.05: material match, length within tolerance, shape variant match, construction match (MALLADO)\n+0.03: secondary feature match (UV protection, lockout time)\n\nPENALTY:\n-0.15: missing required safety feature, flow rate mismatch >1ml/h, missing support when required\n-0.10: length diff >20%, variant mismatch, wrong parts count, MARINER vs non-MARINER mismatch\n-0.05: shape variant mismatch (COBRA 1 vs COBRA 2)\n```\n\n## Selection Logic\n1. Apply rejection rules → eliminate score=0\n2. Apply scoring adjustments\n3. Accept candidates ≥0.65\n4. Select TOP 3 by score\n5. No valid candidates → `match_type: \"Sem Match\"`\n\n---\n\n# OUTPUT\n\n**Output ONLY a JSON array. No text before or after.**\n\n## Multi-Match Rules\n- **Semantic**: Up to 3 rows per input (one per match), `match_rank`: 1|2|3\n- **Exact**: 1 row, `match_rank`: 1\n- **No match**: 1 row, `match_rank`: null\n\n## Structure (18 fields)\n```json\n[{\n  \"lote_pedido\": <input>,\n  \"posicao_pedido\": <input>,\n  \"artigo_pedido\": <input>,\n  \"descricao_pedido\": <input>,\n  \"especificacoes_tecnicas\": <input, preserve null>,\n  \"quantidade_pedido\": <input>,\n  \"preco_artigo\": <input>,\n  \"preco_posicao\": <input>,\n  \"preco_lote\": <input>,\n  \"matched_code\": <DB codigo_spms for Exato | null for Semântico/Sem Match>,\n  \"artigo\": <DB artigo or null>,\n  \"descricao\": <DB descricao (table) or metadata.descricao_artigo (vector) or null>,\n  \"unidade_venda\": <DB as STRING or null>,\n  \"quantidade\": <DB or null>,\n  \"preco\": <DB or null>,\n  \"similarity_score\": <1.0 | 0.XX | 0>,\n  \"match_type\": <\"Exato\" | \"Semântico\" | \"Sem Match\">,\n  \"match_rank\": <1 | 2 | 3 | null>\n}]\n```\n\n## Match Type Rules\n| Scenario | matched_code | similarity_score | match_type | Rows |\n|----------|--------------|------------------|------------|------|\n| query_artigos_table found | DB codigo_spms | 1.0 | \"Exato\" | 1 |\n| query_artigos_vectors found | **null** | 0.XX | \"Semântico\" | 1-3 |\n| No match | null | 0 | \"Sem Match\" | 1 |\n\n## Vector Metadata Mapping\n```yaml\nartigo: metadata.artigo (→ string)\ndescricao: metadata.descricao_artigo  # NOT the text field!\nunidade_venda: metadata.unidade_venda (→ string)\nquantidade: metadata.quantidade\npreco: metadata.preco\n```\n\n---\n\n# EXAMPLES\n\n## Example 1: Exact Match (codigo_spms)\n\n**Input:**\n```json\n{\"lote_pedido\":1,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT001\",\"descricao_pedido\":\"ANGIODYNAMICS SOFT-VU COBRA (2) 5F 90CM 0.038\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":10,\"preco_artigo\":45.00,\"preco_posicao\":450.00,\"preco_lote\":450.00,\"codigo_spms\":\"A1234\"}\n```\n\n**Process:** codigo_spms=\"A1234\" → query_artigos_table → match found\n\n**Output:**\n```json\n[{\"lote_pedido\":1,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT001\",\"descricao_pedido\":\"ANGIODYNAMICS SOFT-VU COBRA (2) 5F 90CM 0.038\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":10,\"preco_artigo\":45.00,\"preco_posicao\":450.00,\"preco_lote\":450.00,\"matched_code\":\"A1234\",\"artigo\":\"100118681\",\"descricao\":\"ANGIODYNAMICS SOFT-VU COBRA (2) 5F 90CM 0.038 MALLADO\",\"unidade_venda\":\"1\",\"quantidade\":5,\"preco\":42.50,\"similarity_score\":1.0,\"match_type\":\"Exato\",\"match_rank\":1}]\n```\n\n## Example 2: Semantic Match (Single Result)\n\n**Input:**\n```json\n{\"lote_pedido\":2,\"posicao_pedido\":1,\"artigo_pedido\":\"PAR001\",\"descricao_pedido\":\"Parafuso pedicular poliaxial 6,5x50mm titânio\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":8,\"preco_artigo\":180.00,\"preco_posicao\":1440.00,\"preco_lote\":1440.00,\"codigo_spms\":null}\n```\n\n**Process:**\n1. Category: SCREW (parafuso, pedicular)\n2. Extract: Type=pedicular polyaxial, Dims=6.5x50mm, Material=titanium\n3. Query: `parafuso tornillo screw pedicular pedicle polyaxial poliaxial 6.5x50 6,5x50 6.5mm 50mm titanium titânio`\n4. Validate: Type=pedicular ✓, Diameter=6.5 ✓\n\n**Output:**\n```json\n[{\"lote_pedido\":2,\"posicao_pedido\":1,\"artigo_pedido\":\"PAR001\",\"descricao_pedido\":\"Parafuso pedicular poliaxial 6,5x50mm titânio\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":8,\"preco_artigo\":180.00,\"preco_posicao\":1440.00,\"preco_lote\":1440.00,\"matched_code\":null,\"artigo\":\"TC65050PP\",\"descricao\":\"TRANSCONTINENTAL PARAFUSO PEDICULAR POLIAXIAL Ø6,5X50 TITANIO\",\"unidade_venda\":\"1\",\"quantidade\":20,\"preco\":175.00,\"similarity_score\":0.94,\"match_type\":\"Semântico\",\"match_rank\":1}]\n```\n\n## Example 3: Semantic Match (Multi-Result with Progressive Cascade)\n\n**Input:**\n```json\n{\"lote_pedido\":3,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT100\",\"descricao_pedido\":\"Cateter diagnóstico COBRA 5F 100CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":20,\"preco_artigo\":38.00,\"preco_posicao\":760.00,\"preco_lote\":760.00,\"codigo_spms\":null}\n```\n\n**Process:**\n1. Category: CATHETER\n2. L1 Query: `cateter catheter COBRA diagnóstico 5F 100CM 0.035 0.038` → 1 match (0.82)\n3. L2 Query: `cateter catheter COBRA 5F 100CM` → 2 more matches (0.76, 0.71)\n4. Combine, dedupe, sort → TOP 3\n\n**Output (3 rows, same input, different matches):**\n```json\n[\n  {\"lote_pedido\":3,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT100\",\"descricao_pedido\":\"Cateter diagnóstico COBRA 5F 100CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":20,\"preco_artigo\":38.00,\"preco_posicao\":760.00,\"preco_lote\":760.00,\"matched_code\":null,\"artigo\":\"100118690\",\"descricao\":\"ANGIODYNAMICS SOFT-VU COBRA 5F 100CM\",\"unidade_venda\":\"1\",\"quantidade\":10,\"preco\":35.00,\"similarity_score\":0.82,\"match_type\":\"Semântico\",\"match_rank\":1},\n  {\"lote_pedido\":3,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT100\",\"descricao_pedido\":\"Cateter diagnóstico COBRA 5F 100CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":20,\"preco_artigo\":38.00,\"preco_posicao\":760.00,\"preco_lote\":760.00,\"matched_code\":null,\"artigo\":\"100118691\",\"descricao\":\"COOK COBRA 2 5F 100CM 0.038\",\"unidade_venda\":\"1\",\"quantidade\":8,\"preco\":32.50,\"similarity_score\":0.76,\"match_type\":\"Semântico\",\"match_rank\":2},\n  {\"lote_pedido\":3,\"posicao_pedido\":1,\"artigo_pedido\":\"CAT100\",\"descricao_pedido\":\"Cateter diagnóstico COBRA 5F 100CM\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":20,\"preco_artigo\":38.00,\"preco_posicao\":760.00,\"preco_lote\":760.00,\"matched_code\":null,\"artigo\":\"100118692\",\"descricao\":\"IMPRESS COBRA C2 5F 100CM\",\"unidade_venda\":\"1\",\"quantidade\":12,\"preco\":30.00,\"similarity_score\":0.71,\"match_type\":\"Semântico\",\"match_rank\":3}\n]\n```\n\n---\n\n# RULES\n\n## REQUIRED\n- Response starts with `[`, ends with `]`\n- All 18 fields present\n- `especificacoes_tecnicas` preserves null (not \"\")\n- `unidade_venda` is STRING type\n- `matched_code` is null for \"Semântico\"\n- `descricao` from `metadata.descricao_artigo` for semantic (NOT `text` field)\n\n## FORBIDDEN\n- Empty response\n- Text before/after JSON\n- Markdown code blocks\n- Using `text` field for descricao\n\n---\n\n# ERROR HANDLING\n\nIf ANY error occurs, output record with:\n- All input fields copied\n- Match fields: null\n- `similarity_score`: 0\n- `match_type`: \"Sem Match\"\n- `match_rank`: null\n\n---\n\n# WORKFLOW\n\n```\n1. CHECK codigo_spms → query_artigos_table if value → if found: Exato, done\n2. DETECT category\n3. NORMALIZE (universal + decimal + language + category + shape standardization)\n4. EXTRACT components (category-specific)\n5. EXPAND synonyms (use extended synonym lists)\n6. BUILD query (both decimal formats, category-specific template)\n7. CALL query_artigos_vectors (progressive cascade)\n8. VALIDATE (rejection rules + scoring)\n9. OUTPUT JSON array\n```\n\n**Your response will be parsed by `JSON.parse()`. Output exactly one valid JSON array.**"
        }
      },
      "id": "8b8d7425-cd4a-4f9f-a8cd-5b26d7aafba3",
      "name": "Matching semântico3",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        2720,
        640
      ],
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "inventory_upload_jobs",
          "mode": "list",
          "cachedResultName": "inventory_upload_jobs"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Webhook Update Inventory').first().json.body.jobId }}",
            "completed_at": "={{ $now }}",
            "status": "completed",
            "processed_rows": "={{ $json.processed_rows }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "file_name",
              "displayName": "file_name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "row_count",
              "displayName": "row_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "error_message",
              "displayName": "error_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "processed_rows",
              "displayName": "processed_rows",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "completed_at",
              "displayName": "completed_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1872,
        -464
      ],
      "id": "31ba4006-84fe-4835-9ca5-dcfa993ee670",
      "name": "Update jobs",
      "credentials": {
        "postgres": {
          "id": "qdwvjO0qEjit6Vuu",
          "name": "Cardiva Supabase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "let insertedCount = 0;\nlet deletedCount = 0;\nlet totalCsvRows = 0;\n\ntry {\n  insertedCount = $('Insert into DB').all().length;\n} catch (e) {\n  insertedCount = 0;\n}\n\ntry {\n  deletedCount = $('Delete from DB').all().length;\n} catch (e) {\n  deletedCount = 0;\n}\n\ntry {\n  totalCsvRows = $('Delete empty rows from CSV').all().length;\n} catch (e) {\n  totalCsvRows = 0;\n}\n\n// Get jobId from the Webhook node\n// Using .first() to avoid \"Can't determine which item to use\" error\nlet jobId = null;\ntry {\n  // Try Webhook node first\n  jobId = $('Webhook Update Inventory').first().json.body?.jobId;\n} catch (e) {\n  try {\n    // Fallback to Switch node\n    jobId = $('Switch').first().json.body?.jobId;\n  } catch (e2) {\n    jobId = null;\n  }\n}\n\nreturn [{\n  json: {\n    // Net change: inserted minus deleted\n    processed_rows: insertedCount - deletedCount,\n    inserted_rows: insertedCount,\n    deleted_rows: deletedCount,\n    total_csv_rows: totalCsvRows,\n    jobId: jobId,\n    status: 'completed'\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        -464
      ],
      "id": "2d5d5190-81a9-440a-ae91-b070dd50e6af",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1392,
        -464
      ],
      "id": "4f0b28cc-e189-4c38-97fe-2297d0c64be9",
      "name": "No Operation, do nothing",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "updateInventory",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        64,
        -512
      ],
      "id": "48251ecf-024c-40e9-8bbf-6b2a618b4132",
      "name": "Webhook Update Inventory",
      "webhookId": "a862c67e-1d8f-40c6-8070-bdca2d7fd256"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "uploadRFP",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        80,
        48
      ],
      "id": "705894ef-3269-4e98-b0d4-b1f70b8d3f96",
      "name": "Webhook Upload RFP",
      "webhookId": "a862c67e-1d8f-40c6-8070-bdca2d7fd256"
    }
  ],
  "pinData": {
    "Matching semântico3": [
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 1,\n    \"posicao_pedido\": 1,\n    \"artigo_pedido\": \"230001016\",\n    \"descricao_pedido\": \"AGULHA EPICRANIANA COM SISTEMA SEGURANÇA 21GX20MM\",\n    \"especificacoes_tecnicas\": \"O sistema anti picada deverá fechar de forma fácil e segura por forma a garantir a segurança do utilizador\",\n    \"quantidade_pedido\": 100,\n    \"preco_artigo\": 0.132,\n    \"preco_posicao\": 13.2,\n    \"preco_lote\": 13.2,\n    \"matched_code\": \"S1988\",\n    \"artigo\": \"12021107\",\n    \"descricao\": \"Epicat-Set Safety 21G LL Cx100\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 7,\n    \"preco\": 1.73902060234081,\n    \"similarity_score\": 1.0,\n    \"match_type\": \"Exato\",\n    \"match_rank\": 1\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[{\"lote_pedido\": 2, \"posicao_pedido\": 2, \"artigo_pedido\": \"230001017\", \"descricao_pedido\": \"AGULHA EPICRANIANA COM SISTEMA SEGURANÇA 22GX20MM\", \"especificacoes_tecnicas\": \"\", \"quantidade_pedido\": 100, \"preco_artigo\": 0.132, \"preco_posicao\": 13.2, \"preco_lote\": 13.2, \"matched_code\": \"S1989\", \"artigo\": \"12021108\", \"descricao\": \"Epicat-Set Safety 22G LL Cx100\", \"unidade_venda\": \"100\", \"quantidade\": 8, \"preco\": 0.4743019114447915, \"similarity_score\": 1.0, \"match_type\": \"Exato\", \"match_rank\": 1}]"
        }
      },
      {
        "json": {
          "output": "```json\n[\n  {\n    \"lote_pedido\": 3,\n    \"posicao_pedido\": 3,\n    \"artigo_pedido\": \"230001019\",\n    \"descricao_pedido\": \"AGULHA EPICRANEANA COM SISTEMA SEGURANÇA 25GX20MM\",\n    \"especificacoes_tecnicas\": \"\",\n    \"quantidade_pedido\": 100,\n    \"preco_artigo\": 0.3,\n    \"preco_posicao\": 30,\n    \"preco_lote\": 30,\n    \"codigo_spms\": \"S1990\",\n    \"matched_code\": \"S1990\",\n    \"artigo\": \"12021111\",\n    \"descricao\": \"Epicat-Set Safety 25G LL Cx100\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 16,\n    \"preco\": 5.42,\n    \"similarity_score\": 1.0,\n    \"match_type\": \"Exato\",\n    \"match_rank\": 1\n  }\n]\n```"
        }
      },
      {
        "json": {
          "output": "[{\"lote_pedido\": 4, \"posicao_pedido\": 4, \"artigo_pedido\": \"230003050\", \"descricao_pedido\": \"AGULHA IRRECUP. C\\\\SIST. ANTI PICADA 18G 1,2X40MM\", \"especificacoes_tecnicas\": \"\", \"quantidade_pedido\": 700, \"preco_artigo\": 0.06, \"preco_posicao\": 42, \"preco_lote\": 42, \"matched_code\": \"A5962\", \"artigo\": \"14200025\", \"descricao\": \"Hypodermic safety needle 18G 1.2x40mm cx100\", \"unidade_venda\": \"100\", \"quantidade\": 9, \"preco\": 4.670170108293879, \"similarity_score\": 1.0, \"match_type\": \"Exato\", \"match_rank\": 1}]"
        }
      },
      {
        "json": {
          "output": "[{\"lote_pedido\": 5, \"posicao_pedido\": 5, \"artigo_pedido\": \"230003051\", \"descricao_pedido\": \"AGULHA IRRECUP. C\\\\SIST. ANTI PICADA 19G 1/1.1X25 MM\", \"especificacoes_tecnicas\": \"\", \"quantidade_pedido\": 11500, \"preco_artigo\": 0.076, \"preco_posicao\": 874, \"preco_lote\": 874, \"matched_code\": \"A5981\", \"artigo\": \"14200027\", \"descricao\": \"Hypodermic safety needle 19G 1.1x25mm cx100\", \"unidade_venda\": \"100\", \"quantidade\": 18, \"preco\": 7.170560845160015, \"similarity_score\": 1.0, \"match_type\": \"Exato\", \"match_rank\": 1}]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 6,\n    \"posicao_pedido\": 6,\n    \"artigo_pedido\": \"230003053\",\n    \"descricao_pedido\": \"AGULHA IRRECUP. C\\\\SIST. ANTI PICADA 21G/0.8X25 MM\",\n    \"especificacoes_tecnicas\": \"\",\n    \"quantidade_pedido\": 6500,\n    \"preco_artigo\": 0.08,\n    \"preco_posicao\": 520,\n    \"preco_lote\": 520,\n    \"matched_code\": \"A5966\",\n    \"artigo\": \"14200030\",\n    \"descricao\": \"Hypodermic safety needle 21G 0.8x25mm cx100\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 8,\n    \"preco\": 3.95312530844227,\n    \"similarity_score\": 1.0,\n    \"match_type\": \"Exato\",\n    \"match_rank\": 1\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[{\"lote_pedido\": 7, \"posicao_pedido\": 7, \"artigo_pedido\": \"230003054\", \"descricao_pedido\": \"AGULHA IRRECUP. C\\\\SIST. ANTI PICADA 21G/0.8X40 MM\", \"especificacoes_tecnicas\": \"\", \"quantidade_pedido\": 43500, \"preco_artigo\": 0.06, \"preco_posicao\": 2610, \"preco_lote\": 2610, \"codigo_spms\": \"A5967\", \"matched_code\": \"A5967\", \"artigo\": \"14200031\", \"descricao\": \"Hypodermic safety needle 21G 0.8x40mm cx100\", \"unidade_venda\": \"100\", \"quantidade\": 9, \"preco\": 4.255062816103541, \"similarity_score\": 1.0, \"match_type\": \"Exato\", \"match_rank\": 1}]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 8,\n    \"posicao_pedido\": 8,\n    \"artigo_pedido\": \"230003056\",\n    \"descricao_pedido\": \"AGULHA IRRECUP. C\\\\SIST. ANTI PICADA 23G 0,6X25 MM\",\n    \"especificacoes_tecnicas\": \"\",\n    \"quantidade_pedido\": 20000,\n    \"preco_artigo\": 0.076,\n    \"preco_posicao\": 1520,\n    \"preco_lote\": 1520,\n    \"matched_code\": \"A5970\",\n    \"artigo\": \"14200036\",\n    \"descricao\": \"Hypodermic safety needle 23G 0.6x25mm cx100\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 15,\n    \"preco\": 7.598590386804663,\n    \"similarity_score\": 1.0,\n    \"match_type\": \"Exato\",\n    \"match_rank\": 1\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 9,\n    \"posicao_pedido\": 9,\n    \"artigo_pedido\": \"230003057\",\n    \"descricao_pedido\": \"AGULHA IRRECUP. C\\\\SIST. ANTI PICADA 25G 0,5X16 MM\",\n    \"especificacoes_tecnicas\": \"\",\n    \"quantidade_pedido\": 24000,\n    \"preco_artigo\": 0.076,\n    \"preco_posicao\": 1824,\n    \"preco_lote\": 1824,\n    \"matched_code\": \"A5984\",\n    \"artigo\": \"14200039\",\n    \"descricao\": \"Hypodermic safety needle 25G 0.5x16mm cx100\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 20,\n    \"preco\": 0.6541604121759843,\n    \"similarity_score\": 1,\n    \"match_type\": \"Exato\",\n    \"match_rank\": 1\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 10,\n    \"posicao_pedido\": 10,\n    \"artigo_pedido\": \"230003058\",\n    \"descricao_pedido\": \"AGULHA IRRECUP. C\\\\SIST. ANTI PICADA 25G 0,5X25 MM\",\n    \"especificacoes_tecnicas\": \"\",\n    \"quantidade_pedido\": 500,\n    \"preco_artigo\": 0.06,\n    \"preco_posicao\": 30,\n    \"preco_lote\": 30,\n    \"matched_code\": \"A5972\",\n    \"artigo\": \"14200038\",\n    \"descricao\": \"Hypodermic safety needle 25G 0.5x25mm cx100\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 6,\n    \"preco\": 5.778293130873772,\n    \"similarity_score\": 1.0,\n    \"match_type\": \"Exato\",\n    \"match_rank\": 1\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[{\"lote_pedido\": 11, \"posicao_pedido\": 11, \"artigo_pedido\": \"230003059\", \"descricao_pedido\": \"AGULHA IRRECUP. C\\\\SIST. ANTI PICADA 26G 0.45X12 MM\", \"especificacoes_tecnicas\": \"\", \"quantidade_pedido\": 2500, \"preco_artigo\": 0.06, \"preco_posicao\": 150, \"preco_lote\": 150, \"matched_code\": \"A5974\", \"artigo\": \"14200041\", \"descricao\": \"Hypodermic safety needle 26G 0.45x13mm cx100\", \"unidade_venda\": \"100\", \"quantidade\": 5, \"preco\": 5.6120571262142285, \"similarity_score\": 1.0, \"match_type\": \"Exato\", \"match_rank\": 1}]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 12,\n    \"posicao_pedido\": 12,\n    \"artigo_pedido\": \"230003100\",\n    \"descricao_pedido\": \"AGULHA IRRECUP.ROMBA P/ASPIRACAO E IRRIGACAO S/FILTRO 18G 1,20 X 40MM\",\n    \"especificacoes_tecnicas\": \"- Agulhas contundentes estéreis para uso único, tamanhos: 18G,1\\\" e 18G,1\\\" 1/2\\\"; - Material de polipropileno em conformidade com YY/T0242; - Tubo de agulha de aço inoxidável em conformidade com GB/T18457; - Membrana de filtração em conformidade com YY0770; - Sem látex e sem DEHP.\",\n    \"quantidade_pedido\": 369000,\n    \"preco_artigo\": 0.025,\n    \"preco_posicao\": 9225,\n    \"preco_lote\": 9225,\n    \"matched_code\": null,\n    \"artigo\": \"14200025\",\n    \"descricao\": \"Hypodermic safety needle 18G 1.2x40mm cx100\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 9,\n    \"preco\": 4.670170108293879,\n    \"similarity_score\": 0.81,\n    \"match_type\": \"Semântico\",\n    \"match_rank\": 1\n  },\n  {\n    \"lote_pedido\": 12,\n    \"posicao_pedido\": 12,\n    \"artigo_pedido\": \"230003100\",\n    \"descricao_pedido\": \"AGULHA IRRECUP.ROMBA P/ASPIRACAO E IRRIGACAO S/FILTRO 18G 1,20 X 40MM\",\n    \"especificacoes_tecnicas\": \"- Agulhas contundentes estéreis para uso único, tamanhos: 18G,1\\\" e 18G,1\\\" 1/2\\\"; - Material de polipropileno em conformidade com YY/T0242; - Tubo de agulha de aço inoxidável em conformidade com GB/T18457; - Membrana de filtração em conformidade com YY0770; - Sem látex e sem DEHP.\",\n    \"quantidade_pedido\": 369000,\n    \"preco_artigo\": 0.025,\n    \"preco_posicao\": 9225,\n    \"preco_lote\": 9225,\n    \"matched_code\": null,\n    \"artigo\": \"14200010\",\n    \"descricao\": \"Hypodermic needle 18G 1.2 x 40mm cx 100\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 6,\n    \"preco\": 5.866241586562589,\n    \"similarity_score\": 0.77,\n    \"match_type\": \"Semântico\",\n    \"match_rank\": 2\n  },\n  {\n    \"lote_pedido\": 12,\n    \"posicao_pedido\": 12,\n    \"artigo_pedido\": \"230003100\",\n    \"descricao_pedido\": \"AGULHA IRRECUP.ROMBA P/ASPIRACAO E IRRIGACAO S/FILTRO 18G 1,20 X 40MM\",\n    \"especificacoes_tecnicas\": \"- Agulhas contundentes estéreis para uso único, tamanhos: 18G,1\\\" e 18G,1\\\" 1/2\\\"; - Material de polipropileno em conformidade com YY/T0242; - Tubo de agulha de aço inoxidável em conformidade com GB/T18457; - Membrana de filtração em conformidade com YY0770; - Sem látex e sem DEHP.\",\n    \"quantidade_pedido\": 369000,\n    \"preco_artigo\": 0.025,\n    \"preco_posicao\": 9225,\n    \"preco_lote\": 9225,\n    \"matched_code\": null,\n    \"artigo\": \"14200026\",\n    \"descricao\": \"Hypodermic safety needle 19G 1.1x40mm cx100\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 18,\n    \"preco\": 2.163396817584569,\n    \"similarity_score\": 0.69,\n    \"match_type\": \"Semântico\",\n    \"match_rank\": 3\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[{\"lote_pedido\": 13, \"posicao_pedido\": 13, \"artigo_pedido\": \"230047000\", \"descricao_pedido\": \"SERINGA IRRECUP. 2/PECAS-2ML\", \"especificacoes_tecnicas\": \"\", \"quantidade_pedido\": 135000, \"preco_artigo\": 0.019, \"preco_posicao\": 2565, \"preco_lote\": 2565, \"matched_code\": null, \"artigo\": \"10621247\", \"descricao\": \"Seringa NIPRO 3PCS 2ml S/agulha UN\", \"unidade_venda\": \"1\", \"quantidade\": 18, \"preco\": 4.65702486088716, \"similarity_score\": 0.72, \"match_type\": \"Semântico\", \"match_rank\": 1}]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 14,\n    \"posicao_pedido\": 14,\n    \"artigo_pedido\": \"230047001\",\n    \"descricao_pedido\": \"SERINGA IRRECUP. 2/PECAS-5ML\",\n    \"especificacoes_tecnicas\": null,\n    \"quantidade_pedido\": 144000,\n    \"preco_artigo\": 0.0192,\n    \"preco_posicao\": 2764.8,\n    \"preco_lote\": 2764.8,\n    \"matched_code\": null,\n    \"artigo\": null,\n    \"descricao\": null,\n    \"unidade_venda\": null,\n    \"quantidade\": null,\n    \"preco\": null,\n    \"similarity_score\": 0,\n    \"match_type\": \"Sem Match\",\n    \"match_rank\": null\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[{\"lote_pedido\": 15, \"posicao_pedido\": 15, \"artigo_pedido\": \"230047002\", \"descricao_pedido\": \"SERINGA IRRECUP. 2/PECAS-10ML\", \"especificacoes_tecnicas\": null, \"quantidade_pedido\": 157000, \"preco_artigo\": 0.029, \"preco_posicao\": 4553, \"preco_lote\": 4553, \"matched_code\": null, \"artigo\": null, \"descricao\": null, \"unidade_venda\": null, \"quantidade\": null, \"preco\": null, \"similarity_score\": 0, \"match_type\": \"Sem Match\", \"match_rank\": null}]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 16,\n    \"posicao_pedido\": 16,\n    \"artigo_pedido\": \"230047003\",\n    \"descricao_pedido\": \"SERINGA IRRECUP. 2/PECAS-20ML\",\n    \"especificacoes_tecnicas\": \"\",\n    \"quantidade_pedido\": 100000,\n    \"preco_artigo\": 0.058,\n    \"preco_posicao\": 5800,\n    \"preco_lote\": 5800,\n    \"matched_code\": null,\n    \"artigo\": null,\n    \"descricao\": null,\n    \"unidade_venda\": null,\n    \"quantidade\": null,\n    \"preco\": null,"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 17,\n    \"posicao_pedido\": 17,\n    \"artigo_pedido\": \"230048000\",\n    \"descricao_pedido\": \"SERINGA IRRECUP.P/INSULINA U-100 3/PEC./1ML\",\n    \"especificacoes_tecnicas\": \"Baixo volume morto\",\n    \"quantidade_pedido\": 23000,\n    \"preco_artigo\": 0.0388,\n    \"preco_posicao\": 892.4,\n    \"preco_lote\": 892.4,\n    \"matched_code\": null,\n    \"artigo\": \"10621244\",\n    \"descricao\": \"SERINGA SOL-M INSULINA 1ML S/AGULHA 1UN\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 3,\n    \"preco\": 1.8154992395385965,\n    \"similarity_score\": 0.77,\n    \"match_type\": \"Semântico\",\n    \"match_rank\": 1\n  },\n  {\n    \"lote_pedido\": 17,\n    \"posicao_pedido\": 17,\n    \"artigo_pedido\": \"230048000\",\n    \"descricao_pedido\": \"SERINGA IRRECUP.P/INSULINA U-100 3/PEC./1ML\",\n    \"especificacoes_tecnicas\": \"Baixo volume morto\",\n    \"quantidade_pedido\": 23000,\n    \"preco_artigo\": 0.0388,\n    \"preco_posicao\": 892.4,\n    \"preco_lote\": 892.4,\n    \"matched_code\": null,\n    \"artigo\": \"10621240\",\n    \"descricao\": \"SERINGA INSULINA PIC 1ML S/AGULHA UN 25.920\",\n    \"unidade_venda\": \"160\",\n    \"quantidade\": 2,\n    \"preco\": 6.333951523278244,\n    \"similarity_score\": 0.75,\n    \"match_type\": \"Semântico\",\n    \"match_rank\": 2\n  },\n  {\n    \"lote_pedido\": 17,\n    \"posicao_pedido\": 17,\n    \"artigo_pedido\": \"230048000\",\n    \"descricao_pedido\": \"SERINGA IRRECUP.P/INSULINA U-100 3/PEC./1ML\",\n    \"especificacoes_tecnicas\": \"Baixo volume morto\",\n    \"quantidade_pedido\": 23000,\n    \"preco_artigo\": 0.0388,\n    \"preco_posicao\": 892.4,\n    \"preco_lote\": 892.4,\n    \"matched_code\": null,\n    \"artigo\": \"10621243\",\n    \"descricao\": \"SERINGA BD MICROFINE INSULINA 1ML S/AGULHA 1UN\",\n    \"unidade_venda\": \"120\",\n    \"quantidade\": 11,\n    \"preco\": 2.2492702859531866,\n    \"similarity_score\": 0.73,\n    \"match_type\": \"Semântico\",\n    \"match_rank\": 3\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[{\"lote_pedido\": 18, \"posicao_pedido\": 18, \"artigo_pedido\": \"230048002\", \"descricao_pedido\": \"SERINGA IRRECUP.P/TUBERCULINA U-100 3/PEC./1ML\", \"especificacoes_tecnicas\": null, \"quantidade_pedido\": 1000, \"preco_artigo\": 0.04, \"preco_posicao\": 40.0, \"preco_lote\": 40.0, \"matched_code\": null, \"artigo\": \"10621239\", \"descricao\": \"Seringa Tuberculina 1ml S/ agulha Cx100\", \"unidade_venda\": \"100\", \"quantidade\": 18, \"preco\": 2.3425261774180512, \"similarity_score\": 0.9500000000000001, \"match_type\": \"Semântico\", \"match_rank\": 1}, {\"lote_pedido\": 18, \"posicao_pedido\": 18, \"artigo_pedido\": \"230048002\", \"descricao_pedido\": \"SERINGA IRRECUP.P/TUBERCULINA U-100 3/PEC./1ML\", \"especificacoes_tecnicas\": null, \"quantidade_pedido\": 1000, \"preco_artigo\": 0.04, \"preco_posicao\": 40.0, \"preco_lote\": 40.0, \"matched_code\": null, \"artigo\": \"10621249\", \"descricao\": \"SERINGA PIC TUBERCULINA 1ML S/ AG 1UN\", \"unidade_venda\": \"160\", \"quantidade\": 18, \"preco\": 5.595729822461621, \"similarity_score\": 0.94, \"match_type\": \"Semântico\", \"match_rank\": 2}, {\"lote_pedido\": 18, \"posicao_pedido\": 18, \"artigo_pedido\": \"230048002\", \"descricao_pedido\": \"SERINGA IRRECUP.P/TUBERCULINA U-100 3/PEC./1ML\", \"especificacoes_tecnicas\": null, \"quantidade_pedido\": 1000, \"preco_artigo\": 0.04, \"preco_posicao\": 40.0, \"preco_lote\": 40.0, \"matched_code\": null, \"artigo\": \"10621241\", \"descricao\": \"SERINGA BD TUBERCULINA 1ML S/AG 1UN REF154-031\", \"unidade_venda\": null, \"quantidade\": 17, \"preco\": 4.773760374776913, \"similarity_score\": 0.94, \"match_type\": \"Semântico\", \"match_rank\": 3}]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 19,\n    \"posicao_pedido\": 19,\n    \"artigo_pedido\": \"230049000\",\n    \"descricao_pedido\": \"SERINGA IRRECUP. 3/PECAS 5ML\",\n    \"especificacoes_tecnicas\": null,\n    \"quantidade_pedido\": 4000,\n    \"preco_artigo\": 0.0263,\n    \"preco_posicao\": 105.2,\n    \"preco_lote\": 105.2,\n    \"matched_code\": null,\n    \"artigo\": \"20800257\",\n    \"descricao\": \"Seringa de Aspiração 5mL\",\n    \"unidade_venda\": \"10\",\n    \"quantidade\": 16,\n    \"preco\": 7.737273516577518,\n    \"similarity_score\": 0.75,\n    \"match_type\": \"Semântico\",\n    \"match_rank\": 1\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[{\"lote_pedido\": 20, \"posicao_pedido\": 20, \"artigo_pedido\": \"230049001\", \"descricao_pedido\": \"SERINGA IRRECUP. 3/PECAS 10ML com ponta excêntrica\", \"especificacoes_tecnicas\": \"Com ponta excêntrica\", \"quantidade_pedido\": 16500, \"preco_artigo\": 0.039, \"preco_posicao\": 643.5, \"preco_lote\": 643.5, \"matched_code\": null, \"artigo\": null, \"descricao\": null, \"unidade_venda\": null, \"quantidade\": null, \"preco\": null, \"similarity_score\": 0, \"match_type\": \"Sem Match\", \"match_rank\": null}]"
        }
      },
      {
        "json": {
          "output": "[{\"lote_pedido\":21,\"posicao_pedido\":21,\"artigo_pedido\":\"230049002\",\"descricao_pedido\":\"SERINGA IRRECUP.3/PECAS 50ML\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":3000,\"preco_artigo\":0.1431,\"preco_posicao\":429.3,\"preco_lote\":429.3,\"matched_code\":null,\"artigo\":null,\"descricao\":null,\"unidade_venda\":null,\"quantidade\":null,\"preco\":null,\"similarity_score\":0,\"match_type\":\"Sem Match\",\"match_rank\":null}]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 22,\n    \"posicao_pedido\": 22,\n    \"artigo_pedido\": \"230049003\",\n    \"descricao_pedido\": \"SERINGA IRRECUP.3/PECAS BICO CATETER 100ML\",\n    \"especificacoes_tecnicas\": \"\",\n    \"quantidade_pedido\": 11000,\n    \"preco_artigo\": 0.2968,\n    \"preco_posicao\": 3264.8,\n    \"preco_lote\": 3264.8,\n    \"matched_code\": null,\n    \"artigo\": null,\n    \"descricao\": null,\n    \"unidade_venda\": null,\n    \"quantidade\": null,\n    \"preco\": null,\n    \"similarity_score\": 0,\n    \"match_type\": \"Sem Match\",\n    \"match_rank\": null\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 23,\n    \"posicao_pedido\": 23,\n    \"artigo_pedido\": \"230049004\",\n    \"descricao_pedido\": \"SERINGA IRRECUP.3/PECAS 20ML\",\n    \"especificacoes_tecnicas\": null,\n    \"quantidade_pedido\": 1300,\n    \"preco_artigo\": 0.054,\n    \"preco_posicao\": 70.2,\n    \"preco_lote\": 70.2,\n    \"matched_code\": null,\n    \"artigo\": null,\n    \"descricao\": null,\n    \"unidade_venda\": null,\n    \"quantidade\": null,\n    \"preco\": null,\n    \"similarity_score\": 0.0,\n    \"match_type\": \"Sem Match\",\n    \"match_rank\": null\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 24,\n    \"posicao_pedido\": 24,\n    \"artigo_pedido\": \"230049006\",\n    \"descricao_pedido\": \"SERINGA IRRECUP.3/PECAS 2ML\",\n    \"especificacoes_tecnicas\": null,\n    \"quantidade_pedido\": 500,\n    \"preco_artigo\": 0.0215,\n    \"preco_posicao\": 10.75,\n    \"preco_lote\": 10.75,\n    \"matched_code\": null,\n    \"artigo\": \"10621247\",\n    \"descricao\": \"Seringa NIPRO 3PCS 2ml S/agulha UN\",\n    \"unidade_venda\": \"1\",\n    \"quantidade\": 18,\n    \"preco\": 4.65702486088716,\n    \"similarity_score\": 0.95,\n    \"match_type\": \"Semântico\",\n    \"match_rank\": 1\n  },\n  {\n    \"lote_pedido\": 24,\n    \"posicao_pedido\": 24,\n    \"artigo_pedido\": \"230049006\",\n    \"descricao_pedido\": \"SERINGA IRRECUP.3/PECAS 2ML\",\n    \"especificacoes_tecnicas\": null,\n    \"quantidade_pedido\": 500,\n    \"preco_artigo\": 0.0215,\n    \"preco_posicao\": 10.75,\n    \"preco_lote\": 10.75,\n    \"matched_code\": null,\n    \"artigo\": \"10621248\",\n    \"descricao\": \"Seringa descartável Paracélsia 3P 1ml s/agulha\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 11,\n    \"preco\": 6.246855270387512,\n    \"similarity_score\": 0.7000000000000001,\n    \"match_type\": \"Semântico\",\n    \"match_rank\": 2\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 25,\n    \"posicao_pedido\": 25,\n    \"artigo_pedido\": \"230049007\",\n    \"descricao_pedido\": \"SERINGA IRRECUP.3/PECAS 20 ML LUER LOCK\",\n    \"especificacoes_tecnicas\": \"\",\n    \"quantidade_pedido\": 5000,\n    \"preco_artigo\": 0.0678,\n    \"preco_posicao\": 339,\n    \"preco_lote\": 339,\n    \"matched_code\": null,\n    \"artigo\": null,\n    \"descricao\": null,\n    \"unidade_venda\": null,\n    \"quantidade\": null,\n    \"preco\": null,\n    \"similarity_score\": 0,\n    \"match_type\": \"Sem Match\",\n    \"match_rank\": null\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[{\"lote_pedido\":26,\"posicao_pedido\":26,\"artigo_pedido\":\"230049008\",\"descricao_pedido\":\"SERINGA IRRECUP.3/PECAS 5 ML LUER LOCK\",\"especificacoes_tecnicas\":null,\"quantidade_pedido\":1000,\"preco_artigo\":0.0317,\"preco_posicao\":31.7,\"preco_lote\":31.7,\"matched_code\":null,\"artigo\":\"20800257\",\"descricao\":\"Aspirating Syringe 5mL\",\"unidade_venda\":\"10\",\"quantidade\":16,\"preco\":7.737273516577518,\"similarity_score\":0.75,\"match_type\":\"Semântico\",\"match_rank\":1}]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 27,\n    \"posicao_pedido\": 27,\n    \"artigo_pedido\": \"230049009\",\n    \"descricao_pedido\": \"SERINGA IRRECUP.3/PECAS 10 ML LUER LOCK\",\n    \"especificacoes_tecnicas\": null,\n    \"quantidade_pedido\": 2500,\n    \"preco_artigo\": 0.0456,\n    \"preco_posicao\": 114,\n    \"preco_lote\": 114,\n    \"matched_code\": null,\n    \"artigo\": \"22200050\",\n    \"descricao\": \"Sonogun\",\n    \"unidade_venda\": \"1\",\n    \"quantidade\": 16,\n    \"preco\": 0.4853700790838804,\n    \"similarity_score\": 0.6,\n    \"match_type\": \"Semântico\",\n    \"match_rank\": 1\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[{\"lote_pedido\": 28, \"posicao_pedido\": 28, \"artigo_pedido\": \"230049011\", \"descricao_pedido\": \"SERINGA IRRECUP. 3/PECAS 30ML LUER-LOCK\", \"especificacoes_tecnicas\": null, \"quantidade_pedido\": 4000, \"preco_artigo\": 0.13, \"preco_posicao\": 520, \"preco_lote\": 520, \"matched_code\": null, \"artigo\": null, \"descricao\": null, \"unidade_venda\": null, \"quantidade\": null, \"preco\": null, \"similarity_score\": 0, \"match_type\": \"Sem Match\", \"match_rank\": null}]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 29,\n    \"posicao_pedido\": 29,\n    \"artigo_pedido\": \"230033000\",\n    \"descricao_pedido\": \"LANCETA P/PUNCAO CAPILAR 21GX1,8MM\",\n    \"especificacoes_tecnicas\": null,\n    \"quantidade_pedido\": 150000,\n    \"preco_artigo\": 0.044,\n    \"preco_posicao\": 6600,\n    \"preco_lote\": 6600,\n    \"matched_code\": null,\n    \"artigo\": null,\n    \"descricao\": null,\n    \"unidade_venda\": null,\n    \"quantidade\": null,\n    \"preco\": null,\n    \"similarity_score\": 0,\n    \"match_type\": \"Sem Match\",\n    \"match_rank\": null\n  }\n]"
        }
      },
      {
        "json": {
          "output": "[\n  {\n    \"lote_pedido\": 30,\n    \"posicao_pedido\": 30,\n    \"artigo_pedido\": \"230046000\",\n    \"descricao_pedido\": \"SERINGA COLTA GASES SANGUE C\\\\SISTEMA SEG. 3CC C\\\\AGULHA 23G X1XA(100 UN/HP)\",\n    \"especificacoes_tecnicas\": \"\",\n    \"quantidade_pedido\": 16000,\n    \"preco_artigo\": 0.65,\n    \"preco_posicao\": 10400,\n    \"preco_lote\": 10400,\n    \"matched_code\": null,\n    \"artigo\": \"14200036\",\n    \"descricao\": \"Hypodermic safety needle 23G 0.6x25mm cx100\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 15,\n    \"preco\": 7.598590386804663,\n    \"similarity_score\": 0.68,\n    \"match_type\": \"Semântico\",\n    \"match_rank\": 1\n  },\n  {\n    \"lote_pedido\": 30,\n    \"posicao_pedido\": 30,\n    \"artigo_pedido\": \"230046000\",\n    \"descricao_pedido\": \"SERINGA COLTA GASES SANGUE C\\\\SISTEMA SEG. 3CC C\\\\AGULHA 23G X1XA(100 UN/HP)\",\n    \"especificacoes_tecnicas\": \"\",\n    \"quantidade_pedido\": 16000,\n    \"preco_artigo\": 0.65,\n    \"preco_posicao\": 10400,\n    \"preco_lote\": 10400,\n    \"matched_code\": null,\n    \"artigo\": \"14200034\",\n    \"descricao\": \"Hypodermic safety needle 23G 0.6x32mm cx100\",\n    \"unidade_venda\": \"100\",\n    \"quantidade\": 8,\n    \"preco\": 0.6486311396877784,\n    \"similarity_score\": 0.65,\n    \"match_type\": \"Semântico\",\n    \"match_rank\": 2\n  }\n]"
        }
      }
    ]
  },
  "connections": {
    "Merge": {
      "main": [
        [
          {
            "node": "Adicionar produtos a GSheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Share file": {
      "main": [
        [
          {
            "node": "Create a draft",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "query_artigos_vectors",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Extração de produtos RFP",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Extrai conteúdo": {
      "main": [
        [
          {
            "node": "É imagem em PDF?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "É imagem em PDF?": {
      "main": [
        [
          {
            "node": "Upload pdf \"imagem\" p/ cloud mistral",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extração de produtos RFP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aplicar OCR e devolve conteúdo": {
      "main": [
        [
          {
            "node": "Converter todas as páginas em markdown único",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obter Signed URL": {
      "main": [
        [
          {
            "node": "Aplicar OCR e devolve conteúdo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload pdf \"imagem\" p/ cloud mistral": {
      "main": [
        [
          {
            "node": "Obter Signed URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Converter todas as páginas em markdown único": {
      "main": [
        [
          {
            "node": "Extração de produtos RFP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extração de produtos RFP": {
      "main": [
        [
          {
            "node": "Formatação Produtos RFP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Matching semântico": {
      "main": [
        [
          {
            "node": "Formatação Match Produtos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatação Produtos RFP": {
      "main": [
        [
          {
            "node": "Matching semântico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatação Match Produtos": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          },
          {
            "node": "Copia template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Copia template": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Adicionar produtos a GSheet": {
      "main": [
        [
          {
            "node": "Share file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gmail Trigger": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Extract from CSV",
            "type": "main",
            "index": 0
          },
          {
            "node": "Select all artigos from DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extrai conteúdo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Exist in file but not in DB - Insert": {
      "main": [
        [
          {
            "node": "Insert into DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Exist in DB but not in file - Delete": {
      "main": [
        [
          {
            "node": "Delete from DB",
            "type": "main",
            "index": 0
          },
          {
            "node": "Delete from Vector Store",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select all artigos from DB": {
      "main": [
        [
          {
            "node": "Exist in file but not in DB - Insert",
            "type": "main",
            "index": 0
          },
          {
            "node": "Exist in DB but not in file - Delete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from CSV": {
      "main": [
        [
          {
            "node": "Delete empty rows from CSV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete empty rows from CSV": {
      "main": [
        [
          {
            "node": "Exist in DB but not in file - Delete",
            "type": "main",
            "index": 1
          },
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          },
          {
            "node": "Exist in file but not in DB - Insert",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Character Text Splitter1": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Trigger": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Select rows from a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select rows from a table": {
      "main": [
        [
          {
            "node": "Add embedding field",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Postgres PGVector Store - Insert (Setup)1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Postgres PGVector Store - Insert (Setup)1",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Add embedding field": {
      "main": [
        [
          {
            "node": "Postgres PGVector Store - Insert (Setup)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres PGVector Store - Insert (Setup)1": {
      "main": [
        [
          {
            "node": "Update Flg_embedded",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‘Execute workflow’": {
      "main": [
        [
          {
            "node": "Select rows from a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a draft": {
      "main": [
        []
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Matching semântico",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "query_artigos_table": {
      "ai_tool": [
        [
          {
            "node": "Matching semântico",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "query_artigos_vectors": {
      "ai_tool": [
        [
          {
            "node": "Matching semântico",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Insert into DB": {
      "main": [
        []
      ]
    },
    "Delete from Vector Store": {
      "main": [
        []
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Update jobs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete from DB": {
      "main": [
        []
      ]
    },
    "No Operation, do nothing": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Update Inventory": {
      "main": [
        [
          {
            "node": "Extract from CSV",
            "type": "main",
            "index": 0
          },
          {
            "node": "Select all artigos from DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Upload RFP": {
      "main": [
        [
          {
            "node": "Extrai conteúdo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "16ccbece-4ce2-4563-900b-7c80507ba878",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "861ea1fddb22a0b9af16e6092c971643defa70631669089d78d9b90a1e47a91a"
  },
  "id": "hGpWU-gMe0Cq2iH6-sx1z",
  "tags": []
}